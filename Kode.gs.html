// --- TAMBAHAN BARU ---
const SHEET_SUPERADMIN = "Sheet_Superadmin";
// --- AKHIR TAMBAHAN ---

const MASTER_SHEET_ID = "191TzI0vRzK8xg7kGym8qUnvXz_edlCH_IJmmwMZMK_M"; 
const TARGET_FOLDER_ID = "1Xu9vSZQKAxVCNDuAXI8W5l-3xb58cQm9";

// --- TAMBAHAN BARU ---
const DONASI_FOLDER_ID = "1ETK_gUuPQsuSeNu_XbIctkvVb9JSPmS9"; // <== PENTING: Ganti ID ini
// --- AKHIR TAMBAHAN ---

const MASTER_SHEET_CACHE_KEY = 'MASTER_SHEET_DATA_V1';

const MAPEL_CACHE_KEY = 'mapel_data_v1';
const SISWA_CACHE_KEY = 'siswa_data_v1';
const NILAI_GRID_CACHE_KEY_PREFIX = 'nilai_grid_v1_';
const REKAP_NILAI_CACHE_KEY = 'rekap_nilai_v1';
const NILAI_RAPOR_GRID_CACHE_KEY_PREFIX = 'nilai_rapor_grid_v1_';
const REKAP_NILAI_RAPOR_CACHE_KEY = 'rekap_nilai_rapor_v1';

const TEMPLATE_SISWA_FILENAME = "template_import_siswa.xlsx";
const TEMPLATE_SISWA_MIMETYPE = MimeType.MICROSOFT_EXCEL;

const SHEET_REGISTRASI_PENDING = "Registrasi_Pending";
const TOKEN_EXPIRY_HOURS = 24; // Token berlaku 24 jam

const LOCKED_KELAS_CACHE_KEY = 'locked_kelas_v1';

const NILAI_IJAZAH_CACHE_KEY = 'nilai_ijazah_v1';

const SHEET_CACHE_IJAZAH = "Cache_Rekap_Ijazah";

const MASTER_NISN_INDEX_KEY = 'master_nisn_index_v1';
const HASIL_KELULUSAN_PREFIX = 'hasil_kelulusan_v1_';

const MASTER_KELULUSAN_DB_ID = "1f0xj0-tfK7hlEnAV-pIySfj_K4o46vjGV6iqo6toZRI";

// GANTI DENGAN ID FILE YANG ANDA SALIN DARI LANGKAH 2
const TEMPLATE_SISWA_FILE_ID = "1jITh9Ss5DsesT35RN-R3DDvI1AZDIi8M57F4nTLZoeM";

/**
 * Mengubah array byte (dari computeDigest) menjadi string heksadesimal.
 */
function bytesToHex(bytes) {
  return bytes.map(byte => {
    return ('0' + (byte & 0xFF).toString(16)).slice(-2);
  }).join('');
}

/**
 * Membuat string salt acak yang unik.
 */
function generateSalt() {
  return Utilities.getUuid();
}

/**
 * Membuat hash SHA-256 dari password dan salt.
 * Mengembalikan hash sebagai string hex.
 */
function hashPassword(password, salt) {
  const digest = Utilities.computeDigest(Utilities.DigestAlgorithm.SHA_256, password + salt, Utilities.Charset.UTF_8);
  return bytesToHex(digest);
}

/**
 * Memverifikasi apakah password inputan cocok dengan hash yang tersimpan.
 */
function verifyPassword(inputPassword, storedHash, storedSalt) {
  const newHash = hashPassword(inputPassword, storedSalt);
  return newHash === storedHash;
}

function getSheetRegistrasiPending(masterSS) {
  let sheet = masterSS.getSheetByName(SHEET_REGISTRASI_PENDING);
  if (!sheet) {
    sheet = masterSS.insertSheet(SHEET_REGISTRASI_PENDING);
    sheet.appendRow(['Email', 'NamaSekolah', 'NPSN', 'Jenjang', 'HashedPassword', 'Salt', 'VerificationToken', 'Timestamp']);
    sheet.setFrozenRows(1);
  } else {
    const header = sheet.getRange(1, 3).getValue();
    if (header !== "NPSN") {
       sheet.insertColumnBefore(3);
       sheet.getRange(1, 3).setValue("NPSN");
    }
  }
  return sheet;
}

function doGet(e) {
  // Cek apakah ada parameter 'v' (untuk verifikasi)
  if (e.parameter.v) {
    const token = e.parameter.v;
    // Proses token dan dapatkan pesan HTML
    const message = prosesVerifikasiToken(token);
    
    // --- PERBAIKAN DI SINI ---
    // 1. Buat template dari file 'verifikasi.html'
    const template = HtmlService.createTemplateFromFile('verifikasi');
    
    // 2. Masukkan pesan (sukses/gagal) ke dalam variabel template 'verificationMessage'
    //    Ini akan mengisi placeholder <?!= verificationMessage; ?> di file verifikasi.html
    template.verificationMessage = `<div>${message}</div>`;
    
    // 3. Evaluasi template SETELAH variabelnya diisi
    return template.evaluate()
      .setTitle('Verifikasi Akun');
    // --- AKHIR PERBAIKAN ---
  }
  
  // Jika tidak ada parameter 'v', jalankan aplikasi utama seperti biasa
  return HtmlService.createTemplateFromFile('index')
    .evaluate()
    .setTitle('Pengolahan Nilai Ijazah')
    .setFaviconUrl("https://images.icon-icons.com/547/PNG/512/1455554314_line-15_icon-icons.com_53330.png")
    .addMetaTag('viewport', 'width=device-width, initial-scale=1.0');
}

// --- TAMBAHAN BARU ---
/**
 * Mendapatkan atau membuat sheet untuk Superadmin.
 */
function getSheetSuperadmin(masterSS) {
  let sheet = masterSS.getSheetByName(SHEET_SUPERADMIN);
  if (!sheet) {
    sheet = masterSS.insertSheet(SHEET_SUPERADMIN);
    // Email, Nama Tampilan, HashedPassword, Salt
    sheet.appendRow(['Email', 'Nama', 'HashedPassword', 'Salt']);
    sheet.setFrozenRows(1);
    
    // --- BUAT AKUN SUPERADMIN PERTAMA KALI (HANYA SEKALI) ---
    // Ganti 'superadmin@email.com', 'Super Admin', dan 'password_superadmin'
    // Jalankan fungsi ini sekali manual dari editor Apps Script untuk membuat akun.
    // try {
    //   const firstSalt = generateSalt();
    //   const firstHash = hashPassword('password_superadmin', firstSalt);
    //   sheet.appendRow(['superadmin@email.com', 'Super Admin', firstHash, firstSalt]);
    // } catch (e) {}
    // --- AKHIR PEMBUATAN AKUN ---
  }
  return sheet;
}

// --- FUNGSI BARU ---
/**
 * Mengirim email verifikasi ke pengguna.
 */
function kirimEmailVerifikasi(email, namaSekolah, token) {
  try {
    const url = ScriptApp.getService().getUrl() + '?v=' + token;
    const subject = "Verifikasi Akun Aplikasi Nilai Ijazah";
    const body = `
      <div style="font-family: Arial, sans-serif; line-height: 1.6;">
        <p>Halo, Admin ${namaSekolah},</p>
        <p>Terima kasih telah mendaftar di Aplikasi Pengolahan Nilai Ijazah.</p>
        <p>Untuk mengaktifkan akun Anda, silakan klik tombol di bawah ini:</p>
        <p style="margin: 25px 0;">
          <a href="${url}" style="font-size: 16px; font-weight: bold; padding: 12px 20px; background-color: #0d6efd; color: white; text-decoration: none; border-radius: 5px;">
            Aktivasi Akun Saya
          </a>
        </p>
        <p>Jika tombol di atas tidak berfungsi, salin dan tempel URL berikut di browser Anda:</p>
        <p style="word-break: break-all;">${url}</p>
        <p>Link ini akan kedaluwarsa dalam ${TOKEN_EXPIRY_HOURS} jam.</p>
        <br>
        <p>Terima kasih.</p>
      </div>
    `;

    MailApp.sendEmail({
      to: email,
      subject: subject,
      htmlBody: body,
      name: "Admin Aplikasi Ijazah" // Nama pengirim
    });
    Logger.log("Email verifikasi terkirim ke: " + email);
  } catch (e) {
    Logger.log(`Gagal mengirim email verifikasi ke ${email}: ${e.message}`);
    // Sebaiknya jangan gagalkan registrasi jika email gagal, cukup log saja
  }
}

// --- PERBAIKAN PADA TANDA TANGAN FUNGSI ---
function buatDatabaseSekolahBaru(namaSekolah, jenjang, npsn, email, password, masterSS) {
// --- AKHIR PERBAIKAN ---
  let newSSID = null; 
  try {
    let targetFolder;
    try {
      targetFolder = DriveApp.getFolderById(TARGET_FOLDER_ID);
    } catch (folderError) {
      Logger.log("Error mengambil folder: " + folderError);
      throw new Error("Error: Folder target tidak ditemukan atau tidak dapat diakses. ID: " + TARGET_FOLDER_ID);
    }

    const namaSekolahUpper = namaSekolah.toUpperCase();
    const newSpreadsheet = SpreadsheetApp.create("Database Nilai - " + namaSekolahUpper); 
    newSSID = newSpreadsheet.getId();
    Logger.log("Spreadsheet baru dibuat (via verifikasi): " + newSSID);

    const newFile = DriveApp.getFileById(newSSID);
    targetFolder.addFile(newFile); 
    DriveApp.getRootFolder().removeFile(newFile); 
    Logger.log("Spreadsheet dipindahkan ke folder: " + targetFolder.getName());

    const defaultSheet = newSpreadsheet.getSheets()[0];
    
    const sheetSiswa = newSpreadsheet.insertSheet('Siswa');
    sheetSiswa.appendRow([
        'SiswaID', 'NamaSiswa', 'NISN', 'NIS_Lokal', 'JenisKelamin', 
        'TempatLahir', 'TglLahir', 'Kelas', 'Urutan'
      ]);
    sheetSiswa.getRange('C:D').setNumberFormat('@');
      
    
    const sheetKelas = newSpreadsheet.insertSheet('Kelas');
    sheetKelas.appendRow(['NamaKelas']); 

    let defaultKelas = '';
    switch (jenjang) {
      case 'SD/MI':
        defaultKelas = 'VI';
        break;
      case 'SMP/MTS':
        defaultKelas = 'IX';
        break;
      case 'SMA/MA':
        defaultKelas = 'XII';
        break;
    }
    
    if (defaultKelas) {
      sheetKelas.appendRow([defaultKelas]);
    }
    
    const sheetMapel = newSpreadsheet.insertSheet('Mapel');
    sheetMapel.appendRow(['MapelID', 'NamaMapel', 'isUS', 'isUP', 'Urutan']); 

    const defaultMapel = getDynamicDefaultMapel(jenjang, masterSS);
    if (defaultMapel.length > 0) {
      sheetMapel.getRange(2, 1, defaultMapel.length, 5).setValues(defaultMapel);
    }

    newSpreadsheet.insertSheet('Nilai_Ujian')
      .appendRow(['SiswaID', 'MapelID', 'UjianMadrasah', 'UjianPraktek']);
      
    newSpreadsheet.insertSheet('Nilai_Rapor_Akhir')
      .appendRow(['SiswaID', 'MapelID', 'SemesterID', 'Nilai_P', 'Nilai_K']);
    
    const sheetSetting = newSpreadsheet.insertSheet('Pengaturan');
    sheetSetting.appendRow(['Setting', 'Value']);
    sheetSetting.appendRow(['Bobot_Rapor', 60]);
    sheetSetting.appendRow(['Bobot_Ujian', 40]);
    sheetSetting.appendRow(['Jumlah_Semester', 5]);
    sheetSetting.appendRow(['KKM', 76]);

    const sheetDataSekolah = newSpreadsheet.insertSheet('Data_Sekolah');
    sheetDataSekolah.appendRow([
      'JenjangPilihan', 'NPSN', 'NSM', 'Alamat', 'Provinsi', 
      'KabKot', 'PilihanKabKot', 'Kecamatan', 'KelDes', 'PilihanKelDes', 
      'KodePos', 'Telepon', 'Email', 'Website', 'NamaKepsek', 'NIPKepsek'
    ]);
    let jenjangPilihanDefault = '';
    if (jenjang === 'SD/MI') {
      jenjangPilihanDefault = 'MI';
    } else if (jenjang === 'SMP/MTS') {
      jenjangPilihanDefault = 'MTS';
    } else if (jenjang === 'SMA/MA') {
      jenjangPilihanDefault = 'MA';
    }
    
    // --- PERBAIKAN DI SINI ---
    // Menggunakan variabel 'npsn' yang diterima fungsi
    sheetDataSekolah.appendRow([
      jenjangPilihanDefault, 
      npsn, // <-- PERBAIKAN
      '', '', '', 
      '', 'Kabupaten', '', '', 'Kelurahan', 
      '', '', '', '', '', ''
    ]);
    // --- AKHIR PERBAIKAN ---

    sheetDataSekolah.getRange('A2:P2').setNumberFormat('@');

    // --- PERUBAHAN DI SINI ---
    // Mengubah struktur Sheet Cache Ijazah
    const sheetCacheIjazah = newSpreadsheet.insertSheet(SHEET_CACHE_IJAZAH);
    // Baris 1: Header untuk Metadata
    sheetCacheIjazah.appendRow(['Meta', 'LastUpdated', 'BobotRaporPct', 'BobotUjianPct', 'KKM', 'SiswaListJSON', 'MapelListJSON']);
    // Baris 2: Header untuk Data Nilai
    sheetCacheIjazah.appendRow(['SiswaID', 'MapelID', 'UjianAsli', 'RaporAsli', 'UjianBobot', 'RaporBobot', 'IjazahFinal']);
    sheetCacheIjazah.setFrozenRows(2); // Bekukan 2 baris header
    sheetCacheIjazah.hideSheet(); // Sembunyikan sheet
    // --- AKHIR PERUBAHAN ---

    newSpreadsheet.deleteSheet(defaultSheet);
    
    return newSSID;

  } catch (e) {
    Logger.log(e);
    if (newSSID) {
      DriveApp.getFileById(newSSID).setTrashed(true);
    }
    throw new Error("Gagal membuat database: " + e.message);
  }
}

function prosesVerifikasiToken(token) {
  if (!token) {
    return `<h1>Permintaan Tidak Valid</h1>
            <p>Permintaan verifikasi tidak lengkap. Pastikan Anda menggunakan link yang benar dari email.</p>`;
  }
  
  let masterSS;
  let sheetSekolah;
  let sheetPending;
  
  const lock = LockService.getScriptLock();
  lock.waitLock(15000);
  
  try {
    masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
    sheetSekolah = masterSS.getSheetByName('Sheet_Sekolah');
    sheetPending = getSheetRegistrasiPending(masterSS); 

    const dataPending = sheetPending.getDataRange().getValues();
    const now = new Date();
    const expiryLimit = now.getTime() - (TOKEN_EXPIRY_HOURS * 60 * 60 * 1000);

    for (let i = dataPending.length - 1; i >= 1; i--) {
      const row = dataPending[i];
      const dbToken = row[6];
      const dbTimestamp = new Date(row[7]).getTime();

      if (dbToken === token) {
        if (dbTimestamp < expiryLimit) {
          sheetPending.deleteRow(i + 1);
          return `<h1>Token Kedaluwarsa</h1>
                  <p>Link verifikasi Anda sudah tidak berlaku (lebih dari ${TOKEN_EXPIRY_HOURS} jam). Untuk keamanan, silakan lakukan registrasi ulang.</p>`;
        }

        const email = row[0];
        const namaSekolah = row[1];
        const npsn = row[2];
        const jenjang = row[3];
        const dbHash = row[4];
        const dbSalt = row[5];
        
        const emailFinder = sheetSekolah.getRange("D2:D").createTextFinder(email).matchEntireCell(true).findAll();
        
        if (emailFinder.length > 0) {
          sheetPending.deleteRow(i + 1);
          const appUrl = ScriptApp.getService().getUrl();
          return `<h1>Akun Sudah Aktif</h1>
                  <p>Akun dengan email ini sudah terverifikasi dan aktif. Anda dapat langsung login.</p>
                  <a href="${appUrl}" class="button-login">Menuju Halaman Login</a>`;
        }

        try {
          // --- PERBAIKAN DI SINI ---
          // Menambahkan 'npsn' sebagai parameter ketiga
          const newSSID = buatDatabaseSekolahBaru(namaSekolah, jenjang, npsn, email, "dummy_password_not_used", masterSS);
          // --- AKHIR PERBAIKAN ---
          
          const newSekolahID = "SKL-" + (sheetSekolah.getLastRow());
          sheetSekolah.appendRow([
            newSekolahID, 
            namaSekolah.toUpperCase(), 
            jenjang, 
            email, 
            dbHash, 
            newSSID,
            dbSalt,
            npsn,
            "NONE", // DonasiStatus
            "",     // DonasiFileID
            "",     // DonasiDataJSON
            ""      // DonasiAlasanTolak
          ]);

          sheetPending.deleteRow(i + 1);
          
          clearMasterSheetCache();
          
          const appUrl = ScriptApp.getService().getUrl();
          return `<h1>Verifikasi Berhasil!</h1>
                  <p>Akun Anda telah berhasil diaktifkan dan database sekolah Anda telah dibuat.</p>
                  <p>Silakan klik tombol di bawah ini untuk masuk ke halaman login.</p>
                  <a href="${appUrl}" class="button-login">Menuju Halaman Login</a>`;
          
        } catch (e) {
          Logger.log(`Verifikasi sukses untuk ${email} TAPI GAGAL buat DB: ${e.message}`);
          return `<h1>Verifikasi Berhasil, Namun...</h1>
                  <p>Akun Anda terverifikasi, tetapi terjadi error saat penyiapan database sekolah. Silakan hubungi admin untuk tindak lanjut.</p>
                  <p style="font-size: 14px; color: #6c757d;">Detail Error: ${e.message}</p>`;
        }
      }
    }
    
    return `<h1>Token Tidak Valid</h1>
            <p>Token verifikasi Anda tidak ditemukan. Link ini mungkin sudah digunakan atau tidak valid.</p>`;

  } catch (e) {
    Logger.log(e);
    return `<h1>Error Server</h1>
            <p>Terjadi kegagalan di server. Silakan coba lagi beberapa saat, atau hubungi admin jika masalah berlanjut.</p>
            <p style="font-size: 14px; color: #6c757d;">Detail Error: ${e.message}</p>`;
  } finally {
    lock.releaseLock();
  }
}

function include(filename) {
  return HtmlService.createHtmlOutputFromFile(filename).getContent();
}

function getCachedMasterSheetData() {
  const cache = CacheService.getScriptCache();
  
  let cachedData = cache.get(MASTER_SHEET_CACHE_KEY);
  if (cachedData != null) {
    Logger.log("Mengambil data Master Sheet dari SCRIPT CACHE");
    return JSON.parse(cachedData);
  }
  
  Logger.log("Mengambil data Master Sheet dari SPREADSHEET (Fresh)");
  let masterSS;
  try {
     masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
  } catch (e) {
    Logger.log("Gagal membuka Master Sheet ID: " + MASTER_SHEET_ID + ". Error: " + e.message);
    throw new Error("Database Master tidak dapat diakses. Hubungi Admin.");
  }

  const sheetSekolah = masterSS.getSheetByName('Sheet_Sekolah');
  if (!sheetSekolah) {
    Logger.log("Sheet 'Sheet_Sekolah' tidak ditemukan di Master Sheet.");
    throw new Error("Database Master tidak dikonfigurasi. Hubungi Admin.");
  }
  
  const dataSekolah = sheetSekolah.getDataRange().getValues();
  
  cache.put(MASTER_SHEET_CACHE_KEY, JSON.stringify(dataSekolah), 3600); 
  
  return dataSekolah;
}

function clearLockedKelasCache(sekolahID) {
  try {
    const cacheKey = LOCKED_KELAS_CACHE_KEY + "_" + sekolahID;
    CacheService.getScriptCache().remove(cacheKey);
  } catch (e) {
  }
}

function clearMasterSheetCache() {
  try {
    CacheService.getScriptCache().remove(MASTER_SHEET_CACHE_KEY);
    Logger.log("Cache Master Sheet dibersihkan.");
  } catch (e) {
    Logger.log("Gagal membersihkan cache Master Sheet: " + e.message);
  }
}

// Salin dan ganti fungsi clearRekapNilaiCache() Anda dengan yang ini
function clearRekapNilaiCache(sekolahID) {
  try {
    const cacheKey = REKAP_NILAI_CACHE_KEY + "_" + sekolahID;
    
    // --- PERBAIKAN: Gunakan variabel scriptCache ---
    const scriptCache = CacheService.getScriptCache();
    scriptCache.remove(cacheKey);
    // --- AKHIR PERBAIKAN ---

    // --- TAMBAHAN: Rekap Ujian mempengaruhi Ijazah ---
    scriptCache.remove(NILAI_IJAZAH_CACHE_KEY + "_" + sekolahID);
    // --- AKHIR TAMBAHAN ---

  } catch (e) {
     Logger.log("Gagal clearRekapNilaiCache: " + e.message);
  }
}

// Salin dan ganti fungsi clearNilaiUjianCache() Anda dengan yang ini
function clearNilaiUjianCache(sekolahID, spreadsheetID) { // <--- Terima spreadsheetID
  try {
    const scriptCache = CacheService.getScriptCache();
    // Hapus cache admin
    scriptCache.remove(NILAI_GRID_CACHE_KEY_PREFIX + 'UM' + "_" + sekolahID);
    scriptCache.remove(NILAI_GRID_CACHE_KEY_PREFIX + 'Praktek' + "_" + sekolahID);

    if (spreadsheetID) {
      const ss = SpreadsheetApp.openById(spreadsheetID);
      const sheetGuru = ss.getSheetByName('Akun_Guru');

      if (sheetGuru) {
        const guruData = sheetGuru.getDataRange().getValues();
        guruData.shift();
        // Loop semua guru di sekolah ini dan hapus cache mereka
        guruData.forEach(row => {
          const namaGuru = row[1];
          if (namaGuru) {
            const suffix = `_GURU_${namaGuru.replace(/\s+/g, '')}`;
            scriptCache.remove(NILAI_GRID_CACHE_KEY_PREFIX + 'UM' + "_" + sekolahID + suffix);
            scriptCache.remove(NILAI_GRID_CACHE_KEY_PREFIX + 'Praktek' + "_" + sekolahID + suffix);
          }
        });
      }
    } // Akhir dari 'if (spreadsheetID)'
    
    // --- TAMBAHAN: Pastikan Ijazah dan Rekap juga bersih ---
    clearRekapNilaiCache(sekolahID);
    scriptCache.remove(NILAI_IJAZAH_CACHE_KEY + "_" + sekolahID);
    // --- AKHIR TAMBAHAN ---

  } catch (e) {
     Logger.log("Gagal clearNilaiUjianCache: " + e.message);
  }
}

// Salin dan ganti fungsi clearRekapNilaiRaporCache() Anda dengan yang ini
function clearRekapNilaiRaporCache(sekolahID) {
  try {
    const cacheKey = REKAP_NILAI_RAPOR_CACHE_KEY + "_" + sekolahID;
    
    // --- PERBAIKAN: Gunakan variabel scriptCache ---
    const scriptCache = CacheService.getScriptCache();
    scriptCache.remove(cacheKey);
    // --- AKHIR PERBAIKAN ---

    // --- TAMBAHAN: Rekap Rapor mempengaruhi Ijazah ---
    scriptCache.remove(NILAI_IJAZAH_CACHE_KEY + "_" + sekolahID);
    // --- AKHIR TAMBAHAN ---

  } catch (e) {
     Logger.log("Gagal clearRekapNilaiRaporCache: " + e.message);
  }
}

// Fungsi ini sudah benar, tidak perlu diubah, tapi pastikan ada di kode Anda.
function clearNilaiRaporCache(sekolahID, spreadsheetID) { // <--- Terima spreadsheetID
  try {
    const scriptCache = CacheService.getScriptCache();
    scriptCache.remove(REKAP_NILAI_RAPOR_CACHE_KEY + "_" + sekolahID);
    scriptCache.remove(NILAI_IJAZAH_CACHE_KEY + "_" + sekolahID);
    
    // Hapus juga cache grid rapor (per semester)
    if (spreadsheetID) {
        const ss = SpreadsheetApp.openById(spreadsheetID);
        
        // Ambil 'jenjang' dari data sekolah
        const sheetDataSekolah = getDataSekolahSheet(ss);
        const jenjangPilihan = sheetDataSekolah.getRange('A2').getValue();
        // Tentukan jenjang berdasarkan jenjangPilihan
        const jenjang = jenjangPilihan.includes('SD') || jenjangPilihan.includes('MI') ? 'SD/MI' : (jenjangPilihan.includes('SMP') || jenjangPilihan.includes('MTS') ? 'SMP/MTS' : 'SMA/MA');

        const sheetSetting = getPengaturanSheet(ss);
        const data = sheetSetting.getRange('A1:B' + sheetSetting.getLastRow()).getValues();
        let jumlahSemester = 5;
        for (let i = 0; i < data.length; i++) {
          if (data[i][0] === 'Jumlah_Semester') {
            jumlahSemester = parseInt(data[i][1], 10) || 5;
            break;
          }
        }
        
        // Tentukan daftar semester ID
        let semesterList = [];
        if (jenjang === 'SD/MI') {
          if (jumlahSemester === 3) semesterList = [{ id: "K5_S1" }, { id: "K5_S2" }, { id: "K6_S1" }];
          else semesterList = [{ id: "K4_S1" }, { id: "K4_S2" }, { id: "K5_S1" }, { id: "K5_S2" }, { id: "K6_S1" }];
        } else if (jenjang === 'SMP/MTS') {
          semesterList = [{ id: "K7_S1" }, { id: "K7_S2" }, { id: "K8_S1" }, { id: "K8_S2" }, { id: "K9_S1" }];
        } else if (jenjang === 'SMA/MA') {
          semesterList = [{ id: "K10_S1" }, { id: "K10_S2" }, { id: "K11_S1" }, { id: "K11_S2" }, { id: "K12_S1" }];
        }
        
        // Hapus cache grid per semester
        semesterList.forEach(sem => {
            scriptCache.remove(NILAI_RAPOR_GRID_CACHE_KEY_PREFIX + sem.id + "_" + sekolahID);
        });
    }
    
  } catch (e) {
    Logger.log("Gagal clearNilaiRaporCache: " + e.message);
  }
}

// Salin dan ganti fungsi clearSiswaCache() Anda dengan yang ini
function clearSiswaCache(sekolahID, spreadsheetID) { // <--- Terima spreadsheetID
  try {
    const cacheKey = SISWA_CACHE_KEY + "_" + sekolahID;
    CacheService.getScriptCache().remove(cacheKey);
    
    // --- PERBAIKAN: AKTIFKAN (UN-COMMENT) DUA BARIS DI BAWAH INI ---
    clearNilaiUjianCache(sekolahID, spreadsheetID);
    clearNilaiRaporCache(sekolahID, spreadsheetID);
    // --- AKHIR PERBAIKAN ---

    clearLockedKelasCache(sekolahID); // Ini tidak perlu spreadsheetID

  } catch (e) {
     Logger.log("Gagal clearSiswaCache: " + e.message);
  }
}

// Salin dan ganti fungsi clearMapelCache() Anda dengan yang ini
function clearMapelCache(sekolahID, spreadsheetID) { // <--- TAMBAHKAN spreadsheetID
  try {
    const cacheKey = MAPEL_CACHE_KEY + "_" + sekolahID;
    
    // --- PERBAIKAN: Hapus baris lama yang salah ---
    // CacheService.getScriptCache().remove(cacheKey);
    // --- AKHIR PERBAIKAN ---
    
    // --- TAMBAHAN: Ganti dengan baris di bawah ini ---
    const scriptCache = CacheService.getScriptCache();
    scriptCache.remove(cacheKey);
    
    // Data mapel mempengaruhi SEMUA cache nilai.
    clearNilaiUjianCache(sekolahID, spreadsheetID);
    clearNilaiRaporCache(sekolahID, spreadsheetID);
    // --- AKHIR TAMBAHAN ---

  } catch (e) {
     Logger.log("Gagal clearMapelCache: " + e.message);
  }
}

function prosesLogin(email, password) {
  try {
    const appUrl = ScriptApp.getService().getUrl();
    const masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
    
    const sheetSuperadmin = getSheetSuperadmin(masterSS);
    const superadminEmailFinder = sheetSuperadmin.getRange("A2:A").createTextFinder(email).matchEntireCell(true).findAll();
    
    if (superadminEmailFinder.length > 0) {
      const rowNum = superadminEmailFinder[0].getRow();
      const rowData = sheetSuperadmin.getRange(rowNum, 1, 1, sheetSuperadmin.getLastColumn()).getValues()[0];
      if (verifyPassword(password, rowData[2], rowData[3])) {
        const token = Utilities.getUuid();
        const sessionData = {
          role: 'superadmin',
          nama: rowData[1],
          lastActivity: new Date().getTime()
        };
        CacheService.getScriptCache().put('SESSION_' + token, JSON.stringify(sessionData), 21600);
        return {
          status: "sukses",
          role: "superadmin",
          nama: rowData[1],
          token: token,
          appUrl: appUrl
        };
      }
    }
    
    const sheetSekolah = masterSS.getSheetByName('Sheet_Sekolah');
    const adminEmailFinder = sheetSekolah.getRange("D2:D").createTextFinder(email).matchEntireCell(true).findAll();
    
    let cachedRow = null;
    let passwordIsValid = false;

    if (adminEmailFinder.length > 0) {
      const rowNum = adminEmailFinder[0].getRow();
      const rowData = sheetSekolah.getRange(rowNum, 1, 1, sheetSekolah.getLastColumn()).getValues()[0];
      
      if (rowData[6]) {
        passwordIsValid = verifyPassword(password, rowData[4], rowData[6]);
      } else {
        passwordIsValid = (rowData[4] === password);
      }
      if (passwordIsValid) {
        cachedRow = rowData;
      }
    }

    if (!passwordIsValid || !cachedRow) {
      return { status: "gagal", message: "Email atau password salah." };
    }
    
    const token = Utilities.getUuid();
    const namaSekolahUpper = cachedRow[1].toUpperCase();
    const userSpreadsheetID = cachedRow[5];
    const jenjangPilihan = getJenjangPilihanFromSheet(userSpreadsheetID);

    // --- TAMBAHKAN BARIS INI ---
    const donasiStatus = cachedRow[8] || "NONE"; // Kolom I adalah DonasiStatus
    // --- AKHIR TAMBAHAN ---

    const sessionData = {
      role: 'admin',
      sekolahID: cachedRow[0],
      namaSekolah: namaSekolahUpper,
      jenjang: cachedRow[2],
      spreadsheetID: userSpreadsheetID,
      jenjangPilihan: jenjangPilihan,
      donasiStatus: donasiStatus,
      lastActivity: new Date().getTime()
    };
    CacheService.getScriptCache().put('SESSION_' + token, JSON.stringify(sessionData), 21600);
    return {
      status: "sukses",
      role: "admin",
      namaSekolah: namaSekolahUpper,
      jenjang: cachedRow[2],
      jenjangPilihan: jenjangPilihan,
      donasiStatus: donasiStatus,
      token: token,
      appUrl: appUrl
    };
  } catch (e) {
    return { status: "gagal", message: "Terjadi error: " + e.message };
  }
}

function prosesRegistrasi(namaSekolah, npsn, jenjang, email, password) {
  const lock = LockService.getScriptLock();
  lock.waitLock(15000);

  try {
    if (!namaSekolah || !npsn || !jenjang || !email || !password) {
      return { status: "gagal", message: "Semua data wajib diisi." };
    }
    if (!/^\d+$/.test(npsn)) {
      return { status: "gagal", message: "NPSN harus berupa angka." };
    }

    if (password.length < 8) {
      return { status: "gagal", message: "Password minimal harus 8 karakter." };
    }
    if (!/[a-z]/.test(password)) {
      return { status: "gagal", message: "Password harus mengandung minimal satu huruf kecil." };
    }
    if (!/[A-Z]/.test(password)) {
      return { status: "gagal", message: "Password harus mengandung minimal satu huruf besar." };
    }
    if (!/\d/.test(password)) {
      return { status: "gagal", message: "Password harus mengandung minimal satu angka." };
    }
    if (!/[^a-zA-Z0-9]/.test(password)) {
      return { status: "gagal", message: "Password harus mengandung minimal satu simbol (contoh: @, #, $, !)." };
    }

    const masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
    let sheetSekolah = masterSS.getSheetByName('Sheet_Sekolah');
    
    if (sheetSekolah) {
       const dataSekolah = sheetSekolah.getDataRange().getValues();
       for (let i = 1; i < dataSekolah.length; i++) {
         if (dataSekolah[i][3] === email) {
           return { status: "gagal", message: "Email ini sudah terdaftar dan aktif." };
         }
         if (dataSekolah[i][7] && dataSekolah[i][7] == npsn) { 
           return { status: "gagal", message: "NPSN ini sudah terdaftar oleh sekolah lain." };
         }
       }
    } else {
       sheetSekolah = masterSS.insertSheet('Sheet_Sekolah');
       sheetSekolah.appendRow(['SekolahID', 'NamaSekolah', 'Jenjang', 'EmailAdmin', 'HashedPassword', 'SpreadsheetID', 'Salt', 'NPSN']);
    }

    const sheetPending = getSheetRegistrasiPending(masterSS);
    const dataPending = sheetPending.getDataRange().getValues();
    const now = new Date();
    const expiryLimit = now.getTime() - (TOKEN_EXPIRY_HOURS * 60 * 60 * 1000);

    for (let i = dataPending.length - 1; i >= 1; i--) {
      const row = dataPending[i];
      const dbEmail = row[0];
      const dbNPSN = row[2];
      const dbTimestamp = new Date(row[7]).getTime();

      if (dbTimestamp < expiryLimit) {
        sheetPending.deleteRow(i + 1);
        continue;
      }
      
      if (dbNPSN === npsn) {
        return { status: "gagal", message: "NPSN ini sudah didaftarkan dan menunggu verifikasi." };
      }
      if (dbEmail === email) {
        kirimEmailVerifikasi(email, row[1], row[6]);
        return { 
          status: "pending", 
          message: "Email ini sudah terdaftar dan menunggu verifikasi. Kami telah mengirim ulang link verifikasi." 
        };
      }
    }

    const verificationToken = Utilities.getUuid() + Utilities.getUuid();
    const namaSekolahUpper = namaSekolah.toUpperCase();
    const newSalt = generateSalt();
    const newHash = hashPassword(password, newSalt);

    sheetPending.appendRow([
      email,
      namaSekolahUpper,
      npsn,
      jenjang,
      newHash, 
      newSalt, 
      verificationToken,
      now 
    ]);
    
    kirimEmailVerifikasi(email, namaSekolahUpper, verificationToken);

    return { 
      status: "pending", 
      message: "Registrasi awal berhasil! Kami telah mengirimkan link verifikasi ke email Anda. Silakan cek inbox (atau folder spam)." 
    };
    
  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: "Terjadi error di server: " + e.message };
  } finally {
    lock.releaseLock();
  }
}

function prosesLogout(token) {
  try {
    if (token) {
       CacheService.getScriptCache().remove('SESSION_' + token);
    }
    return { status: "sukses" };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function validateAndRefreshSession(token) {
  if (!token) {
    throw new Error("Sesi tidak ditemukan. Silakan login ulang.");
  }
  const cache = CacheService.getScriptCache();
  const sessionJson = cache.get('SESSION_' + token);
  if (!sessionJson) {
    throw new Error("Sesi kedaluwarsa atau tidak valid. Silakan login ulang.");
  }
  const sessionData = JSON.parse(sessionJson);
  const now = new Date().getTime();

  // --- TAMBAHKAN BLOK INI ---
  // Refresh status donasi dari DB jika admin
  if (sessionData.role === 'admin' && !sessionData.isImpersonating) {
    try {
      const masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
      const sheetSekolah = masterSS.getSheetByName('Sheet_Sekolah');
      const dataSekolah = sheetSekolah.getDataRange().getValues();
      for (let i = 1; i < dataSekolah.length; i++) {
        if (dataSekolah[i][0] === sessionData.sekolahID) {
          sessionData.donasiStatus = dataSekolah[i][8] || "NONE"; // Kolom I
          break;
        }
      }
    } catch (e) {
      Logger.log("Gagal refresh donasi status untuk " + sessionData.sekolahID + ": " + e.message);
    }
  }
  // --- AKHIR BLOK ---

  const threeHours = 3 * 60 * 60 * 1000;
  if (now - sessionData.lastActivity > threeHours) {
    cache.remove('SESSION_' + token);
    throw new Error("Sesi Anda telah berakhir (3 jam tidak aktif). Silakan login ulang.");
  }
  sessionData.lastActivity = now;
  cache.put('SESSION_' + token, JSON.stringify(sessionData), 21600);
  return sessionData;
}

function checkToken(tokenFromClient) {
  try {
    const sessionData = validateAndRefreshSession(tokenFromClient);
    const appUrl = ScriptApp.getService().getUrl(); // <-- TAMBAHKAN INI

    if (sessionData.role === 'superadmin') {
      return {
        status: "sukses",
        role: "superadmin",
        namaSekolah: sessionData.nama,
        appUrl: appUrl // <-- TAMBAHKAN INI
      };
    } else if (sessionData.role === 'admin') {
      return {
        status: "sukses",
        role: "admin",
        isImpersonating: sessionData.isImpersonating === true,
        namaSekolah: sessionData.namaSekolah,
        jenjang: sessionData.jenjang,
        jenjangPilihan: sessionData.jenjangPilihan,
        donasiStatus: sessionData.donasiStatus || "NONE",
        appUrl: appUrl // <-- TAMBAHKAN INI
      };
    } else if (sessionData.role === 'guru') {
      return {
        status: "sukses",
        role: "guru",
        namaSekolah: sessionData.namaSekolah,
        namaGuru: sessionData.namaGuru,
        jenjangPilihan: sessionData.jenjangPilihan,
        hasUjianPraktek: sessionData.hasUjianPraktek,
        hasUjianMadrasah: sessionData.hasUjianMadrasah,
        appUrl: appUrl // <-- TAMBAHKAN INI
      };
    } else {
      throw new Error("Sesi tidak valid (role tidak dikenal).");
    }
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function validateSuperadminSession(token) {
  const sessionData = validateAndRefreshSession(token);
  if (sessionData.role !== 'superadmin') {
    throw new Error("Akses ditolak. Anda harus login sebagai Superadmin.");
  }
  if (sessionData.isImpersonating) {
    throw new Error("Akses ditolak. Harap kembali ke Superadmin sebelum mengelola sekolah.");
  }
  return sessionData;
}

function getSekolahList(token) {
  try {
    validateSuperadminSession(token);
    const dataSekolah = getCachedMasterSheetData();
    dataSekolah.shift();
    const sekolahList = dataSekolah.map(row => {
      return {
        id: row[0],
        nama: row[1],
        jenjang: row[2],
        email: row[3],
        spreadsheetId: row[5],
        donasiStatus: row[8] || "NONE"
      };
    });
    return { status: "sukses", sekolah: sekolahList };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function superadminDeleteSekolah(token, sekolahID, spreadsheetID) {
  const lock = LockService.getScriptLock();
  lock.waitLock(15000);
  try {
    validateSuperadminSession(token);
    if (!sekolahID || !spreadsheetID) {
      throw new Error("ID Sekolah dan ID Spreadsheet diperlukan.");
    }
    const masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
    const sheetSekolah = masterSS.getSheetByName('Sheet_Sekolah');
    const data = sheetSekolah.getDataRange().getValues();
    let rowDeleted = false;
    for (let i = data.length - 1; i >= 1; i--) {
      if (data[i][0] === sekolahID) {
        sheetSekolah.deleteRow(i + 1);
        rowDeleted = true;
        break;
      }
    }
    if (!rowDeleted) {
      throw new Error("SekolahID tidak ditemukan di database master.");
    }
    try {
      DriveApp.getFileById(spreadsheetID).setTrashed(true);
    } catch (driveError) {
    }
    clearMasterSheetCache();
    return { status: "sukses", message: "Sekolah berhasil dihapus." };
  } catch (e) {
    return { status: "gagal", message: e.message };
  } finally {
    lock.releaseLock();
  }
}

/**
 * [SUPERADMIN] Membatalkan status premium sekolah yang sudah APPROVED.
 */
function superadminBatalkanPremium(token, sekolahID, alasan) {
  const lock = LockService.getScriptLock();
  lock.waitLock(15000);
  try {
    validateSuperadminSession(token);
    
    if (!sekolahID) throw new Error("SekolahID tidak ada.");
    if (!alasan) throw new Error("Alasan pembatalan wajib diisi.");

    const masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
    const sheetSekolah = masterSS.getSheetByName('Sheet_Sekolah');
    const dataSekolah = sheetSekolah.getDataRange().getValues();
    
    let rowToUpdate = -1;
    for (let i = 1; i < dataSekolah.length; i++) {
      if (dataSekolah[i][0] === sekolahID) {
        rowToUpdate = i + 1;
        break;
      }
    }
    
    if (rowToUpdate === -1) {
      throw new Error("Gagal menemukan data sekolah.");
    }
    
    // Ubah status jadi REJECTED dan catat alasannya
    sheetSekolah.getRange(rowToUpdate, 9).setValue("REJECTED"); // Kolom I (Status)
    sheetSekolah.getRange(rowToUpdate, 12).setValue(alasan); // Kolom L (Alasan)
    
    clearMasterSheetCache();
    
    // Hapus juga cache kelulusan jika ada, karena fitur dimatikan
    const scriptCache = CacheService.getScriptCache();
    scriptCache.remove(MASTER_NISN_INDEX_KEY);
    scriptCache.remove(HASIL_KELULUSAN_PREFIX + sekolahID);
    
    return { status: "sukses", message: "Status premium berhasil dibatalkan." };

  } catch (e) {
    return { status: "gagal", message: e.message };
  } finally {
    lock.releaseLock();
  }
}

function superadminSaveSekolah(token, data) {
  const lock = LockService.getScriptLock();
  lock.waitLock(15000);
  try {
    validateSuperadminSession(token);
    const { id, nama, jenjang, email, password } = data;
    if (!nama || !jenjang || !email) {
      throw new Error("Nama, Jenjang, dan Email wajib diisi.");
    }
    const masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
    const sheetSekolah = masterSS.getSheetByName('Sheet_Sekolah');
    const dataSekolah = sheetSekolah.getDataRange().getValues();
    const mode = id ? 'edit' : 'add';
    for (let i = 1; i < dataSekolah.length; i++) {
      if (dataSekolah[i][3] === email && dataSekolah[i][0] !== id) {
        throw new Error("Email ini sudah digunakan oleh sekolah lain.");
      }
    }
    if (mode === 'add') {
      if (!password) {
        throw new Error("Password wajib diisi untuk akun baru.");
      }
      
      // --- PERBAIKAN DI SINI ---
      // Menambahkan '' sebagai parameter 'npsn'
      const newSSID = buatDatabaseSekolahBaru(nama, jenjang, '', email, password, masterSS);
      // --- AKHIR PERBAIKAN ---

      const newSalt = generateSalt();
      const newHash = hashPassword(password, newSalt);
      const newSekolahID = "SKL-" + (sheetSekolah.getLastRow());
      sheetSekolah.appendRow([
        newSekolahID,
        nama.toUpperCase(),
        jenjang,
        email,
        newHash,
        newSSID,
        newSalt,
        "", // NPSN (kosongkan saja, bisa diisi admin sekolah nanti)
        "NONE", // DonasiStatus
        "",     // DonasiFileID
        "",     // DonasiDataJSON
        ""      // DonasiAlasanTolak
      ]);
    } else {
      let rowToUpdate = -1;
      for (let i = 1; i < dataSekolah.length; i++) {
        if (dataSekolah[i][0] === id) {
          rowToUpdate = i + 1;
          break;
        }
      }
      if (rowToUpdate === -1) {
        throw new Error("SekolahID tidak ditemukan untuk diedit.");
      }
      sheetSekolah.getRange(rowToUpdate, 2).setValue(nama.toUpperCase());
      sheetSekolah.getRange(rowToUpdate, 3).setValue(jenjang);
      sheetSekolah.getRange(rowToUpdate, 4).setValue(email);
      if (password) {
        const newSalt = generateSalt();
        const newHash = hashPassword(password, newSalt);
        sheetSekolah.getRange(rowToUpdate, 5).setValue(newHash);
        sheetSekolah.getRange(rowToUpdate, 7).setValue(newSalt);
      }
    }
    clearMasterSheetCache();
    return { status: "sukses", message: "Data sekolah berhasil disimpan." };
  } catch (e) {
    return { status: "gagal", message: e.message };
  } finally {
    lock.releaseLock();
  }
}

function superadminImpersonate(sekolahID, token) {
  try {
    const sessionData = validateSuperadminSession(token);
    const dataSekolahFromCache = getCachedMasterSheetData();
    let targetRow = null;
    for (let i = 1; i < dataSekolahFromCache.length; i++) {
      if (dataSekolahFromCache[i][0] === sekolahID) {
        targetRow = dataSekolahFromCache[i];
        break;
      }
    }
    if (!targetRow) {
      return { status: "gagal", message: "SekolahID tidak ditemukan." };
    }
    const spreadsheetID = targetRow[5];
    if (!spreadsheetID) {
      return { status: "gagal", message: "Sekolah ini tidak memiliki SpreadsheetID." };
    }
    const jenjangPilihan = getJenjangPilihanFromSheet(spreadsheetID);
    
    sessionData.originalRole = 'superadmin';
    sessionData.role = 'admin';
    sessionData.isImpersonating = true;
    sessionData.sekolahID = sekolahID;
    sessionData.namaSekolah = targetRow[1].toUpperCase();
    sessionData.jenjang = targetRow[2];
    sessionData.spreadsheetID = spreadsheetID;
    sessionData.jenjangPilihan = jenjangPilihan;

    const appUrl = ScriptApp.getService().getUrl();

    CacheService.getScriptCache().put('SESSION_' + token, JSON.stringify(sessionData), 21600);

    return {
      status: "sukses",
      role: "admin",
      isImpersonating: true,
      namaSekolah: sessionData.namaSekolah,
      jenjang: sessionData.jenjang,
      jenjangPilihan: jenjangPilihan,
      token: token,
      appUrl: appUrl
    };
  } catch (e) {
    return { status: "gagal", message: "Terjadi error: " + e.message };
  }
}

/**
 * [ADMIN] Memeriksa apakah data Ijazah 'dirty' dengan membandingkan
 * data saat ini dengan data yang terakhir disimpan di cache.
 */
/*
function getIjazahDirtyState() {
  try {
    const { spreadsheetID } = validateAdminSession();
    const ss = SpreadsheetApp.openById(spreadsheetID);

    // 1. Dapatkan Sheet Cache
    const sheetCache = ss.getSheetByName(SHEET_CACHE_IJAZAH);
    if (!sheetCache) {
      Logger.log("getIjazahDirtyState: Cache_Rekap_Ijazah tidak ditemukan. Menandai sebagai dirty.");
      return { status: "sukses", isDirty: true };
    }
    const metaValues = sheetCache.getRange(1, 1, 1, 5).getValues()[0];
    const headerValues = sheetCache.getRange(2, 1, 1, 7).getValues()[0];
    
    // 2. Periksa Integritas Cache
    if (metaValues[0] !== 'Meta' || headerValues[0] !== 'SiswaID' || !metaValues[1]) {
      Logger.log("getIjazahDirtyState: Cache rusak atau belum pernah dihitung. Menandai sebagai dirty.");
      return { status: "sukses", isDirty: true };
    }
    
    // 3. Bandingkan Pengaturan (Bobot, KKM, Semester)
    const cachedBobotRapor = metaValues[2];
    const cachedBobotUjian = metaValues[3];
    const cachedKKM = metaValues[4];
    
    const settingsResponse = getBobotData(); // Ini juga mengambil KKM
    const semesterResponse = getSemesterList(); // Ini mengambil Jml Semester
    
    const currentSettings = {
      bobotRapor: settingsResponse.bobotRapor,
      bobotUjian: settingsResponse.bobotUjian,
      kkm: settingsResponse.kkm,
      jmlSemester: semesterResponse.semesterList.length
    };
    
    // Ambil Jml Semester dari cache (ini belum kita simpan sebelumnya, jadi kita tambahkan)
    const cachedJmlSemester = sheetCache.getRange('H1').getValue(); // Simpan di H1
    
    if (cachedBobotRapor != currentSettings.bobotRapor ||
        cachedBobotUjian != currentSettings.bobotUjian ||
        cachedKKM != currentSettings.kkm ||
        (cachedJmlSemester && cachedJmlSemester != currentSettings.jmlSemester)) {
      Logger.log("getIjazahDirtyState: Pengaturan (Bobot/KKM/Semester) berbeda. Menandai sebagai dirty.");
      return { status: "sukses", isDirty: true };
    }

    // 4. Bandingkan Data Nilai
    // Baca cache
    const lastRow = sheetCache.getLastRow();
    const cachedDataMap = new Map();
    if (lastRow > 2) {
      const cachedValues = sheetCache.getRange(3, 1, lastRow - 2, 4).getValues(); // Hanya perlu SiswaID, MapelID, UjianAsli, RaporAsli
      cachedValues.forEach(row => {
        const key = `${row[0]}_${row[1]}`;
        cachedDataMap.set(key, { ujian: row[2], rapor: row[3] });
      });
    }

    // Hitung data saat ini
    const siswaData = getSiswa();
    const siswaList = siswaData.siswa.map(s => ({ id: s.id, nama: s.nama, nisn: s.nisn, kelas: s.kelas }));
    const mapelListFull = getMapelDataInternal(ss);
    const semesterIds = semesterResponse.semesterList.map(s => s.id);

    const { nilaiRekapMap: currentUjianMap } = getRekapUjianInternal(ss, siswaList, mapelListFull);
    const { nilaiRekapMap: currentRaporMap } = getRekapRaporInternal(ss, siswaList, mapelListFull, semesterIds);

    // Lakukan perbandingan
    // Cek jika ada siswa/mapel baru atau yg dihapus (perbedaan jumlah)
    const mapelListIjazah = mapelListFull.filter(m => m.isUS === true || m.isUP === true);
    if (cachedDataMap.size !== (siswaList.length * mapelListIjazah.length)) {
       Logger.log("getIjazahDirtyState: Jumlah siswa atau mapel berubah. Menandai sebagai dirty.");
       return { status: "sukses", isDirty: true };
    }

    for (const siswa of siswaList) {
      for (const mapel of mapelListIjazah) {
        const key = `${siswa.id}_${mapel.id}`;
        
        const currentNilaiUjian = currentUjianMap.get(key) || 0;
        const currentNilaiRapor = currentRaporMap.get(key) || 0;
        
        const cachedNilai = cachedDataMap.get(key);

        if (!cachedNilai || cachedNilai.ujian != currentNilaiUjian || cachedNilai.rapor != currentNilaiRapor) {
          Logger.log(`getIjazahDirtyState: Perbedaan nilai ditemukan untuk ${key}. Menandai sebagai dirty.`);
          return { status: "sukses", isDirty: true };
        }
      }
    }

    // 5. Jika semua lolos, data bersih
    Logger.log("getIjazahDirtyState: Tidak ada perbedaan ditemukan. Data bersih.");
    return { status: "sukses", isDirty: false };

  } catch (e) {
    Logger.log("Gagal getIjazahDirtyState: " + e.message);
    // Jika gagal membandingkan, anggap saja dirty demi keamanan
    return { status: "sukses", isDirty: true };
  }
}
*/

function superadminReturn(token) {
  try {
    const sessionData = validateAndRefreshSession(token);
    if (sessionData.originalRole !== 'superadmin') {
       throw new Error("Tidak dapat kembali. Sesi asal bukan Superadmin.");
    }

    const newSessionData = {
        role: 'superadmin',
        nama: sessionData.nama,
        lastActivity: new Date().getTime()
    };
    CacheService.getScriptCache().put('SESSION_' + token, JSON.stringify(newSessionData), 21600);

    return {
      status: "sukses",
      role: "superadmin",
      namaSekolah: newSessionData.nama
    };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function getDynamicDefaultMapel(jenjang, masterSpreadsheet) {
  try {
    const mapelSheet = masterSpreadsheet.getSheetByName('Data_Mapel_Default');
    if (!mapelSheet) {
      Logger.log("Peringatan: Sheet 'Data_Mapel_Default' tidak ditemukan di Master Sheet.");
      return []; 
    }
    
    const data = mapelSheet.getDataRange().getValues();
    data.shift(); 

    const defaultMapel = [];
    
    for (let i = 0; i < data.length; i++) {
      const row = data[i];
      const jenjangData = row[0]; 
      const mapelID = row[1];     
      const namaMapel = row[2];   
      
      const val_us = row[3]; 
      const val_up = row[4]; 

      let isUS_default = false;
      let isUP_default = false;

      if (val_us === true) {
        isUS_default = true;
      } else if (typeof val_us === 'string') {
        isUS_default = val_us.trim().toUpperCase() === 'TRUE';
      }

      if (val_up === true) {
        isUP_default = true;
      } else if (typeof val_up === 'string') {
        isUP_default = val_up.trim().toUpperCase() === 'TRUE';
      }
      
      if (jenjangData === jenjang || jenjangData === 'UMUM') {
        if (mapelID && namaMapel) { 
          defaultMapel.push([mapelID, namaMapel, isUS_default, isUP_default, i + 1]);
        }
      }
    }
    
    return defaultMapel;

  } catch (e) {
    Logger.log("Error saat mengambil mapel dinamis: " + e.message);
    return []; 
  }
}

function getMapelSheet(ss) {
  let userSpreadsheet = ss;
  if (!userSpreadsheet) {
    const { spreadsheetID } = validateAdminSession(); 
    if (!spreadsheetID) throw new Error("Spreadsheet ID Sesi tidak ditemukan.");
    userSpreadsheet = SpreadsheetApp.openById(spreadsheetID);
  }

  const sheetMapel = userSpreadsheet.getSheetByName('Mapel');
  if (!sheetMapel) throw new Error("Sheet 'Mapel' tidak ditemukan.");
  
  try {
    const header = sheetMapel.getRange('E1').getValue();
    if (header !== 'Urutan') {
      sheetMapel.getRange('E1').setValue('Urutan');
    }
  } catch (e) {
    Logger.log("Gagal mengecek/membuat header Urutan Mapel: " + e.message);
  }

  return sheetMapel;
}

// Salin dan GANTI fungsi getMapel() Anda dengan yang ini
function getMapel(token) {
  try {
    const { sessionData, spreadsheetID } = validateAdminOrGuruSession(token);
    const ss = SpreadsheetApp.openById(spreadsheetID);
    
    // Panggil helper internal baru
    const mapel = _getMapelInternal(ss, sessionData.sekolahID);
    
    return { status: "sukses", mapel: mapel };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function createMapel(token, mapelID, namaMapel) {
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    if (!mapelID || !namaMapel) return { status: "gagal", message: "Data tidak lengkap." };
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheetMapel = getMapelSheet(ss);
    const data = sheetMapel.getDataRange().getValues();
    let maxUrutan = 0;
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] && data[i][0].toUpperCase() === mapelID.toUpperCase()) {
        return { status: "gagal", message: "MapelID sudah ada." };
      }
      const urutanNum = Number(data[i][4] || 0);
      if (urutanNum > maxUrutan) maxUrutan = urutanNum;
    }
    const newUrutan = maxUrutan + 1;
    const defaultIsUS = false;
    const defaultIsUP = false;

    sheetMapel.appendRow([mapelID, namaMapel, defaultIsUS, defaultIsUP, newUrutan]);
    clearMapelCache(sessionData.sekolahID, spreadsheetID);

    // --- PERUBAHAN DI SINI ---
    // Buat objek data baru untuk dikirim kembali ke klien
    const newMapelObject = {
      id: mapelID,
      nama: namaMapel,
      isUS: defaultIsUS,
      isUP: defaultIsUP,
      urutan: newUrutan,
      originalUrutan: newUrutan,
      originalIsUS: defaultIsUS,
      originalIsUP: defaultIsUP
    };
    
    return { status: "sukses", newData: newMapelObject };
    // --- AKHIR PERUBAHAN ---

  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function updateMapel(token, mapelID, namaMapel) {
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    if (!mapelID || !namaMapel) return { status: "gagal", message: "Data tidak lengkap." };
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheetMapel = getMapelSheet(ss);
    const data = sheetMapel.getDataRange().getValues();
    
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] === mapelID) {
        
        sheetMapel.getRange(i + 1, 2).setValue(namaMapel); // Update nama
        clearMapelCache(sessionData.sekolahID, spreadsheetID);

        // --- PERUBAHAN DI SINI ---
        // Kirim kembali data lengkap dari baris yang diperbarui
        const updatedMapelObject = {
          id: data[i][0],
          nama: namaMapel, // Nama baru dari input
          isUS: data[i][2] || false,
          isUP: data[i][3] || false,
          urutan: Number(data[i][4] || i),
          originalUrutan: Number(data[i][4] || i),
          originalIsUS: data[i][2] || false,
          originalIsUP: data[i][3] || false
        };

        return { status: "sukses", newData: updatedMapelObject };
        // --- AKHIR PERUBAHAN ---
      }
    }
    return { status: "gagal", message: "MapelID tidak ditemukan." };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function deleteMapel(token, mapelID) {
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheetMapel = getMapelSheet(ss);
    const data = sheetMapel.getDataRange().getValues();
    for (let i = data.length - 1; i >= 1; i--) {
      if (data[i][0] === mapelID) {
        sheetMapel.deleteRow(i + 1);
        clearMapelCache(sessionData.sekolahID, spreadsheetID);
        return { status: "sukses" };
      }
    }
    return { status: "gagal", message: "MapelID tidak ditemukan." };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function syncDefaultMapel(token) {
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    const jenjang = sessionData.jenjang;
    const masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
    const sourceData = getDynamicDefaultMapel(jenjang, masterSS);
    const sourceMap = new Map();
    sourceData.forEach(row => {
      sourceMap.set(row[0], { name: row[1], isUS: row[2], isUP: row[3], urutan: row[4] });
    });
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheetMapel = getMapelSheet(ss);
    const targetRange = sheetMapel.getDataRange();
    const targetValues = targetRange.getValues();
    targetValues.shift();
    const targetIdMap = new Map(targetValues.map(row => [row[0], true]));
    let maxUrutan = 0;
    targetValues.forEach(row => {
      const urutanNum = Number(row[4] || 0);
      if (urutanNum > maxUrutan) maxUrutan = urutanNum;
    });
    const mapelToAdd = [];
    let changesMade = false;
    for (let i = 0; i < targetValues.length; i++) {
      const targetId = targetValues[i][0];
      const sourceRowData = sourceMap.get(targetId);
      if (sourceRowData) {
        if (targetValues[i][2] != sourceRowData.isUS || targetValues[i][3] != sourceRowData.isUP) {
          targetValues[i][2] = sourceRowData.isUS;
          targetValues[i][3] = sourceRowData.isUP;
          changesMade = true;
        }
      }
    }
    for (const [sourceId, sourceData] of sourceMap.entries()) {
      if (!targetIdMap.has(sourceId)) {
        maxUrutan++;
        mapelToAdd.push([sourceId, sourceData.name, sourceData.isUS, sourceData.isUP, maxUrutan]);
      }
    }
    if (changesMade) {
      sheetMapel.getRange(2, 1, targetValues.length, targetValues[0].length).setValues(targetValues);
    }
    if (mapelToAdd.length > 0) {
      sheetMapel.getRange(sheetMapel.getLastRow() + 1, 1, mapelToAdd.length, 5).setValues(mapelToAdd);
    }
    clearMapelCache(sessionData.sekolahID, spreadsheetID);
    return { status: "sukses" };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function deleteAllMapel(token) {
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheetMapel = getMapelSheet(ss);
    const lastRow = sheetMapel.getLastRow();
    if (lastRow > 1) {
      sheetMapel.deleteRows(2, lastRow - 1);
    }
    clearMapelCache(sessionData.sekolahID, spreadsheetID);
    return { status: "sukses", message: "Semua mapel telah dihapus." };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function saveMapelTipeUjianBatch(token, tipeUjianData) {
  let spreadsheetID, sessionData;
  try {
    const session = validateAdminSession(token);
    spreadsheetID = session.spreadsheetID;
    sessionData = session.sessionData;
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
  const lock = LockService.getDocumentLock();
  lock.waitLock(15000);
  try {
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheetMapel = getMapelSheet(ss);
    const dataRange = sheetMapel.getDataRange();
    const data = dataRange.getValues();
    const dataMap = new Map(tipeUjianData.map(item => [item.id, item]));
    let changesMade = false;

    const valuesToUpdate = [];

    for (let i = 1; i < data.length; i++) {
      const id = data[i][0];
      const newData = dataMap.get(id);
      
      let currentIsUS = data[i][2];
      let currentIsUP = data[i][3];

      if (newData) {
        if (currentIsUS != newData.isUS || currentIsUP != newData.isUP) {
          currentIsUS = newData.isUS;
          currentIsUP = newData.isUP;
          changesMade = true;
        }
      }
      valuesToUpdate.push([currentIsUS, currentIsUP]);
    }
    
    if (changesMade) {
      if (valuesToUpdate.length > 0) {
        sheetMapel.getRange(2, 3, valuesToUpdate.length, 2).setValues(valuesToUpdate);
      }
      clearMapelCache(sessionData.sekolahID, spreadsheetID);
    }
    return { status: "sukses" };
  } catch (e) {
    return { status: "gagal", message: e.message };
  } finally {
    lock.releaseLock();
  }
}

function saveMapelUrutanBatch(token, urutanData) {
  let spreadsheetID, sessionData;
  try {
    const session = validateAdminSession(token);
    spreadsheetID = session.spreadsheetID;
    sessionData = session.sessionData;
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
  const lock = LockService.getDocumentLock();
  lock.waitLock(15000);
  try {
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getMapelSheet(ss);
    const dataRange = sheet.getDataRange();
    const data = dataRange.getValues();
    const urutanMap = new Map(urutanData.map(item => [item.id, item.urutan]));
    let changesMade = false;
    for (let i = 1; i < data.length; i++) {
      const id = data[i][0];
      const newUrutan = urutanMap.get(id);
      if (newUrutan !== undefined && data[i][4] != newUrutan) {
        data[i][4] = newUrutan;
        changesMade = true;
      }
    }
    if (changesMade) {
      const valuesToUpdate = data.slice(1).map(row => [row[4]]);
      if (valuesToUpdate.length > 0) {
        sheet.getRange(2, 5, valuesToUpdate.length, 1).setValues(valuesToUpdate);
      }
      clearMapelCache(sessionData.sekolahID, spreadsheetID);
    }
    return { status: "sukses" };
  } catch (e) {
    return { status: "gagal", message: e.message };
  } finally {
    lock.releaseLock();
  }
}

function getSiswaSheet(ss) {
  let userSpreadsheet = ss;
  if (!userSpreadsheet) {
    const { spreadsheetID } = validateAdminSession();
    if (!spreadsheetID) throw new Error("Spreadsheet ID Sesi tidak ditemukan.");
    userSpreadsheet = SpreadsheetApp.openById(spreadsheetID);
  }

  let sheet = userSpreadsheet.getSheetByName('Siswa');
  if (!sheet) {
    sheet = userSpreadsheet.insertSheet('Siswa');
    sheet.appendRow([
        'SiswaID', 'NamaSiswa', 'NISN', 'NIS_Lokal', 'JenisKelamin', 
        'TempatLahir', 'TglLahir', 'Kelas'
      ]);
    SpreadsheetApp.flush();
  }
  
  try {
    sheet.getRange('C:D').setNumberFormat('@');
  } catch (e) {
    Logger.log("Gagal set format teks untuk NISN/NIS: " + e.message);
  }
  
  try {
    const header = sheet.getRange('I1').getValue();
    if (header !== 'Urutan') {
      sheet.getRange('I1').setValue('Urutan');
    }
  } catch (e) {
    Logger.log("Gagal mengecek/membuat header Urutan: " + e.message);
  }

  return sheet;
}

// Salin dan GANTI fungsi getSiswa() Anda dengan yang ini
function getSiswa(token) {
  try {
    const { sessionData, spreadsheetID } = validateAdminOrGuruSession(token);
    const sekolahID = sessionData.sekolahID;
    
    // Panggil helper internal yang mengelola cache
    const siswaList = _getSiswaInternal(spreadsheetID, sekolahID);
    
    return { status: "sukses", siswa: siswaList };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function createSiswa(token, dataSiswa) {
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    if (!dataSiswa.nama || !dataSiswa.nisn || !dataSiswa.jk || !dataSiswa.kelas) {
      return { status: "gagal", message: "Data wajib diisi." };
    }
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getSiswaSheet(ss);
    const lastRow = sheet.getLastRow();
    const nisnSet = new Set();
    let maxIdNum = 0;
    let maxUrutan = 0;
    if (lastRow > 1) {
      const dataRange = sheet.getRange("A2:I" + lastRow).getValues();
      dataRange.forEach(row => {
        if (row[2]) nisnSet.add(String(row[2]));
        const idNum = parseInt((row[0] || 'SIS-0').split('-')[1] || 0);
        if (idNum > maxIdNum) maxIdNum = idNum;
        const urutanNum = Number(row[8] || 0);
        if (urutanNum > maxUrutan) maxUrutan = urutanNum;
      });
    }
    if (nisnSet.has(String(dataSiswa.nisn))) {
      return { status: "gagal", message: "NISN sudah terdaftar." };
    }
    const newIdNum = maxIdNum + 1;
    const newUrutan = maxUrutan + 1;
    const newSiswaID = "SIS-" + newIdNum;
    const formattedNisn = dataSiswa.nisn ? "'" + dataSiswa.nisn : null;
    const formattedNisLokal = dataSiswa.nisLokal ? "'" + dataSiswa.nisLokal : null;
    sheet.appendRow([
      newSiswaID, dataSiswa.nama, formattedNisn, formattedNisLokal,
      dataSiswa.jk, dataSiswa.tempatLahir, dataSiswa.tglLahir || null,
      dataSiswa.kelas, newUrutan
    ]);

    clearSiswaCache(sessionData.sekolahID, spreadsheetID);

    // --- PERUBAHAN DI SINI ---
    // Buat objek siswa baru untuk dikirim kembali ke klien
    const newSiswaObject = {
      id: newSiswaID,
      nama: dataSiswa.nama,
      nisn: dataSiswa.nisn, // Kirim nilai mentah
      nisLokal: dataSiswa.nisLokal || '',
      jk: dataSiswa.jk || '',
      tempatLahir: dataSiswa.tempatLahir || '',
      tglLahir: dataSiswa.tglLahir || '',
      kelas: dataSiswa.kelas || '',
      urutan: newUrutan,
      originalUrutan: newUrutan // Penting untuk logika 'dirty check'
    };

    return { status: "sukses", newData: newSiswaObject };
    // --- AKHIR PERUBAHAN ---

  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function updateSiswa(token, dataSiswa) {
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    if (!dataSiswa.id) return { status: "gagal", message: "ID Siswa hilang." };
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getSiswaSheet(ss);
    const data = sheet.getDataRange().getValues();
    let rowToUpdate = -1;
    for (let i = 1; i < data.length; i++) {
      if (data[i][2] == dataSiswa.nisn && data[i][0] != dataSiswa.id) {
        return { status: "gagal", message: "NISN sudah digunakan." };
      }
      if (data[i][0] == dataSiswa.id) rowToUpdate = i + 1;
    }
    if (rowToUpdate === -1) return { status: "gagal", message: "Siswa tidak ditemukan." };
    const formattedNisn = dataSiswa.nisn ? "'" + dataSiswa.nisn : null;
    const formattedNisLokal = dataSiswa.nisLokal ? "'" + dataSiswa.nisLokal : null;
    const updatedRow = [
      dataSiswa.id, dataSiswa.nama, formattedNisn, formattedNisLokal,
      dataSiswa.jk, dataSiswa.tempatLahir, dataSiswa.tglLahir || null, dataSiswa.kelas
    ];
    sheet.getRange(rowToUpdate, 1, 1, updatedRow.length).setValues([updatedRow]);
    
    clearSiswaCache(sessionData.sekolahID, spreadsheetID);

    // --- PERUBAHAN DI SINI ---
    // Ambil 'urutan' asli dari data yang dibaca (data adalah array 0-indexed, rowToUpdate 1-indexed)
    const urutanAsli = data[rowToUpdate - 1][8]; // Kolom I adalah index 8
    
    // Gabungkan dataSiswa dari klien dengan urutan dari server
    const updatedSiswaObject = { 
      ...dataSiswa, // Data dari form (id, nama, nisn, dll)
      urutan: urutanAsli, 
      originalUrutan: urutanAsli 
    };

    return { status: "sukses", newData: updatedSiswaObject };
    // --- AKHIR PERUBAHAN ---

  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function deleteSiswa(token, siswaID) {
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token); // <--- Ambil spreadsheetID
    if (!siswaID) return { status: "gagal", message: "SiswaID kosong." };
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getSiswaSheet(ss);
    const data = sheet.getDataRange().getValues();
    for (let i = data.length - 1; i >= 1; i--) {
      if (data[i][0] == siswaID) {
        sheet.deleteRow(i + 1);
        
        // --- PERBAIKAN DI SINI ---
        clearSiswaCache(sessionData.sekolahID, spreadsheetID);
        // --- AKHIR PERBAIKAN ---

        return { status: "sukses" };
      }
    }
    return { status: "gagal", message: "Siswa tidak ditemukan." };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function deleteAllSiswa(token) {
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token); // <--- Ambil spreadsheetID
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getSiswaSheet(ss);
    const lastRow = sheet.getLastRow();
    if (lastRow > 1) {
      sheet.deleteRows(2, lastRow - 1);
    }
    
    // --- PERBAIKAN DI SINI ---
    clearSiswaCache(sessionData.sekolahID, spreadsheetID);
    // --- AKHIR PERBAIKAN ---

    return { status: "sukses", message: "Semua data siswa dihapus." };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function getDataSekolahSheet(ss) {
  let userSpreadsheet = ss;
  if (!userSpreadsheet) {
    const { spreadsheetID } = validateAdminSession();
    if (!spreadsheetID) throw new Error("Spreadsheet ID Sesi tidak ditemukan.");
    userSpreadsheet = SpreadsheetApp.openById(spreadsheetID);
  }

  let sheet = userSpreadsheet.getSheetByName('Data_Sekolah');
  if (!sheet) {
    sheet = userSpreadsheet.insertSheet('Data_Sekolah');
    sheet.appendRow([
      'JenjangPilihan', 'NPSN', 'NSM', 'Alamat', 'Provinsi', 
      'KabKot', 'PilihanKabKot', 'Kecamatan', 'KelDes', 'PilihanKelDes', 
      'KodePos', 'Telepon', 'Email', 'Website', 'NamaKepsek', 'NIPKepsek'
    ]);
    sheet.appendRow([
      '', '', '', '', '', 
      '', 'Kabupaten', '', '', 'Kelurahan', 
      '', '', '', '', '', ''
    ]);
    sheet.getRange('A2:P2').setNumberFormat('@');
    SpreadsheetApp.flush(); 
  }
  return sheet;
}

function getJenjangPilihanFromSheet(spreadsheetID) {
  try {
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getDataSekolahSheet(ss); 
    const jenjangPilihan = sheet.getRange('A2').getValue(); 
    return String(jenjangPilihan);
  } catch (e) {
    Logger.log(`Gagal mengambil jenjangPilihan dari sheet ${spreadsheetID}: ${e.message}`);
    return ""; 
  }
}

function getSchoolData(token) {
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getDataSekolahSheet(ss);
    const data = sheet.getRange('A2:P2').getValues()[0];
    const dataSekolah = {
      jenjangBase: sessionData.jenjang,
      namaSekolah: sessionData.namaSekolah,
      jenjangPilihan: data[0],
      npsn: data[1],
      nsm: data[2],
      alamat: data[3],
      provinsi: data[4],
      kabKot: data[5],
      pilihanKabKot: data[6],
      kecamatan: data[7],
      kelDes: data[8],
      pilihanKelDes: data[9],
      kodePos: data[10],
      telepon: data[11],
      email: data[12],
      website: data[13],
      namaKepsek: data[14],
      nipKepsek: data[15]
    };
    return { status: "sukses", data: dataSekolah };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function saveSchoolData(token, data) {
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    sessionData.jenjangPilihan = data.jenjangPilihan;
    CacheService.getScriptCache().put('SESSION_' + token, JSON.stringify(sessionData), 21600);

    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getDataSekolahSheet(ss);
    const dataArray = [
      data.jenjangPilihan, data.npsn, data.nsm, data.alamat, data.provinsi,
      data.kabKot, data.pilihanKabKot, data.kecamatan, data.kelDes, data.pilihanKelDes,
      data.kodePos, data.telepon, data.email, data.website, data.namaKepsek, data.nipKepsek
    ];
    sheet.getRange('A2:P2').setValues([dataArray]);
    return { status: "sukses" };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function getPengaturanSheet(ss) {
  let userSpreadsheet = ss;
  if (!userSpreadsheet) {
    const { spreadsheetID } = validateAdminSession();
    if (!spreadsheetID) throw new Error("Spreadsheet ID Sesi tidak ditemukan.");
    userSpreadsheet = SpreadsheetApp.openById(spreadsheetID);
  }

  let sheet = userSpreadsheet.getSheetByName('Pengaturan');
  if (!sheet) {
    sheet = userSpreadsheet.insertSheet('Pengaturan');
    sheet.appendRow(['Setting', 'Value']);
    sheet.appendRow(['Bobot_Rapor', 60]); 
    sheet.appendRow(['Bobot_Ujian', 40]); 
    sheet.appendRow(['Jumlah_Semester', 5]);
    sheet.appendRow(['KKM', 76]); 
    SpreadsheetApp.flush();
  }
  
  try {
    const data = sheet.getRange('A1:A' + sheet.getLastRow()).getValues();
    let foundSemester = false;
    let foundKKM = false;
    for (let i = 0; i < data.length; i++) {
      if (data[i][0] === 'Jumlah_Semester') {
        foundSemester = true;
      }
      if (data[i][0] === 'KKM') {
        foundKKM = true;
      }
    }
    if (!foundSemester) {
      sheet.appendRow(['Jumlah_Semester', 5]);
    }
    if (!foundKKM) { 
      sheet.appendRow(['KKM', 76]); 
    }
  } catch (e) {
    Logger.log("Gagal mengecek/membuat setting: " + e.message);
  }
  
  return sheet;
}

function getBobotData(token) {
  try {
    const { spreadsheetID } = validateAdminSession(token);
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getPengaturanSheet(ss);
    const data = sheet.getRange('A1:B' + sheet.getLastRow()).getValues();
    let bobotRapor = 60;
    let bobotUjian = 40;
    let kkm = 76;
    for (let i = 0; i < data.length; i++) {
      if (data[i][0] === 'Bobot_Rapor') {
        bobotRapor = data[i][1];
      } else if (data[i][0] === 'Bobot_Ujian') {
        bobotUjian = data[i][1];
      } else if (data[i][0] === 'KKM') {
        kkm = data[i][1];
      }
    }
    return { status: "sukses", bobotUjian: bobotUjian, bobotRapor: bobotRapor, kkm: kkm };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function saveBobotData(token, bobotRapor, bobotUjian, kkm) {
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    if ((bobotRapor + bobotUjian) !== 100) {
      return { status: "gagal", message: "Total bobot harus 100." };
    }
    const kkmValue = parseInt(kkm, 10);
    if (isNaN(kkmValue) || kkmValue < 0 || kkmValue > 100) {
      return { status: "gagal", message: "KKM harus angka antara 0 dan 100." };
    }
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getPengaturanSheet(ss);
    const data = sheet.getRange('A1:B' + sheet.getLastRow()).getValues();
    let foundRapor = false;
    let foundUjian = false;
    let foundKKM = false;
    for (let i = 0; i < data.length; i++) {
      const rowIdx = i + 1;
      if (data[i][0] === 'Bobot_Rapor') {
        sheet.getRange('B' + rowIdx).setValue(bobotRapor);
        foundRapor = true;
      } else if (data[i][0] === 'Bobot_Ujian') {
        sheet.getRange('B' + rowIdx).setValue(bobotUjian);
        foundUjian = true;
      } else if (data[i][0] === 'KKM') {
        sheet.getRange('B' + rowIdx).setValue(kkmValue);
        foundKKM = true;
      }
    }
    if (!foundRapor) sheet.appendRow(['Bobot_Rapor', bobotRapor]);
    if (!foundUjian) sheet.appendRow(['Bobot_Ujian', bobotUjian]);
    if (!foundKKM) sheet.appendRow(['KKM', kkmValue]);

    clearRekapNilaiCache(sessionData.sekolahID);
    clearRekapNilaiRaporCache(sessionData.sekolahID);
    return { status: "sukses" };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function getKelasSheet(ss) {
  let userSpreadsheet = ss;
  if (!userSpreadsheet) {
    const { spreadsheetID } = validateAdminSession();
    if (!spreadsheetID) throw new Error("Spreadsheet ID Sesi tidak ditemukan.");
    userSpreadsheet = SpreadsheetApp.openById(spreadsheetID);
  }

  let sheet = userSpreadsheet.getSheetByName('Kelas');
  if (!sheet) {
    sheet = userSpreadsheet.insertSheet('Kelas');
    sheet.appendRow(['NamaKelas']);
    SpreadsheetApp.flush();
  }
  return sheet;
}

function getLockedKelasSet(ss, sekolahID) {
  try {
    const cacheKey = LOCKED_KELAS_CACHE_KEY + "_" + sekolahID;
    const scriptCache = CacheService.getScriptCache();
    const cachedData = scriptCache.get(cacheKey);
    if (cachedData != null) {
      return new Set(JSON.parse(cachedData));
    }

    const sheetSiswa = getSiswaSheet(ss);
    const sheetNilaiUjian = getNilaiUjianSheet(ss);
    const sheetNilaiRapor = getNilaiRaporSheet(ss);

    const siswaDataValues = (sheetSiswa.getLastRow() > 1) 
      ? sheetSiswa.getRange("A2:H" + sheetSiswa.getLastRow()).getValues() 
      : [];
      
    const siswaIdToKelasMap = new Map();
    for (const row of siswaDataValues) {
      if (row[0] && row[7]) siswaIdToKelasMap.set(row[0], row[7]);
    }

    const lockedSiswaIdSet = new Set();
    
    if (sheetNilaiUjian.getLastRow() > 1) {
      const nilaiUjianData = sheetNilaiUjian.getRange("A2:D" + sheetNilaiUjian.getLastRow()).getValues();
      for (const row of nilaiUjianData) {
        if (row[0] && ((row[2] != null && row[2] !== "") || (row[3] != null && row[3] !== ""))) {
          lockedSiswaIdSet.add(row[0]);
        }
      }
    }

    if (sheetNilaiRapor.getLastRow() > 1) {
      const nilaiRaporData = sheetNilaiRapor.getRange("A2:E" + sheetNilaiRapor.getLastRow()).getValues();
      for (const row of nilaiRaporData) {
        if (row[0] && ((row[3] != null && row[3] !== "") || (row[4] != null && row[4] !== ""))) {
          lockedSiswaIdSet.add(row[0]);
        }
      }
    }

    const lockedKelasSet = new Set();
    for (const siswaId of lockedSiswaIdSet) {
      if (siswaIdToKelasMap.has(siswaId)) {
        lockedKelasSet.add(siswaIdToKelasMap.get(siswaId).toUpperCase());
      }
    }
    
    scriptCache.put(cacheKey, JSON.stringify(Array.from(lockedKelasSet)), 3600);
    return lockedKelasSet;
  } catch (e) {
    return new Set();
  }
}

function getKelas(token) {
  try {
    const { sessionData, spreadsheetID } = validateAdminOrGuruSession(token);
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getKelasSheet(ss);
    const data = sheet.getDataRange().getValues();
    data.shift();
    const kelasListNama = data.map(row => row[0]).filter(nama => nama);
    const lockedKelasSet = getLockedKelasSet(ss, sessionData.sekolahID);
    const kelasListWithStatus = kelasListNama.map(nama => {
      return {
        nama: nama,
        isLocked: lockedKelasSet.has(nama.toUpperCase())
      };
    });
    return { status: "sukses", kelasList: kelasListWithStatus };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function saveKelas(token, kelasList) {
  let spreadsheetID, sessionData;
  try {
    const session = validateAdminSession(token);
    spreadsheetID = session.spreadsheetID; // <--- Ambil spreadsheetID
    sessionData = session.sessionData;
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
  const lock = LockService.getDocumentLock();
  lock.waitLock(15000);
  try {
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getKelasSheet(ss);
    const lockedKelasSet = getLockedKelasSet(ss, sessionData.sekolahID);
    const oldData = sheet.getDataRange().getValues();
    oldData.shift();
    const oldClassList = oldData.map(row => row[0]).filter(nama => nama);
    const newClassSet = new Set(kelasList.map(k => k.toUpperCase()));
    for (const oldClass of oldClassList) {
      if (lockedKelasSet.has(oldClass.toUpperCase())) {
        if (!newClassSet.has(oldClass.toUpperCase())) {
          return { status: "gagal", message: `Kelas '${oldClass}' tidak dapat dihapus karena sudah memiliki data nilai.` };
        }
      }
    }
    const lastRow = sheet.getLastRow();
    if (lastRow > 1) {
      sheet.deleteRows(2, lastRow - 1);
    }
    if (kelasList && kelasList.length > 0) {
      const dataToSave = kelasList.map(nama => [nama]);
      sheet.getRange(2, 1, dataToSave.length, 1).setValues(dataToSave);
    }
    
    // --- PERBAIKAN DI SINI ---
    clearSiswaCache(sessionData.sekolahID, spreadsheetID);
    // --- AKHIR PERBAIKAN ---
    
    clearLockedKelasCache(sessionData.sekolahID);
    return { status: "sukses" };
  } catch (e) {
    return { status: "gagal", message: e.message };
  } finally {
    lock.releaseLock();
  }
}

function getSiswaTemplateUrl(token) {
  try {
    validateAdminSession(token);
    const url = "https://docs.google.com/spreadsheets/d/" + TEMPLATE_SISWA_FILE_ID + "/export?format=xlsx";
    const oauthToken = ScriptApp.getOAuthToken();
    const response = UrlFetchApp.fetch(url, {
      headers: {
        'Authorization': 'Bearer ' + oauthToken
      }
    });
    const blob = response.getBlob().setName("template_import_siswa.xlsx");
    const base64Data = Utilities.base64Encode(blob.getBytes());
    return {
      status: "sukses",
      base64: base64Data,
      mimeType: MimeType.MICROSOFT_EXCEL,
      fileName: "template_import_siswa.xlsx"
    };
  } catch (e) {
    if (e.message.includes("Export_TRANSIENT") || e.message.includes("failed")) {
      return { status: "gagal", message: "Gagal mengekspor template. Pastikan file template dapat diakses." };
    }
    return { status: "gagal", message: "Gagal membuat template: " + e.message };
  }
}

function prosesImportExcelSiswa(token, fileData) {
  let tempExcelFileId = null;
  let tempConvertedSheetId = null;
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheetSiswa = getSiswaSheet(ss);
    const sheetKelas = getKelasSheet(ss);
    const { base64, mimeType, fileName } = fileData;
    const decodedData = Utilities.base64Decode(base64.split(',')[1]);
    const blob = Utilities.newBlob(decodedData, mimeType, fileName);
    const tempExcelFile = DriveApp.createFile(blob);
    tempExcelFileId = tempExcelFile.getId();
    const conversionResource = {
      title: `[TEMP] Konversi - ${fileName}`,
      mimeType: MimeType.GOOGLE_SHEETS
    };
    const convertedFile = Drive.Files.copy(conversionResource, tempExcelFileId, { convert: true });
    tempConvertedSheetId = convertedFile.id;
    const tempSheet = SpreadsheetApp.openById(tempConvertedSheetId);
    const dataSheet = tempSheet.getSheets()[0];
    const excelData = dataSheet.getDataRange().getValues();
    if (excelData.length <= 1) {
      throw new Error("File Excel kosong atau hanya berisi header.");
    }
    excelData.shift();
    const dataNisn = sheetSiswa.getRange('C2:C' + sheetSiswa.getLastRow()).getValues()
      .map(row => String(row[0]).trim())
      .filter(nisn => nisn);
    const existingNisnSet = new Set(dataNisn);
    const dataKelas = sheetKelas.getRange('A2:A' + sheetKelas.getLastRow()).getValues()
      .map(row => String(row[0]).trim())
      .filter(kelas => kelas);
    const existingKelasSet = new Set(dataKelas);
    const gagalList = [];
    const rowsToAppend = [];
    const existingData = sheetSiswa.getDataRange().getValues();
    let maxIdNum = 0;
    let maxUrutan = 0;
    for (let i = 1; i < existingData.length; i++) {
      const idNum = parseInt((existingData[i][0] || 'SIS-0').split('-')[1] || 0);
      if (idNum > maxIdNum) maxIdNum = idNum;
      const urutanNum = Number(existingData[i][8] || 0);
      if (urutanNum > maxUrutan) maxUrutan = urutanNum;
    }
    let nextIdNum = maxIdNum + 1;
    let nextUrutan = maxUrutan + 1;
    for (let i = 0; i < excelData.length; i++) {
      const row = excelData[i];
      const barisKe = i + 2;
      const nama = (row[0] ? String(row[0]) : '').trim();
      const nisn = (row[1] ? String(row[1]) : '').trim();
      const nisLokal = (row[2] ? String(row[2]) : '').trim();
      const jk = (row[3] ? String(row[3]) : '').trim().toUpperCase();
      const tempatLahir = (row[4] ? String(row[4]) : '').trim();
      let tglLahir = (row[5] ? row[5] : '');
      if (tglLahir instanceof Date) {
        tglLahir = Utilities.formatDate(tglLahir, Session.getScriptTimeZone(), "yyyy-MM-dd");
      } else {
        tglLahir = String(tglLahir).trim();
      }
      const kelas = (row[6] ? String(row[6]) : '').trim();
      if (!nama || !nisn || !jk || !kelas) {
        gagalList.push({ baris: barisKe, nama: nama, nisn: nisn, alasan: "Data wajib tidak lengkap." });
        continue;
      }
      if (existingNisnSet.has(nisn)) {
        gagalList.push({ baris: barisKe, nama: nama, nisn: nisn, alasan: "NISN sudah terdaftar." });
        continue;
      }
      if (jk !== 'L' && jk !== 'P') {
        gagalList.push({ baris: barisKe, nama: nama, nisn: nisn, alasan: "Jenis Kelamin harus 'L' atau 'P'." });
        continue;
      }
      if (!existingKelasSet.has(kelas)) {
        gagalList.push({ baris: barisKe, nama: nama, nisn: nisn, alasan: `Kelas '${kelas}' tidak ditemukan.` });
        continue;
      }
      const newSiswaID = "SIS-" + nextIdNum;
      const formattedNisn = nisn ? "'" + nisn : null;
      const formattedNisLokal = nisLokal ? "'" + nisLokal : null;
      const newRow = [
        newSiswaID, nama, formattedNisn, formattedNisLokal, jk,
        tempatLahir, (tglLahir || null), kelas, nextUrutan
      ];
      rowsToAppend.push(newRow);
      existingNisnSet.add(nisn);
      nextIdNum++;
      nextUrutan++;
    }
    if (rowsToAppend.length > 0) {
      sheetSiswa.getRange(sheetSiswa.getLastRow() + 1, 1, rowsToAppend.length, rowsToAppend[0].length)
        .setValues(rowsToAppend);
    }
    DriveApp.getFileById(tempExcelFileId).setTrashed(true);
    DriveApp.getFileById(tempConvertedSheetId).setTrashed(true);
    
    // --- PERBAIKAN DI SINI ---
    clearSiswaCache(sessionData.sekolahID, spreadsheetID);
    // --- AKHIR PERBAIKAN ---

    return {
      status: "sukses",
      totalDiProses: excelData.length,
      berhasilDiUpload: rowsToAppend.length,
      gagalDiUpload: gagalList.length,
      dataGagal: gagalList
    };
  } catch (e) {
    if (tempExcelFileId) { DriveApp.getFileById(tempExcelFileId).setTrashed(true); }
    if (tempConvertedSheetId) { DriveApp.getFileById(tempConvertedSheetId).setTrashed(true); }
    return { status: "gagal", message: "Terjadi error: " + e.message };
  }
}

function moveSiswaUrutan(token, siswaID, direction) {
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getSiswaSheet(ss);
    const data = sheet.getDataRange().getValues();
    let targetRowIndex = -1;
    let targetData = null;
    for (let i = 0; i < data.length; i++) {
      if (data[i][0] === siswaID) {
        targetRowIndex = i;
        targetData = {
          id: data[i][0],
          kelas: data[i][7],
          urutan: Number(data[i][8] || parseInt((data[i][0] || 'SIS-0').split('-')[1] || 0)),
          sheetRow: i + 1
        };
        break;
      }
    }
    if (!targetData) {
      throw new Error("SiswaID tidak ditemukan.");
    }
    const classmates = [];
    for (let i = 0; i < data.length; i++) {
      if (data[i][7] === targetData.kelas) {
        const idNum = parseInt((data[i][0] || 'SIS-0').split('-')[1] || 0);
        classmates.push({
          id: data[i][0],
          kelas: data[i][7],
          urutan: Number(data[i][8] || idNum),
          sheetRow: i + 1
        });
      }
    }
    classmates.sort((a, b) => a.urutan - b.urutan);
    let targetIndexInClass = classmates.findIndex(s => s.id === siswaID);
    let swapTarget = null;
    if (direction === 'up' && targetIndexInClass > 0) {
      swapTarget = classmates[targetIndexInClass - 1];
    } else if (direction === 'down' && targetIndexInClass < classmates.length - 1) {
      swapTarget = classmates[targetIndexInClass + 1];
    }
    if (swapTarget) {
      const targetUrutanVal = targetData.urutan;
      const swapUrutanVal = swapTarget.urutan;
      sheet.getRange(targetData.sheetRow, 9).setValue(swapUrutanVal);
      sheet.getRange(swapTarget.sheetRow, 9).setValue(targetUrutanVal);
      clearSiswaCache(sessionData.sekolahID);
      return { status: "sukses" };
    }
    return { status: "gagal", message: "Tidak bisa bergerak lebih jauh." };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function saveSiswaUrutanBatch(token, urutanData) {
  let spreadsheetID, sessionData;
  try {
    const session = validateAdminSession(token);
    spreadsheetID = session.spreadsheetID; // <--- Ambil spreadsheetID
    sessionData = session.sessionData;
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
  const lock = LockService.getDocumentLock();
  lock.waitLock(15000);
  try {
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getSiswaSheet(ss);
    const dataRange = sheet.getDataRange();
    const data = dataRange.getValues();
    const urutanMap = new Map(urutanData.map(item => [item.id, item.urutan]));
    let changesMade = false;
    for (let i = 1; i < data.length; i++) {
      const id = data[i][0];
      const newUrutan = urutanMap.get(id);
      if (newUrutan !== undefined && data[i][8] != newUrutan) {
        data[i][8] = newUrutan;
        changesMade = true;
      }
    }
    if (changesMade) {
      const valuesToUpdate = data.slice(1).map(row => [row[8]]);
      if (valuesToUpdate.length > 0) {
        sheet.getRange(2, 9, valuesToUpdate.length, 1).setValues(valuesToUpdate);
      }
      
      // --- PERBAIKAN DI SINI ---
      clearSiswaCache(sessionData.sekolahID, spreadsheetID);
      // --- AKHIR PERBAIKAN ---
    }
    return { status: "sukses" };
  } catch (e) {
    return { status: "gagal", message: e.message };
  } finally {
    lock.releaseLock();
  }
}

function getNilaiUjianSheet(ss) {
  let userSpreadsheet = ss;
  if (!userSpreadsheet) {
    const { spreadsheetID } = validateAdminSession();
    if (!spreadsheetID) throw new Error("Spreadsheet ID Sesi tidak ditemukan.");
    userSpreadsheet = SpreadsheetApp.openById(spreadsheetID);
  }

  let sheet = userSpreadsheet.getSheetByName('Nilai_Ujian');
  if (!sheet) {
    sheet = userSpreadsheet.insertSheet('Nilai_Ujian');
    sheet.appendRow(['SiswaID', 'MapelID', 'UjianMadrasah', 'UjianPraktek']);
    SpreadsheetApp.flush();
  }
  return sheet;
}

// Salin dan GANTI fungsi getNilaiUjianGridData() Anda dengan yang ini
function getNilaiUjianGridData(token, tipeUjian) {
  try {
    const sessionData = validateAndRefreshSession(token);
    const spreadsheetID = sessionData.spreadsheetID;
    const sekolahID = sessionData.sekolahID;
    const isGuru = (sessionData.role === 'guru');
    
    const assignedMapelSet = isGuru ? new Set(sessionData.assignedMapel) : null;
    const assignedKelasSet = isGuru ? new Set(sessionData.assignedKelas) : null;
    const mapelKelasData = isGuru ? sessionData.mapelKelasData : null;

    const scriptCache = CacheService.getScriptCache();
    const cacheKeySuffix = isGuru ? `_GURU_${sessionData.namaGuru.replace(/\s+/g, '')}` : '';
    const cacheKey = NILAI_GRID_CACHE_KEY_PREFIX + tipeUjian + "_" + sekolahID + cacheKeySuffix;
    
    const cachedData = scriptCache.get(cacheKey);
    if (cachedData != null) {
      const ss = SpreadsheetApp.openById(spreadsheetID); // Buka SS hanya untuk cek waktu
      let cekWaktu = { diizinkan: true, pesan: "" };
      if (isGuru) {
        cekWaktu = cekWaktuInputGuru(ss);
      }
      const parsedCache = JSON.parse(cachedData);
      parsedCache.data.isInputDiizinkan = cekWaktu.diizinkan;
      parsedCache.data.pesanInput = cekWaktu.pesan;
      parsedCache.data.mapelKelasData = mapelKelasData;
      return parsedCache;
    }

    const ss = SpreadsheetApp.openById(spreadsheetID);

    let cekWaktu = { diizinkan: true, pesan: "" };
    if (isGuru) {
      cekWaktu = cekWaktuInputGuru(ss);
    }

    // --- PERBAIKAN: GANTI BACA SHEET DENGAN HELPER CACHE ---
    // HAPUS: const sheetSiswa = getSiswaSheet(ss);
    // HAPUS: const dataSiswa = sheetSiswa.getDataRange().getValues();
    // HAPUS: dataSiswa.shift();
    // HAPUS: let siswaList = dataSiswa.map(row => ({...}));
    
    // GANTI DENGAN:
    let siswaList = _getSiswaInternal(spreadsheetID, sekolahID);
    // --- AKHIR PERBAIKAN ---

    if (isGuru) {
      siswaList = siswaList.filter(siswa => assignedKelasSet.has(siswa.kelas));
    }
    // Siswa sudah di-sort oleh _getSiswaInternal, tidak perlu sort ulang

    // --- PERBAIKAN: GANTI DENGAN HELPER CACHE MAPEL ---
    // HAPUS: let mapelListFull = getMapelDataInternal(ss, sekolahID);
    // GANTI DENGAN:
    let mapelListFull = _getMapelInternal(ss, sekolahID);
    // --- AKHIR PERBAIKAN ---
    
    if (isGuru) {
      mapelListFull = mapelListFull.filter(m => assignedMapelSet.has(m.id));
    }

    let filteredMapel = (tipeUjian === 'UM') ? mapelListFull.filter(m => m.isUS) : mapelListFull.filter(m => m.isUP);
    const mapelList = filteredMapel.map(m => ({ id: m.id, nama: m.nama }));

    const sheetNilai = getNilaiUjianSheet(ss);
    const dataNilai = sheetNilai.getDataRange().getValues();
    dataNilai.shift();
    const nilaiData = {};
    dataNilai.forEach(row => {
      const key = `${row[0]}_${row[1]}`;
      nilaiData[key] = (tipeUjian === 'UM') ? row[2] : row[3];
    });

    const response = { 
      status: "sukses", 
      data: { 
        siswaList, 
        mapelList, 
        nilaiData,
        isInputDiizinkan: cekWaktu.diizinkan,
        pesanInput: cekWaktu.pesan,
        mapelKelasData: mapelKelasData 
      } 
    };
    scriptCache.put(cacheKey, JSON.stringify(response), 600);
    return response;
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function saveNilaiUjianBatch(token, dataToSave) {
  try {
    const sessionData = validateAndRefreshSession(token);
    const spreadsheetID = sessionData.spreadsheetID;
    const isGuru = (sessionData.role === 'guru');

    // --- TAMBAHKAN BLOK INI ---
    const ss = SpreadsheetApp.openById(spreadsheetID); // Buka SS di awal
    if (isGuru) {
      const cekWaktu = cekWaktuInputGuru(ss);
      if (!cekWaktu.diizinkan) {
        // Jika tidak diizinkan, langsung kembalikan error
        return { status: "gagal", message: cekWaktu.pesan };
      }
    }
    // --- AKHIR TAMBAHAN ---

    if (isGuru) {
      const assignedSet = new Set(sessionData.assignedMapel);
      for (const item of dataToSave) {
        if (!assignedSet.has(item.mapelId)) {
          throw new Error(`Akses Ditolak: Anda tidak berhak menyimpan nilai untuk mapel ${item.mapelId}`);
        }
      }
    }

    const lock = LockService.getDocumentLock();
    lock.waitLock(15000);
    try {
      // const ss = SpreadsheetApp.openById(spreadsheetID); // <-- Baris ini dipindah ke atas
      const sheet = getNilaiUjianSheet(ss); // <-- Gunakan 'ss' dari atas
      const data = sheet.getDataRange().getValues();
      const dataMap = new Map();
      for (let i = 1; i < data.length; i++) {
        dataMap.set(`${data[i][0]}_${data[i][1]}`, {row: i + 1, um: data[i][2], up: data[i][3]});
      }
      const rowsToAppend = [];
      let tipeUjianDisimpan = null;
      
      dataToSave.forEach(item => {
        if (!tipeUjianDisimpan) tipeUjianDisimpan = item.tipeUjian;
        const key = `${item.siswaId}_${item.mapelId}`;
        let nilaiBaru = null;
        if (item.nilai !== "" && item.nilai != null) {
          let num = parseFloat(item.nilai);
          if (!isNaN(num) && num >= 0 && num <= 100) nilaiBaru = num;
        }
        
        const existing = dataMap.get(key);
        
        if (existing !== undefined) {
          const colIdx = (item.tipeUjian === 'UM') ? 3 : 4;
          const oldNilai = (item.tipeUjian === 'UM') ? existing.um : existing.up;
          
          if (oldNilai !== nilaiBaru) {
            sheet.getRange(existing.row, colIdx).setValue(nilaiBaru);
            if(item.tipeUjian === 'UM') existing.um = nilaiBaru;
            else existing.up = nilaiBaru;
          }
        } else {
          let newRow = [item.siswaId, item.mapelId, null, null];
          newRow[(item.tipeUjian === 'UM') ? 2 : 3] = nilaiBaru;
          rowsToAppend.push(newRow);
          dataMap.set(key, {
            row: data.length + rowsToAppend.length, 
            um: newRow[2], 
            up: newRow[3]
          });
        }
      });
      
      if (rowsToAppend.length > 0) {
        sheet.getRange(sheet.getLastRow() + 1, 1, rowsToAppend.length, 4).setValues(rowsToAppend);
      }
      
      const sekolahID = sessionData.sekolahID;
      
      // --- PERBAIKAN ---
      const scriptCache = CacheService.getScriptCache();
      // --- AKHIR PERBAIKAN ---

      if (tipeUjianDisimpan) {
         // --- PERBAIKAN ---
         scriptCache.remove(NILAI_GRID_CACHE_KEY_PREFIX + tipeUjianDisimpan + "_" + sekolahID);
         if (isGuru) {
             scriptCache.remove(NILAI_GRID_CACHE_KEY_PREFIX + tipeUjianDisimpan + "_" + sekolahID + `_GURU_${sessionData.namaGuru.replace(/\s+/g, '')}`);
         }
         // --- AKHIR PERBAIKAN ---
      } else {
         clearNilaiUjianCache(sekolahID);
      }

      if (!isGuru) {
        clearRekapNilaiCache(sekolahID);
      }
      clearLockedKelasCache(sekolahID);
      return { status: "sukses", message: "Nilai tersimpan." };
    } finally {
      lock.releaseLock();
    }
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function getNilaiTemplateData(token, kelasDipilih) {
  let tempSpreadsheetId = null;
  try {
    const { sessionData } = validateAdminOrGuruSession(token);
    const namaSekolah = sessionData.namaSekolah;
    const siswaResponse = getSiswa(token);
    if (siswaResponse.status !== 'sukses') throw new Error(siswaResponse.message);
    const siswaList = siswaResponse.siswa;
    const filteredSiswa = (kelasDipilih === 'semua') ? siswaList : siswaList.filter(s => s.kelas === kelasDipilih);
    if (filteredSiswa.length === 0) return { status: "gagal", message: `Tidak ada siswa di kelas '${kelasDipilih}'.` };
    const mapelResponse = getMapel(token);
    if (mapelResponse.status !== 'sukses') throw new Error(mapelResponse.message);
    
    let allMapel = mapelResponse.mapel;
    
    // --- TAMBAHAN FILTER UNTUK GURU ---
    if (sessionData.role === 'guru') {
      const assignedMapelSet = new Set(sessionData.assignedMapel);
      allMapel = allMapel.filter(m => assignedMapelSet.has(m.id));
    }
    // --- AKHIR TAMBAHAN ---
    
    const mapelUS = allMapel.filter(m => m.isUS === true);
    const mapelUP = allMapel.filter(m => m.isUP === true);
    const timestamp = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "yyyyMMdd_HHmmss");
    const tempFileName = `[TEMP] Template Nilai - ${namaSekolah} - ${timestamp}`;
    const ss = SpreadsheetApp.create(tempFileName);
    tempSpreadsheetId = ss.getId();
    const rule = SpreadsheetApp.newDataValidation().requireNumberBetween(0, 100).setAllowInvalid(true).build();
    const sheetUS = ss.getSheetByName('Sheet1');
    const jenjangPilihan = sessionData.jenjangPilihan;
    const namaSheetUS = (jenjangPilihan === 'MI' || jenjangPilihan === 'MTS' || jenjangPilihan === 'MA') ? 'Ujian Madrasah' : 'Ujian Sekolah';
    sheetUS.setName(namaSheetUS);
    sheetUS.getRange("B:B").setNumberFormat("@");
    if (mapelUS.length > 0) {
      const headersUS = ["Nama Siswa", "NISN", "Kelas", ...mapelUS.map(m => m.id)];
      sheetUS.getRange(1, 1, 1, headersUS.length).setValues([headersUS]);
      const dataSiswaRows = filteredSiswa.map(s => [s.nama, String(s.nisn), s.kelas]);
      sheetUS.getRange(2, 1, dataSiswaRows.length, 3).setValues(dataSiswaRows);
      sheetUS.getRange(2, 4, dataSiswaRows.length, mapelUS.length).setDataValidation(rule);
      sheetUS.autoResizeColumns(1, 3);
    } else {
      sheetUS.getRange('A1').setValue(`Tidak ada mapel untuk ${namaSheetUS}.`);
    }
    const sheetUP = ss.insertSheet('Ujian Praktek');
    sheetUP.getRange("B:B").setNumberFormat("@");
    if (mapelUP.length > 0) {
      const headersUP = ["Nama Siswa", "NISN", "Kelas", ...mapelUP.map(m => m.id)];
      sheetUP.getRange(1, 1, 1, headersUP.length).setValues([headersUP]);
      const dataSiswaRows = filteredSiswa.map(s => [s.nama, String(s.nisn), s.kelas]);
      sheetUP.getRange(2, 1, dataSiswaRows.length, 3).setValues(dataSiswaRows);
      sheetUP.getRange(2, 4, dataSiswaRows.length, mapelUP.length).setDataValidation(rule);
      sheetUP.autoResizeColumns(1, 3);
    } else {
      sheetUP.getRange('A1').setValue('Tidak ada mapel untuk Ujian Praktek.');
    }
    SpreadsheetApp.flush();
    const url = "https://docs.google.com/spreadsheets/d/" + tempSpreadsheetId + "/export?format=xlsx";
    const oauthToken = ScriptApp.getOAuthToken();
    const response = UrlFetchApp.fetch(url, { headers: { 'Authorization': 'Bearer ' + oauthToken } });
    const base64Data = Utilities.base64Encode(response.getBlob().getBytes());
    return { status: "sukses", base64: base64Data, mimeType: MimeType.MICROSOFT_EXCEL, fileName: "template_nilai_ujian.xlsx" };
  } catch (e) {
    return { status: "gagal", message: "Gagal membuat template: " + e.message };
  } finally {
    if (tempSpreadsheetId) DriveApp.getFileById(tempSpreadsheetId).setTrashed(true);
  }
}

function hitungNilaiRekap(nilaiUM, nilaiUP) {
  const um = (nilaiUM === null || nilaiUM === undefined || nilaiUM === "") ? null : parseFloat(nilaiUM);
  const up = (nilaiUP === null || nilaiUP === undefined || nilaiUP === "") ? null : parseFloat(nilaiUP);
  
  const umIsValid = (um !== null && !isNaN(um));
  const upIsValid = (up !== null && !isNaN(up));
  
  if (umIsValid && upIsValid) {
    return (um + up) / 2;
  } else if (umIsValid) {
    return um;
  } else if (upIsValid) {
    return up;
  } else {
    return null;
  }
}

// Salin dan GANTI fungsi getRekapitulasiNilaiData() Anda dengan yang ini
function getRekapitulasiNilaiData(token) {
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    const sekolahID = sessionData.sekolahID;
    
    const scriptCache = CacheService.getScriptCache();
    const cacheKey = REKAP_NILAI_CACHE_KEY + "_" + sekolahID;
    const cachedData = scriptCache.get(cacheKey);

    if (cachedData != null) {
      return JSON.parse(cachedData);
    }
    
    const ss = SpreadsheetApp.openById(spreadsheetID);

    // --- PERBAIKAN: GANTI BACA SHEET DENGAN HELPER CACHE ---
    // HAPUS: const siswaData = getSiswa(token);
    // HAPUS: if (siswaData.status !== 'sukses') throw new Error(siswaData.message);
    // HAPUS: const siswaList = siswaData.siswa.map(s => ({ id: s.id, nama: s.nama, nisn: s.nisn, kelas: s.kelas }));
    // GANTI DENGAN:
    const siswaList = _getSiswaInternal(spreadsheetID, sekolahID).map(s => ({ id: s.id, nama: s.nama, nisn: s.nisn, kelas: s.kelas }));
    
    // HAPUS: const mapelListFull = getMapelDataInternal(ss, sekolahID);
    // GANTI DENGAN:
    const mapelListFull = _getMapelInternal(ss, sekolahID);
    // --- AKHIR PERBAIKAN ---

    const { mapelList, nilaiRekapMap } = getRekapUjianInternal(ss, siswaList, mapelListFull);
    const nilaiRekapDataObj = {};
    nilaiRekapMap.forEach((value, key) => { nilaiRekapDataObj[key] = value; });
    const response = { status: "sukses", data: { siswaList, mapelList, nilaiRekapData: nilaiRekapDataObj } };
    
    scriptCache.put(cacheKey, JSON.stringify(response), 600);
    
    return response;
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

// Salin dan GANTI fungsi getRekapitulasiNilaiRaporData() Anda dengan yang ini
function getRekapitulasiNilaiRaporData(token) {
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    const sekolahID = sessionData.sekolahID;
    
    const scriptCache = CacheService.getScriptCache();
    const cacheKey = REKAP_NILAI_RAPOR_CACHE_KEY + "_" + sekolahID;
    const cachedData = scriptCache.get(cacheKey);

    if (cachedData != null) {
      return JSON.parse(cachedData);
    }
    
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const semesterListData = getSemesterList(token);
    if (semesterListData.status !== 'sukses') throw new Error(semesterListData.message);
    const semesterIds = semesterListData.semesterList.map(s => s.id);
    
    // --- PERBAIKAN: GANTI BACA SHEET DENGAN HELPER CACHE ---
    // HAPUS: const siswaData = getSiswa(token);
    // HAPUS: if (siswaData.status !== 'sukses') throw new Error(siswaData.message);
    // HAPUS: const siswaList = siswaData.siswa.map(s => ({ id: s.id, nama: s.nama, nisn: s.nisn, kelas: s.kelas }));
    // GANTI DENGAN:
    const siswaList = _getSiswaInternal(spreadsheetID, sekolahID).map(s => ({ id: s.id, nama: s.nama, nisn: s.nisn, kelas: s.kelas }));
    
    // HAPUS: const mapelListFull = getMapelDataInternal(ss, sekolahID);
    // GANTI DENGAN:
    const mapelListFull = _getMapelInternal(ss, sekolahID);
    // --- AKHIR PERBAIKAN ---
    
    const { mapelList, nilaiRekapMap } = getRekapRaporInternal(ss, siswaList, mapelListFull, semesterIds);
    const nilaiRekapDataObj = {};
    nilaiRekapMap.forEach((value, key) => { nilaiRekapDataObj[key] = value; });
    const response = {
      status: "sukses",
      data: { siswaList, mapelList, nilaiRekapData: nilaiRekapDataObj, jumlahSemester: semesterIds.length }
    };
    
    scriptCache.put(cacheKey, JSON.stringify(response), 600);

    return response;
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function getSemesterSetting(token) {
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getPengaturanSheet(ss);
    const data = sheet.getRange('A1:B' + sheet.getLastRow()).getValues();
    let jumlahSemester = 5;
    for (let i = 0; i < data.length; i++) {
      if (data[i][0] === 'Jumlah_Semester') {
        jumlahSemester = data[i][1];
        break;
      }
    }
    return { status: "sukses", jenjang: sessionData.jenjang, setting: jumlahSemester };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function saveSemesterSetting(token, jumlahSemester) {
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    const jenjang = sessionData.jenjang;
    const settingAngka = parseInt(jumlahSemester, 10);
    if (settingAngka !== 3 && settingAngka !== 5) return { status: "gagal", message: "Nilai semester tidak valid." };
    if (jenjang !== 'SD/MI' && settingAngka === 3) return { status: "gagal", message: "3 semester hanya untuk SD/MI." };
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getPengaturanSheet(ss);
    const data = sheet.getRange('A1:B' + sheet.getLastRow()).getValues();
    let found = false;
    for (let i = 0; i < data.length; i++) {
      if (data[i][0] === 'Jumlah_Semester') {
        sheet.getRange('B' + (i + 1)).setValue(settingAngka);
        found = true;
        break;
      }
    }
    if (!found) sheet.appendRow(['Jumlah_Semester', settingAngka]);
    clearNilaiRaporCache(sessionData.sekolahID);
    return { status: "sukses" };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function getNilaiRaporSheet(ss) {
  let userSpreadsheet = ss;
  if (!userSpreadsheet) {
    const { spreadsheetID } = validateAdminSession();
    if (!spreadsheetID) throw new Error("Spreadsheet ID Sesi tidak ditemukan.");
    userSpreadsheet = SpreadsheetApp.openById(spreadsheetID);
  }

  let sheet = userSpreadsheet.getSheetByName('Nilai_Rapor_Akhir');
  if (!sheet) {
    sheet = userSpreadsheet.insertSheet('Nilai_Rapor_Akhir');
    sheet.appendRow(['SiswaID', 'MapelID', 'SemesterID', 'Nilai_P', 'Nilai_K']);
    SpreadsheetApp.flush();
  } else {
    const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    const nilaiIndex = headers.indexOf('Nilai');
    const nilaiPIndex = headers.indexOf('Nilai_P');
    
    if (nilaiIndex !== -1 && nilaiPIndex === -1) {
      sheet.getRange(1, nilaiIndex + 1).setValue('Nilai_P');
      sheet.getRange(1, headers.length + 1).setValue('Nilai_K');
      Logger.log("Migrasi skema Nilai_Rapor_Akhir: Menambahkan Nilai_P dan Nilai_K.");
    } else if (nilaiPIndex === -1) {
       sheet.clear();
       sheet.appendRow(['SiswaID', 'MapelID', 'SemesterID', 'Nilai_P', 'Nilai_K']);
    }
  }
  return sheet;
}

function getSemesterList(token) {
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    const jenjang = sessionData.jenjang;
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheetSetting = getPengaturanSheet(ss);
    const data = sheetSetting.getRange('A1:B' + sheetSetting.getLastRow()).getValues();
    let jumlahSemester = 5;
    for (let i = 0; i < data.length; i++) {
      if (data[i][0] === 'Jumlah_Semester') {
        jumlahSemester = parseInt(data[i][1], 10) || 5;
        break;
      }
    }
    let semesterList = [];
    if (jenjang === 'SD/MI') {
      if (jumlahSemester === 3) {
        semesterList = [{ id: "K5_S1", nama: "Kelas 5 Ganjil", color: "#0d6efd" }, { id: "K5_S2", nama: "Kelas 5 Genap", color: "#0d6efd" }, { id: "K6_S1", nama: "Kelas 6 Ganjil", color: "#198754" }];
      } else {
        semesterList = [{ id: "K4_S1", nama: "Kelas 4 Ganjil", color: "#fd7e14" }, { id: "K4_S2", nama: "Kelas 4 Genap", color: "#fd7e14" }, { id: "K5_S1", nama: "Kelas 5 Ganjil", color: "#0d6efd" }, { id: "K5_S2", nama: "Kelas 5 Genap", color: "#0d6efd" }, { id: "K6_S1", nama: "Kelas 6 Ganjil", color: "#198754" }];
      }
    } else if (jenjang === 'SMP/MTS') {
      semesterList = [{ id: "K7_S1", nama: "Kelas 7 Ganjil", color: "#fd7e14" }, { id: "K7_S2", nama: "Kelas 7 Genap", color: "#fd7e14" }, { id: "K8_S1", nama: "Kelas 8 Ganjil", color: "#0d6efd" }, { id: "K8_S2", nama: "Kelas 8 Genap", color: "#0d6efd" }, { id: "K9_S1", nama: "Kelas 9 Ganjil", color: "#198754" }];
    } else if (jenjang === 'SMA/MA') {
      semesterList = [{ id: "K10_S1", nama: "Kelas 10 Ganjil", color: "#fd7e14" }, { id: "K10_S2", nama: "Kelas 10 Genap", color: "#fd7e14" }, { id: "K11_S1", nama: "Kelas 11 Ganjil", color: "#0d6efd" }, { id: "K11_S2", nama: "Kelas 11 Genap", color: "#0d6efd" }, { id: "K12_S1", nama: "Kelas 12 Ganjil", color: "#198754" }];
    }
    return { status: "sukses", semesterList: semesterList };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function getNilaiRaporGridData(token, semesterId) {
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    const sekolahID = sessionData.sekolahID;
    
    const scriptCache = CacheService.getScriptCache();
    const cacheKey = NILAI_RAPOR_GRID_CACHE_KEY_PREFIX + semesterId + "_" + sekolahID;
    const cachedData = scriptCache.get(cacheKey);

    if (cachedData != null) {
      return JSON.parse(cachedData);
    }
    const ss = SpreadsheetApp.openById(spreadsheetID);
    
    // --- PERBAIKAN DI SINI ---
    // Menggunakan helper cache _getSiswaInternal (ini sudah benar dari langkah sebelumnya)
    const siswaList = _getSiswaInternal(spreadsheetID, sekolahID).map(s => ({ 
      id: s.id, 
      nama: s.nama, 
      nisn: s.nisn, 
      kelas: s.kelas 
    }));
    
    // Menggunakan helper cache _getMapelInternal
    const mapelListFull = _getMapelInternal(ss, sekolahID); 
    // --- AKHIR PERBAIKAN ---

    const filteredMapelList = mapelListFull.filter(m => m.isUS === true || m.isUP === true);
    const mapelList = filteredMapelList.map(m => ({ id: m.id, nama: m.nama }));
    const sheetNilai = getNilaiRaporSheet(ss);
    const dataNilai = sheetNilai.getDataRange().getValues();
    dataNilai.shift();
    const nilaiMapP = new Map();
    const nilaiMapK = new Map();
    const nilaiMapRekap = new Map();
    dataNilai.forEach(row => {
      if (row[2] === semesterId) {
        const key = `${row[0]}_${row[1]}`;
        if (row[3] !== "" && row[3] != null) nilaiMapP.set(key, row[3]);
        if (row[4] !== "" && row[4] != null) nilaiMapK.set(key, row[4]);
        const p = (row[3] === "" || row[3] == null) ? null : parseFloat(row[3]);
        const k = (row[4] === "" || row[4] == null) ? null : parseFloat(row[4]);
        let rekapVal = null;
        if (p != null && !isNaN(p) && k != null && !isNaN(k)) rekapVal = (p + k) / 2;
        else if (p != null && !isNaN(p)) rekapVal = p;
        else if (k != null && !isNaN(k)) rekapVal = k;
        if (rekapVal !== null) nilaiMapRekap.set(key, Math.round(rekapVal));
      }
    });
    const nilaiDataP = {};
    const nilaiDataK = {};
    const nilaiDataRekap = {};
    siswaList.forEach(siswa => {
      mapelList.forEach(mapel => {
        const key = `${siswa.id}_${mapel.id}`;
        if (nilaiMapP.has(key)) nilaiDataP[key] = nilaiMapP.get(key);
        if (nilaiMapK.has(key)) nilaiDataK[key] = nilaiMapK.get(key);
        if (nilaiMapRekap.has(key)) nilaiDataRekap[key] = nilaiMapRekap.get(key);
      });
    });
    const semesterListData = getSemesterList(token);
    let namaSemester = semesterId;
    if (semesterListData.status === 'sukses') {
      const sem = semesterListData.semesterList.find(s => s.id === semesterId);
      if (sem) namaSemester = sem.nama;
    }
    const response = {
      status: "sukses",
      namaSemester: namaSemester,
      dataP: { siswaList, mapelList, nilaiData: nilaiDataP },
      dataK: { siswaList, mapelList, nilaiData: nilaiDataK },
      dataRekap: { siswaList, mapelList, nilaiRekapData: nilaiDataRekap }
    };
    
    scriptCache.put(cacheKey, JSON.stringify(response), 600);
    
    return response;
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function saveNilaiRaporBatch(token, dataToSave, tipeNilai) {
  let spreadsheetID, sessionData;
  try {
    const session = validateAdminSession(token);
    spreadsheetID = session.spreadsheetID;
    sessionData = session.sessionData;
    if (!tipeNilai || (tipeNilai !== 'P' && tipeNilai !== 'K')) return { status: "gagal", message: "Tipe nilai tidak valid." };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
  const lock = LockService.getDocumentLock();
  lock.waitLock(15000);
  try {
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getNilaiRaporSheet(ss);
    const data = sheet.getDataRange().getValues();
    const kolomIndex = (tipeNilai === 'P') ? 3 : 4;
    const kolomNomor = kolomIndex + 1;
    
    const dataMap = new Map();
    for (let i = 1; i < data.length; i++) {
      dataMap.set(`${data[i][0]}_${data[i][1]}_${data[i][2]}`, {row: i + 1, value: data[i][kolomIndex]});
    }

    const rowsToAppend = [];
    
    dataToSave.forEach(item => {
      if (!item.semesterId) return;
      const key = `${item.siswaId}_${item.mapelId}_${item.semesterId}`;
      let nilaiAngka = null;
      if (item.nilai !== "" && item.nilai != null) {
        let num = parseFloat(item.nilai);
        if (!isNaN(num) && Number.isInteger(num) && num >= 0 && num <= 100) nilaiAngka = num;
      }
      
      const existing = dataMap.get(key);
      
      if (existing !== undefined) {
        if (existing.value !== nilaiAngka) {
          sheet.getRange(existing.row, kolomNomor).setValue(nilaiAngka);
          existing.value = nilaiAngka;
        }
      } else {
        let newRow = [item.siswaId, item.mapelId, item.semesterId, null, null];
        newRow[kolomIndex] = nilaiAngka;
        rowsToAppend.push(newRow);
        dataMap.set(key, {
          row: data.length + rowsToAppend.length, 
          value: nilaiAngka
        });
      }
    });

    if (rowsToAppend.length > 0) {
      sheet.getRange(sheet.getLastRow() + 1, 1, rowsToAppend.length, 5).setValues(rowsToAppend);
    }

    const sekolahID = sessionData.sekolahID;
    
    // --- PERBAIKAN ---
    const scriptCache = CacheService.getScriptCache();
    // --- AKHIR PERBAIKAN ---
    
    new Set(dataToSave.map(i => i.semesterId)).forEach(semId => {
      if (semId) {
        // --- PERBAIKAN ---
        scriptCache.remove(NILAI_RAPOR_GRID_CACHE_KEY_PREFIX + semId + "_" + sekolahID);
        // --- AKHIR PERBAIKAN ---
      }
    });
    clearRekapNilaiRaporCache(sekolahID);
    clearLockedKelasCache(sekolahID);
    return { status: "sukses", message: "Nilai rapor tersimpan." };
  } catch (e) {
    return { status: "gagal", message: e.message };
  } finally {
    lock.releaseLock();
  }
}

/**
 * FUNGSI MIGRASI SATU KALI.
 * Jalankan ini secara manual dari editor Apps Script.
 * Ini akan mengubah semua password plain text di Sheet_Sekolah menjadi hash.
 */
function MIGRASI_PasswordLama() {
  Logger.log("Memulai migrasi password...");
  
  let masterSS;
  let sheetSekolah;
  
  try {
    masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
    sheetSekolah = masterSS.getSheetByName('Sheet_Sekolah');
    if (!sheetSekolah) {
      Logger.log("Sheet_Sekolah tidak ditemukan. Migrasi dibatalkan.");
      return;
    }
    
    const range = sheetSekolah.getDataRange();
    const values = range.getValues();
    let migratedCount = 0;
    
    // Mulai dari i = 1 untuk melewati header
    for (let i = 1; i < values.length; i++) {
      const plainPass = values[i][4]; // Kolom E
      const salt = values[i][6];      // Kolom G
      
      // Jika 'salt' KOSONG dan 'plainPass' ADA ISINYA, maka itu akun lama
      if (!salt && plainPass) {
        const newSalt = generateSalt();
        const newHash = hashPassword(plainPass, newSalt);
        
        // Update HashedPassword (Kolom E)
        sheetSekolah.getRange(i + 1, 5).setValue(newHash);
        // Update Salt (Kolom G)
        sheetSekolah.getRange(i + 1, 7).setValue(newSalt);
        
        migratedCount++;
        Logger.log(`Password untuk baris ${i+1} (Email: ${values[i][3]}) telah di-hash.`);
      }
    }
    
    if (migratedCount > 0) {
      // Bersihkan cache agar data baru dibaca
      clearMasterSheetCache();
      Logger.log(`Migrasi Selesai. ${migratedCount} password telah di-hash dan diamankan. Cache dibersihkan.`);
      SpreadsheetApp.flush();
      Browser.msgBox(`Migrasi Selesai. ${migratedCount} password telah di-hash dan diamankan.`);
    } else {
      Logger.log("Migrasi Selesai. Tidak ada password plain text yang ditemukan untuk dimigrasi.");
      Browser.msgBox("Migrasi Selesai. Tidak ada password lama yang ditemukan.");
    }
    
  } catch (e) {
    Logger.log("Gagal total saat migrasi: " + e.message);
    Browser.msgBox("Migrasi Gagal: " + e.message);
  }
}

function getNilaiRaporTemplateData(token, semesterId, kelasDipilih) {
  let tempSpreadsheetId = null;
  try {
    const { sessionData } = validateAdminSession(token);
    const namaSekolah = sessionData.namaSekolah;
    const siswaResponse = getSiswa(token);
    if (siswaResponse.status !== 'sukses') throw new Error(siswaResponse.message);
    const siswaList = siswaResponse.siswa;
    const filteredSiswa = (kelasDipilih === 'semua') ? siswaList : siswaList.filter(s => s.kelas === kelasDipilih);
    if (filteredSiswa.length === 0) return { status: "gagal", message: `Tidak ada siswa di kelas '${kelasDipilih}'.` };
    const mapelResponse = getMapel(token);
    if (mapelResponse.status !== 'sukses') throw new Error(mapelResponse.message);
    const mapelList = mapelResponse.mapel;
    if (mapelList.length === 0) return { status: "gagal", message: "Tidak ada mata pelajaran." };
    const timestamp = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "yyyyMMdd_HHmmss");
    const tempFileName = `[TEMP] Template Rapor - ${namaSekolah} - ${timestamp}`;
    const ss = SpreadsheetApp.create(tempFileName);
    tempSpreadsheetId = ss.getId();
    const rule = SpreadsheetApp.newDataValidation().requireNumberBetween(0, 100).setAllowInvalid(true).build();
    const mapelHeaders = mapelList.map(m => m.id);
    const headers = ["Nama Siswa", "NISN", "Kelas", ...mapelHeaders];
    const dataSiswaRows = filteredSiswa.map(s => [s.nama, String(s.nisn), s.kelas]);
    const sheetP = ss.getSheetByName('Sheet1');
    sheetP.setName("Pengetahuan");
    sheetP.getRange("B:B").setNumberFormat("@");
    sheetP.getRange(1, 1, 1, headers.length).setValues([headers]);
    sheetP.getRange(2, 1, dataSiswaRows.length, 3).setValues(dataSiswaRows);
    if (mapelHeaders.length > 0) sheetP.getRange(2, 4, dataSiswaRows.length, mapelHeaders.length).setDataValidation(rule);
    sheetP.autoResizeColumns(1, 3);
    const sheetK = ss.insertSheet('Keterampilan');
    sheetK.getRange("B:B").setNumberFormat("@");
    sheetK.getRange(1, 1, 1, headers.length).setValues([headers]);
    sheetK.getRange(2, 1, dataSiswaRows.length, 3).setValues(dataSiswaRows);
    if (mapelHeaders.length > 0) sheetK.getRange(2, 4, dataSiswaRows.length, mapelHeaders.length).setDataValidation(rule);
    sheetK.autoResizeColumns(1, 3);
    const metadataSheet = ss.insertSheet('Metadata');
    metadataSheet.appendRow(['SemesterID', semesterId]);
    metadataSheet.appendRow(['Kelas', kelasDipilih]);
    metadataSheet.hideSheet();
    SpreadsheetApp.flush();
    const url = "[https://docs.google.com/spreadsheets/d/](https://docs.google.com/spreadsheets/d/)" + tempSpreadsheetId + "/export?format=xlsx";
    const oauthToken = ScriptApp.getOAuthToken();
    const response = UrlFetchApp.fetch(url, { headers: { 'Authorization': 'Bearer ' + oauthToken } });
    const fileNameOutput = `template_rapor_${semesterId}_${kelasDipilih}.xlsx`;
    return { status: "sukses", base64: Utilities.base64Encode(response.getBlob().getBytes()), mimeType: MimeType.MICROSOFT_EXCEL, fileName: fileNameOutput };
  } catch (e) {
    return { status: "gagal", message: "Gagal membuat template: " + e.message };
  } finally {
    if (tempSpreadsheetId) DriveApp.getFileById(tempSpreadsheetId).setTrashed(true);
  }
}

function prosesUploadExcelNilai(token, fileData) {
  let tempExcelFileId = null;
  let tempConvertedSheetId = null;
  try {
    const { sessionData, spreadsheetID } = validateAdminOrGuruSession(token);
    const ss = SpreadsheetApp.openById(spreadsheetID);

    // --- TAMBAHAN KEAMANAN UNTUK GURU ---
    const isGuru = (sessionData.role === 'guru');
    const assignedMapelSet = isGuru ? new Set(sessionData.assignedMapel) : null;

    // --- TAMBAHKAN BLOK INI ---
    if (isGuru) {
      const cekWaktu = cekWaktuInputGuru(ss);
      if (!cekWaktu.diizinkan) {
        throw new Error(cekWaktu.pesan); // Hentikan proses upload
      }
    }
    // --- AKHIR TAMBAHAN ---

    const sheetSiswa = getSiswaSheet(ss);
    const dataSiswa = sheetSiswa.getDataRange().getValues();
    dataSiswa.shift();
    const nisnToSiswaIdMap = new Map(dataSiswa.map(row => [String(row[2]), row[0]]));
    const sheetMapel = getMapelSheet(ss);
    const dataMapel = sheetMapel.getDataRange().getValues();
    dataMapel.shift();
    const mapelIdSet = new Set(dataMapel.map(row => row[0]));

    const { base64, mimeType, fileName } = fileData;
    const decodedData = Utilities.base64Decode(base64.split(',')[1]);
    const blob = Utilities.newBlob(decodedData, mimeType, fileName);
    const tempExcelFile = DriveApp.createFile(blob);
    tempExcelFileId = tempExcelFile.getId();
    const conversionResource = { title: `[TEMP] Upload Nilai - ${fileName}`, mimeType: MimeType.GOOGLE_SHEETS };
    const convertedFile = Drive.Files.copy(conversionResource, tempExcelFileId, { convert: true });
    tempConvertedSheetId = convertedFile.id;
    const tempSheet = SpreadsheetApp.openById(tempConvertedSheetId);
    const gagalList = [];
    const dataToSave = [];
    let totalDitemukan = 0;
    const jenjangPilihan = sessionData.jenjangPilihan;
    const namaSheetUS = (jenjangPilihan === 'MI' || jenjangPilihan === 'MTS' || jenjangPilihan === 'MA') ? 'Ujian Madrasah' : 'Ujian Sekolah';
    const sheetsToProcess = [{ name: namaSheetUS, type: 'UM' }, { name: 'Ujian Praktek', type: 'Praktek' }];
    sheetsToProcess.forEach(sheetInfo => {
      const sheet = tempSheet.getSheetByName(sheetInfo.name);
      if (!sheet) {
        gagalList.push({ sheet: sheetInfo.name, baris: 'N/A', info: 'Sheet Tidak Ditemukan', alasan: 'Sheet tidak ada di file.' });
        return;
      }
      const data = sheet.getDataRange().getValues();
      if (data.length <= 1) return;
      const header = data.shift();
      const mapelHeaders = header.slice(3);
      data.forEach((row, rowIndex) => {
        const barisKe = rowIndex + 2;
        const namaSiswa = row[0];
        const nisn = String(row[1]).trim();
        const siswaId = nisnToSiswaIdMap.get(nisn);
        if (!siswaId) {
          gagalList.push({ sheet: sheetInfo.name, baris: barisKe, info: `Siswa: ${namaSiswa || nisn}`, alasan: "NISN tidak terdaftar." });
          return;
        }
        mapelHeaders.forEach((mapelId, mapelIndex) => {
          mapelId = String(mapelId).trim();
          const nilai = row[mapelIndex + 3];
          if (nilai === null || nilai === "") return;

          // --- TAMBAHAN PENGECEKAN GURU ---
          if (isGuru && !assignedMapelSet.has(mapelId)) {
            // Jika ini guru, dan mapel ini BUKAN mapel mereka,
            // lewati (jangan proses dan jangan laporkan error).
            return; // Ini sama dengan 'continue' di forEach
          }
          // --- AKHIR TAMBAHAN ---

          totalDitemukan++;
          const info = `Siswa: ${namaSiswa} (Mapel: ${mapelId})`;
          if (!mapelIdSet.has(mapelId)) {
            gagalList.push({ sheet: sheetInfo.name, baris: barisKe, info: info, alasan: `Kode Mapel '${mapelId}' tidak dikenal.` });
            return;
          }
          let num = parseFloat(nilai);
          if (isNaN(num) || !Number.isInteger(num) || num < 0 || num > 100) {
            gagalList.push({ sheet: sheetInfo.name, baris: barisKe, info: info, alasan: `Nilai '${nilai}' tidak valid (harus angka bulat 0-100).` });
            return;
          }
          dataToSave.push({ siswaId: siswaId, mapelId: mapelId, tipeUjian: sheetInfo.type, nilai: num });
        });
      });
    });
    if (dataToSave.length > 0) {
      const saveResult = saveNilaiUjianBatch(token, dataToSave);
      if (saveResult.status !== 'sukses') throw new Error(saveResult.message);
    }
    DriveApp.getFileById(tempExcelFileId).setTrashed(true);
    DriveApp.getFileById(tempConvertedSheetId).setTrashed(true);
    return { status: "sukses", totalDitemukan: totalDitemukan, berhasilDiUpload: dataToSave.length, gagalDiUpload: gagalList.length, dataGagal: gagalList };
  } catch (e) {
    if (tempExcelFileId) DriveApp.getFileById(tempExcelFileId).setTrashed(true);
    if (tempConvertedSheetId) DriveApp.getFileById(tempConvertedSheetId).setTrashed(true);
    return { status: "gagal", message: "Terjadi error: " + e.message };
  }
}

function prosesUploadExcelNilaiRapor(token, fileData, semesterIdFromModal) {
  let tempExcelFileId = null;
  let tempConvertedSheetId = null;
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const { base64, mimeType, fileName } = fileData;
    const decodedData = Utilities.base64Decode(base64.split(',')[1]);
    const blob = Utilities.newBlob(decodedData, mimeType, fileName);
    const tempExcelFile = DriveApp.createFile(blob);
    tempExcelFileId = tempExcelFile.getId();
    const conversionResource = { title: `[TEMP] Upload Rapor - ${fileName}`, mimeType: MimeType.GOOGLE_SHEETS };
    const convertedFile = Drive.Files.copy(conversionResource, tempExcelFileId, { convert: true });
    tempConvertedSheetId = convertedFile.id;
    const tempSheet = SpreadsheetApp.openById(tempConvertedSheetId);
    const metadataSheet = tempSheet.getSheetByName('Metadata');
    if (!metadataSheet) throw new Error("File template tidak valid. Sheet 'Metadata' hilang.");
    const templateSemesterId = metadataSheet.getRange('B1').getValue();
    const templateKelas = metadataSheet.getRange('B2').getValue();
    if (templateSemesterId !== semesterIdFromModal) throw new Error("Semester file tidak cocok dengan pilihan.");
    const sheetSiswa = getSiswaSheet(ss);
    const dataSiswa = sheetSiswa.getDataRange().getValues();
    dataSiswa.shift();
    const nisnToSiswaIdMap = new Map();
    dataSiswa.forEach(row => {
      if (templateKelas === 'semua' || row[7] === templateKelas) nisnToSiswaIdMap.set(String(row[2]), row[0]);
    });
    const sheetMapel = getMapelSheet(ss);
    const dataMapel = sheetMapel.getDataRange().getValues();
    dataMapel.shift();
    const mapelIdSet = new Set(dataMapel.map(row => row[0]));
    const gagalList = [];
    const dataToSaveP = [];
    const dataToSaveK = [];
    let totalDitemukan = 0;
    const sheetsToProcess = [{ name: "Pengetahuan", dataArray: dataToSaveP }, { name: 'Keterampilan', dataArray: dataToSaveK }];
    sheetsToProcess.forEach(sheetInfo => {
      const sheet = tempSheet.getSheetByName(sheetInfo.name);
      if (!sheet) {
        gagalList.push({ sheet: sheetInfo.name, baris: 'N/A', info: 'Sheet Tidak Ditemukan', alasan: 'Sheet tidak ada.' });
        return;
      }
      const data = sheet.getDataRange().getValues();
      if (data.length <= 1) return;
      const header = data.shift();
      const mapelHeaders = header.slice(3);
      data.forEach((row, rowIndex) => {
        const barisKe = rowIndex + 2;
        const namaSiswa = row[0];
        const nisn = String(row[1]).trim();
        const kelasSiswa = String(row[2]).trim();
        const siswaId = nisnToSiswaIdMap.get(nisn);
        if (templateKelas !== 'semua' && kelasSiswa !== templateKelas) {
          gagalList.push({ sheet: sheetInfo.name, baris: barisKe, info: `Siswa: ${namaSiswa}`, alasan: "Siswa salah kelas." });
          return;
        }
        if (!siswaId) {
          gagalList.push({ sheet: sheetInfo.name, baris: barisKe, info: `Siswa: ${namaSiswa || nisn}`, alasan: "NISN tidak terdaftar." });
          return;
        }
        mapelHeaders.forEach((mapelId, mapelIndex) => {
          mapelId = String(mapelId).trim();
          const nilai = row[mapelIndex + 3];
          if (nilai === null || nilai === "") return;
          totalDitemukan++;
          const info = `Siswa: ${namaSiswa} (Mapel: ${mapelId})`;
          if (!mapelIdSet.has(mapelId)) {
            gagalList.push({ sheet: sheetInfo.name, baris: barisKe, info: info, alasan: `Kode Mapel '${mapelId}' tidak dikenal.` });
            return;
          }
          let num = parseFloat(nilai);
          if (isNaN(num) || !Number.isInteger(num) || num < 0 || num > 100) {
            gagalList.push({ sheet: sheetInfo.name, baris: barisKe, info: info, alasan: `Nilai '${nilai}' tidak valid.` });
            return;
          }
          sheetInfo.dataArray.push({ siswaId, mapelId, semesterId: templateSemesterId, nilai: num });
        });
      });
    });
    let totalBerhasil = 0;
    if (dataToSaveP.length > 0) {
      const saveResultP = saveNilaiRaporBatch(token, dataToSaveP, 'P');
      if (saveResultP.status === 'sukses') totalBerhasil += dataToSaveP.length;
      else throw new Error("Gagal simpan Pengetahuan: " + saveResultP.message);
    }
    if (dataToSaveK.length > 0) {
      const saveResultK = saveNilaiRaporBatch(token, dataToSaveK, 'K');
      if (saveResultK.status === 'sukses') totalBerhasil += dataToSaveK.length;
      else throw new Error("Gagal simpan Keterampilan: " + saveResultK.message);
    }
    DriveApp.getFileById(tempExcelFileId).setTrashed(true);
    DriveApp.getFileById(tempConvertedSheetId).setTrashed(true);
    return { status: "sukses", totalDitemukan, berhasilDiUpload: totalBerhasil, gagalDiUpload: gagalList.length, dataGagal: gagalList };
  } catch (e) {
    if (tempExcelFileId) DriveApp.getFileById(tempExcelFileId).setTrashed(true);
    if (tempConvertedSheetId) DriveApp.getFileById(tempConvertedSheetId).setTrashed(true);
    return { status: "gagal", message: "Terjadi error: " + e.message };
  }
}

// HAPUS fungsi getMapelDataInternal() lama Anda
// dan TAMBAHKAN fungsi _getMapelInternal() ini
/**
 * [INTERNAL HELPER] Mengambil data mapel dari cache atau sheet.
 * (Sebelumnya bernama getMapelDataInternal)
 */
function _getMapelInternal(ss, sekolahID) {
  const cacheKey = MAPEL_CACHE_KEY + "_" + sekolahID;
  
  // --- PERBAIKAN ---
  const scriptCache = CacheService.getScriptCache();
  const cachedMapel = scriptCache.get(cacheKey);
  // --- AKHIR PERBAIKAN ---

  if (cachedMapel != null) {
    return JSON.parse(cachedMapel);
  }
  
  Logger.log("CACHE MISS: _getMapelInternal untuk " + sekolahID);
  const sheetMapel = getMapelSheet(ss);
  const data = sheetMapel.getDataRange().getValues();
  data.shift();
  const mapel = data.map((row, index) => ({
    id: row[0],
    nama: row[1],
    isUS: row[2] || false,
    isUP: row[3] || false,
    urutan: Number(row[4] || index + 1)
  })).filter(row => row.id).sort((a, b) => a.urutan - b.urutan);
  
  // --- PERBAIKAN ---
  scriptCache.put(cacheKey, JSON.stringify(mapel), 600);
  // --- AKHIR PERBAIKAN ---

  return mapel;
}

function getRekapUjianInternal(ss, siswaList, mapelListFull) {
  
    const filteredMapelList = mapelListFull.filter(m => m.isUS === true || m.isUP === true);
    const mapelFlags = new Map(filteredMapelList.map(m => [m.id, { isUS: m.isUS, isUP: m.isUP }]));
    
    const sheetNilai = getNilaiUjianSheet(ss);
    const dataNilai = sheetNilai.getDataRange().getValues();
    dataNilai.shift(); 
    
    const nilaiMap = new Map();
    dataNilai.forEach(row => {
      const siswaId = row[0];
      const mapelId = row[1];
      const nilaiUM = row[2];
      const nilaiUP = row[3];
      const key = `${siswaId}_${mapelId}`;
      nilaiMap.set(key, { um: nilaiUM, up: nilaiUP });
    });
    
    const nilaiRekapData = new Map();
    siswaList.forEach(siswa => {
      filteredMapelList.forEach(mapel => {
        const key = `${siswa.id}_${mapel.id}`;
        const storedNilai = nilaiMap.get(key);
        const flags = mapelFlags.get(mapel.id);
        
        let nilaiRekap = null;
        
        if (flags && (flags.isUS || flags.isUP)) {
          let nilaiUM_to_use = null;
          let nilaiUP_to_use = null;

          if (storedNilai) {
            nilaiUM_to_use = (flags.isUS) ? storedNilai.um : null;
            nilaiUP_to_use = (flags.isUP) ? storedNilai.up : null;
          }
          
          nilaiRekap = hitungNilaiRekap(nilaiUM_to_use, nilaiUP_to_use);
        }
        
        if (nilaiRekap !== null) {
            nilaiRekapData.set(key, Math.round(nilaiRekap));
        }
      });
    });

    return { 
      mapelList: filteredMapelList.map(m => ({ id: m.id, nama: m.nama })),
      nilaiRekapMap: nilaiRekapData
    };
}

function getRekapRaporInternal(ss, siswaList, mapelListFull, semesterIds) {

  const semesterIdSet = new Set(semesterIds);
  const semesterCount = semesterIds.length;
  
  const filteredMapelList = mapelListFull.filter(m => m.isUS === true || m.isUP === true);
  
  const sheetNilai = getNilaiRaporSheet(ss);
  const dataNilai = sheetNilai.getDataRange().getValues();
  dataNilai.shift(); 
  
  const nilaiMap = new Map();
  dataNilai.forEach(row => {
    const siswaId = row[0];
    const mapelId = row[1];
    const semId = row[2];
    const nilaiP = parseFloat(row[3]); 
    const nilaiK = parseFloat(row[4]); 
    
    if (semesterIdSet.has(semId)) {
      
      let nilaiAkhirSem = null;
      const pIsValid = !isNaN(nilaiP);
      const kIsValid = !isNaN(nilaiK);
      
      if (pIsValid && kIsValid) {
        nilaiAkhirSem = (nilaiP + nilaiK) / 2;
      } else if (pIsValid) {
        nilaiAkhirSem = nilaiP;
      } else if (kIsValid) {
        nilaiAkhirSem = nilaiK;
      }

      if (nilaiAkhirSem !== null) {
        const key = `${siswaId}_${mapelId}`;
        if (!nilaiMap.has(key)) {
          nilaiMap.set(key, []);
        }
        nilaiMap.get(key).push(nilaiAkhirSem);
      }
    }
  });
  
  const nilaiRekapData = new Map();
  siswaList.forEach(siswa => {
    filteredMapelList.forEach(mapel => { 
      const key = `${siswa.id}_${mapel.id}`;
      const nilaiArray = nilaiMap.get(key);
      
      if (nilaiArray && nilaiArray.length > 0) {
        const sum = nilaiArray.reduce((acc, val) => acc + val, 0);
        const average = sum / semesterCount; 
        
        nilaiRekapData.set(key, Math.round(average));
      } else {
        nilaiRekapData.set(key, null);
      }
    });
  });

  return {
    mapelList: filteredMapelList.map(m => ({ id: m.id, nama: m.nama })),
    nilaiRekapMap: nilaiRekapData
  };
}

function getNilaiIjazahData(token) {
  try {
    const { spreadsheetID } = validateAdminSession(token);
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = ss.getSheetByName(SHEET_CACHE_IJAZAH);
    if (!sheet) return { status: "gagal", message: "Data belum dikalkulasi. Klik 'Hitung Ulang Nilai' dulu." };
    const metaValues = sheet.getRange(1, 1, 1, 7).getValues()[0];
    if (metaValues[0] !== 'Meta' || !metaValues[1]) return { status: "gagal", message: "Cache rusak. Klik 'Hitung Ulang Nilai'." };
    let siswaList, mapelList;
    try {
      siswaList = JSON.parse(metaValues[5]);
      mapelList = JSON.parse(metaValues[6]);
    } catch (e) { throw new Error("Data cache rusak. Harap Hitung Ulang."); }
    const dataUjianOriginal = {};
    const dataRaporOriginal = {};
    const dataUjianWeighted = {};
    const dataRaporWeighted = {};
    const dataIjazahFinal = {};
    const lastRow = sheet.getLastRow();
    if (lastRow > 2) {
      const dataValues = sheet.getRange(3, 1, lastRow - 2, 7).getValues();
      for (let i = 0; i < dataValues.length; i++) {
        const row = dataValues[i];
        const key = `${row[0]}_${row[1]}`;
        dataUjianOriginal[key] = row[2];
        dataRaporOriginal[key] = row[3];
        dataUjianWeighted[key] = row[4];
        dataRaporWeighted[key] = row[5];
        dataIjazahFinal[key] = row[6];
      }
    }
    return {
      status: "sukses",
      data: {
        siswaList, mapelList, dataUjian: dataUjianWeighted, dataRapor: dataRaporWeighted,
        dataIjazah: dataIjazahFinal, dataUjianOriginal, dataRaporOriginal,
        kkm: metaValues[4], bobotUjianPct: metaValues[3], bobotRaporPct: metaValues[2]
      }
    };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

// Salin dan GANTI fungsi recalculateIjazahData() Anda dengan yang ini
function recalculateIjazahData(token) {
  let spreadsheetID, sessionData;
  try {
    const session = validateAdminSession(token);
    spreadsheetID = session.spreadsheetID;
    sessionData = session.sessionData;
    const ss = SpreadsheetApp.openById(spreadsheetID);
    
    const sheetSetting = getPengaturanSheet(ss);
    const settings = sheetSetting.getRange('A1:B' + sheetSetting.getLastRow()).getValues();
    let bobotRapor = 60, bobotUjian = 40, kkm = 76, jmlSemester = 5;
    settings.forEach(s => {
      if (s[0] === 'Bobot_Rapor') bobotRapor = s[1];
      if (s[0] === 'Bobot_Ujian') bobotUjian = s[1];
      if (s[0] === 'KKM') kkm = s[1];
      if (s[0] === 'Jumlah_Semester') jmlSemester = s[1];
    });

    // --- PERBAIKAN 2.2 (SUDAH DITERAPKAN) ---
    // Menggunakan helper cache _getSiswaInternal
    // Kita butuh data lengkap (termasuk tglLahir), jadi panggil _getSiswaInternal
    const siswaListFull = _getSiswaInternal(spreadsheetID, sessionData.sekolahID);
    const siswaList = siswaListFull.map(s => ({ 
        id: s.id, 
        nama: s.nama, 
        nisn: s.nisn, 
        kelas: s.kelas 
    }));
    
    // Menggunakan helper cache _getMapelInternal
    const mapelListFull = _getMapelInternal(ss, sessionData.sekolahID);
    // --- AKHIR PERBAIKAN 2.2 ---
    
    const mapelIjazah = mapelListFull.filter(m => m.isUS || m.isUP);
    
    const { nilaiRekapMap: nilaiUjian } = getRekapUjianInternal(ss, siswaList, mapelListFull);
    
    const semesterIds = [];
    const jenjang = sessionData.jenjang;
    if (jenjang === 'SD/MI') {
       if (jmlSemester === 3) semesterIds.push('K5_S1','K5_S2','K6_S1');
       else semesterIds.push('K4_S1','K4_S2','K5_S1','K5_S2','K6_S1');
    } else if (jenjang === 'SMP/MTS') {
       semesterIds.push('K7_S1','K7_S2','K8_S1','K8_S2','K9_S1');
    } else {
       semesterIds.push('K10_S1','K10_S2','K11_S1','K11_S2','K12_S1');
    }
    const { nilaiRekapMap: nilaiRapor } = getRekapRaporInternal(ss, siswaList, mapelListFull, semesterIds);

    const dataToAppend = [];
    
    // --- PERBAIKAN 2.3: Buat rekapMap di sini ---
    const rekapMap = new Map();
    // --- AKHIR PERBAIKAN 2.3 ---

    siswaList.forEach(siswa => {
      // --- PERBAIKAN 2.3 ---
      let sum = 0;
      let count = 0;
      // --- AKHIR PERBAIKAN 2.3 ---

      mapelIjazah.forEach(mapel => {
        const key = `${siswa.id}_${mapel.id}`;
        const nU = nilaiUjian.get(key) || 0;
        const nR = nilaiRapor.get(key) || 0;
        const final = (nU * (bobotUjian/100)) + (nR * (bobotRapor/100));
        dataToAppend.push([siswa.id, mapel.id, nU, nR, nU*(bobotUjian/100), nR*(bobotRapor/100), final]);
        
        // --- PERBAIKAN 2.3: Kumpulkan nilai akhir ---
        sum += final;
        count++;
        // --- AKHIR PERBAIKAN 2.3 ---
      });

      // --- PERBAIKAN 2.3: Simpan data rekap untuk dikirim ---
      rekapMap.set(siswa.id, { sum: sum, count: count });
      // --- AKHIR PERBAIKAN 2.3 ---
    });

    let sheetCache = ss.getSheetByName(SHEET_CACHE_IJAZAH);
    if (!sheetCache) { sheetCache = ss.insertSheet(SHEET_CACHE_IJAZAH); sheetCache.hideSheet(); }
    sheetCache.clear();
    sheetCache.appendRow(['Meta', new Date(), bobotRapor, bobotUjian, kkm, JSON.stringify(siswaList), JSON.stringify(mapelIjazah), jmlSemester]);
    sheetCache.appendRow(['SiswaID', 'MapelID', 'UjianAsli', 'RaporAsli', 'UjianBobot', 'RaporBobot', 'IjazahFinal']);
    if (dataToAppend.length > 0) sheetCache.getRange(3, 1, dataToAppend.length, 7).setValues(dataToAppend);

    // --- PERBAIKAN 2.3: Buat siswaMap dan nisnList di sini ---
    const siswaMap = new Map();
    const nisnList = [];
    // Gunakan siswaListFull dari _getSiswaInternal() karena mengandung tglLahir
    siswaListFull.forEach(siswa => { 
        let nisn = String(siswa.nisn).trim().replace("'", "");
        const tglLahir = siswa.tglLahir; // Ambil tglLahir dari helper
        if (nisn && tglLahir && siswa.nama) {
          siswaMap.set(nisn, { id: siswa.id, dob: tglLahir, nama: siswa.nama });
          nisnList.push(nisn);
        }
    });
    // --- AKHIR PERBAIKAN 2.3 ---

    const db = SpreadsheetApp.openById(MASTER_KELULUSAN_DB_ID);
    const sheetHasil = db.getSheetByName('Sheet_Hasil_Publikasi');
    const hasilData = sheetHasil.getDataRange().getValues();
    for (let i = 1; i < hasilData.length; i++) {
      if (hasilData[i][0] === sessionData.sekolahID) {
        
        // --- PERUBAHAN KRUSIAL 2.3: Kirim data sebagai parameter ---
        _internalPublishLogic(
            spreadsheetID, 
            sessionData.sekolahID, 
            sessionData.namaSekolah, 
            hasilData[i][1],
            siswaMap,   // <-- Data baru
            nisnList,   // <-- Data baru
            rekapMap,   // <-- Data baru
            kkm         // <-- Data baru
        );
        // --- AKHIR PERUBAHAN 2.3 ---
        break;
      }
    }

    return { status: "sukses", message: "Nilai berhasil dihitung.", isDirty: false };
  } catch (e) {
    return { status: "gagal", message: e.message, isDirty: true };
  }
}

function exportDataIjazah(token, tipeFile, tipeData, kelasFilter, isWeighted) {
  let tempSpreadsheetId = null;
  try {
    const { sessionData } = validateAdminSession(token);
    const namaSekolah = sessionData.namaSekolah;
    const jenjangPilihan = sessionData.jenjangPilihan;
    const ijazahResponse = getNilaiIjazahData(token);
    if (ijazahResponse.status !== 'sukses') throw new Error(ijazahResponse.message);
    const data = ijazahResponse.data;
    let dataToExport, title = "", kkmInfo = "";
    if (tipeData === 'ujian') {
      dataToExport = isWeighted ? data.dataUjian : data.dataUjianOriginal;
      title = (jenjangPilihan === 'MI' || jenjangPilihan === 'MTS' || jenjangPilihan === 'MA') ? "NILAI UJIAN MADRASAH" : "NILAI UJIAN SEKOLAH";
      kkmInfo = isWeighted ? `(Bobot ${data.bobotUjianPct}%)` : "(Nilai Asli)";
    } else if (tipeData === 'rapor') {
      dataToExport = isWeighted ? data.dataRapor : data.dataRaporOriginal;
      title = "NILAI RAPOR";
      kkmInfo = isWeighted ? `(Bobot ${data.bobotRaporPct}%)` : "(Nilai Asli)";
    } else {
      dataToExport = data.dataIjazah;
      title = "NILAI IJAZAH";
      kkmInfo = `(KKM: ${data.kkm})`;
    }
    const filteredSiswaList = (kelasFilter === 'semua') ? data.siswaList : data.siswaList.filter(s => s.kelas === kelasFilter);
    const dataPayload = {
      namaSekolah, title, kkmInfo, kelasFilter, siswaList: filteredSiswaList,
      mapelList: data.mapelList, nilaiData: dataToExport, tipeData, isWeighted, kkmValue: data.kkm
    };
    const tempSS = buatSpreadsheetEksporIjazah(dataPayload);
    tempSpreadsheetId = tempSS.getId();
    let blob, fileName, mimeType;
    const timestamp = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "yyyyMMdd");
    const safeTitle = title.replace(/ /g, '_'), safeKelas = kelasFilter.replace(/ /g, '_');
    if (tipeFile === 'pdf') {
      blob = generatePdfBlobFromSheet(tempSS);
      fileName = `Nilai_${safeTitle}_${safeKelas}_${timestamp}.pdf`;
      mimeType = MimeType.PDF;
    } else {
      blob = generateExcelBlobFromSheet(tempSS);
      fileName = `Nilai_${safeTitle}_${safeKelas}_${timestamp}.xlsx`;
      mimeType = MimeType.MICROSOFT_EXCEL;
    }
    return { status: "sukses", base64: Utilities.base64Encode(blob.getBytes()), mimeType, fileName };
  } catch (e) {
    return { status: "gagal", message: e.message };
  } finally {
    if (tempSpreadsheetId) DriveApp.getFileById(tempSpreadsheetId).setTrashed(true);
  }
}

function buatSpreadsheetEksporIjazah(dataPayload) {
  const { namaSekolah, title, kkmInfo, kelasFilter, siswaList, mapelList, nilaiData, tipeData, isWeighted, kkmValue } = dataPayload;
  
  const ss = SpreadsheetApp.create(`[TEMP] Ekspor ${title}`);
  const sheet = ss.getSheetByName('Sheet1');
  sheet.setName('Data Nilai');

  sheet.getRange('A1').setValue(namaSekolah.toUpperCase()).setFontSize(14).setFontWeight('bold');
  sheet.getRange('A2').setValue(`REKAPITULASI ${title.toUpperCase()} ${kkmInfo}`).setFontSize(12).setFontWeight('bold');
  sheet.getRange('A3').setValue(`Kelas: ${(kelasFilter === 'semua') ? 'Semua Kelas' : kelasFilter}`).setFontSize(12).setFontWeight('bold');

  const headers = ["No", "Nama Siswa", "NISN", "Kelas", ...mapelList.map(m => m.id), "Jumlah", "Rata-Rata"];
  if (tipeData === 'ijazah') {
    headers.push("Status");
  }
  
  const headerRange = sheet.getRange(5, 1, 1, headers.length);
  headerRange.setValues([headers]);
  headerRange.setFontWeight('bold').setHorizontalAlignment('center').setVerticalAlignment('middle');
  headerRange.setBackground("#666666").setFontColor("#ffffff");

  headerRange.setWrap(false);
  sheet.getRange(5, 2).setWrap(true);
  sheet.getRange(5, 5, 1, mapelList.length).setWrap(true);

  const dataRows = [];
  
  siswaList.forEach((siswa, index) => {
    const row = [index + 1, siswa.nama, "'" + siswa.nisn, siswa.kelas];
    let sum = 0;
    let count = 0;
    
    mapelList.forEach(mapel => {
      const key = `${siswa.id}_${mapel.id}`;
      const nilai = nilaiData[key];
      
      if (nilai !== null && nilai !== undefined) {
        const nilaiAngka = parseFloat(nilai);
        if (tipeData === 'ijazah' || !isWeighted) {
          const nilaiTampil = Math.round(nilaiAngka);
          sum += nilaiTampil;
          row.push(nilaiTampil); 
        } else {
          const nilaiTampil = parseFloat(nilaiAngka.toFixed(2));
          sum += nilaiTampil;
          row.push("'" + nilaiTampil.toFixed(2).replace('.', ',')); 
        }
        count++;
      } else {
        row.push(null); 
      }
    });
    
    const average = (count > 0) ? (sum / count) : 0;
    
    if (tipeData === 'ijazah' || !isWeighted) {
      row.push(Math.round(sum)); 
    } else {
      row.push("'" + sum.toFixed(2).replace('.', ',')); 
    }
    
    row.push("'" + average.toFixed(2).replace('.', ',')); 

    if (tipeData === 'ijazah') {
      row.push(average >= kkmValue ? 'LULUS' : 'TIDAK LULUS');
    }
    
    dataRows.push(row);
  });

  if (dataRows.length > 0) {
    const dataRange = sheet.getRange(6, 1, dataRows.length, headers.length);
    dataRange.setValues(dataRows);
    dataRange.applyRowBanding(SpreadsheetApp.BandingTheme.LIGHT_GREY, false, false);
    
    dataRange.setVerticalAlignment('middle'); 
    sheet.getRange(6, 2, dataRows.length, 1).setWrap(true); 
    
    sheet.getRange(6, 1, dataRows.length, 1).setHorizontalAlignment('center'); // Kolom No (A) -> Rata Tengah
    sheet.getRange(6, 2, dataRows.length, 1).setHorizontalAlignment('left');  // Kolom Nama (B) -> Rata Kiri
    
    // --- PERBAIKAN RATA TENGAH NISN ---
    sheet.getRange(6, 3, dataRows.length, 1).setHorizontalAlignment('center'); // Kolom NISN (C) -> Rata Tengah
    sheet.getRange(6, 4, dataRows.length, headers.length - 3).setHorizontalAlignment('center'); // Kolom Kelas (D) -> dst
    // --- AKHIR PERBAIKAN ---
    
    const tableRange = sheet.getRange(5, 1, dataRows.length + 1, headers.length);
    tableRange.setBorder(true, true, true, true, true, true);
    tableRange.setFontSize(11); 
    
    const legendStartRow = 6 + dataRows.length + 2; 
    
    const mergeStartCol = 3; 
    const mergeEndCol = 12;  
    const mergeCount = mergeEndCol - mergeStartCol + 1; 
    
    sheet.getRange(legendStartRow, mergeStartCol, 1, mergeCount).merge(); 
    
    // --- PERBAIKAN RATA KIRI LEGENDA ---
    sheet.getRange(legendStartRow, mergeStartCol).setValue("Keterangan Kode Mapel :")
         .setFontWeight('bold').setFontSize(11).setHorizontalAlignment('left');
    // --- AKHIR PERBAIKAN ---
         
    const legendData = [];
    mapelList.forEach(mapel => {
      legendData.push([mapel.id, "'=", mapel.nama]); 
    });
    
    if (legendData.length > 0) {
      const legendDataRange = sheet.getRange(legendStartRow + 1, 3, legendData.length, 3);
      legendDataRange.setValues(legendData);
      
      legendDataRange.setFontSize(11);
      
      // --- PERBAIKAN RATA KIRI LEGENDA ---
      sheet.getRange(legendStartRow + 1, 3, legendData.length, 1).setFontWeight('bold').setHorizontalAlignment('left'); // Kolom C (Kode)
      // --- AKHIR PERBAIKAN ---
      
      sheet.getRange(legendStartRow + 1, 4, legendData.length, 1).setHorizontalAlignment('center'); // Kolom D (=)

      for (let i = 0; i < legendData.length; i++) {
        let row = legendStartRow + 1 + i;
        sheet.getRange(row, 5, 1, 8).merge(); 
        sheet.getRange(row, 5).setHorizontalAlignment('left').setVerticalAlignment('middle');
      }
    }
  }

  sheet.setColumnWidth(1, 40); 
  sheet.setColumnWidth(2, 220); 
  sheet.setColumnWidth(3, 100); 
  sheet.setColumnWidth(4, 60);  
  
  const mapelColStart = 5;
  for(let i = 0; i < mapelList.length; i++) {
    const colIndex = mapelColStart + i;
    sheet.setColumnWidth(colIndex, 60); 
  }

  const rekapColStart = mapelColStart + mapelList.length;
  sheet.setColumnWidth(rekapColStart, 80); 
  sheet.setColumnWidth(rekapColStart + 1, 80); 
  if (tipeData === 'ijazah') {
    sheet.setColumnWidth(rekapColStart + 2, 100); 
  }

  SpreadsheetApp.flush();

  return ss;
}

function generatePdfBlobFromSheet(spreadsheet) {
  const spreadsheetId = spreadsheet.getId();
  const file = DriveApp.getFileById(spreadsheetId);
  
  const marginInches = 0.2 / 2.54; 
  
  const url = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/export?` +
    'format=pdf&' +
    'size=a4&' +
    'portrait=false&' + 
    'fitw=true&' + 
    'sheetnames=false&' +
    'printtitle=false&' +
    'pagenumbers=false&' +
    'gridlines=false&' +
    'fzr=false&' +
    'gid=' + spreadsheet.getSheets()[0].getSheetId() + '&' +
    `top_margin=${marginInches}&` +
    `bottom_margin=${marginInches}&` +
    `left_margin=${marginInches}&` +
    `right_margin=${marginInches}`;
    
  const token = ScriptApp.getOAuthToken();
  const response = UrlFetchApp.fetch(url, {
    headers: {
      'Authorization': 'Bearer ' + token
    }
  });

  return response.getBlob().setName(spreadsheet.getName() + ".pdf");
}

function generateExcelBlobFromSheet(spreadsheet) {
  const spreadsheetId = spreadsheet.getId();
  const url = "https://docs.google.com/spreadsheets/d/" + spreadsheetId + "/export?format=xlsx";
  const token = ScriptApp.getOAuthToken();
  
  const response = UrlFetchApp.fetch(url, {
    headers: {
      'Authorization': 'Bearer ' + token
    }
  });

  return response.getBlob().setName(spreadsheet.getName() + ".xlsx");
}

function clearAllCaches(token) {
  try {
    const { sessionData } = validateAdminSession(token);
    clearSiswaCache(sessionData.sekolahID);
    clearMapelCache(sessionData.sekolahID);
    clearMasterSheetCache();
    return { status: "sukses" };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function getValidationData(token) {
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    const ss = SpreadsheetApp.openById(spreadsheetID);
    
    // --- PERBAIKAN DI SINI ---
    const siswaList = _getSiswaInternal(spreadsheetID, sessionData.sekolahID);
    const mapelListFull = _getMapelInternal(ss, sessionData.sekolahID);
    // --- AKHIR PERBAIKAN ---

    const requiredMapelList = mapelListFull.filter(m => m.isUS === true || m.isUP === true);
    const requiredMapelIds = new Set(requiredMapelList.map(m => m.id));
    const mapelInfoMap = new Map(requiredMapelList.map(m => [m.id, { isUS: m.isUS, isUP: m.isUP }]));
    
    const semesterListData = getSemesterList(token);
    if (semesterListData.status !== 'sukses') throw new Error("Gagal mengambil daftar semester.");
    const requiredSemesterList = semesterListData.semesterList;
    const semesterListWithCodes = requiredSemesterList.map(sem => {
      const parts = sem.id.split('_');
      return { ...sem, shortCode: (parts.length === 2) ? `${parts[0].replace('K', '')}.${parts[1].replace('S', '')}` : '' };
    });
    const requiredSemesterIdSet = new Set(requiredSemesterList.map(s => s.id));
    
    const nilaiRaporSheet = getNilaiRaporSheet(ss);
    const raporDataValues = nilaiRaporSheet.getDataRange().getValues();
    raporDataValues.shift();
    const raporMap = new Map();
    raporDataValues.forEach(row => {
      if (requiredSemesterIdSet.has(row[2]) && requiredMapelIds.has(row[1])) {
        if (!raporMap.has(row[0])) raporMap.set(row[0], new Map());
        if (!raporMap.get(row[0]).has(row[1])) raporMap.get(row[0]).set(row[1], new Map());
        raporMap.get(row[0]).get(row[1]).set(row[2], { P: (row[3] != null && row[3] !== ""), K: (row[4] != null && row[4] !== "") });
      }
    });
    
    const nilaiUjianSheet = getNilaiUjianSheet(ss);
    const ujianDataValues = nilaiUjianSheet.getDataRange().getValues();
    ujianDataValues.shift();
    const ujianMap = new Map();
    ujianDataValues.forEach(row => {
      if (requiredMapelIds.has(row[1])) {
        if (!ujianMap.has(row[0])) ujianMap.set(row[0], new Map());
        ujianMap.get(row[0]).set(row[1], { UM: (row[2] != null && row[2] !== ""), UP: (row[3] != null && row[3] !== "") });
      }
    });
    
    const validationResults = {};
    let globalNeedsUM = false, globalNeedsUP = false;
    mapelInfoMap.forEach(info => { if (info.isUS) globalNeedsUM = true; if (info.isUP) globalNeedsUP = true; });
    
    siswaList.forEach(siswa => {
      const resultSiswa = { rapor: {}, ujian: {} };
      if (globalNeedsUM) resultSiswa.ujian.UM = true;
      if (globalNeedsUP) resultSiswa.ujian.UP = true;
      requiredSemesterList.forEach(sem => { resultSiswa.rapor[`${sem.id}_P`] = true; resultSiswa.rapor[`${sem.id}_K`] = true; });
      for (const mapel of requiredMapelList) {
        const mapelInfo = mapelInfoMap.get(mapel.id);
        for (const sem of requiredSemesterList) {
          const rData = raporMap.get(siswa.id)?.get(mapel.id)?.get(sem.id) || { P: false, K: false };
          if (resultSiswa.rapor[`${sem.id}_P`] && !rData.P) resultSiswa.rapor[`${sem.id}_P`] = false;
          if (resultSiswa.rapor[`${sem.id}_K`] && !rData.K) resultSiswa.rapor[`${sem.id}_K`] = false;
        }
        const uData = ujianMap.get(siswa.id)?.get(mapel.id) || { UM: false, UP: false };
        if (globalNeedsUM && mapelInfo.isUS && !uData.UM) resultSiswa.ujian.UM = false;
        if (globalNeedsUP && mapelInfo.isUP && !uData.UP) resultSiswa.ujian.UP = false;
      }
      if (!globalNeedsUM) delete resultSiswa.ujian.UM;
      if (!globalNeedsUP) delete resultSiswa.ujian.UP;
      validationResults[siswa.id] = resultSiswa;
    });
    return { status: "sukses", data: { siswaList: siswaList.map(s => ({ id: s.id, nama: s.nama, nisn: s.nisn, kelas: s.kelas })), requiredSemesters: semesterListWithCodes, validationData: validationResults } };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

/**
 * FUNGSI UNTUK DIJALANKAN MANUAL SEKALI SAJA
 * * CARA MENJALANKAN:
 * 1. Buka file Kode.gs.html Anda.
 * 2. Salin dan tempel (paste) fungsi ini di bagian paling bawah file.
 * 3. UBAH 'email_superadmin@anda.com', 'Nama Super Admin', dan 'password_rahasia_anda'.
 * 4. Simpan file (Ctrl+S atau ikon Simpan).
 * 5. Di bagian atas editor, pilih nama fungsi "BUAT_SUPERADMIN_PERTAMA_KALI" dari menu dropdown (di sebelah "Debug" dan "Run").
 * 6. Klik tombol "Run" ().
 * 7. Periksa log (View > Logs) untuk pesan "BERHASIL!".
 * 8. Hapus atau beri komentar (//) pada fungsi ini setelah selesai.
 */
/*
function BUAT_SUPERADMIN_PERTAMA_KALI() {
  try {
    // --- SESUAIKAN DATA DI BAWAH INI ---
    const EMAIL_SUPERADMIN = "syamsulbahri.agro27b@gmail.com";
    const NAMA_SUPERADMIN = "Syamsul Bahri";
    const PASSWORD_SUPERADMIN = "Andhika9619!"; // Ganti dengan password yang kuat
    // --- BATAS PENYESUAIAN ---

    if (PASSWORD_SUPERADMIN === "password_rahasia_anda" || EMAIL_SUPERADMIN === "superadmin@email.com") {
      Logger.log("PENTING: Harap ubah email dan password di dalam kode fungsi sebelum menjalankan.");
      Browser.msgBox("PENTING: Harap ubah email dan password di dalam kode fungsi sebelum menjalankan.");
      return;
    }

    const masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
    const sheet = getSheetSuperadmin(masterSS); // Fungsi ini akan membuat sheet jika belum ada

    // Cek apakah email sudah ada
    const data = sheet.getDataRange().getValues();
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] === EMAIL_SUPERADMIN) {
        Logger.log("Akun Superadmin dengan email " + EMAIL_SUPERADMIN + " sudah ada.");
        Browser.msgBox("Akun Superadmin dengan email " + EMAIL_SUPERADMIN + " sudah ada.");
        return;
      }
    }

    // Buat hash dan salt baru (memanggil fungsi yang sudah ada di script Anda)
    const newSalt = generateSalt();
    const newHash = hashPassword(PASSWORD_SUPERADMIN, newSalt);

    // Tambahkan ke sheet
    sheet.appendRow([EMAIL_SUPERADMIN, NAMA_SUPERADMIN, newHash, newSalt]);

    Logger.log("BERHASIL! Akun Superadmin " + EMAIL_SUPERADMIN + " telah dibuat.");
    Browser.msgBox("BERHASIL! Akun Superadmin " + EMAIL_SUPERADMIN + " telah dibuat. Anda sekarang dapat login.");

  } catch (e) {
    Logger.log("Gagal membuat Superadmin: " + e.message);
    Browser.msgBox("Gagal membuat Superadmin: " + e.message);
  }
}
*/

/**
 * Memvalidasi sesi Admin ATAU Guru.
 */
function validateAdminOrGuruSession(token) {
  const sessionData = validateAndRefreshSession(token);
  
  if (sessionData.role !== 'admin' && sessionData.role !== 'guru') {
    throw new Error("Akses ditolak. API ini hanya untuk Admin atau Guru.");
  }
  
  if (!sessionData.spreadsheetID) {
    throw new Error("Sesi tidak valid (Spreadsheet ID tidak ditemukan).");
  }
  
  // Mengembalikan data lengkap untuk digunakan di fungsi pemanggil
  return { sessionData, spreadsheetID: sessionData.spreadsheetID };
}

function validateAdminSession(token) {
  const sessionData = validateAndRefreshSession(token);
  if (sessionData.role !== 'admin') {
    throw new Error("Akses ditolak. API ini hanya untuk Admin Sekolah.");
  }
  if (!sessionData.spreadsheetID) {
    throw new Error("Sesi Admin tidak valid (Spreadsheet ID tidak ditemukan).");
  }
  return { sessionData, spreadsheetID: sessionData.spreadsheetID };
}

// Salin dan GANTI fungsi _internalPublishLogic() Anda dengan yang ini
/**
 * FUNGSI HELPER BARU
 * Berisi logika inti untuk mempublikasikan hasil.
 * VERSI REFACTOR 2.3: Menerima data yang sudah dihitung sebagai parameter
 * untuk menghindari pembacaan ganda.
 */
function _internalPublishLogic(
    spreadsheetID, sekolahID, namaSekolah, tanggalPengumumanISO,
    siswaMap, nisnList, rekapMap, kkm // <-- PARAMETER BARU DARI PERBAIKAN 2.3
) {
  // --- PERBAIKAN BLOK GATING ---
  // Cek status donasi.
  const masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
  const sheetSekolah = masterSS.getSheetByName('Sheet_Sekolah');
  const dataSekolah = sheetSekolah.getDataRange().getValues();
  let donasiStatus = "NONE";
  for (let i = 1; i < dataSekolah.length; i++) {
    if (dataSekolah[i][0] === sekolahID) {
      donasiStatus = dataSekolah[i][8] || "NONE";
      break;
    }
  }
  
  // JIKA DONASI TIDAK AKTIF:
  if (donasiStatus !== "APPROVED") {
    // Jangan lempar error, cukup hentikan fungsi secara diam-diam.
    Logger.log(`_internalPublishLogic dihentikan untuk ${sekolahID} (Donasi: ${donasiStatus}). Kalkulasi nilai tetap berhasil.`);
    return;
  }
  // --- AKHIR PERBAIKAN BLOK ---

  // --- PERUBAHAN KRUSIAL 2.3: HAPUS BLOK PEMBACAAN DATA ---
  // const ss = SpreadsheetApp.openById(spreadsheetID);
  // const siswaListFull = _getSiswaInternal(spreadsheetID, sekolahID);
  // ... (logika membuat siswaMap & nisnList) ...
  // const sheetCacheIjazah = ss.getSheetByName(SHEET_CACHE_IJAZAH);
  // ... (logika membaca kkm dan ijazahData) ...
  // ... (logika membuat rekapMap) ...
  // --- BLOK DI ATAS SEPENUHNYA DIHAPUS ---
  // --- AKHIR PERUBAHAN 2.3 ---


  // 3. Tentukan status kelulusan
  // Logika ini sekarang menggunakan data dari PARAMETER (siswaMap, rekapMap, kkm)
  const hasilKelulusan = {};
  siswaMap.forEach((data, nisn) => {
    const rekap = rekapMap.get(data.id);
    let status = 'TIDAK LULUS'; // Default
    if (rekap && rekap.count > 0) {
      const average = rekap.sum / rekap.count;
      if (average >= kkm) { // <-- kkm dari parameter
        status = 'LULUS';
      }
    }
    hasilKelulusan[nisn] = {
      dob: data.dob,
      status: status,
      nama: data.nama
    };
  });
  
  const hasilKelulusanJson = JSON.stringify(hasilKelulusan);
  
  // 4. Tulis/Timpa ke Database Master Kelulusan
  const db = SpreadsheetApp.openById(MASTER_KELULUSAN_DB_ID);
  const sheetHasil = db.getSheetByName('Sheet_Hasil_Publikasi');
  const hasilData = sheetHasil.getDataRange().getValues();
  let rowUpdated = false;
  for (let i = 1; i < hasilData.length; i++) {
    if (hasilData[i][0] === sekolahID) {
      // Timpa data yang ada
      sheetHasil.getRange(i + 1, 2, 1, 3).setValues([[tanggalPengumumanISO, hasilKelulusanJson, namaSekolah]]);
      rowUpdated = true;
      break;
    }
  }
  if (!rowUpdated) {
    // Tambah data baru jika belum ada
    sheetHasil.appendRow([sekolahID, tanggalPengumumanISO, hasilKelulusanJson, namaSekolah]);
  }
  
  // 5. Update Master Index (Hapus lama, tambah baru)
  const sheetIndex = db.getSheetByName('Sheet_Master_Index');
  const indexData = sheetIndex.getDataRange().getDisplayValues(); 
  const rowsToDelete = [];
  for (let i = indexData.length - 1; i >= 1; i--) { 
    if (indexData[i][1] === sekolahID) {
      rowsToDelete.push(i + 1);
    }
  }
  rowsToDelete.forEach(rowNum => {
    sheetIndex.deleteRow(rowNum);
  });
  
  // Gunakan nisnList dari PARAMETER
  const nisnRowsToAdd = nisnList.map(nisn => ["'" + nisn, sekolahID]); 
  if (nisnRowsToAdd.length > 0) {
    sheetIndex.getRange(sheetIndex.getLastRow() + 1, 1, nisnRowsToAdd.length, 2).setValues(nisnRowsToAdd);
  }
  
  // 6. Bersihkan Cache Publik
  const scriptCache = CacheService.getScriptCache();
  scriptCache.remove(MASTER_NISN_INDEX_KEY);
  scriptCache.remove(HASIL_KELULUSAN_PREFIX + sekolahID);
  
  // Bangun ulang cache publik agar data baru segera tersedia
  rebuildKelulusanCacheFromDB(); 

  // Kembalikan jumlah siswa untuk pesan sukses (gunakan nisnList dari PARAMETER)
  return nisnList.length;
}

function publishKelulusan(token, tanggalPengumumanISO) {
  const lock = LockService.getScriptLock();
  lock.waitLock(30000);
  try {
    const session = validateAdminSession(token);
    const nisnListLength = _internalPublishLogic(session.spreadsheetID, session.sessionData.sekolahID, session.sessionData.namaSekolah, tanggalPengumumanISO);
    return { status: "sukses", message: `Hasil kelulusan dipublikasikan untuk ${nisnListLength} siswa.` };
  } catch (e) {
    return { status: "gagal", message: e.message };
  } finally {
    lock.releaseLock();
  }
}

function getPublishedStatus(token) {
  try {
    const { sessionData } = validateAdminSession(token);
    const scriptCache = CacheService.getScriptCache();
    const dataWrapperJson = scriptCache.get(HASIL_KELULUSAN_PREFIX + sessionData.sekolahID);
    if (dataWrapperJson) {
      return { status: "sukses", isPublished: true, publishDate: JSON.parse(dataWrapperJson).tanggalPengumuman };
    } else {
      return { status: "sukses", isPublished: false };
    }
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function unpublishKelulusan(token) {
  const lock = LockService.getScriptLock();
  lock.waitLock(30000);
  try {
    const { sessionData } = validateAdminSession(token);
    const sekolahID = sessionData.sekolahID;
    const db = SpreadsheetApp.openById(MASTER_KELULUSAN_DB_ID);
    const sheetHasil = db.getSheetByName('Sheet_Hasil_Publikasi');
    const hasilData = sheetHasil.getDataRange().getValues();
    for (let i = hasilData.length - 1; i >= 1; i--) {
      if (hasilData[i][0] === sekolahID) {
        sheetHasil.deleteRow(i + 1);
        break;
      }
    }
    const sheetIndex = db.getSheetByName('Sheet_Master_Index');
    const indexData = sheetIndex.getDataRange().getDisplayValues();
    const rowsToDelete = [];
    let nisnRemovedCount = 0;
    for (let i = indexData.length - 1; i >= 1; i--) {
      if (indexData[i][1] === sekolahID) {
        rowsToDelete.push(i + 1);
        nisnRemovedCount++;
      }
    }
    rowsToDelete.forEach(rowNum => sheetIndex.deleteRow(rowNum));
    const scriptCache = CacheService.getScriptCache();
    scriptCache.remove(MASTER_NISN_INDEX_KEY);
    scriptCache.remove(HASIL_KELULUSAN_PREFIX + sekolahID);
    return { status: "sukses", message: `Publikasi ditarik (${nisnRemovedCount} NISN dihapus).` };
  } catch (e) {
    return { status: "gagal", message: e.message };
  } finally {
    lock.releaseLock();
  }
}

function cekStatusSiswa(nisn, tglLahir) {
  try {
    if (!nisn || !tglLahir) {
      return { status: 'error', message: 'NISN dan Tanggal Lahir harus diisi.' };
    }
    
    const scriptCache = CacheService.getScriptCache();
    let allHasilWrappers = null;
    let masterIndex;
    
    const masterIndexJson = scriptCache.get(MASTER_NISN_INDEX_KEY);
    
    if (!masterIndexJson) {
      Logger.log("CACHE MISS: Master Index. Membangun ulang dari DB...");
      const rebuiltData = rebuildKelulusanCacheFromDB();
      masterIndex = rebuiltData.masterIndex;
      allHasilWrappers = rebuiltData.allHasilWrappers;
    } else {
      masterIndex = JSON.parse(masterIndexJson);
    }
    
    const nisnTrimmed = String(nisn).trim();
    const sekolahID = masterIndex[nisnTrimmed];
    
    if (!sekolahID) {
      return { status: 'error', message: 'NISN tidak terdaftar.' };
    }
    
    let dataWrapper;
    if (allHasilWrappers) {
      dataWrapper = allHasilWrappers[sekolahID];
    } else {
      const dataWrapperJson = scriptCache.get(HASIL_KELULUSAN_PREFIX + sekolahID);
      if (!dataWrapperJson) {
        Logger.log(`CACHE MISS: Hasil Sekolah ${sekolahID}. Membangun ulang dari DB...`);
        const rebuiltData = rebuildKelulusanCacheFromDB();
        dataWrapper = rebuiltData.allHasilWrappers[sekolahID];
      } else {
        dataWrapper = JSON.parse(dataWrapperJson);
      }
    }
    
    if (!dataWrapper) {
      return { status: 'error', message: 'Hasil kelulusan untuk sekolah ini belum dipublikasikan oleh Admin.' };
    }

    // --- TAMBAHKAN BLOK GATING INI ---
    if (dataWrapper.donasiStatus !== "APPROVED") {
      return { status: 'error', message: 'Fitur Cek Kelulusan belum diaktifkan oleh sekolah ini.' };
    }
    // --- AKHIR BLOK ---
    
    const dataSiswa = dataWrapper.hasil[nisnTrimmed];
    
    if (!dataSiswa) {
      return { status: 'error', message: 'NISN tidak terdaftar di sekolah ini.' };
    }
    
    if (dataSiswa.dob !== tglLahir) {
      return { status: 'error', message: 'NISN dan Tanggal Lahir tidak cocok.' };
    }
    
    const tanggalPengumuman = new Date(dataWrapper.tanggalPengumuman);
    const sekarang = new Date();
    
    const responsePayload = {
      namaSekolah: dataWrapper.namaSekolah,
      namaSiswa: dataSiswa.nama
    };
    
    if (sekarang < tanggalPengumuman) {
      return { 
        ...responsePayload,
        status: 'countdown', 
        targetDate: dataWrapper.tanggalPengumuman 
      };
    } else {
      return { 
        ...responsePayload,
        status: 'hasil', 
        result: dataSiswa.status 
      };
    }
    
  } catch (e) {
    Logger.log("Gagal cekStatusSiswa: " + e.message);
    return { status: 'error', message: 'Terjadi kesalahan server: ' + e.message };
  }
}

function rebuildKelulusanCacheFromDB() {
  Logger.log("Memulai Pembangunan Ulang Cache Kelulusan dari DB...");
  const scriptCache = CacheService.getScriptCache();
  let masterIndex = {};
  let allHasilWrappers = {};

  try {
    const db = SpreadsheetApp.openById(MASTER_KELULUSAN_DB_ID);

    // --- TAMBAHKAN BLOK INI ---
    // 1. Buat Peta Donasi
    const masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
    const sheetSekolah = masterSS.getSheetByName('Sheet_Sekolah');
    const dataSekolah = sheetSekolah.getDataRange().getValues();
    const donasiStatusMap = new Map();
    for(let i=1; i < dataSekolah.length; i++) {
      donasiStatusMap.set(dataSekolah[i][0], dataSekolah[i][8] || "NONE"); // Kolom A -> Kolom I
    }
    // --- AKHIR BLOK ---
    
    const sheetIndex = db.getSheetByName('Sheet_Master_Index');
    const indexData = sheetIndex.getRange(2, 1, sheetIndex.getLastRow() - 1, 2).getDisplayValues(); 
    indexData.forEach(row => {
      masterIndex[row[0]] = row[1]; 
    });

    const sheetHasil = db.getSheetByName('Sheet_Hasil_Publikasi');
    const hasilData = sheetHasil.getRange(2, 1, sheetHasil.getLastRow() - 1, 4).getValues();
    
    hasilData.forEach(row => {
      const sekolahID = row[0];
      const tanggalISO = row[1];
      const hasilJson = row[2];
      const namaSekolah = row[3];
      
      try {
        const dataWrapper = {
          tanggalPengumuman: tanggalISO,
          namaSekolah: namaSekolah,
          donasiStatus: donasiStatusMap.get(sekolahID) || "NONE",
          hasil: JSON.parse(hasilJson)
        };
        allHasilWrappers[sekolahID] = dataWrapper;
        scriptCache.put(HASIL_KELULUSAN_PREFIX + sekolahID, JSON.stringify(dataWrapper), 21600);
      } catch (e) {
        Logger.log(`Gagal mem-parse JSON untuk ${sekolahID}: ${e.message}`);
      }
    });
    
    scriptCache.put(MASTER_NISN_INDEX_KEY, JSON.stringify(masterIndex), 21600);
    Logger.log(`Pembangunan Ulang Cache Selesai. ${indexData.length} NISN dan ${hasilData.length} sekolah dimuat.`);
    
  } catch (e) {
    Logger.log(`FATAL: Gagal membangun ulang cache: ${e.message}`);
  }
  
  return { masterIndex, allHasilWrappers };
}

function prosesLoginGuru(npsn, email, password) {
  try {
    const masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
    const sheetSekolah = masterSS.getSheetByName('Sheet_Sekolah');
    
    let targetSekolah = null;
    let rowData = null;
    
    const npsnFinder = sheetSekolah.getRange("H2:H").createTextFinder(npsn).matchEntireCell(true).findAll();
    
    if (npsnFinder.length > 0) {
      const rowNum = npsnFinder[0].getRow();
      rowData = sheetSekolah.getRange(rowNum, 1, 1, sheetSekolah.getLastColumn()).getValues()[0];
      targetSekolah = rowData;
    } else {
      const namaFinder = sheetSekolah.getRange("B2:B").createTextFinder(npsn).matchEntireCell(true).findAll();
      if (namaFinder.length > 0) {
        const rowNum = namaFinder[0].getRow();
        rowData = sheetSekolah.getRange(rowNum, 1, 1, sheetSekolah.getLastColumn()).getValues()[0];
        targetSekolah = rowData;
      }
    }

    if (!targetSekolah) {
      return { status: "gagal", message: "NPSN/Kode Sekolah tidak ditemukan." };
    }

    const donasiStatus = targetSekolah[8] || "NONE"; // Kolom I
    if (donasiStatus !== "APPROVED") {
      return { status: "gagal", message: "Fitur Login Guru adalah fitur premium. Silakan minta Admin Sekolah Anda untuk mengaktifkan donasi." };
    }

    const spreadsheetID = targetSekolah[5];
    const jenjangPilihan = getJenjangPilihanFromSheet(spreadsheetID);
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheetGuru = getGuruSheet(ss);
    if (!sheetGuru) {
      return { status: "gagal", message: "Fitur guru belum diaktifkan di sekolah ini. Hubungi Admin." };
    }

    const guruEmailFinder = sheetGuru.getRange("A2:A").createTextFinder(email).matchEntireCell(true).findAll();

    const appUrl = ScriptApp.getService().getUrl();
    
    if (guruEmailFinder.length > 0) {
      const rowNum = guruEmailFinder[0].getRow();
      const guruData = sheetGuru.getRange(rowNum, 1, 1, sheetGuru.getLastColumn()).getValues()[0];
      
      if (verifyPassword(password, guruData[2], guruData[3])) {
        
        const dataMapel = guruData[4]; // Kolom E (MapelKelasJSON)
        let mapelKelasData = {};
        let assignedMapel = [];
        let assignedKelas = new Set(); 

        if (dataMapel) {
          try {
            mapelKelasData = JSON.parse(dataMapel);
          } catch (e) {
            mapelKelasData = {};
            const mapelArray = String(dataMapel).split(',').map(s => s.trim());
            mapelArray.forEach(mapelId => {
              if (mapelId) {
                mapelKelasData[mapelId] = ["*"]; 
              }
            });
          }
        }

        assignedMapel = Object.keys(mapelKelasData);
        for (const mapel in mapelKelasData) {
          const kelasArray = mapelKelasData[mapel];
          if (kelasArray.includes("*")) {
            const kelasSheet = getKelasSheet(ss);
            const semuaKelas = kelasSheet.getDataRange().getValues();
            semuaKelas.shift(); 
            semuaKelas.forEach(row => assignedKelas.add(row[0]));
          } else {
            kelasArray.forEach(k => assignedKelas.add(k));
          }
        }

        // --- PERBAIKAN DI SINI ---
        const allMapel = _getMapelInternal(ss, targetSekolah[0]);
        // --- AKHIR PERBAIKAN ---
        
        const mapelUPSet = new Set();
        const mapelUMSet = new Set();
        
        allMapel.forEach(m => {
          if (m.isUP) mapelUPSet.add(m.id);
          if (m.isUS) mapelUMSet.add(m.id);
        });
        
        let hasPraktek = false;
        let hasMadrasah = false;
        
        for (const mapelId of assignedMapel) {
          if (mapelUPSet.has(mapelId)) hasPraktek = true;
          if (mapelUMSet.has(mapelId)) hasMadrasah = true;
          if (hasPraktek && hasMadrasah) break;
        }
        
        const token = Utilities.getUuid();
        const sessionData = {
          role: 'guru',
          sekolahID: targetSekolah[0],
          namaSekolah: targetSekolah[1],
          jenjang: targetSekolah[2],
          spreadsheetID: spreadsheetID,
          jenjangPilihan: jenjangPilihan,
          namaGuru: guruData[1],
          assignedMapel: assignedMapel, 
          assignedKelas: Array.from(assignedKelas), 
          mapelKelasData: mapelKelasData, 
          hasUjianPraktek: hasPraktek,
          hasUjianMadrasah: hasMadrasah,
          lastActivity: new Date().getTime()
        };
        CacheService.getScriptCache().put('SESSION_' + token, JSON.stringify(sessionData), 21600);
        
        return {
          status: "sukses",
          role: "guru",
          namaSekolah: targetSekolah[1],
          namaGuru: guruData[1],
          jenjangPilihan: jenjangPilihan,
          hasUjianPraktek: hasPraktek,
          hasUjianMadrasah: hasMadrasah,
          token: token,
          appUrl: appUrl
        };
      }
    }
    return { status: "gagal", message: "Email atau password guru salah." };
  } catch (e) {
    return { status: "gagal", message: "Terjadi error: " + e.message };
  }
}

// --- FUNGSI KELOLA GURU (Admin) ---

function getGuruSheet(ss) {
  let sheet = ss.getSheetByName('Akun_Guru');
  if (!sheet) {
    sheet = ss.insertSheet('Akun_Guru');
    // Header: Email, Nama, Password (Hash), Salt, MapelKelasJSON
    // --- PERUBAHAN NAMA KOLOM ---
    sheet.appendRow(['Email', 'Nama', 'HashedPassword', 'Salt', 'MapelKelasJSON']);
    // --- AKHIR PERUBAHAN ---
    sheet.setFrozenRows(1);
  } else {
    // --- PERBAIKAN MIGRASI (Jalankan sekali) ---
    const header = sheet.getRange(1, 5).getValue();
    if (header === "MapelIDs") {
      sheet.getRange(1, 5).setValue("MapelKelasJSON");
    }
    // --- AKHIR PERBAIKAN ---
  }
  return sheet;
}

function getGuru(token) {
  try {
    const { spreadsheetID } = validateAdminSession(token);
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getGuruSheet(ss);
    const data = sheet.getDataRange().getValues();
    data.shift(); // Hapus header

    const guruList = data.map(row => {
      const email = row[0];
      const nama = row[1];
      const dataMapel = row[4]; // Kolom E (MapelKelasJSON)
      let mapelKelasData = {};

      if (dataMapel) {
        try {
          // Coba parse sebagai JSON (Format baru)
          mapelKelasData = JSON.parse(dataMapel);
        } catch (e) {
          // Gagal parse? Ini pasti format lama (string "MTK,IPA")
          mapelKelasData = {};
          const mapelArray = String(dataMapel).split(',').map(s => s.trim());
          mapelArray.forEach(mapelId => {
            if (mapelId) {
              mapelKelasData[mapelId] = ["*"]; // "*" berarti "Semua Kelas"
            }
          });
        }
      }

      return {
        email: email,
        nama: nama,
        mapelKelas: mapelKelasData // Kirim sebagai objek JSON
      };
    }).filter(g => g.email); // Hanya ambil yang emailnya ada

    return { status: "sukses", guru: guruList };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function saveGuru(token, guruData) {
  const lock = LockService.getDocumentLock();
  lock.waitLock(15000);
  try {
    const { spreadsheetID } = validateAdminSession(token);
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getGuruSheet(ss);
    const data = sheet.getDataRange().getValues();

    // --- PERUBAHAN LOGIKA ---
    // 'mapelIds' sekarang adalah objek JSON
    const mapelKelasJSON = JSON.stringify(guruData.mapelKelas); 
    // --- AKHIR PERUBAHAN ---

    let rowIndex = -1;
    if (guruData.mode === 'edit') {
       for (let i = 1; i < data.length; i++) {
         if (data[i][0] === guruData.originalEmail) {
           rowIndex = i + 1;
           break;
         }
       }
       if (rowIndex === -1) return { status: "gagal", message: "Guru tidak ditemukan untuk diedit." };
    } else {
       for (let i = 1; i < data.length; i++) {
         if (data[i][0] === guruData.email) return { status: "gagal", message: "Email guru sudah terdaftar." };
       }
    }

    if (guruData.mode === 'add') {
      if (!guruData.password) return { status: "gagal", message: "Password wajib untuk guru baru." };
      const newSalt = generateSalt();
      const newHash = hashPassword(guruData.password, newSalt);
      // --- PERUBAHAN DISINI ---
      sheet.appendRow([guruData.email, guruData.nama, newHash, newSalt, mapelKelasJSON]);
    } else {
      // Mode Edit
      sheet.getRange(rowIndex, 1).setValue(guruData.email);
      sheet.getRange(rowIndex, 2).setValue(guruData.nama);
      // --- PERUBAHAN DISINI ---
      sheet.getRange(rowIndex, 5).setValue(mapelKelasJSON); // Update mapel

      if (guruData.password) {
        const newSalt = generateSalt();
        const newHash = hashPassword(guruData.password, newSalt);
        sheet.getRange(rowIndex, 3).setValue(newHash);
        sheet.getRange(rowIndex, 4).setValue(newSalt);
      }
    }

    return { status: "sukses", message: "Data guru berhasil disimpan." };
  } catch (e) {
    return { status: "gagal", message: e.message };
  } finally {
    lock.releaseLock();
  }
}

function deleteGuru(token, emailGuru) {
  const lock = LockService.getDocumentLock();
  lock.waitLock(15000);
  try {
    const { spreadsheetID } = validateAdminSession(token);
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getGuruSheet(ss);
    const data = sheet.getDataRange().getValues();
    
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] === emailGuru) {
        sheet.deleteRow(i + 1);
        return { status: "sukses", message: "Guru berhasil dihapus." };
      }
    }
    return { status: "gagal", message: "Guru tidak ditemukan." };
  } catch (e) {
    return { status: "gagal", message: e.message };
  } finally {
    lock.releaseLock();
  }
}

function getGuruTemplateData(token) {
  let tempSpreadsheetId = null;
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    const ss = SpreadsheetApp.openById(spreadsheetID);
    
    // --- PERBAIKAN DI SINI ---
    const mapelList = _getMapelInternal(ss, sessionData.sekolahID);
    // --- AKHIR PERBAIKAN ---
    
    const namaSekolah = sessionData.namaSekolah;
    const timestamp = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "yyyyMMdd_HHmmss");
    const tempFileName = `[TEMP] Template Guru - ${namaSekolah} - ${timestamp}`;
    
    const tempSS = SpreadsheetApp.create(tempFileName);
    tempSpreadsheetId = tempSS.getId();
    
    const sheetTemplate = tempSS.getSheetByName('Sheet1');
    sheetTemplate.setName('Template Guru');
    
    const sheetMapel = tempSS.insertSheet('Daftar Mapel');
    
    sheetMapel.appendRow(['KODE MAPEL', 'NAMA MATA PELAJARAN']);
    if (mapelList.length > 0) {
      const mapelData = mapelList.map(m => [m.id, m.nama]);
      sheetMapel.getRange(2, 1, mapelData.length, 2).setValues(mapelData);
      sheetMapel.autoResizeColumns(1, 2);
    }
    sheetMapel.setFrozenRows(1);
    
    sheetTemplate.appendRow(['NamaGuru', 'Email', 'Password', 'MapelIDs']);
    sheetTemplate.appendRow([
      'Budi Santoso, S.Pd.', 
      'budi.santoso@email.com', 
      'PasswordMin8Karakter', 
      'PAI,MTK,BIN'
    ]);
    sheetTemplate.getRange('A1:D1').setFontWeight('bold');
    
    const helpText = "Kolom A, B, dan C wajib diisi. Kolom D (MapelIDs) diisi dengan KODE MAPEL dari sheet 'Daftar Mapel'. Pisahkan beberapa kode mapel dengan koma (,) tanpa spasi.";
    sheetTemplate.getRange('A3').setValue(helpText).setFontStyle('italic').setFontColor('#666');
    sheetTemplate.getRange('A3:D3').merge();
    
    sheetTemplate.getRange('D:D').setNumberFormat('@');
    sheetTemplate.autoResizeColumns(1, 4);
    
    SpreadsheetApp.flush(); 

    const url = "https://docs.google.com/spreadsheets/d/" + tempSpreadsheetId + "/export?format=xlsx";
    const oauthToken = ScriptApp.getOAuthToken();
    const response = UrlFetchApp.fetch(url, { headers: { 'Authorization': 'Bearer ' + oauthToken } });
    
    const fileNameOutput = `template_import_guru_${namaSekolah}.xlsx`;
    
    return { 
      status: "sukses", 
      base64: Utilities.base64Encode(response.getBlob().getBytes()), 
      mimeType: MimeType.MICROSOFT_EXCEL, 
      fileName: fileNameOutput 
    };
    
  } catch (e) {
    return { status: "gagal", message: "Gagal membuat template: " + e.message };
  } finally {
    if (tempSpreadsheetId) DriveApp.getFileById(tempSpreadsheetId).setTrashed(true);
  }
}

function prosesImportExcelGuru(token, fileData) {
  let tempExcelFileId = null;
  let tempConvertedSheetId = null;
  
  try {
    const { spreadsheetID } = validateAdminSession(token);
    const ss = SpreadsheetApp.openById(spreadsheetID);
    
    const sheetGuru = getGuruSheet(ss);
    const dataGuru = sheetGuru.getDataRange().getValues();
    const existingEmailSet = new Set();
    for(let i=1; i < dataGuru.length; i++) {
      existingEmailSet.add(String(dataGuru[i][0]).trim().toLowerCase());
    }

    // --- PERBAIKAN DI SINI ---
    const mapelList = _getMapelInternal(ss, spreadsheetID);
    // --- AKHIR PERBAIKAN ---
    
    const validMapelIdSet = new Set(mapelList.map(m => m.id));

    const { base64, mimeType, fileName } = fileData;
    const decodedData = Utilities.base64Decode(base64.split(',')[1]);
    const blob = Utilities.newBlob(decodedData, mimeType, fileName);
    
    const tempExcelFile = DriveApp.createFile(blob);
    tempExcelFileId = tempExcelFile.getId();
    const conversionResource = { title: `[TEMP] Import Guru - ${fileName}`, mimeType: MimeType.GOOGLE_SHEETS };
    const convertedFile = Drive.Files.copy(conversionResource, tempExcelFileId, { convert: true });
    tempConvertedSheetId = convertedFile.id;
    
    const tempSheet = SpreadsheetApp.openById(tempConvertedSheetId);
    const dataSheet = tempSheet.getSheetByName('Template Guru');
    if (!dataSheet) {
      throw new Error("File Excel tidak valid. Sheet 'Template Guru' tidak ditemukan.");
    }
    
    const excelData = dataSheet.getDataRange().getValues();
    if (excelData.length <= 1) {
      throw new Error("File Excel kosong atau hanya berisi header.");
    }
    
    excelData.shift(); 

    const gagalList = [];
    const rowsToAppend = [];
    
    for (let i = 0; i < excelData.length; i++) {
      const row = excelData[i];
      const barisKe = i + 2;
      
      const nama = (row[0] ? String(row[0]) : '').trim();
      const email = (row[1] ? String(row[1]) : '').trim().toLowerCase();
      const password = (row[2] ? String(row[2]) : '');
      const mapelIdsStr = (row[3] ? String(row[3]) : '').trim();

      if (!nama || !email || !password) {
        gagalList.push({ baris: barisKe, nama: nama, email: email, alasan: "Nama, Email, atau Password kosong." });
        continue;
      }
      
      if (existingEmailSet.has(email)) {
        gagalList.push({ baris: barisKe, nama: nama, email: email, alasan: "Email sudah terdaftar." });
        continue;
      }

      if (password.length < 8) {
         gagalList.push({ baris: barisKe, nama: nama, email: email, alasan: "Password kurang dari 8 karakter." });
         continue;
      }

      const mapelIds = mapelIdsStr.split(',').map(id => id.trim()).filter(id => id);
      let mapelValid = true;
      let mapelInvalid = '';
      
      for (const id of mapelIds) {
        if (!validMapelIdSet.has(id)) {
          mapelValid = false;
          mapelInvalid = id;
          break;
        }
      }

      if (!mapelValid) {
        gagalList.push({ baris: barisKe, nama: nama, email: email, alasan: `Kode Mapel '${mapelInvalid}' tidak valid.` });
        continue;
      }

      const newSalt = generateSalt();
      const newHash = hashPassword(password, newSalt);
      const finalMapelIdsStr = mapelIds.join(',');

      rowsToAppend.push([email, nama, newHash, newSalt, finalMapelIdsStr]);
      existingEmailSet.add(email);
    }

    if (rowsToAppend.length > 0) {
      sheetGuru.getRange(sheetGuru.getLastRow() + 1, 1, rowsToAppend.length, rowsToAppend[0].length)
        .setValues(rowsToAppend);
    }

    DriveApp.getFileById(tempExcelFileId).setTrashed(true);
    DriveApp.getFileById(tempConvertedSheetId).setTrashed(true);
    
    return {
      status: "sukses",
      totalDiProses: excelData.length,
      berhasilDiUpload: rowsToAppend.length,
      gagalDiUpload: gagalList.length,
      dataGagal: gagalList
    };
    
  } catch (e) {
    if (tempExcelFileId) { try { DriveApp.getFileById(tempExcelFileId).setTrashed(true); } catch (err) {} }
    if (tempConvertedSheetId) { try { DriveApp.getFileById(tempConvertedSheetId).setTrashed(true); } catch (err) {} }
    return { status: "gagal", message: "Terjadi error: " + e.message };
  }
}

/**
 * Mengambil pengaturan batas waktu input guru dari sheet Pengaturan.
 */
function getPengaturanGuru(token) {
  try {
    const { spreadsheetID } = validateAdminSession(token);
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getPengaturanSheet(ss);
    const data = sheet.getRange('A1:B' + sheet.getLastRow()).getValues();
    
    // --- TAMBAHAN BARU ---
    // 1. Dapatkan timezone dari spreadsheet, bukan dari script
    const spreadsheetTimeZone = ss.getSpreadsheetTimeZone(); 
    // 2. Tentukan format yang TEPAT untuk <input type="datetime-local">
    const formatString = "yyyy-MM-dd'T'HH:mm";
    // --- AKHIR TAMBAHAN ---
    
    let pengaturan = {
      isAktif: false,
      tanggalMulai: '',
      tanggalTutup: ''
    };

    for (let i = 0; i < data.length; i++) {
      if (data[i][0] === 'Guru_Input_Aktif') {
        pengaturan.isAktif = data[i][1] === true;
      
      } else if (data[i][0] === 'Guru_Input_Mulai') {
        
        // --- PERBAIKAN DI SINI ---
        // Menggunakan Utilities.formatDate alih-alih .toISOString()
        if (data[i][1] instanceof Date) {
          pengaturan.tanggalMulai = Utilities.formatDate(data[i][1], spreadsheetTimeZone, formatString);
        } else {
          pengaturan.tanggalMulai = '';
        }
        // --- AKHIR PERBAIKAN ---

      } else if (data[i][0] === 'Guru_Input_Tutup') {
        
        // --- PERBAIKAN DI SINI ---
        // Menggunakan Utilities.formatDate alih-alih .toISOString()
        if (data[i][1] instanceof Date) {
          pengaturan.tanggalTutup = Utilities.formatDate(data[i][1], spreadsheetTimeZone, formatString);
        } else {
          pengaturan.tanggalTutup = '';
        }
        // --- AKHIR PERBAIKAN ---
      }
    }
    
    return { status: "sukses", pengaturan: pengaturan };

  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

/**
 * Menyimpan pengaturan batas waktu input guru.
 */
function savePengaturanGuru(token, pengaturan) {
  try {
    const { spreadsheetID } = validateAdminSession(token);
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getPengaturanSheet(ss);
    const data = sheet.getRange('A1:B' + sheet.getLastRow()).getValues();

    const settingsMap = new Map(data.map(row => [row[0], row[1]]));
    settingsMap.set('Guru_Input_Aktif', pengaturan.isAktif);
    settingsMap.set('Guru_Input_Mulai', pengaturan.isAktif && pengaturan.tanggalMulai ? new Date(pengaturan.tanggalMulai) : null);
    settingsMap.set('Guru_Input_Tutup', pengaturan.isAktif && pengaturan.tanggalTutup ? new Date(pengaturan.tanggalTutup) : null);

    // Hapus baris lama
    sheet.getRange('A1:B' + sheet.getLastRow()).clearContent();
    
    // Tulis ulang semua
    const newData = Array.from(settingsMap.entries());
    sheet.getRange(1, 1, newData.length, 2).setValues(newData);

    return { status: "sukses", message: "Pengaturan waktu input guru berhasil disimpan." };

  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

/**
 * Memeriksa apakah input guru saat ini diizinkan berdasarkan pengaturan.
 * @param {GoogleAppsScript.Spreadsheet.Spreadsheet} ss - Spreadsheet yang aktif.
 * @returns {Object} { diizinkan: boolean, pesan: string }
 */
function cekWaktuInputGuru(ss) {
  try {
    const sheet = getPengaturanSheet(ss);
    const data = sheet.getRange('A1:B' + sheet.getLastRow()).getValues();
    
    let isAktif = false;
    let tanggalMulai = null;
    let tanggalTutup = null;

    for (let i = 0; i < data.length; i++) {
      if (data[i][0] === 'Guru_Input_Aktif') {
        isAktif = data[i][1] === true;
      } else if (data[i][0] === 'Guru_Input_Mulai') {
        if (data[i][1] instanceof Date) tanggalMulai = data[i][1];
      } else if (data[i][0] === 'Guru_Input_Tutup') {
        if (data[i][1] instanceof Date) tanggalTutup = data[i][1];
      }
    }
    
    // --- PERUBAHAN UTAMA DI SINI ---
    // Jika tidak aktif, langsung blokir.
    if (!isAktif) {
      return { diizinkan: false, pesan: "Admin belum mengaktifkan izin input nilai untuk guru." };
    }
    // --- AKHIR PERUBAHAN ---

    const now = new Date();

    // Cek tanggal hanya jika 'isAktif' adalah true
    if (tanggalMulai && now < tanggalMulai) {
      const tglMulaiStr = Utilities.formatDate(tanggalMulai, Session.getScriptTimeZone(), "dd MMM yyyy 'pukul' HH:mm");
      return { diizinkan: false, pesan: `Input nilai belum dibuka. Akan dibuka pada ${tglMulaiStr}.` };
    }
    
    if (tanggalTutup && now > tanggalTutup) {
      const tglTutupStr = Utilities.formatDate(tanggalTutup, Session.getScriptTimeZone(), "dd MMM yyyy 'pukul' HH:mm");
      return { diizinkan: false, pesan: `Waktu input nilai sudah ditutup sejak ${tglTutupStr}.` };
    }

    // Jika aktif, dan lolos cek tanggal (atau tanggal kosong)
    return { diizinkan: true, pesan: "Input diizinkan." };

  } catch (e) {
    Logger.log("Error cekWaktuInputGuru: " + e.message);
    // Gagal-safe: Asumsikan TIDAK diizinkan jika terjadi error
    return { diizinkan: false, pesan: "Gagal memvalidasi izin input. Hubungi Admin." };
  }
}

/**
 * Helper untuk membuat password acak sederhana.
 */
function generateRandomPassword() {
  const chars = 'abcdefghjkmnpqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let password = '';
  for (let i = 0; i < 8; i++) {
    password += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return password;
}

/**
 * [ADMIN] Membuat data kartu login untuk SEMUA guru.
 * PENTING: Ini akan MENGGANTI (RESET) semua password guru yang ada.
 * VERSI REVISI: Menambahkan NPSN sekolah ke data respons.
 */
function generateGuruLoginCards(token) {
  const lock = LockService.getDocumentLock();
  lock.waitLock(30000); // Kunci dokumen selama 30 detik
  
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token); // Ambil spreadsheetID
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getGuruSheet(ss);
    
    // --- TAMBAHAN BARU: Ambil NPSN ---
    const sheetDataSekolah = getDataSekolahSheet(ss); // Fungsi ini sudah ada
    const npsn = sheetDataSekolah.getRange('B2').getValue() || 'N/A'; // Kolom B adalah NPSN
    // --- AKHIR TAMBAHAN ---

    const dataRange = sheet.getRange(2, 1, sheet.getLastRow() - 1, 4); // Kolom A-D (Email, Nama, Hash, Salt)
    const data = dataRange.getValues();
    
    const cardData = [];
    const updatedData = [];

    for (let i = 0; i < data.length; i++) {
      const email = data[i][0];
      const nama = data[i][1];
      
      if (!email || !nama) {
        continue; // Lewati baris kosong
      }

      // 1. Buat password baru
      const newPassword = generateRandomPassword();
      
      // 2. Buat hash & salt baru
      const newSalt = generateSalt();
      const newHash = hashPassword(newPassword, newSalt);
      
      // 3. Siapkan data untuk ditulis kembali ke sheet
      updatedData.push([email, nama, newHash, newSalt]);
      
      // 4. Siapkan data untuk dikirim ke klien (dengan password plain text baru)
      cardData.push({
        email: email,
        nama: nama,
        newPassword: newPassword
      });
    }

    // 5. Tulis SEMUA password baru ke sheet dalam satu operasi
    if (updatedData.length > 0) {
      sheet.getRange(2, 1, updatedData.length, 4).setValues(updatedData);
    }

    // --- PERUBAHAN DI SINI: Tambahkan npsn ke respons ---
    return { status: "sukses", cardData: cardData, npsn: npsn };

  } catch (e) {
    Logger.log("Error generateGuruLoginCards: " + e.message);
    return { status: "gagal", message: e.message };
  } finally {
    lock.releaseLock();
  }
}

/**
 * [ADMIN] Menyinkronkan data MapelKelasJSON semua guru ke ["*"] (Semua Kelas).
 * Hanya berjalan jika total kelas di sekolah = 1.
 */
function syncGuruClassesToSingleClass(token) {
  const lock = LockService.getDocumentLock();
  lock.waitLock(15000);
  
  try {
    const { spreadsheetID } = validateAdminSession(token);
    const ss = SpreadsheetApp.openById(spreadsheetID);
    
    // 1. Validasi bahwa hanya ada 1 kelas
    const sheetKelas = getKelasSheet(ss);
    const totalKelas = sheetKelas.getLastRow() - 1; // Kurangi header
    if (totalKelas !== 1) {
      throw new Error(`Fitur ini hanya dapat digunakan jika Anda memiliki TEPAT SATU kelas terdaftar. (Terdeteksi: ${totalKelas} kelas)`);
    }

    // 2. Proses sheet Guru
    const sheetGuru = getGuruSheet(ss);
    if (sheetGuru.getLastRow() <= 1) {
      return { status: "sukses", message: "Tidak ada data guru untuk disinkronkan." };
    }

    const dataRange = sheetGuru.getRange(2, 1, sheetGuru.getLastRow() - 1, 5); // Kolom A sampai E
    const values = dataRange.getValues();
    
    let changesMade = 0;
    let newJsonValues = []; // Array untuk menampung JSON baru

    for (let i = 0; i < values.length; i++) {
      const mapelKelasJSON = values[i][4]; // Kolom E
      
      if (!mapelKelasJSON) {
        newJsonValues.push([null]); // Jika kosong, biarkan kosong
        continue;
      }

      try {
        const mapelData = JSON.parse(mapelKelasJSON);
        const mapelKeys = Object.keys(mapelData);

        if (mapelKeys.length === 0) {
          newJsonValues.push([mapelKelasJSON]); // Jika JSON kosong, biarkan
          continue;
        }

        let needsSync = false;
        const newData = {};

        // Buat ulang data baru
        for (const key of mapelKeys) {
          newData[key] = ["*"]; // Atur ke "Semua Kelas"
          
          // Cek apakah data lama "kotor"
          const val = mapelData[key];
          if (!Array.isArray(val) || val.length !== 1 || val[0] !== "*") {
            needsSync = true; // Tandai jika datanya BUKAN ["*"]
          }
        }

        if (needsSync) {
          changesMade++;
          newJsonValues.push([JSON.stringify(newData)]); // Simpan JSON baru
        } else {
          newJsonValues.push([mapelKelasJSON]); // Data sudah bersih, simpan yang lama
        }
        
      } catch (e) {
        newJsonValues.push([mapelKelasJSON]); // Gagal parse, biarkan data aslinya
      }
    }

    // 3. Tulis kembali data JSON yang sudah bersih secara batch
    if (changesMade > 0) {
      sheetGuru.getRange(2, 5, newJsonValues.length, 1).setValues(newJsonValues);
    }
    
    return { status: "sukses", message: `Sinkronisasi selesai. ${changesMade} data guru diperbarui.` };

  } catch (e) {
    return { status: "gagal", message: e.message };
  } finally {
    lock.releaseLock();
  }
}

/**
 * [ADMIN] Mendapatkan detail status donasi saat ini.
 */
function getDonasiStatusDetail(token) {
  try {
    const { sessionData } = validateAdminSession(token); // Ini sudah refresh sesi
    
    // Siapkan data dasar untuk dikirim
    const adminData = {
      email: "", // Kita akan ambil ini di bawah
      namaSekolah: sessionData.namaSekolah
    };

    // Jika tidak NONE, ambil detail lengkap dari Master Sheet
    const masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
    const sheetSekolah = masterSS.getSheetByName('Sheet_Sekolah');
    const dataSekolah = sheetSekolah.getDataRange().getValues();
    
    let donasiDetail = { status: "NONE" };

    for (let i = 1; i < dataSekolah.length; i++) {
      if (dataSekolah[i][0] === sessionData.sekolahID) {
        
        adminData.email = dataSekolah[i][3]; // Ambil email dari Kolom D
        
        const donasiStatus = dataSekolah[i][8] || "NONE";
        
        if (donasiStatus !== "NONE") {
            const fileId = dataSekolah[i][9]; // Kolom J (FileID)
            let fileUrl = null;
            if (fileId) {
              try {
                // Buat link view sementara
                const file = DriveApp.getFileById(fileId);
                fileUrl = file.getDownloadUrl().replace("&export=download", ""); // Dapatkan link viewer
              } catch (e) {
                Logger.log("Gagal get file URL untuk donasi: " + e.message);
              }
            }
            
            donasiDetail = {
                status: donasiStatus,     // Kolom I
                fileId: fileId,
                fileUrl: fileUrl,
                dataJson: dataSekolah[i][10],  // Kolom K
                alasan: dataSekolah[i][11]   // Kolom L
            };
        }
        break; // Hentikan loop setelah sekolah ditemukan
      }
    }
    
    // Kembalikan kedua objek
    return { status: "sukses", donasi: donasiDetail, admin: adminData };

  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

/**
 * [ADMIN] Mengirimkan formulir donasi.
 */
function submitDonasi(token, fileData, formDataJSON) {
  const lock = LockService.getScriptLock();
  lock.waitLock(15000);
  try {
    const { sessionData } = validateAdminSession(token);
    
    // 1. Upload file bukti
    const { base64, mimeType, fileName } = fileData;
    const decodedData = Utilities.base64Decode(base64.split(',')[1]);
    const blob = Utilities.newBlob(decodedData, mimeType, `[${sessionData.namaSekolah}] - ${fileName}`);
    
    const folder = DriveApp.getFolderById(DONASI_FOLDER_ID);
    const newFile = folder.createFile(blob);
    const newFileId = newFile.getId();
    
    // 2. Update Master Sheet
    const masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
    const sheetSekolah = masterSS.getSheetByName('Sheet_Sekolah');
    const dataSekolah = sheetSekolah.getDataRange().getValues();
    
    let rowToUpdate = -1;
    let oldFileId = null;
    for (let i = 1; i < dataSekolah.length; i++) {
      if (dataSekolah[i][0] === sessionData.sekolahID) {
        rowToUpdate = i + 1;
        oldFileId = dataSekolah[i][9]; // Kolom J (FileID lama)
        break;
      }
    }
    
    if (rowToUpdate === -1) {
      throw new Error("Gagal menemukan data sekolah Anda.");
    }
    
    // 3. Hapus file lama jika ada
    if (oldFileId) {
      try { DriveApp.getFileById(oldFileId).setTrashed(true); } catch(e) {}
    }
    
    // 4. Tulis data baru
    sheetSekolah.getRange(rowToUpdate, 9, 1, 4).setValues([[
      "PENDING",      // Kolom I (Status)
      newFileId,      // Kolom J (FileID)
      formDataJSON,   // Kolom K (Data Form)
      ""              // Kolom L (Alasan)
    ]]);
    
    clearMasterSheetCache();
    
    return { status: "sukses", donasiStatus: "PENDING" };
    
  } catch (e) {
    return { status: "gagal", message: e.message };
  } finally {
    lock.releaseLock();
  }
}

/**
 * [ADMIN] Membatalkan donasi yang sedang pending.
 */
function batalkanDonasi(token) {
  const lock = LockService.getScriptLock();
  lock.waitLock(15000);
  try {
    const { sessionData } = validateAdminSession(token);

    const masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
    const sheetSekolah = masterSS.getSheetByName('Sheet_Sekolah');
    const dataSekolah = sheetSekolah.getDataRange().getValues();
    
    let rowToUpdate = -1;
    let fileToTrash = null;
    for (let i = 1; i < dataSekolah.length; i++) {
      if (dataSekolah[i][0] === sessionData.sekolahID) {
        if (dataSekolah[i][8] === "PENDING") { // Hanya bisa batalkan yg PENDING
          rowToUpdate = i + 1;
          fileToTrash = dataSekolah[i][9]; // Kolom J (FileID)
        }
        break;
      }
    }
    
    if (rowToUpdate === -1) {
      throw new Error("Gagal menemukan data donasi pending.");
    }

    if (fileToTrash) {
      try { DriveApp.getFileById(fileToTrash).setTrashed(true); } catch(e) {}
    }
    
    sheetSekolah.getRange(rowToUpdate, 9, 1, 4).setValues([[
      "NONE", // Kolom I (Status)
      "",     // Kolom J (FileID)
      "",     // Kolom K (Data Form)
      ""      // Kolom L (Alasan)
    ]]);
    
    clearMasterSheetCache();
    
    return { status: "sukses", donasiStatus: "NONE" };
    
  } catch (e) {
    return { status: "gagal", message: e.message };
  } finally {
    lock.releaseLock();
  }
}

/**
 * [SUPERADMIN] Mengambil daftar donasi yang PENDING.
 */
function getDonasiList(token) {
  try {
    validateSuperadminSession(token);
    const dataSekolah = getCachedMasterSheetData();
    dataSekolah.shift(); // Hapus header
    
    const pendingList = [];
    
    for (const row of dataSekolah) {
      const donasiStatus = row[8]; // Kolom I
      if (donasiStatus === "PENDING") {
        const fileId = row[9]; // Kolom J
        let fileUrl = null;
        if (fileId) {
          try {
            const file = DriveApp.getFileById(fileId);
            file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW); // Pastikan SA bisa lihat
            fileUrl = file.getDownloadUrl().replace("&export=download", ""); // Dapatkan link viewer
          } catch (e) {
            fileUrl = "ERROR: " + e.message;
          }
        }
        
        pendingList.push({
          sekolahID: row[0],
          namaSekolah: row[1],
          dataJson: row[10], // Kolom K
          fileUrl: fileUrl
        });
      }
    }
    
    return { status: "sukses", pendingList: pendingList };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

/**
 * [SUPERADMIN] Memverifikasi (Setujui/Tolak) donasi.
 */
function verifikasiDonasi(token, sekolahID, isApproved, alasan) {
  const lock = LockService.getScriptLock();
  lock.waitLock(15000);
  try {
    validateSuperadminSession(token);
    
    if (!sekolahID) throw new Error("SekolahID tidak ada.");
    if (!isApproved && !alasan) throw new Error("Alasan penolakan wajib diisi.");

    const masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
    const sheetSekolah = masterSS.getSheetByName('Sheet_Sekolah');
    const dataSekolah = sheetSekolah.getDataRange().getValues();
    
    let rowToUpdate = -1;
    for (let i = 1; i < dataSekolah.length; i++) {
      if (dataSekolah[i][0] === sekolahID) {
        rowToUpdate = i + 1;
        break;
      }
    }
    
    if (rowToUpdate === -1) {
      throw new Error("Gagal menemukan data sekolah.");
    }
    
    if (isApproved) {
      sheetSekolah.getRange(rowToUpdate, 9).setValue("APPROVED"); // Kolom I
      sheetSekolah.getRange(rowToUpdate, 12).setValue("");      // Kolom L
    } else {
      sheetSekolah.getRange(rowToUpdate, 9).setValue("REJECTED"); // Kolom I
      sheetSekolah.getRange(rowToUpdate, 12).setValue(alasan); // Kolom L
    }
    
    clearMasterSheetCache();
    
    return { status: "sukses", message: "Verifikasi berhasil disimpan." };

  } catch (e) {
    return { status: "gagal", message: e.message };
  } finally {
    lock.releaseLock();
  }
}

/**
 * [INTERNAL HELPER BARU]
 * Mengambil data siswa dari cache atau (jika cache kosong) dari sheet.
 * Ini menggantikan logika yang sebelumnya terduplikat di banyak fungsi.
 */
function _getSiswaInternal(spreadsheetID, sekolahID) {
  const cacheKey = SISWA_CACHE_KEY + "_" + sekolahID;
  const scriptCache = CacheService.getScriptCache();
  const cachedSiswa = scriptCache.get(cacheKey);

  if (cachedSiswa != null) {
    // 1. Ditemukan di cache, kembalikan data cache
    return JSON.parse(cachedSiswa);
  }

  // 2. Tidak ada di cache, ambil dari sheet
  Logger.log("CACHE MISS: _getSiswaInternal untuk " + sekolahID);
  const ss = SpreadsheetApp.openById(spreadsheetID);
  const sheet = getSiswaSheet(ss);
  const data = sheet.getDataRange().getValues();
  data.shift(); // Hapus header
  
  const siswaList = data.map(row => {
    const idNum = parseInt((row[0] || 'SIS-0').split('-')[1] || 0);
    return {
      id: row[0],
      nama: row[1],
      nisn: row[2],
      nisLokal: row[3] || '',
      jk: row[4] || '',
      tempatLahir: row[5] || '',
      tglLahir: (row[6] instanceof Date) ? Utilities.formatDate(row[6], Session.getScriptTimeZone(), "yyyy-MM-dd") : (row[6] || ''),
      kelas: row[7] || '',
      urutan: row[8] || idNum
    };
  });
  
  // Urutkan data sebelum disimpan ke cache
  siswaList.sort((a, b) => {
    const kelasCompare = a.kelas.localeCompare(b.kelas);
    if (kelasCompare !== 0) return kelasCompare;
    return (Number(a.urutan) || 0) - (Number(b.urutan) || 0);
  });
  
  // 3. Simpan ke cache untuk panggilan berikutnya
  scriptCache.put(cacheKey, JSON.stringify(siswaList), 3600); // Cache 1 jam
  return siswaList;
}
