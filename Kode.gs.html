// --- TAMBAHAN BARU ---
const SHEET_SUPERADMIN = "Sheet_Superadmin";
// --- AKHIR TAMBAHAN ---

const MASTER_SHEET_ID = "191TzI0vRzK8xg7kGym8qUnvXz_edlCH_IJmmwMZMK_M"; 
const TARGET_FOLDER_ID = "1Xu9vSZQKAxVCNDuAXI8W5l-3xb58cQm9";

const MASTER_SHEET_CACHE_KEY = 'MASTER_SHEET_DATA_V1';

const MAPEL_CACHE_KEY = 'mapel_data_v1';
const SISWA_CACHE_KEY = 'siswa_data_v1';
const NILAI_GRID_CACHE_KEY_PREFIX = 'nilai_grid_v1_';
const REKAP_NILAI_CACHE_KEY = 'rekap_nilai_v1';
const NILAI_RAPOR_GRID_CACHE_KEY_PREFIX = 'nilai_rapor_grid_v1_';
const REKAP_NILAI_RAPOR_CACHE_KEY = 'rekap_nilai_rapor_v1';

const TEMPLATE_SISWA_FILENAME = "template_import_siswa.xlsx";
const TEMPLATE_SISWA_MIMETYPE = MimeType.MICROSOFT_EXCEL;

const SHEET_REGISTRASI_PENDING = "Registrasi_Pending";
const TOKEN_EXPIRY_HOURS = 24; // Token berlaku 24 jam

const LOCKED_KELAS_CACHE_KEY = 'locked_kelas_v1';

const NILAI_IJAZAH_CACHE_KEY = 'nilai_ijazah_v1';

const SHEET_CACHE_IJAZAH = "Cache_Rekap_Ijazah";

const MASTER_NISN_INDEX_KEY = 'master_nisn_index_v1';
const HASIL_KELULUSAN_PREFIX = 'hasil_kelulusan_v1_';

const MASTER_KELULUSAN_DB_ID = "1f0xj0-tfK7hlEnAV-pIySfj_K4o46vjGV6iqo6toZRI";

// GANTI DENGAN ID FILE YANG ANDA SALIN DARI LANGKAH 2
const TEMPLATE_SISWA_FILE_ID = "1jITh9Ss5DsesT35RN-R3DDvI1AZDIi8M57F4nTLZoeM";

/**
 * [HELPER] Kunci Cache dan Nilai Default untuk Konfigurasi Sekolah
 * Tambahkan ini di bagian atas file Anda, dekat konstanta lainnya.
 */
const CONFIG_CACHE_KEY = 'sekolah_config_v1_';
const DEFAULTS_CONFIG = {
  bobotRapor: 60,
  bobotUjian: 40,
  kkm: 76,
  jumlahSemester: 5,
  jenjangPilihan: '',
  npsn: '',
  nsm: '',
  alamat: '',
  provinsi: '',
  kabKot: '',
  pilihanKabKot: 'Kabupaten',
  kecamatan: '',
  kelDes: '',
  pilihanKelDes: 'Kelurahan',
  kodePos: '',
  telepon: '',
  email: '',
  website: '',
  namaKepsek: '',
  nipKepsek: ''
};

/**
 * FUNGSI SATU KALI JALAN: Untuk menyimpan kredensial Firestore dengan aman.
 * 1. Buka file JSON yang Anda download dari Firebase.
 * 2. Salin nilai "project_id".
 * 3. Salin nilai "client_email".
 * 4. Salin nilai "private_key" (seluruh string, termasuk "-----BEGIN...-----").
 * 5. JALANKAN fungsi ini SATU KALI dari editor Apps Script.
 * 6. Setelah berhasil, HAPUS nilai-nilai tersebut dari kode agar aman.
 */
function setupFirestoreAuth() {
  // --- TEMPEL KREDENSIAL ANDA DI SINI (HANYA UNTUK 1 KALI RUN) ---
  const project_id = "GANTI_DENGAN_PROJECT_ID_ANDA";
  const client_email = "GANTI_DENGAN_CLIENT_EMAIL_ANDA";
  const private_key = "GANTI_DENGAN_PRIVATE_KEY_ANDA";
  // -----------------------------------------------------------

  if (project_id === "GANTI_DENGAN_PROJECT_ID_ANDA") {
    throw new Error("Harap masukkan kredensial dari file JSON service account Anda ke dalam fungsi setupFirestoreAuth.");
  }

  const scriptProperties = PropertiesService.getScriptProperties();
  scriptProperties.setProperties({
    'firestore_project_id': project_id,
    'firestore_client_email': client_email,
    'firestore_private_key': private_key
  });

  Logger.log("Kredensial Firestore berhasil disimpan di ScriptProperties.");
  Logger.log("PENTING: Sekarang hapus kembali detail kredensial dari dalam fungsi setupFirestoreAuth()!");
}

/**
 * Mengambil instance Firestore yang sudah terautentikasi.
 * (Menggantikan `SpreadsheetApp.openById()_` untuk data nilai)
 */
function getFirestoreInstance() {
  const scriptProperties = PropertiesService.getScriptProperties();
  const project_id = scriptProperties.getProperty('firestore_project_id');
  const client_email = scriptProperties.getProperty('firestore_client_email');
  const private_key = scriptProperties.getProperty('firestore_private_key');

  if (!project_id || !client_email || !private_key) {
    throw new Error("Kredensial Firestore tidak ditemukan. Harap jalankan `setupFirestoreAuth()` terlebih dahulu.");
  }

  const firestore = FirebaseApp.getFirestore(client_email, private_key, project_id);
  
  // Kembalikan instance DAN project_id untuk membangun path manual
  return { firestore: firestore, projectId: project_id }; 
}

/**
 * Mengubah array byte (dari computeDigest) menjadi string heksadesimal.
 */
function bytesToHex(bytes) {
  return bytes.map(byte => {
    return ('0' + (byte & 0xFF).toString(16)).slice(-2);
  }).join('');
}

/**
 * Membuat string salt acak yang unik.
 */
function generateSalt() {
  return Utilities.getUuid();
}

/**
 * Membuat hash SHA-256 dari password dan salt.
 * Mengembalikan hash sebagai string hex.
 */
function hashPassword(password, salt) {
  const digest = Utilities.computeDigest(Utilities.DigestAlgorithm.SHA_256, password + salt, Utilities.Charset.UTF_8);
  return bytesToHex(digest);
}

/**
 * Memverifikasi apakah password inputan cocok dengan hash yang tersimpan.
 */
function verifyPassword(inputPassword, storedHash, storedSalt) {
  const newHash = hashPassword(inputPassword, storedSalt);
  return newHash === storedHash;
}

function getSheetRegistrasiPending(masterSS) {
  let sheet = masterSS.getSheetByName(SHEET_REGISTRASI_PENDING);
  if (!sheet) {
    sheet = masterSS.insertSheet(SHEET_REGISTRASI_PENDING);
    sheet.appendRow(['Email', 'NamaSekolah', 'NPSN', 'Jenjang', 'HashedPassword', 'Salt', 'VerificationToken', 'Timestamp']);
    sheet.setFrozenRows(1);
  } else {
    const header = sheet.getRange(1, 3).getValue();
    if (header !== "NPSN") {
       sheet.insertColumnBefore(3);
       sheet.getRange(1, 3).setValue("NPSN");
    }
  }
  return sheet;
}

function doGet(e) {
  // Cek apakah ada parameter 'v' (untuk verifikasi)
  if (e.parameter.v) {
    const token = e.parameter.v;
    // Proses token dan dapatkan pesan HTML
    const message = prosesVerifikasiToken(token);
    
    // Tampilkan halaman 'verifikasi.html' dan ganti kontennya dengan pesan hasil
    return HtmlService.createTemplateFromFile('verifikasi')
      .evaluate()
      .setTitle('Verifikasi Akun')
      .setContent(`<div>${message}</div>`); // Mengganti konten <body>
  }
  
  // Jika tidak ada parameter 'v', jalankan aplikasi utama seperti biasa
  return HtmlService.createTemplateFromFile('index')
    .evaluate()
    .setTitle('Pengolahan Nilai Ijazah')
    .setFaviconUrl("https://images.icon-icons.com/547/PNG/512/1455554314_line-15_icon-icons.com_53330.png")
    .addMetaTag('viewport', 'width=device-width, initial-scale=1.0');
}

// --- TAMBAHAN BARU ---
/**
 * Mendapatkan atau membuat sheet untuk Superadmin.
 */
function getSheetSuperadmin(masterSS) {
  let sheet = masterSS.getSheetByName(SHEET_SUPERADMIN);
  if (!sheet) {
    sheet = masterSS.insertSheet(SHEET_SUPERADMIN);
    // Email, Nama Tampilan, HashedPassword, Salt
    sheet.appendRow(['Email', 'Nama', 'HashedPassword', 'Salt']);
    sheet.setFrozenRows(1);
    
    // --- BUAT AKUN SUPERADMIN PERTAMA KALI (HANYA SEKALI) ---
    // Ganti 'superadmin@email.com', 'Super Admin', dan 'password_superadmin'
    // Jalankan fungsi ini sekali manual dari editor Apps Script untuk membuat akun.
    // try {
    //   const firstSalt = generateSalt();
    //   const firstHash = hashPassword('password_superadmin', firstSalt);
    //   sheet.appendRow(['superadmin@email.com', 'Super Admin', firstHash, firstSalt]);
    // } catch (e) {}
    // --- AKHIR PEMBUATAN AKUN ---
  }
  return sheet;
}

// --- FUNGSI BARU ---
/**
 * Mengirim email verifikasi ke pengguna.
 */
function kirimEmailVerifikasi(email, namaSekolah, token) {
  try {
    const url = ScriptApp.getService().getUrl() + '?v=' + token;
    const subject = "Verifikasi Akun Aplikasi Nilai Ijazah";
    const body = `
      <div style="font-family: Arial, sans-serif; line-height: 1.6;">
        <p>Halo, Admin ${namaSekolah},</p>
        <p>Terima kasih telah mendaftar di Aplikasi Pengolahan Nilai Ijazah.</p>
        <p>Untuk mengaktifkan akun Anda, silakan klik tombol di bawah ini:</p>
        <p style="margin: 25px 0;">
          <a href="${url}" style="font-size: 16px; font-weight: bold; padding: 12px 20px; background-color: #0d6efd; color: white; text-decoration: none; border-radius: 5px;">
            Aktivasi Akun Saya
          </a>
        </p>
        <p>Jika tombol di atas tidak berfungsi, salin dan tempel URL berikut di browser Anda:</p>
        <p style="word-break: break-all;">${url}</p>
        <p>Link ini akan kedaluwarsa dalam ${TOKEN_EXPIRY_HOURS} jam.</p>
        <br>
        <p>Terima kasih.</p>
      </div>
    `;

    MailApp.sendEmail({
      to: email,
      subject: subject,
      htmlBody: body,
      name: "Admin Aplikasi Ijazah" // Nama pengirim
    });
    Logger.log("Email verifikasi terkirim ke: " + email);
  } catch (e) {
    Logger.log(`Gagal mengirim email verifikasi ke ${email}: ${e.message}`);
    // Sebaiknya jangan gagalkan registrasi jika email gagal, cukup log saja
  }
}

function buatDatabaseSekolahBaru(namaSekolah, jenjang, email, password, masterSS) {
  let newSSID = null; 
  try {
    let targetFolder;
    try {
      targetFolder = DriveApp.getFolderById(TARGET_FOLDER_ID);
    } catch (folderError) {
      Logger.log("Error mengambil folder: " + folderError);
      throw new Error("Error: Folder target tidak ditemukan atau tidak dapat diakses. ID: " + TARGET_FOLDER_ID);
    }

    const namaSekolahUpper = namaSekolah.toUpperCase();
    const newSpreadsheet = SpreadsheetApp.create("Database Nilai - " + namaSekolahUpper); 
    newSSID = newSpreadsheet.getId();
    Logger.log("Spreadsheet baru dibuat (via verifikasi): " + newSSID);

    const newFile = DriveApp.getFileById(newSSID);
    targetFolder.addFile(newFile); 
    DriveApp.getRootFolder().removeFile(newFile); 
    Logger.log("Spreadsheet dipindahkan ke folder: " + targetFolder.getName());

    const defaultSheet = newSpreadsheet.getSheets()[0];
    
    const sheetSiswa = newSpreadsheet.insertSheet('Siswa');
    sheetSiswa.appendRow([
        'SiswaID', 'NamaSiswa', 'NISN', 'NIS_Lokal', 'JenisKelamin', 
        'TempatLahir', 'TglLahir', 'Kelas', 'Urutan'
      ]);
    sheetSiswa.getRange('C:D').setNumberFormat('@');
      
    
    const sheetKelas = newSpreadsheet.insertSheet('Kelas');
    sheetKelas.appendRow(['NamaKelas']); 

    let defaultKelas = '';
    switch (jenjang) {
      case 'SD/MI':
        defaultKelas = 'VI';
        break;
      case 'SMP/MTS':
        defaultKelas = 'IX';
        break;
      case 'SMA/MA':
        defaultKelas = 'XII';
        break;
    }
    
    if (defaultKelas) {
      sheetKelas.appendRow([defaultKelas]);
    }
    
    const sheetMapel = newSpreadsheet.insertSheet('Mapel');
    sheetMapel.appendRow(['MapelID', 'NamaMapel', 'isUS', 'isUP', 'Urutan']); 

    const defaultMapel = getDynamicDefaultMapel(jenjang, masterSS);
    if (defaultMapel.length > 0) {
      sheetMapel.getRange(2, 1, defaultMapel.length, 5).setValues(defaultMapel);
    }

    newSpreadsheet.insertSheet('Nilai_Ujian')
      .appendRow(['SiswaID', 'MapelID', 'UjianMadrasah', 'UjianPraktek']);
      
    newSpreadsheet.insertSheet('Nilai_Rapor_Akhir')
      .appendRow(['SiswaID', 'MapelID', 'SemesterID', 'Nilai_P', 'Nilai_K']);
    
    const sheetSetting = newSpreadsheet.insertSheet('Pengaturan');
    sheetSetting.appendRow(['Setting', 'Value']);
    sheetSetting.appendRow(['Bobot_Rapor', 60]);
    sheetSetting.appendRow(['Bobot_Ujian', 40]);
    sheetSetting.appendRow(['Jumlah_Semester', 5]);
    sheetSetting.appendRow(['KKM', 76]);

    const sheetDataSekolah = newSpreadsheet.insertSheet('Data_Sekolah');
    sheetDataSekolah.appendRow([
      'JenjangPilihan', 'NPSN', 'NSM', 'Alamat', 'Provinsi', 
      'KabKot', 'PilihanKabKot', 'Kecamatan', 'KelDes', 'PilihanKelDes', 
      'KodePos', 'Telepon', 'Email', 'Website', 'NamaKepsek', 'NIPKepsek'
    ]);
    let jenjangPilihanDefault = '';
    if (jenjang === 'SD/MI') {
      jenjangPilihanDefault = 'MI';
    } else if (jenjang === 'SMP/MTS') {
      jenjangPilihanDefault = 'MTS';
    } else if (jenjang === 'SMA/MA') {
      jenjangPilihanDefault = 'MA';
    }
    
    sheetDataSekolah.appendRow([
      jenjangPilihanDefault, 
      '', '', '', '', 
      '', 'Kabupaten', '', '', 'Kelurahan', 
      '', '', '', '', '', ''
    ]);
    sheetDataSekolah.getRange('A2:P2').setNumberFormat('@');

    // --- PERUBAHAN DI SINI ---
    // Mengubah struktur Sheet Cache Ijazah
    const sheetCacheIjazah = newSpreadsheet.insertSheet(SHEET_CACHE_IJAZAH);
    // Baris 1: Header untuk Metadata
    sheetCacheIjazah.appendRow(['Meta', 'LastUpdated', 'BobotRaporPct', 'BobotUjianPct', 'KKM', 'SiswaListJSON', 'MapelListJSON']);
    // Baris 2: Header untuk Data Nilai
    sheetCacheIjazah.appendRow(['SiswaID', 'MapelID', 'UjianAsli', 'RaporAsli', 'UjianBobot', 'RaporBobot', 'IjazahFinal']);
    sheetCacheIjazah.setFrozenRows(2); // Bekukan 2 baris header
    sheetCacheIjazah.hideSheet(); // Sembunyikan sheet
    // --- AKHIR PERUBAHAN ---

    newSpreadsheet.deleteSheet(defaultSheet);
    
    return newSSID;

  } catch (e) {
    Logger.log(e);
    if (newSSID) {
      DriveApp.getFileById(newSSID).setTrashed(true);
    }
    throw new Error("Gagal membuat database: " + e.message);
  }
}

/**
 * [DIGANTI] Memverifikasi token dari Firestore, lalu membuat dokumen di koleksi 'sekolah'.
 * Fungsi ini tidak lagi membutuhkan `masterSS` atau `lock`.
 */
function prosesVerifikasiToken(token) {
  if (!token) {
    return `<h1>Permintaan Tidak Valid</h1>
            <p>Permintaan verifikasi tidak lengkap. Pastikan Anda menggunakan link yang benar dari email.</p>`;
  }
  
  try {
    const { firestore } = getFirestoreInstance();
    const docPath = `registrasi_pending/${token}`;
    
    let pendingDoc;
    try {
      pendingDoc = firestore.getDocument(docPath);
    } catch (e) {
      // Dokumen tidak ada
      return `<h1>Token Tidak Valid</h1>
              <p>Token verifikasi Anda tidak ditemukan. Link ini mungkin sudah digunakan atau tidak valid.</p>`;
    }

    const dataPending = pendingDoc.fields;
    const now = new Date();
    const expiryLimit = new Date(now.getTime() - (TOKEN_EXPIRY_HOURS * 60 * 60 * 1000));
    const timestamp = new Date(parseValue(dataPending.timestamp));

    if (timestamp < expiryLimit) {
      firestore.deleteDocument(docPath); // Hapus token kedaluwarsa
      return `<h1>Token Kedaluwarsa</h1>
              <p>Link verifikasi Anda sudah tidak berlaku (lebih dari ${TOKEN_EXPIRY_HOURS} jam). Untuk keamanan, silakan lakukan registrasi ulang.</p>`;
    }

    const email = parseValue(dataPending.email);
    const namaSekolah = parseValue(dataPending.namaSekolah);
    
    // Cek lagi jika email sudah terdaftar di 'sekolah'
    const emailCheck = firestore.getCollection('sekolah').where('emailAdmin', '==', email).getDocuments();
    if (emailCheck.length > 0) {
      firestore.deleteDocument(docPath); // Hapus token
      const appUrl = ScriptApp.getService().getUrl();
      return `<h1>Akun Sudah Aktif</h1>
              <p>Akun dengan email ini sudah terverifikasi dan aktif. Anda dapat langsung login.</p>
              <a href="${appUrl}" class="button-login">Menuju Halaman Login</a>`;
    }

    // Buat Spreadsheet baru (fungsi ini tidak berubah, `masterSS` diabaikan)
    const newSSID = buatDatabaseSekolahBaru(namaSekolah, parseValue(dataPending.jenjang), email, "dummy", null);
    
    // Buat dokumen sekolah baru di Firestore
    const newSekolahID = "SKL-" + Utilities.getUuid().substring(0, 6).toUpperCase(); // Buat ID unik
    const docSekolahPath = `sekolah/${newSekolahID}`;
    
    const dataSekolah = {
      sekolahID: newSekolahID,
      namaSekolah: namaSekolah,
      jenjang: parseValue(dataPending.jenjang),
      emailAdmin: email,
      hashedPassword: parseValue(dataPending.hashedPassword),
      salt: parseValue(dataPending.salt),
      spreadsheetID: newSSID,
      npsn: parseValue(dataPending.npsn)
    };
    
    firestore.createDocument(docSekolahPath, dataSekolah);
    
    // Hapus dokumen pending
    firestore.deleteDocument(docPath);
    
    const appUrl = ScriptApp.getService().getUrl();
    return `<h1>Verifikasi Berhasil!</h1>
            <p>Akun Anda telah berhasil diaktifkan dan database sekolah Anda telah dibuat.</p>
            <p>Silakan klik tombol di bawah ini untuk masuk ke halaman login.</p>
            <a href="${appUrl}" class="button-login">Menuju Halaman Login</a>`;
    
  } catch (e) {
    Logger.log(e);
    return `<h1>Error Server</h1>
            <p>Terjadi kegagalan di server. Silakan coba lagi beberapa saat, atau hubungi admin jika masalah berlanjut.</p>
            <p style="font-size: 14px; color: #6c757d;">Detail Error: ${e.message}</p>`;
  }
}

function include(filename) {
  return HtmlService.createHtmlOutputFromFile(filename).getContent();
}

function getCachedMasterSheetData() {
  const cache = CacheService.getScriptCache();
  
  let cachedData = cache.get(MASTER_SHEET_CACHE_KEY);
  if (cachedData != null) {
    Logger.log("Mengambil data Master Sheet dari SCRIPT CACHE");
    return JSON.parse(cachedData);
  }
  
  Logger.log("Mengambil data Master Sheet dari SPREADSHEET (Fresh)");
  let masterSS;
  try {
     masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
  } catch (e) {
    Logger.log("Gagal membuka Master Sheet ID: " + MASTER_SHEET_ID + ". Error: " + e.message);
    throw new Error("Database Master tidak dapat diakses. Hubungi Admin.");
  }

  const sheetSekolah = masterSS.getSheetByName('Sheet_Sekolah');
  if (!sheetSekolah) {
    Logger.log("Sheet 'Sheet_Sekolah' tidak ditemukan di Master Sheet.");
    throw new Error("Database Master tidak dikonfigurasi. Hubungi Admin.");
  }
  
  const dataSekolah = sheetSekolah.getDataRange().getValues();
  
  cache.put(MASTER_SHEET_CACHE_KEY, JSON.stringify(dataSekolah), 3600); 
  
  return dataSekolah;
}

function clearLockedKelasCache(sekolahID) {
  try {
    const cacheKey = LOCKED_KELAS_CACHE_KEY + "_" + sekolahID;
    CacheService.getScriptCache().remove(cacheKey);
  } catch (e) {
  }
}

function clearMasterSheetCache() {
  try {
    CacheService.getScriptCache().remove(MASTER_SHEET_CACHE_KEY);
    Logger.log("Cache Master Sheet dibersihkan.");
  } catch (e) {
    Logger.log("Gagal membersihkan cache Master Sheet: " + e.message);
  }
}

function clearRekapNilaiCache(sekolahID) {
  try {
    const cacheKey = REKAP_NILAI_CACHE_KEY + "_" + sekolahID;
    CacheService.getUserCache().remove(cacheKey);
  } catch (e) {
  }
}

function clearNilaiUjianCache(sekolahID) {
  try {
    const userCache = CacheService.getUserCache();
    userCache.remove(NILAI_GRID_CACHE_KEY_PREFIX + 'UM' + "_" + sekolahID);
    userCache.remove(NILAI_GRID_CACHE_KEY_PREFIX + 'Praktek' + "_" + sekolahID);
    clearRekapNilaiCache(sekolahID);
  } catch (e) {
  }
}

function clearRekapNilaiRaporCache(sekolahID) {
  try {
    const cacheKey = REKAP_NILAI_RAPOR_CACHE_KEY + "_" + sekolahID;
    CacheService.getUserCache().remove(cacheKey);
  } catch (e) {
  }
}

function clearNilaiRaporCache(sekolahID) {
  try {
    const userCache = CacheService.getUserCache();
    userCache.remove(REKAP_NILAI_RAPOR_CACHE_KEY + "_" + sekolahID);
    userCache.remove(NILAI_IJAZAH_CACHE_KEY + "_" + sekolahID);
  } catch (e) {
  }
}

function clearSiswaCache(sekolahID) {
  try {
    const cacheKey = SISWA_CACHE_KEY + "_" + sekolahID;
    CacheService.getUserCache().remove(cacheKey);
    clearNilaiUjianCache(sekolahID);
    clearNilaiRaporCache(sekolahID);
  } catch (e) {
  }
}

function clearMapelCache(sekolahID) {
  try {
    const cacheKey = MAPEL_CACHE_KEY + "_" + sekolahID;
    CacheService.getUserCache().remove(cacheKey);
    clearNilaiUjianCache(sekolahID);
    clearNilaiRaporCache(sekolahID);
  } catch (e) {
  }
}

/**
 * [DIGANTI] Memproses login Admin dan Superadmin dari Firestore.
 */
function prosesLogin(email, password) {
  try {
    const { firestore } = getFirestoreInstance();
    email = email.trim().toLowerCase();

    // 1. Cek Superadmin
    // Dokumen superadmin menggunakan email sebagai ID Dokumen
    try {
      const superadminDoc = firestore.getDocument(`superadmin/${email}`);
      if (superadminDoc.fields) {
        const sa = superadminDoc.fields;
        if (verifyPassword(password, parseValue(sa.hashedPassword), parseValue(sa.salt))) {
          const token = Utilities.getUuid();
          const sessionData = {
            role: 'superadmin',
            nama: parseValue(sa.nama),
            lastActivity: new Date().getTime()
          };
          CacheService.getScriptCache().put('SESSION_' + token, JSON.stringify(sessionData), 21600);
          return { status: "sukses", role: "superadmin", nama: parseValue(sa.nama), token: token };
        }
      }
    } catch (e) {
      // Gagal (dokumen tidak ada), lanjutkan cek admin sekolah
    }

    // 2. Cek Admin Sekolah (via Query)
    const sekolahDocs = firestore.getCollection('sekolah')
                                 .where('emailAdmin', '==', email)
                                 .getDocuments();

    if (sekolahDocs.length > 0) {
      const sekolahData = sekolahDocs[0].fields;
      if (verifyPassword(password, parseValue(sekolahData.hashedPassword), parseValue(sekolahData.salt))) {
        
        const token = Utilities.getUuid();
        const sekolahID = parseValue(sekolahData.sekolahID);
        const spreadsheetID = parseValue(sekolahData.spreadsheetID);
        const namaSekolahUpper = parseValue(sekolahData.namaSekolah).toUpperCase();
        
        // Ambil jenjangPilihan dari config sekolah (fungsi dari Langkah 3)
        const config = getSekolahConfigData(sekolahID, spreadsheetID);
        
        const sessionData = {
          role: 'admin',
          sekolahID: sekolahID,
          namaSekolah: namaSekolahUpper,
          jenjang: parseValue(sekolahData.jenjang),
          spreadsheetID: spreadsheetID,
          jenjangPilihan: config.jenjangPilihan, // Dari config
          lastActivity: new Date().getTime()
        };
        CacheService.getScriptCache().put('SESSION_' + token, JSON.stringify(sessionData), 21600);
        return {
          status: "sukses",
          role: "admin",
          namaSekolah: namaSekolahUpper,
          jenjang: sessionData.jenjang,
          jenjangPilihan: config.jenjangPilihan,
          token: token
        };
      }
    }

    // 3. Gagal total
    return { status: "gagal", message: "Email atau password salah." };
  } catch (e) {
    Logger.log(`Gagal prosesLogin (Firestore): ${e.message}`);
    return { status: "gagal", message: "Terjadi error: " + e.message };
  }
}

/**
 * [DIGANTI] Memproses registrasi baru ke koleksi 'registrasi_pending' di Firestore.
 */
function prosesRegistrasi(namaSekolah, npsn, jenjang, email, password) {
  try {
    // Validasi input
    if (!namaSekolah || !npsn || !jenjang || !email || !password) {
      return { status: "gagal", message: "Semua data wajib diisi." };
    }
    if (!/^\d+$/.test(npsn)) {
      return { status: "gagal", message: "NPSN harus berupa angka." };
    }
    if (password.length < 8) {
      return { status: "gagal", message: "Password minimal harus 8 karakter." };
    }
    if (!/[a-z]/.test(password)) {
      return { status: "gagal", message: "Password harus mengandung minimal satu huruf kecil." };
    }
    if (!/[A-Z]/.test(password)) {
      return { status: "gagal", message: "Password harus mengandung minimal satu huruf besar." };
    }
    if (!/\d/.test(password)) {
      return { status: "gagal", message: "Password harus mengandung minimal satu angka." };
    }
    if (!/[^a-zA-Z0-9]/.test(password)) {
      return { status: "gagal", message: "Password harus mengandung minimal satu simbol (contoh: @, #, $, !)." };
    }

    email = email.trim().toLowerCase();
    const { firestore } = getFirestoreInstance();

    // 1. Cek duplikat di koleksi 'sekolah'
    const emailCheck = firestore.getCollection('sekolah').where('emailAdmin', '==', email).getDocuments();
    if (emailCheck.length > 0) {
      return { status: "gagal", message: "Email ini sudah terdaftar dan aktif." };
    }
    const npsnCheck = firestore.getCollection('sekolah').where('npsn', '==', npsn).getDocuments();
    if (npsnCheck.length > 0) {
      return { status: "gagal", message: "NPSN ini sudah terdaftar oleh sekolah lain." };
    }

    // 2. Cek duplikat di koleksi 'registrasi_pending'
    const pendingEmailCheck = firestore.getCollection('registrasi_pending').where('email', '==', email).getDocuments();
    const pendingNpsnCheck = firestore.getCollection('registrasi_pending').where('npsn', '==', npsn).getDocuments();

    const now = new Date();
    const expiryLimit = new Date(now.getTime() - (TOKEN_EXPIRY_HOURS * 60 * 60 * 1000));

    // Cek Npsn dulu
    if (pendingNpsnCheck.length > 0) {
      const pendingDoc = pendingNpsnCheck[0];
      const timestamp = new Date(parseValue(pendingDoc.fields.timestamp));
      if (timestamp < expiryLimit) {
        // Data lama, hapus
        firestore.deleteDocument(pendingDoc.name); // 'name' adalah path lengkap
      } else {
        return { status: "gagal", message: "NPSN ini sudah didaftarkan dan menunggu verifikasi." };
      }
    }
    
    // Cek Email
    if (pendingEmailCheck.length > 0) {
      const pendingDoc = pendingEmailCheck[0];
      const timestamp = new Date(parseValue(pendingDoc.fields.timestamp));
      if (timestamp < expiryLimit) {
        firestore.deleteDocument(pendingDoc.name);
      } else {
        // Kirim ulang email
        const token = pendingDoc.name.split('/').pop(); // Ambil ID dokumen dari path
        kirimEmailVerifikasi(email, parseValue(pendingDoc.fields.namaSekolah), token);
        return { 
          status: "pending", 
          message: "Email ini sudah terdaftar dan menunggu verifikasi. Kami telah mengirim ulang link verifikasi." 
        };
      }
    }

    // 3. Buat data pending baru
    const verificationToken = Utilities.getUuid() + Utilities.getUuid();
    const namaSekolahUpper = namaSekolah.toUpperCase();
    const newSalt = generateSalt();
    const newHash = hashPassword(password, newSalt);

    const dataPending = {
      email: email,
      namaSekolah: namaSekolahUpper,
      npsn: npsn,
      jenjang: jenjang,
      hashedPassword: newHash,
      salt: newSalt,
      timestamp: now.toISOString()
    };
    
    // Gunakan token sebagai ID Dokumen
    firestore.createDocument(`registrasi_pending/${verificationToken}`, dataPending);
    
    kirimEmailVerifikasi(email, namaSekolahUpper, verificationToken);

    return { 
      status: "pending", 
      message: "Registrasi awal berhasil! Kami telah mengirimkan link verifikasi ke email Anda. Silakan cek inbox (atau folder spam)." 
    };
    
  } catch (e) {
    Logger.log(e);
    return { status: "gagal", message: "Terjadi error di server: " + e.message };
  }
}

function prosesLogout(token) {
  try {
    if (token) {
       CacheService.getScriptCache().remove('SESSION_' + token);
    }
    return { status: "sukses" };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function validateAndRefreshSession(token) {
  if (!token) {
    throw new Error("Sesi tidak ditemukan. Silakan login ulang.");
  }
  const cache = CacheService.getScriptCache();
  const sessionJson = cache.get('SESSION_' + token);
  if (!sessionJson) {
    throw new Error("Sesi kedaluwarsa atau tidak valid. Silakan login ulang.");
  }
  const sessionData = JSON.parse(sessionJson);
  const now = new Date().getTime();
  const threeHours = 3 * 60 * 60 * 1000;
  if (now - sessionData.lastActivity > threeHours) {
    cache.remove('SESSION_' + token);
    throw new Error("Sesi Anda telah berakhir (3 jam tidak aktif). Silakan login ulang.");
  }
  sessionData.lastActivity = now;
  cache.put('SESSION_' + token, JSON.stringify(sessionData), 21600);
  return sessionData;
}

function checkToken(tokenFromClient) {
  try {
    const sessionData = validateAndRefreshSession(tokenFromClient);
    if (sessionData.role === 'superadmin') {
      return {
        status: "sukses",
        role: "superadmin",
        namaSekolah: sessionData.nama
      };
    } else if (sessionData.role === 'admin') {
      return {
        status: "sukses",
        role: "admin",
        isImpersonating: sessionData.isImpersonating === true,
        namaSekolah: sessionData.namaSekolah,
        jenjang: sessionData.jenjang,
        jenjangPilihan: sessionData.jenjangPilihan
      };
    } else if (sessionData.role === 'guru') {
      return {
        status: "sukses",
        role: "guru",
        namaSekolah: sessionData.namaSekolah,
        namaGuru: sessionData.namaGuru,
        jenjangPilihan: sessionData.jenjangPilihan,
        hasUjianPraktek: sessionData.hasUjianPraktek,
        hasUjianMadrasah: sessionData.hasUjianMadrasah
      };
    } else {
      throw new Error("Sesi tidak valid (role tidak dikenal).");
    }
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function validateSuperadminSession(token) {
  const sessionData = validateAndRefreshSession(token);
  if (sessionData.role !== 'superadmin') {
    throw new Error("Akses ditolak. Anda harus login sebagai Superadmin.");
  }
  if (sessionData.isImpersonating) {
    throw new Error("Akses ditolak. Harap kembali ke Superadmin sebelum mengelola sekolah.");
  }
  return sessionData;
}

// --- GANTI FUNGSI INI DI Kode.gs.html ---
/**
 * [PERBAIKAN] Mengambil daftar sekolah dari koleksi 'sekolah' di Firestore.
 */
function getSekolahList(token) {
  try {
    validateSuperadminSession(token);
    const { firestore } = getFirestoreInstance();
    
    const documents = firestore.getCollection('sekolah').getDocuments();
    
    const sekolahList = documents.map(doc => {
      const fields = doc.fields; // 'fields' sudah bersih
      return {
        id: fields.sekolahID,
        nama: fields.namaSekolah,
        jenjang: fields.jenjang,
        email: fields.emailAdmin,
        spreadsheetId: fields.spreadsheetID
      };
    });
    
    return { status: "sukses", sekolah: sekolahList };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

/**
 * [DIGANTI] Menghapus sekolah dari koleksi 'sekolah' dan menghapus Spreadsheet-nya.
 */
function superadminDeleteSekolah(token, sekolahID, spreadsheetID) {
  try {
    validateSuperadminSession(token);
    if (!sekolahID || !spreadsheetID) {
      throw new Error("ID Sekolah dan ID Spreadsheet diperlukan.");
    }
    
    const { firestore } = getFirestoreInstance();
    
    // 1. Hapus dokumen dari Firestore
    firestore.deleteDocument(`sekolah/${sekolahID}`);
    
    // 2. Hapus Spreadsheet (SAMA)
    try {
      DriveApp.getFileById(spreadsheetID).setTrashed(true);
    } catch (driveError) {
      Logger.log(`Gagal menghapus spreadsheet ${spreadsheetID}: ${driveError.message}`);
    }
    
    // TODO (Opsional): Hapus semua data terkait (siswa, mapel, nilai, config, guru, dll)
    // Ini membutuhkan query batch delete di semua koleksi lain,
    // yang bisa memakan waktu. Untuk saat ini, kita biarkan data yatim.
    // Contoh: firestore.deleteDocument(`sekolah_config/${sekolahID}`);
    // Untuk koleksi (siswa, mapel, dll), perlu di-query dulu baru di-batch delete.

    return { status: "sukses", message: "Sekolah berhasil dihapus." };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

/**
 * [DIGANTI] Menyimpan (membuat/update) sekolah di koleksi 'sekolah' Firestore.
 */
function superadminSaveSekolah(token, data) {
  try {
    validateSuperadminSession(token);
    const { id, nama, jenjang, email, password } = data;
    if (!nama || !jenjang || !email) {
      throw new Error("Nama, Jenjang, dan Email wajib diisi.");
    }

    const { firestore } = getFirestoreInstance();
    const mode = id ? 'edit' : 'add';

    // Cek duplikat email
    const emailCheck = firestore.getCollection('sekolah').where('emailAdmin', '==', email).getDocuments();
    if (emailCheck.length > 0 && parseValue(emailCheck[0].fields.sekolahID) !== id) {
      throw new Error("Email ini sudah digunakan oleh sekolah lain.");
    }
    
    if (mode === 'add') {
      if (!password) {
        throw new Error("Password wajib diisi untuk akun baru.");
      }
      const newSSID = buatDatabaseSekolahBaru(nama, jenjang, email, password, null);
      const newSalt = generateSalt();
      const newHash = hashPassword(password, newSalt);
      const newSekolahID = "SKL-" + Utilities.getUuid().substring(0, 6).toUpperCase();
      
      const newDoc = {
        sekolahID: newSekolahID,
        namaSekolah: nama.toUpperCase(),
        jenjang: jenjang,
        emailAdmin: email,
        hashedPassword: newHash,
        spreadsheetID: newSSID,
        salt: newSalt,
        npsn: "" // Superadmin bisa mengedit NPSN nanti
      };
      
      firestore.createDocument(`sekolah/${newSekolahID}`, newDoc);

    } else { // Mode 'edit'
      const docPath = `sekolah/${id}`;
      const fieldsToUpdate = {
        namaSekolah: nama.toUpperCase(),
        jenjang: jenjang,
        emailAdmin: email
      };
      
      if (password) {
        const newSalt = generateSalt();
        const newHash = hashPassword(password, newSalt);
        fieldsToUpdate.hashedPassword = newHash;
        fieldsToUpdate.salt = newSalt;
      }
      
      firestore.updateDocument(docPath, fieldsToUpdate, true);
    }
    
    return { status: "sukses", message: "Data sekolah berhasil disimpan." };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

/**
 * [DIGANTI] Impersonate, membaca data sekolah dari Firestore.
 */
function superadminImpersonate(sekolahID, token) {
  try {
    const sessionData = validateSuperadminSession(token);
    const { firestore } = getFirestoreInstance();

    let targetRow;
    try {
      const doc = firestore.getDocument(`sekolah/${sekolahID}`);
      targetRow = doc.fields;
    } catch (e) {
      return { status: "gagal", message: "SekolahID tidak ditemukan." };
    }
    
    if (!targetRow) {
      return { status: "gagal", message: "SekolahID tidak ditemukan." };
    }
    
    const spreadsheetID = parseValue(targetRow.spreadsheetID);
    if (!spreadsheetID) {
      return { status: "gagal", message: "Sekolah ini tidak memiliki SpreadsheetID." };
    }

    // Panggil helper dari Langkah 3
    const config = getSekolahConfigData(sekolahID, spreadsheetID);
    
    sessionData.originalRole = 'superadmin';
    sessionData.role = 'admin';
    sessionData.isImpersonating = true;
    sessionData.sekolahID = sekolahID;
    sessionData.namaSekolah = parseValue(targetRow.namaSekolah).toUpperCase();
    sessionData.jenjang = parseValue(targetRow.jenjang);
    sessionData.spreadsheetID = spreadsheetID;
    sessionData.jenjangPilihan = config.jenjangPilihan;

    CacheService.getScriptCache().put('SESSION_' + token, JSON.stringify(sessionData), 21600);

    return {
      status: "sukses",
      role: "admin",
      isImpersonating: true,
      namaSekolah: sessionData.namaSekolah,
      jenjang: sessionData.jenjang,
      jenjangPilihan: config.jenjangPilihan,
      token: token
    };
  } catch (e) {
    return { status: "gagal", message: "Terjadi error: " + e.message };
  }
}

/**
 * [ADMIN] Memeriksa apakah data Ijazah 'dirty' dengan membandingkan
 * data saat ini dengan data yang terakhir disimpan di cache.
 */
/*
function getIjazahDirtyState() {
  try {
    const { spreadsheetID } = validateAdminSession();
    const ss = SpreadsheetApp.openById(spreadsheetID);

    // 1. Dapatkan Sheet Cache
    const sheetCache = ss.getSheetByName(SHEET_CACHE_IJAZAH);
    if (!sheetCache) {
      Logger.log("getIjazahDirtyState: Cache_Rekap_Ijazah tidak ditemukan. Menandai sebagai dirty.");
      return { status: "sukses", isDirty: true };
    }
    const metaValues = sheetCache.getRange(1, 1, 1, 5).getValues()[0];
    const headerValues = sheetCache.getRange(2, 1, 1, 7).getValues()[0];
    
    // 2. Periksa Integritas Cache
    if (metaValues[0] !== 'Meta' || headerValues[0] !== 'SiswaID' || !metaValues[1]) {
      Logger.log("getIjazahDirtyState: Cache rusak atau belum pernah dihitung. Menandai sebagai dirty.");
      return { status: "sukses", isDirty: true };
    }
    
    // 3. Bandingkan Pengaturan (Bobot, KKM, Semester)
    const cachedBobotRapor = metaValues[2];
    const cachedBobotUjian = metaValues[3];
    const cachedKKM = metaValues[4];
    
    const settingsResponse = getBobotData(); // Ini juga mengambil KKM
    const semesterResponse = getSemesterList(); // Ini mengambil Jml Semester
    
    const currentSettings = {
      bobotRapor: settingsResponse.bobotRapor,
      bobotUjian: settingsResponse.bobotUjian,
      kkm: settingsResponse.kkm,
      jmlSemester: semesterResponse.semesterList.length
    };
    
    // Ambil Jml Semester dari cache (ini belum kita simpan sebelumnya, jadi kita tambahkan)
    const cachedJmlSemester = sheetCache.getRange('H1').getValue(); // Simpan di H1
    
    if (cachedBobotRapor != currentSettings.bobotRapor ||
        cachedBobotUjian != currentSettings.bobotUjian ||
        cachedKKM != currentSettings.kkm ||
        (cachedJmlSemester && cachedJmlSemester != currentSettings.jmlSemester)) {
      Logger.log("getIjazahDirtyState: Pengaturan (Bobot/KKM/Semester) berbeda. Menandai sebagai dirty.");
      return { status: "sukses", isDirty: true };
    }

    // 4. Bandingkan Data Nilai
    // Baca cache
    const lastRow = sheetCache.getLastRow();
    const cachedDataMap = new Map();
    if (lastRow > 2) {
      const cachedValues = sheetCache.getRange(3, 1, lastRow - 2, 4).getValues(); // Hanya perlu SiswaID, MapelID, UjianAsli, RaporAsli
      cachedValues.forEach(row => {
        const key = `${row[0]}_${row[1]}`;
        cachedDataMap.set(key, { ujian: row[2], rapor: row[3] });
      });
    }

    // Hitung data saat ini
    const siswaData = getSiswa();
    const siswaList = siswaData.siswa.map(s => ({ id: s.id, nama: s.nama, nisn: s.nisn, kelas: s.kelas }));
    const mapelListFull = getMapelDataInternal(ss);
    const semesterIds = semesterResponse.semesterList.map(s => s.id);

    const { nilaiRekapMap: currentUjianMap } = getRekapUjianInternal(ss, siswaList, mapelListFull);
    const { nilaiRekapMap: currentRaporMap } = getRekapRaporInternal(ss, siswaList, mapelListFull, semesterIds);

    // Lakukan perbandingan
    // Cek jika ada siswa/mapel baru atau yg dihapus (perbedaan jumlah)
    const mapelListIjazah = mapelListFull.filter(m => m.isUS === true || m.isUP === true);
    if (cachedDataMap.size !== (siswaList.length * mapelListIjazah.length)) {
       Logger.log("getIjazahDirtyState: Jumlah siswa atau mapel berubah. Menandai sebagai dirty.");
       return { status: "sukses", isDirty: true };
    }

    for (const siswa of siswaList) {
      for (const mapel of mapelListIjazah) {
        const key = `${siswa.id}_${mapel.id}`;
        
        const currentNilaiUjian = currentUjianMap.get(key) || 0;
        const currentNilaiRapor = currentRaporMap.get(key) || 0;
        
        const cachedNilai = cachedDataMap.get(key);

        if (!cachedNilai || cachedNilai.ujian != currentNilaiUjian || cachedNilai.rapor != currentNilaiRapor) {
          Logger.log(`getIjazahDirtyState: Perbedaan nilai ditemukan untuk ${key}. Menandai sebagai dirty.`);
          return { status: "sukses", isDirty: true };
        }
      }
    }

    // 5. Jika semua lolos, data bersih
    Logger.log("getIjazahDirtyState: Tidak ada perbedaan ditemukan. Data bersih.");
    return { status: "sukses", isDirty: false };

  } catch (e) {
    Logger.log("Gagal getIjazahDirtyState: " + e.message);
    // Jika gagal membandingkan, anggap saja dirty demi keamanan
    return { status: "sukses", isDirty: true };
  }
}
*/

function superadminReturn(token) {
  try {
    const sessionData = validateAndRefreshSession(token);
    if (sessionData.originalRole !== 'superadmin') {
       throw new Error("Tidak dapat kembali. Sesi asal bukan Superadmin.");
    }

    const newSessionData = {
        role: 'superadmin',
        nama: sessionData.nama,
        lastActivity: new Date().getTime()
    };
    CacheService.getScriptCache().put('SESSION_' + token, JSON.stringify(newSessionData), 21600);

    return {
      status: "sukses",
      role: "superadmin",
      namaSekolah: newSessionData.nama
    };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function getDynamicDefaultMapel(jenjang, masterSpreadsheet) {
  try {
    const mapelSheet = masterSpreadsheet.getSheetByName('Data_Mapel_Default');
    if (!mapelSheet) {
      Logger.log("Peringatan: Sheet 'Data_Mapel_Default' tidak ditemukan di Master Sheet.");
      return []; 
    }
    
    const data = mapelSheet.getDataRange().getValues();
    data.shift(); 

    const defaultMapel = [];
    
    for (let i = 0; i < data.length; i++) {
      const row = data[i];
      const jenjangData = row[0]; 
      const mapelID = row[1];     
      const namaMapel = row[2];   
      
      const val_us = row[3]; 
      const val_up = row[4]; 

      let isUS_default = false;
      let isUP_default = false;

      if (val_us === true) {
        isUS_default = true;
      } else if (typeof val_us === 'string') {
        isUS_default = val_us.trim().toUpperCase() === 'TRUE';
      }

      if (val_up === true) {
        isUP_default = true;
      } else if (typeof val_up === 'string') {
        isUP_default = val_up.trim().toUpperCase() === 'TRUE';
      }
      
      if (jenjangData === jenjang || jenjangData === 'UMUM') {
        if (mapelID && namaMapel) { 
          defaultMapel.push([mapelID, namaMapel, isUS_default, isUP_default, i + 1]);
        }
      }
    }
    
    return defaultMapel;

  } catch (e) {
    Logger.log("Error saat mengambil mapel dinamis: " + e.message);
    return []; 
  }
}

function getMapelSheet(ss) {
  let userSpreadsheet = ss;
  if (!userSpreadsheet) {
    const { spreadsheetID } = validateAdminSession(); 
    if (!spreadsheetID) throw new Error("Spreadsheet ID Sesi tidak ditemukan.");
    userSpreadsheet = SpreadsheetApp.openById(spreadsheetID);
  }

  const sheetMapel = userSpreadsheet.getSheetByName('Mapel');
  if (!sheetMapel) throw new Error("Sheet 'Mapel' tidak ditemukan.");
  
  try {
    const header = sheetMapel.getRange('E1').getValue();
    if (header !== 'Urutan') {
      sheetMapel.getRange('E1').setValue('Urutan');
    }
  } catch (e) {
    Logger.log("Gagal mengecek/membuat header Urutan Mapel: " + e.message);
  }

  return sheetMapel;
}

function getMapel(token) {
  try {
    const { sessionData, spreadsheetID } = validateAdminOrGuruSession(token);
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const mapel = getMapelDataInternal(ss, sessionData.sekolahID);
    return { status: "sukses", mapel: mapel };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

// --- GANTI FUNGSI INI DI Kode.gs.html ---
function createMapel(token, mapelID, namaMapel) {
  try {
    const { sessionData } = validateAdminSession(token);
    const sekolahID = sessionData.sekolahID;
    if (!mapelID || !namaMapel) return { status: "gagal", message: "Data tidak lengkap." };

    const { firestore } = getFirestoreInstance();
    
    // 1. Cek duplikat
    const docId = `${sekolahID}_${mapelID}`;
    const docPath = `mapel/${docId}`;
    
    try {
      // Coba ambil dokumen. Jika berhasil (tidak error), berarti dokumen sudah ada.
      const existingDoc = firestore.getDocument(docPath);
      if (existingDoc && existingDoc.fields) {
        return { status: "gagal", message: "MapelID sudah ada." };
      }
    } catch (e) {
      // Error berarti dokumen tidak ditemukan, ini yang kita harapkan.
    }
    
    // 2. Dapatkan urutan maksimum
    const queryResponse = firestore.getCollection('mapel')
                                   .where('sekolahID', '==', sekolahID)
                                   // Asumsi Anda perlu index composite untuk ini
                                   // .orderBy('urutan', 'DESCENDING') 
                                   // .limit(1)
                                   .getDocuments();
    
    let maxUrutan = 0;
    if (queryResponse && queryResponse.length > 0) {
       queryResponse.forEach(doc => {
         const urutanNum = Number(parseValue(doc.fields.urutan) || 0);
         if (urutanNum > maxUrutan) maxUrutan = urutanNum;
       });
    }
    
    // 3. Buat dokumen baru
    const newDoc = {
      sekolahID: sekolahID,
      mapelID: mapelID,
      namaMapel: namaMapel,
      isUS: false,
      isUP: false,
      urutan: maxUrutan + 1
    };
    
    // Buat dokumen dengan ID spesifik
    firestore.createDocument(docPath, newDoc);

    clearMapelCache(sekolahID);
    return { status: "sukses" };
  } catch (e) {
    return { status: "gagal", message: "Gagal membuat mapel: " + e.message };
  }
}

// --- GANTI FUNGSI INI DI Kode.gs.html ---
function updateMapel(token, mapelID, namaMapel) {
  try {
    const { sessionData } = validateAdminSession(token);
    const sekolahID = sessionData.sekolahID;
    if (!mapelID || !namaMapel) return { status: "gagal", message: "Data tidak lengkap." };

    const { firestore } = getFirestoreInstance();
    const docId = `${sekolahID}_${mapelID}`;
    const docPath = `mapel/${docId}`;

    const fieldsToUpdate = {
      namaMapel: namaMapel
    };

    // Parameter ketiga (mask) = true, untuk update field spesifik
    firestore.updateDocument(docPath, fieldsToUpdate, true); 

    clearMapelCache(sessionData.sekolahID);
    return { status: "sukses" };
  } catch (e) {
    // Jika 'updateDocument' gagal (misal: dokumen tidak ada), akan error.
    return { status: "gagal", message: "MapelID tidak ditemukan atau gagal update: " + e.message };
  }
}

// --- GANTI FUNGSI INI DI Kode.gs.html ---
function deleteMapel(token, mapelID) {
  try {
    const { sessionData } = validateAdminSession(token);
    const sekolahID = sessionData.sekolahID;
    
    const { firestore } = getFirestoreInstance();
    const docId = `${sekolahID}_${mapelID}`;
    const docPath = `mapel/${docId}`;

    firestore.deleteDocument(docPath);

    clearMapelCache(sessionData.sekolahID);
    return { status: "sukses" };
  } catch (e) {
    return { status: "gagal", message: "Gagal menghapus: " + e.message };
  }
}

function syncDefaultMapel(token) {
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    const jenjang = sessionData.jenjang;
    const masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
    const sourceData = getDynamicDefaultMapel(jenjang, masterSS);
    const sourceMap = new Map();
    sourceData.forEach(row => {
      sourceMap.set(row[0], { name: row[1], isUS: row[2], isUP: row[3], urutan: row[4] });
    });
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheetMapel = getMapelSheet(ss);
    const targetRange = sheetMapel.getDataRange();
    const targetValues = targetRange.getValues();
    targetValues.shift();
    const targetIdMap = new Map(targetValues.map(row => [row[0], true]));
    let maxUrutan = 0;
    targetValues.forEach(row => {
      const urutanNum = Number(row[4] || 0);
      if (urutanNum > maxUrutan) maxUrutan = urutanNum;
    });
    const mapelToAdd = [];
    let changesMade = false;
    for (let i = 0; i < targetValues.length; i++) {
      const targetId = targetValues[i][0];
      const sourceRowData = sourceMap.get(targetId);
      if (sourceRowData) {
        if (targetValues[i][2] != sourceRowData.isUS || targetValues[i][3] != sourceRowData.isUP) {
          targetValues[i][2] = sourceRowData.isUS;
          targetValues[i][3] = sourceRowData.isUP;
          changesMade = true;
        }
      }
    }
    for (const [sourceId, sourceData] of sourceMap.entries()) {
      if (!targetIdMap.has(sourceId)) {
        maxUrutan++;
        mapelToAdd.push([sourceId, sourceData.name, sourceData.isUS, sourceData.isUP, maxUrutan]);
      }
    }
    if (changesMade) {
      sheetMapel.getRange(2, 1, targetValues.length, targetValues[0].length).setValues(targetValues);
    }
    if (mapelToAdd.length > 0) {
      sheetMapel.getRange(sheetMapel.getLastRow() + 1, 1, mapelToAdd.length, 5).setValues(mapelToAdd);
    }
    clearMapelCache(sessionData.sekolahID);
    return { status: "sukses" };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function deleteAllMapel(token) {
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheetMapel = getMapelSheet(ss);
    const lastRow = sheetMapel.getLastRow();
    if (lastRow > 1) {
      sheetMapel.deleteRows(2, lastRow - 1);
    }
    clearMapelCache(sessionData.sekolahID);
    return { status: "sukses", message: "Semua mapel telah dihapus." };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function saveMapelTipeUjianBatch(token, tipeUjianData) {
  let spreadsheetID, sessionData;
  try {
    const session = validateAdminSession(token);
    spreadsheetID = session.spreadsheetID;
    sessionData = session.sessionData;
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
  const lock = LockService.getDocumentLock();
  lock.waitLock(15000);
  try {
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheetMapel = getMapelSheet(ss);
    const dataRange = sheetMapel.getDataRange();
    const data = dataRange.getValues();
    const dataMap = new Map(tipeUjianData.map(item => [item.id, item]));
    let changesMade = false;

    const valuesToUpdate = [];

    for (let i = 1; i < data.length; i++) {
      const id = data[i][0];
      const newData = dataMap.get(id);
      
      let currentIsUS = data[i][2];
      let currentIsUP = data[i][3];

      if (newData) {
        if (currentIsUS != newData.isUS || currentIsUP != newData.isUP) {
          currentIsUS = newData.isUS;
          currentIsUP = newData.isUP;
          changesMade = true;
        }
      }
      valuesToUpdate.push([currentIsUS, currentIsUP]);
    }
    
    if (changesMade) {
      if (valuesToUpdate.length > 0) {
        sheetMapel.getRange(2, 3, valuesToUpdate.length, 2).setValues(valuesToUpdate);
      }
      clearMapelCache(sessionData.sekolahID);
    }
    return { status: "sukses" };
  } catch (e) {
    return { status: "gagal", message: e.message };
  } finally {
    lock.releaseLock();
  }
}

// --- GANTI FUNGSI INI DI Kode.gs.html ---
function saveMapelUrutanBatch(token, urutanData) {
  let sekolahID, sessionData;
  try {
    const session = validateAdminSession(token);
    sekolahID = session.sessionData.sekolahID;
    sessionData = session.sessionData;
  } catch (e) { return { status: "gagal", message: e.message }; }
  
  try {
    const { firestore, projectId } = getFirestoreInstance();
    const projectPath = `projects/${projectId}/databases/(default)/documents`;
    const batch = firestore.batch();

    urutanData.forEach(item => {
      const docId = `${sekolahID}_${item.id}`;
      const fullDocPath = `${projectPath}/mapel/${docId}`;
      const docRef = { name: fullDocPath };
      
      const fieldsToUpdate = {
        urutan: item.urutan
      };

      batch.update(docRef, fieldsToUpdate, { fieldPaths: ["urutan"] });
    });

    batch.commit();
    
    clearMapelCache(sessionData.sekolahID);
    return { status: "sukses" };
  } catch (e) {
    return { status: "gagal", message: "Gagal batch update urutan: " + e.message };
  }
}

function getSiswaSheet(ss) {
  let userSpreadsheet = ss;
  if (!userSpreadsheet) {
    const { spreadsheetID } = validateAdminSession();
    if (!spreadsheetID) throw new Error("Spreadsheet ID Sesi tidak ditemukan.");
    userSpreadsheet = SpreadsheetApp.openById(spreadsheetID);
  }

  let sheet = userSpreadsheet.getSheetByName('Siswa');
  if (!sheet) {
    sheet = userSpreadsheet.insertSheet('Siswa');
    sheet.appendRow([
        'SiswaID', 'NamaSiswa', 'NISN', 'NIS_Lokal', 'JenisKelamin', 
        'TempatLahir', 'TglLahir', 'Kelas'
      ]);
    SpreadsheetApp.flush();
  }
  
  try {
    sheet.getRange('C:D').setNumberFormat('@');
  } catch (e) {
    Logger.log("Gagal set format teks untuk NISN/NIS: " + e.message);
  }
  
  try {
    const header = sheet.getRange('I1').getValue();
    if (header !== 'Urutan') {
      sheet.getRange('I1').setValue('Urutan');
    }
  } catch (e) {
    Logger.log("Gagal mengecek/membuat header Urutan: " + e.message);
  }

  return sheet;
}

// --- GANTI FUNGSI INI DI Kode.gs.html ---
/**
 * [PERBAIKAN] Mengambil data siswa dari Firestore, dengan cache.
 */
function getSiswa(token) {
  try {
    const { sessionData } = validateAdminOrGuruSession(token);
    const sekolahID = sessionData.sekolahID;
    
    const cacheKey = SISWA_CACHE_KEY + "_" + sekolahID;
    const userCache = CacheService.getUserCache();
    const cachedSiswa = userCache.get(cacheKey);
    if (cachedSiswa != null) {
      return { status: "sukses", siswa: JSON.parse(cachedSiswa) };
    }
    
    const { firestore } = getFirestoreInstance();
    const documents = firestore.getCollection('siswa')
                               .where('sekolahID', '==', sekolahID)
                               .getDocuments();

    const siswaList = documents.map(doc => {
      const fields = doc.fields; // 'fields' sudah merupakan objek JS yang bersih
      const id = fields.siswaID;
      const idNum = parseInt((id || 'SIS-0').split('-')[1] || 0);
      
      let tglLahir = fields.tglLahir || '';
      // Jika data tglLahir adalah Objek Date (dari migrasi lama atau Firestore auto-detect)
      if (tglLahir instanceof Date) {
        tglLahir = Utilities.formatDate(tglLahir, Session.getScriptTimeZone(), "yyyy-MM-dd");
      }
      if (tglLahir.includes('T')) { // Jika formatnya ISO Timestamp string
         tglLahir = tglLahir.split('T')[0]; // Ambil YYYY-MM-DD saja
      }

      return {
        id: id,
        nama: fields.namaSiswa,
        nisn: fields.nisn,
        nisLokal: fields.nisLokal || '',
        jk: fields.jenisKelamin || '',
        tempatLahir: fields.tempatLahir || '',
        tglLahir: tglLahir,
        kelas: fields.kelas || '',
        urutan: Number(fields.urutan || idNum)
      };
    });

    siswaList.sort((a, b) => {
      const kelasCompare = a.kelas.localeCompare(b.kelas);
      if (kelasCompare !== 0) return kelasCompare;
      return (Number(a.urutan) || 0) - (Number(b.urutan) || 0);
    });
    
    userCache.put(cacheKey, JSON.stringify(siswaList), 3600);
    return { status: "sukses", siswa: siswaList };
  } catch (e) {
    Logger.log("Gagal getSiswa (Firestore): " + e.message);
    return { status: "gagal", message: e.message };
  }
}

/**
 * [BARU/DIGANTI] Membuat dokumen siswa baru di Firestore.
 */
function createSiswa(token, dataSiswa) {
  try {
    const { sessionData } = validateAdminSession(token);
    const sekolahID = sessionData.sekolahID;
    
    if (!dataSiswa.nama || !dataSiswa.nisn || !dataSiswa.jk || !dataSiswa.kelas) {
      return { status: "gagal", message: "Data wajib diisi." };
    }

    const { firestore } = getFirestoreInstance();

    // 1. Cek duplikat NISN
    const nisnCheck = firestore.getCollection('siswa')
                               .where('sekolahID', '==', sekolahID)
                               .where('nisn', '==', dataSiswa.nisn)
                               .getDocuments();
    
    if (nisnCheck.length > 0) {
      return { status: "gagal", message: "NISN sudah terdaftar." };
    }

    // 2. Dapatkan ID & Urutan maksimum
    // Note: Ini bisa menjadi lambat jika siswa sangat banyak.
    // Alternatifnya adalah menyimpan counter terpisah.
    const allSiswaDocs = firestore.getCollection('siswa')
                                  .where('sekolahID', '==', sekolahID)
                                  .getDocuments();

    let maxIdNum = 0;
    let maxUrutan = 0;
    allSiswaDocs.forEach(doc => {
      const idNum = parseInt((parseValue(doc.fields.siswaID) || 'SIS-0').split('-')[1] || 0);
      if (idNum > maxIdNum) maxIdNum = idNum;
      const urutanNum = Number(parseValue(doc.fields.urutan) || 0);
      if (urutanNum > maxUrutan) maxUrutan = urutanNum;
    });

    const newIdNum = maxIdNum + 1;
    const newUrutan = maxUrutan + 1;
    const newSiswaID = "SIS-" + newIdNum;
    const docId = `${sekolahID}_${newSiswaID}`;
    const docPath = `siswa/${docId}`;

    // 3. Buat dokumen baru
    const newDoc = {
      sekolahID: sekolahID,
      siswaID: newSiswaID,
      namaSiswa: dataSiswa.nama,
      nisn: dataSiswa.nisn,
      nisLokal: dataSiswa.nisLokal || null,
      jenisKelamin: dataSiswa.jk,
      tempatLahir: dataSiswa.tempatLahir || null,
      tglLahir: dataSiswa.tglLahir || null,
      kelas: dataSiswa.kelas,
      urutan: newUrutan
    };

    firestore.createDocument(docPath, newDoc);

    clearSiswaCache(sessionData.sekolahID);
    return { status: "sukses" };
  } catch (e) {
    Logger.log("Gagal createSiswa (Firestore): " + e.message);
    return { status: "gagal", message: e.message };
  }
}

/**
 * [BARU/DIGANTI] Memperbarui dokumen siswa di Firestore.
 */
function updateSiswa(token, dataSiswa) {
  try {
    const { sessionData } = validateAdminSession(token);
    const sekolahID = sessionData.sekolahID;
    if (!dataSiswa.id) return { status: "gagal", message: "ID Siswa hilang." };

    const { firestore } = getFirestoreInstance();

    // 1. Cek duplikat NISN (pada siswa LAIN)
    const nisnCheck = firestore.getCollection('siswa')
                               .where('sekolahID', '==', sekolahID)
                               .where('nisn', '==', dataSiswa.nisn)
                               .getDocuments();

    for (const doc of nisnCheck) {
      if (parseValue(doc.fields.siswaID) !== dataSiswa.id) {
        return { status: "gagal", message: "NISN sudah digunakan oleh siswa lain." };
      }
    }

    // 2. Tentukan path dokumen dan update
    const docId = `${sekolahID}_${dataSiswa.id}`;
    const docPath = `siswa/${docId}`;

    const fieldsToUpdate = {
      namaSiswa: dataSiswa.nama,
      nisn: dataSiswa.nisn,
      nisLokal: dataSiswa.nisLokal || null,
      jenisKelamin: dataSiswa.jk,
      tempatLahir: dataSiswa.tempatLahir || null,
      tglLahir: dataSiswa.tglLahir || null,
      kelas: dataSiswa.kelas
      // 'urutan' tidak diupdate di sini, tapi di 'saveSiswaUrutanBatch'
    };

    // Parameter ketiga (mask) = true, untuk update field spesifik (merge)
    firestore.updateDocument(docPath, fieldsToUpdate, true); 

    clearSiswaCache(sessionData.sekolahID);
    return { status: "sukses" };
  } catch (e) {
    Logger.log("Gagal updateSiswa (Firestore): " + e.message);
    return { status: "gagal", message: e.message };
  }
}

/**
 * [BARU/DIGANTI] Menghapus dokumen siswa dari Firestore.
 */
function deleteSiswa(token, siswaID) {
  try {
    const { sessionData } = validateAdminSession(token);
    const sekolahID = sessionData.sekolahID;
    if (!siswaID) return { status: "gagal", message: "SiswaID kosong." };

    const { firestore } = getFirestoreInstance();
    const docId = `${sekolahID}_${siswaID}`;
    const docPath = `siswa/${docId}`;

    firestore.deleteDocument(docPath);

    clearSiswaCache(sessionData.sekolahID);
    return { status: "sukses" };
  } catch (e) {
    Logger.log("Gagal deleteSiswa (Firestore): " + e.message);
    return { status: "gagal", message: e.message };
  }
}

/**
 * [BARU/DIGANTI] Menghapus semua dokumen siswa untuk sekolah ini.
 * Menggunakan Batch Delete.
 */
function deleteAllSiswa(token) {
  try {
    const { sessionData } = validateAdminSession(token);
    const sekolahID = sessionData.sekolahID;
    
    const { firestore, projectId } = getFirestoreInstance();
    const projectPath = `projects/${projectId}/databases/(default)/documents`;
    const batch = firestore.batch();
    
    const documents = firestore.getCollection('siswa')
                               .where('sekolahID', '==', sekolahID)
                               .getDocuments();
    
    if (documents.length === 0) {
      return { status: "sukses", message: "Tidak ada data siswa untuk dihapus." };
    }

    documents.forEach(doc => {
      // Kita butuh 'doc.name' yang merupakan path lengkap
      batch.delete({ name: doc.name }); 
    });

    batch.commit();

    clearSiswaCache(sessionData.sekolahID);
    return { status: "sukses", message: `Semua data siswa (${documents.length}) telah dihapus.` };
  } catch (e) {
    Logger.log("Gagal deleteAllSiswa (Firestore): " + e.message);
    return { status: "gagal", message: e.message };
  }
}

function getDataSekolahSheet(ss) {
  let userSpreadsheet = ss;
  if (!userSpreadsheet) {
    const { spreadsheetID } = validateAdminSession();
    if (!spreadsheetID) throw new Error("Spreadsheet ID Sesi tidak ditemukan.");
    userSpreadsheet = SpreadsheetApp.openById(spreadsheetID);
  }

  let sheet = userSpreadsheet.getSheetByName('Data_Sekolah');
  if (!sheet) {
    sheet = userSpreadsheet.insertSheet('Data_Sekolah');
    sheet.appendRow([
      'JenjangPilihan', 'NPSN', 'NSM', 'Alamat', 'Provinsi', 
      'KabKot', 'PilihanKabKot', 'Kecamatan', 'KelDes', 'PilihanKelDes', 
      'KodePos', 'Telepon', 'Email', 'Website', 'NamaKepsek', 'NIPKepsek'
    ]);
    sheet.appendRow([
      '', '', '', '', '', 
      '', 'Kabupaten', '', '', 'Kelurahan', 
      '', '', '', '', '', ''
    ]);
    sheet.getRange('A2:P2').setNumberFormat('@');
    SpreadsheetApp.flush(); 
  }
  return sheet;
}

// --- GANTI FUNGSI INI DI Kode.gs.html ---
/**
 * [PERBAIKAN] Fungsi ini dipanggil oleh checkToken() untuk mengambil jenjangPilihan.
 */
function getJenjangPilihanFromSheet(spreadsheetID) {
  try {
    const { firestore } = getFirestoreInstance();
    
    const sekolahDocs = firestore.getCollection('sekolah')
                                 .where('spreadsheetID', '==', spreadsheetID)
                                 .getDocuments();

    if (sekolahDocs.length > 0) {
      const sekolahID = sekolahDocs[0].fields.sekolahID; // 'fields' sudah bersih
      // Panggil helper dari Langkah 3
      const config = getSekolahConfigData(sekolahID, spreadsheetID);
      return config.jenjangPilihan || "";
    } else {
      Logger.log(`Gagal menemukan sekolah untuk spreadsheetID ${spreadsheetID} di getJenjangPilihanFromSheet`);
      return ""; // Fallback
    }
  } catch (e) {
    Logger.log(`Error di getJenjangPilihanFromSheet (Firestore): ${e.message}`);
    return "";
  }
}

// ====================================================================
// BAGIAN A: MIGRASI (Pengaturan) & (Data_Sekolah) -> sekolah_config
// ====================================================================

// --- GANTI FUNGSI INI DI Kode.gs.html ---
/**
 * [PERBAIKAN] Fungsi inti untuk mendapatkan/membuat dokumen konfigurasi sekolah.
 */
function getSekolahConfigData(sekolahID, spreadsheetID) {
  const cacheKey = CONFIG_CACHE_KEY + sekolahID;
  const userCache = CacheService.getUserCache();
  const cachedConfig = userCache.get(cacheKey);
  if (cachedConfig != null) {
    return JSON.parse(cachedConfig);
  }

  const { firestore } = getFirestoreInstance();
  const docPath = `sekolah_config/${sekolahID}`;
  
  try {
    const doc = firestore.getDocument(docPath);
    const configData = {};
    const fields = doc.fields; // 'fields' sudah bersih

    for (const key in DEFAULTS_CONFIG) {
      // Ambil nilai dari 'fields' jika ada, jika tidak, gunakan default
      configData[key] = fields[key] !== undefined ? fields[key] : DEFAULTS_CONFIG[key];
    }
    
    userCache.put(cacheKey, JSON.stringify(configData), 3600); // Cache 1 jam
    return configData;
    
  } catch (e) {
    // Dokumen tidak ditemukan, lakukan migrasi dari Sheet
    Logger.log(`Dokumen config untuk ${sekolahID} tidak ditemukan. Memulai migrasi dari Spreadsheet...`);
    try {
      // (Kode migrasi sisa-nya di sini sudah benar, tidak perlu diubah)
      const ss = SpreadsheetApp.openById(spreadsheetID);
      const newConfigData = { ...DEFAULTS_CONFIG }; // Salin default

      // 1. Migrasi Data_Sekolah
      try {
        const sheetData = ss.getSheetByName('Data_Sekolah');
        if (sheetData) {
          const data = sheetData.getRange('A2:P2').getValues()[0];
          newConfigData.jenjangPilihan = data[0] || DEFAULTS_CONFIG.jenjangPilihan;
          newConfigData.npsn = data[1] || DEFAULTS_CONFIG.npsn;
          // ... (sisa field data[2] s/d data[15] sudah benar) ...
          newConfigData.nsm = data[2] || DEFAULTS_CONFIG.nsm;
          newConfigData.alamat = data[3] || DEFAULTS_CONFIG.alamat;
          newConfigData.provinsi = data[4] || DEFAULTS_CONFIG.provinsi;
          newConfigData.kabKot = data[5] || DEFAULTS_CONFIG.kabKot;
          newConfigData.pilihanKabKot = data[6] || DEFAULTS_CONFIG.pilihanKabKot;
          newConfigData.kecamatan = data[7] || DEFAULTS_CONFIG.kecamatan;
          newConfigData.kelDes = data[8] || DEFAULTS_CONFIG.kelDes;
          newConfigData.pilihanKelDes = data[9] || DEFAULTS_CONFIG.pilihanKelDes;
          newConfigData.kodePos = data[10] || DEFAULTS_CONFIG.kodePos;
          newConfigData.telepon = data[11] || DEFAULTS_CONFIG.telepon;
          newConfigData.email = data[12] || DEFAULTS_CONFIG.email;
          newConfigData.website = data[13] || DEFAULTS_CONFIG.website;
          newConfigData.namaKepsek = data[14] || DEFAULTS_CONFIG.namaKepsek;
          newConfigData.nipKepsek = data[15] || DEFAULTS_CONFIG.nipKepsek;
        }
      } catch (e1) { Logger.log(`Sheet Data_Sekolah tidak ada saat migrasi: ${e1.message}`); }

      // 2. Migrasi Pengaturan
      try {
        const sheetPengaturan = ss.getSheetByName('Pengaturan');
        if (sheetPengaturan) {
          const data = sheetPengaturan.getRange('A1:B' + sheetPengaturan.getLastRow()).getValues();
          data.forEach(row => {
            if (row[0] === 'Bobot_Rapor') newConfigData.bobotRapor = row[1];
            if (row[0] === 'Bobot_Ujian') newConfigData.bobotUjian = row[1];
            if (row[0] === 'KKM') newConfigData.kkm = row[1];
            if (row[0] === 'Jumlah_Semester') newConfigData.jumlahSemester = row[1];
          });
        }
      } catch (e2) { Logger.log(`Sheet Pengaturan tidak ada saat migrasi: ${e2.message}`); }
      
      // 3. Buat dokumen baru di Firestore
      firestore.createDocument(docPath, newConfigData);
      Logger.log(`Migrasi config untuk ${sekolahID} selesai. Dokumen dibuat.`);
      userCache.put(cacheKey, JSON.stringify(newConfigData), 3600);
      return newConfigData;

    } catch (eMig) {
      Logger.log(`Gagal total migrasi config: ${eMig.message}`);
      throw new Error("Gagal memuat konfigurasi sekolah.");
    }
  }
}

/**
 * [HELPER BARU] Fungsi inti untuk menyimpan data ke dokumen konfigurasi sekolah.
 */
function _saveSekolahConfig(sekolahID, dataToMerge, token) {
  try {
    const { firestore } = getFirestoreInstance();
    const docPath = `sekolah_config/${sekolahID}`;

    // Gunakan updateDocument dengan merge=true
    firestore.updateDocument(docPath, dataToMerge, true);

    // Perbarui sesi cache jika jenjangPilihan berubah
    if (dataToMerge.hasOwnProperty('jenjangPilihan') && token) {
      const cache = CacheService.getScriptCache();
      const sessionJson = cache.get('SESSION_' + token);
      if (sessionJson) {
        const sessionData = JSON.parse(sessionJson);
        sessionData.jenjangPilihan = dataToMerge.jenjangPilihan;
        cache.put('SESSION_' + token, JSON.stringify(sessionData), 21600);
      }
    }

    // Bersihkan cache dokumen
    const cacheKey = CONFIG_CACHE_KEY + sekolahID;
    CacheService.getUserCache().remove(cacheKey);

    return { status: "sukses" };
  } catch (e) {
    Logger.log(`Gagal _saveSekolahConfig: ${e.message}`);
    return { status: "gagal", message: e.message };
  }
}

/**
 * [DIGANTI] Mengambil data sekolah (identitas) dari Firestore.
 */
function getSchoolData(token) {
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    const config = getSekolahConfigData(sessionData.sekolahID, spreadsheetID);
    
    // Salin data config ke format lama yang diharapkan client
    const dataSekolah = {
      jenjangBase: sessionData.jenjang,
      namaSekolah: sessionData.namaSekolah,
      jenjangPilihan: config.jenjangPilihan,
      npsn: config.npsn,
      nsm: config.nsm,
      alamat: config.alamat,
      provinsi: config.provinsi,
      kabKot: config.kabKot,
      pilihanKabKot: config.pilihanKabKot,
      kecamatan: config.kecamatan,
      kelDes: config.kelDes,
      pilihanKelDes: config.pilihanKelDes,
      kodePos: config.kodePos,
      telepon: config.telepon,
      email: config.email,
      website: config.website,
      namaKepsek: config.namaKepsek,
      nipKepsek: config.nipKepsek
    };
    
    return { status: "sukses", data: dataSekolah };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

/**
 * [DIGANTI] Menyimpan data sekolah (identitas) ke Firestore.
 */
function saveSchoolData(token, data) {
  try {
    const { sessionData } = validateAdminSession(token);
    // 'data' adalah objek yang sama persis dengan yang kita butuhkan.
    return _saveSekolahConfig(sessionData.sekolahID, data, token);
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function getPengaturanSheet(ss) {
  let userSpreadsheet = ss;
  if (!userSpreadsheet) {
    const { spreadsheetID } = validateAdminSession();
    if (!spreadsheetID) throw new Error("Spreadsheet ID Sesi tidak ditemukan.");
    userSpreadsheet = SpreadsheetApp.openById(spreadsheetID);
  }

  let sheet = userSpreadsheet.getSheetByName('Pengaturan');
  if (!sheet) {
    sheet = userSpreadsheet.insertSheet('Pengaturan');
    sheet.appendRow(['Setting', 'Value']);
    sheet.appendRow(['Bobot_Rapor', 60]); 
    sheet.appendRow(['Bobot_Ujian', 40]); 
    sheet.appendRow(['Jumlah_Semester', 5]);
    sheet.appendRow(['KKM', 76]); 
    SpreadsheetApp.flush();
  }
  
  try {
    const data = sheet.getRange('A1:A' + sheet.getLastRow()).getValues();
    let foundSemester = false;
    let foundKKM = false;
    for (let i = 0; i < data.length; i++) {
      if (data[i][0] === 'Jumlah_Semester') {
        foundSemester = true;
      }
      if (data[i][0] === 'KKM') {
        foundKKM = true;
      }
    }
    if (!foundSemester) {
      sheet.appendRow(['Jumlah_Semester', 5]);
    }
    if (!foundKKM) { 
      sheet.appendRow(['KKM', 76]); 
    }
  } catch (e) {
    Logger.log("Gagal mengecek/membuat setting: " + e.message);
  }
  
  return sheet;
}

/**
 * [DIGANTI] Mengambil data bobot dari Firestore.
 */
function getBobotData(token) {
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    const config = getSekolahConfigData(sessionData.sekolahID, spreadsheetID);
    
    return { 
      status: "sukses", 
      bobotUjian: config.bobotUjian, 
      bobotRapor: config.bobotRapor, 
      kkm: config.kkm 
    };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

/**
 * [DIGANTI] Menyimpan data bobot ke Firestore.
 */
function saveBobotData(token, bobotRapor, bobotUjian, kkm) {
  try {
    const { sessionData } = validateAdminSession(token);
    if ((bobotRapor + bobotUjian) !== 100) {
      return { status: "gagal", message: "Total bobot harus 100." };
    }
    const kkmValue = parseInt(kkm, 10);
    if (isNaN(kkmValue) || kkmValue < 0 || kkmValue > 100) {
      return { status: "gagal", message: "KKM harus angka antara 0 dan 100." };
    }

    const dataToSave = {
      bobotRapor: bobotRapor,
      bobotUjian: bobotUjian,
      kkm: kkmValue
    };
    
    const result = _saveSekolahConfig(sessionData.sekolahID, dataToSave, token);
    if (result.status === 'sukses') {
      clearRekapNilaiCache(sessionData.sekolahID);
      clearRekapNilaiRaporCache(sessionData.sekolahID);
    }
    return result;
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function getKelasSheet(ss) {
  let userSpreadsheet = ss;
  if (!userSpreadsheet) {
    const { spreadsheetID } = validateAdminSession();
    if (!spreadsheetID) throw new Error("Spreadsheet ID Sesi tidak ditemukan.");
    userSpreadsheet = SpreadsheetApp.openById(spreadsheetID);
  }

  let sheet = userSpreadsheet.getSheetByName('Kelas');
  if (!sheet) {
    sheet = userSpreadsheet.insertSheet('Kelas');
    sheet.appendRow(['NamaKelas']);
    SpreadsheetApp.flush();
  }
  return sheet;
}

// ====================================================================
// BAGIAN B: MIGRASI Kelas -> koleksi 'kelas'
// ====================================================================

// --- GANTI FUNGSI INI DI Kode.gs.html ---
/**
 * [PERBAIKAN] Mengambil data kelas yang terkunci (Siswa sudah punya nilai).
 */
function getLockedKelasSet(spreadsheetID, sekolahID) { // Argumen diubah urutannya
  try {
    const cacheKey = LOCKED_KELAS_CACHE_KEY + "_" + sekolahID;
    const scriptCache = CacheService.getScriptCache();
    const cachedData = scriptCache.get(cacheKey);
    if (cachedData != null) {
      return new Set(JSON.parse(cachedData));
    }

    const { firestore } = getFirestoreInstance();
    const lockedSiswaIdSet = new Set();
    const siswaIdToKelasMap = new Map();
    
    // 1. Dapatkan mapping SiswaID -> Kelas dari Firestore
    const siswaDocs = firestore.getCollection('siswa')
                               .where('sekolahID', '==', sekolahID)
                               .getDocuments();
    
    siswaDocs.forEach(doc => {
      const fields = doc.fields; // 'fields' sudah bersih
      const siswaId = fields.siswaID;
      const kelas = fields.kelas;
      if (siswaId && kelas) {
        siswaIdToKelasMap.set(siswaId, kelas);
      }
    });

    // 2. Cek nilai Ujian
    const ujianDocs = firestore.getCollection('nilai_ujian')
                               .where('sekolahID', '==', sekolahID)
                               .getDocuments();
    for (const doc of ujianDocs) {
      const fields = doc.fields; // 'fields' sudah bersih
      if (fields.siswaID) {
         const siswaId = fields.siswaID;
         if (fields.um !== null && fields.um !== undefined) {
           lockedSiswaIdSet.add(siswaId); continue;
         }
         if (fields.up !== null && fields.up !== undefined) {
           lockedSiswaIdSet.add(siswaId);
         }
      }
    }
    
    // 3. Cek nilai Rapor
    const raporDocs = firestore.getCollection('nilai_rapor')
                               .where('sekolahID', '==', sekolahID)
                               .getDocuments();
    for (const doc of raporDocs) {
      const fields = doc.fields; // 'fields' sudah bersih
      if (fields.siswaID) {
         const siswaId = fields.siswaID;
         if (lockedSiswaIdSet.has(siswaId)) continue; 
         
         if (fields.p !== null && fields.p !== undefined) {
           lockedSiswaIdSet.add(siswaId); continue;
         }
         if (fields.k !== null && fields.k !== undefined) {
           lockedSiswaIdSet.add(siswaId);
         }
      }
    }

    // 4. Map SiswaID yang terkunci ke Nama Kelas
    const lockedKelasSet = new Set();
    for (const siswaId of lockedSiswaIdSet) {
      if (siswaIdToKelasMap.has(siswaId)) {
        lockedKelasSet.add(siswaIdToKelasMap.get(siswaId).toUpperCase());
      }
    }
    
    scriptCache.put(cacheKey, JSON.stringify(Array.from(lockedKelasSet)), 3600);
    return lockedKelasSet;
  } catch (e) {
    Logger.log(`Gagal getLockedKelasSet (Firestore): ${e.message}`);
    return new Set(); 
  }
}

// --- GANTI FUNGSI INI DI Kode.gs.html ---
/**
 * [PERBAIKAN] Mengambil daftar kelas dari Firestore.
 */
function getKelas(token) {
  try {
    const { sessionData, spreadsheetID } = validateAdminOrGuruSession(token);
    const sekolahID = sessionData.sekolahID;
    
    // 'ss' dilewatkan hanya untuk 'getLockedKelasSet'
    // Kita harus memperbaiki 'getLockedKelasSet' juga
    const lockedKelasSet = getLockedKelasSet(spreadsheetID, sekolahID); // Argumen dibalik

    const { firestore } = getFirestoreInstance();
    const documents = firestore.getCollection('kelas')
                               .where('sekolahID', '==', sekolahID)
                               .getDocuments();

    const kelasListWithStatus = documents.map(doc => {
      const nama = doc.fields.namaKelas; // 'fields' sudah bersih
      return {
        nama: nama,
        isLocked: lockedKelasSet.has(nama.toUpperCase())
      };
    }).sort((a,b) => a.nama.localeCompare(b.nama)); // Urutkan berdasarkan nama
    
    return { status: "sukses", kelasList: kelasListWithStatus };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

/**
 * [DIGANTI] Menyimpan daftar kelas ke Firestore (Operasi Batch).
 */
function saveKelas(token, kelasList) {
  let sekolahID, sessionData, spreadsheetID;
  try {
    const session = validateAdminSession(token);
    sekolahID = session.sessionData.sekolahID;
    sessionData = session.sessionData;
    spreadsheetID = session.spreadsheetID; // Masih perlu untuk getLockedKelasSet
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
  
  try {
    // 'ss' dilewatkan hanya untuk 'getLockedKelasSet'
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const lockedKelasSet = getLockedKelasSet(ss, sekolahID);
    
    const { firestore, projectId } = getFirestoreInstance();
    const projectPath = `projects/${projectId}/databases/(default)/documents`;
    const batch = firestore.batch();

    // 1. Dapatkan kelas yang ada di database
    const documents = firestore.getCollection('kelas')
                               .where('sekolahID', '==', sekolahID)
                               .getDocuments();
    
    const dbKelasMap = new Map();
    documents.forEach(doc => {
      const nama = parseValue(doc.fields.namaKelas);
      dbKelasMap.set(nama.toUpperCase(), { nama: nama, path: doc.name });
    });

    const newKelasSet = new Set(kelasList.map(k => k.toUpperCase()));

    // 2. Cek penghapusan
    for (const [namaUpper, data] of dbKelasMap.entries()) {
      if (!newKelasSet.has(namaUpper)) {
        // Kelas ini mau dihapus
        if (lockedKelasSet.has(namaUpper)) {
          // Tidak boleh dihapus!
          throw new Error(`Kelas '${data.nama}' tidak dapat dihapus karena sudah memiliki data nilai.`);
        } else {
          // Boleh dihapus
          batch.delete({ name: data.path });
        }
      }
    }

    // 3. Cek penambahan
    for (const nama of kelasList) {
      if (!dbKelasMap.has(nama.toUpperCase())) {
        // Kelas ini baru, tambahkan
        const docId = `${sekolahID}_${nama.replace(/[^a-zA-Z0-9]/g, '_')}`; // Buat ID dokumen yang aman
        const docPath = `${projectPath}/kelas/${docId}`;
        const docRef = { name: docPath };
        
        batch.create(docRef, {
          sekolahID: sekolahID,
          namaKelas: nama
        });
      }
    }

    // 4. Commit batch
    batch.commit();

    clearSiswaCache(sessionData.sekolahID); // Hapus cache siswa (karena filter kelas mungkin berubah)
    clearLockedKelasCache(sessionData.sekolahID); // Hapus cache kelas terkunci
    
    return { status: "sukses" };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function getSiswaTemplateUrl(token) {
  try {
    validateAdminSession(token);
    const url = "https://docs.google.com/spreadsheets/d/" + TEMPLATE_SISWA_FILE_ID + "/export?format=xlsx";
    const oauthToken = ScriptApp.getOAuthToken();
    const response = UrlFetchApp.fetch(url, {
      headers: {
        'Authorization': 'Bearer ' + oauthToken
      }
    });
    const blob = response.getBlob().setName("template_import_siswa.xlsx");
    const base64Data = Utilities.base64Encode(blob.getBytes());
    return {
      status: "sukses",
      base64: base64Data,
      mimeType: MimeType.MICROSOFT_EXCEL,
      fileName: "template_import_siswa.xlsx"
    };
  } catch (e) {
    if (e.message.includes("Export_TRANSIENT") || e.message.includes("failed")) {
      return { status: "gagal", message: "Gagal mengekspor template. Pastikan file template dapat diakses." };
    }
    return { status: "gagal", message: "Gagal membuat template: " + e.message };
  }
}

/**
 * [PENTING] Update 'prosesImportExcelSiswa' agar menggunakan 'getKelas' dari Firestore.
 * Ganti fungsi 'prosesImportExcelSiswa' yang Anda buat di Langkah 2 dengan versi ini.
 */
function prosesImportExcelSiswa(token, fileData) {
  let tempExcelFileId = null;
  let tempConvertedSheetId = null;
  try {
    const { sessionData } = validateAdminSession(token);
    const sekolahID = sessionData.sekolahID;
    
    const { firestore, projectId } = getFirestoreInstance();
    const projectPath = `projects/${projectId}/databases/(default)/documents`;

    // 1. Ambil data NISN dan Urutan dari Firestore
    const allSiswaDocs = firestore.getCollection('siswa')
                                  .where('sekolahID', '==', sekolahID)
                                  .getDocuments();
    
    const existingNisnSet = new Set();
    let maxIdNum = 0;
    let maxUrutan = 0;
    allSiswaDocs.forEach(doc => {
      const nisn = parseValue(doc.fields.nisn);
      if (nisn) existingNisnSet.add(nisn);
      const idNum = parseInt((parseValue(doc.fields.siswaID) || 'SIS-0').split('-')[1] || 0);
      if (idNum > maxIdNum) maxIdNum = idNum;
      const urutanNum = Number(parseValue(doc.fields.urutan) || 0);
      if (urutanNum > maxUrutan) maxUrutan = urutanNum;
    });

    // 2. Ambil data Kelas dari Firestore
    const kelasDocs = firestore.getCollection('kelas')
                               .where('sekolahID', '==', sekolahID)
                               .getDocuments();
    const existingKelasSet = new Set(kelasDocs.map(doc => parseValue(doc.fields.namaKelas).trim()));

    // 3. Proses file (SAMA)
    const { base64, mimeType, fileName } = fileData;
    const decodedData = Utilities.base64Decode(base64.split(',')[1]);
    const blob = Utilities.newBlob(decodedData, mimeType, fileName);
    const tempExcelFile = DriveApp.createFile(blob);
    tempExcelFileId = tempExcelFile.getId();
    const conversionResource = { title: `[TEMP] Konversi - ${fileName}`, mimeType: MimeType.GOOGLE_SHEETS };
    const convertedFile = Drive.Files.copy(conversionResource, tempExcelFileId, { convert: true });
    tempConvertedSheetId = convertedFile.id;
    const tempSheet = SpreadsheetApp.openById(tempConvertedSheetId);
    const dataSheet = tempSheet.getSheets()[0];
    const excelData = dataSheet.getDataRange().getValues();
    if (excelData.length <= 1) throw new Error("File Excel kosong atau hanya berisi header.");
    excelData.shift();

    // 4. Validasi dan Persiapan Batch
    const gagalList = [];
    const batch = firestore.batch();
    let nextIdNum = maxIdNum + 1;
    let nextUrutan = maxUrutan + 1;
    let successCount = 0;

    for (let i = 0; i < excelData.length; i++) {
      const row = excelData[i];
      const barisKe = i + 2;
      const nama = (row[0] ? String(row[0]) : '').trim();
      const nisn = (row[1] ? String(row[1]) : '').trim();
      const nisLokal = (row[2] ? String(row[2]) : '').trim();
      const jk = (row[3] ? String(row[3]) : '').trim().toUpperCase();
      const tempatLahir = (row[4] ? String(row[4]) : '').trim();
      let tglLahir = (row[5] ? row[5] : '');
      if (tglLahir instanceof Date) {
        tglLahir = Utilities.formatDate(tglLahir, Session.getScriptTimeZone(), "yyyy-MM-dd");
      } else {
        tglLahir = String(tglLahir).trim();
      }
      const kelas = (row[6] ? String(row[6]) : '').trim();
      
      // Validasi
      if (!nama || !nisn || !jk || !kelas) {
        gagalList.push({ baris: barisKe, nama: nama, nisn: nisn, alasan: "Data wajib tidak lengkap." }); continue;
      }
      if (existingNisnSet.has(nisn)) {
        gagalList.push({ baris: barisKe, nama: nama, nisn: nisn, alasan: "NISN sudah terdaftar." }); continue;
      }
      if (jk !== 'L' && jk !== 'P') {
        gagalList.push({ baris: barisKe, nama: nama, nisn: nisn, alasan: "Jenis Kelamin harus 'L' atau 'P'." }); continue;
      }
      if (!existingKelasSet.has(kelas)) {
        gagalList.push({ baris: barisKe, nama: nama, nisn: nisn, alasan: `Kelas '${kelas}' tidak ditemukan.` }); continue;
      }

      // Buat dokumen untuk batch
      const newSiswaID = "SIS-" + nextIdNum;
      const docId = `${sekolahID}_${newSiswaID}`;
      const fullDocPath = `${projectPath}/siswa/${docId}`;
      const docRef = { name: fullDocPath };
      
      const newDoc = {
        sekolahID: sekolahID, siswaID: newSiswaID, namaSiswa: nama, nisn: nisn,
        nisLokal: nisLokal || null, jenisKelamin: jk, tempatLahir: tempatLahir || null,
        tglLahir: tglLahir || null, kelas: kelas, urutan: nextUrutan
      };

      batch.create(docRef, newDoc);
      
      existingNisnSet.add(nisn);
      nextIdNum++;
      nextUrutan++;
      successCount++;
    }

    // 5. Commit Batch
    if (successCount > 0) {
      batch.commit();
    }

    // 6. Cleanup
    DriveApp.getFileById(tempExcelFileId).setTrashed(true);
    DriveApp.getFileById(tempConvertedSheetId).setTrashed(true);
    clearSiswaCache(sessionData.sekolahID);
    
    return {
      status: "sukses",
      totalDiProses: excelData.length,
      berhasilDiUpload: successCount,
      gagalDiUpload: gagalList.length,
      dataGagal: gagalList
    };
  } catch (e) {
    if (tempExcelFileId) { DriveApp.getFileById(tempExcelFileId).setTrashed(true); }
    if (tempConvertedSheetId) { DriveApp.getFileById(tempConvertedSheetId).setTrashed(true); }
    Logger.log("Gagal prosesImportExcelSiswa (Firestore): " + e.message);
    return { status: "gagal", message: "Terjadi error: " + e.message };
  }
}

function moveSiswaUrutan(token, siswaID, direction) {
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = getSiswaSheet(ss);
    const data = sheet.getDataRange().getValues();
    let targetRowIndex = -1;
    let targetData = null;
    for (let i = 0; i < data.length; i++) {
      if (data[i][0] === siswaID) {
        targetRowIndex = i;
        targetData = {
          id: data[i][0],
          kelas: data[i][7],
          urutan: Number(data[i][8] || parseInt((data[i][0] || 'SIS-0').split('-')[1] || 0)),
          sheetRow: i + 1
        };
        break;
      }
    }
    if (!targetData) {
      throw new Error("SiswaID tidak ditemukan.");
    }
    const classmates = [];
    for (let i = 0; i < data.length; i++) {
      if (data[i][7] === targetData.kelas) {
        const idNum = parseInt((data[i][0] || 'SIS-0').split('-')[1] || 0);
        classmates.push({
          id: data[i][0],
          kelas: data[i][7],
          urutan: Number(data[i][8] || idNum),
          sheetRow: i + 1
        });
      }
    }
    classmates.sort((a, b) => a.urutan - b.urutan);
    let targetIndexInClass = classmates.findIndex(s => s.id === siswaID);
    let swapTarget = null;
    if (direction === 'up' && targetIndexInClass > 0) {
      swapTarget = classmates[targetIndexInClass - 1];
    } else if (direction === 'down' && targetIndexInClass < classmates.length - 1) {
      swapTarget = classmates[targetIndexInClass + 1];
    }
    if (swapTarget) {
      const targetUrutanVal = targetData.urutan;
      const swapUrutanVal = swapTarget.urutan;
      sheet.getRange(targetData.sheetRow, 9).setValue(swapUrutanVal);
      sheet.getRange(swapTarget.sheetRow, 9).setValue(targetUrutanVal);
      clearSiswaCache(sessionData.sekolahID);
      return { status: "sukses" };
    }
    return { status: "gagal", message: "Tidak bisa bergerak lebih jauh." };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

/**
 * [BARU/DIGANTI] Menyimpan urutan siswa secara batch ke Firestore.
 */
function saveSiswaUrutanBatch(token, urutanData) {
  let sekolahID, sessionData;
  try {
    const session = validateAdminSession(token);
    sekolahID = session.sessionData.sekolahID;
    sessionData = session.sessionData;
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
  
  try {
    const { firestore, projectId } = getFirestoreInstance();
    const projectPath = `projects/${projectId}/databases/(default)/documents`;
    const batch = firestore.batch();

    urutanData.forEach(item => {
      const docId = `${sekolahID}_${item.id}`;
      const fullDocPath = `${projectPath}/siswa/${docId}`;
      const docRef = { name: fullDocPath };
      
      const fieldsToUpdate = {
        urutan: item.urutan
      };

      // Update dokumen di batch, dengan mask
      batch.update(docRef, fieldsToUpdate, { fieldPaths: ["urutan"] });
    });

    batch.commit();
    
    clearSiswaCache(sessionData.sekolahID);
    return { status: "sukses" };
  } catch (e) {
    Logger.log("Gagal saveSiswaUrutanBatch (Firestore): " + e.message);
    return { status: "gagal", message: e.message };
  }
}

/*
function getNilaiUjianSheet(ss) {
  let userSpreadsheet = ss;
  if (!userSpreadsheet) {
    const { spreadsheetID } = validateAdminSession();
    if (!spreadsheetID) throw new Error("Spreadsheet ID Sesi tidak ditemukan.");
    userSpreadsheet = SpreadsheetApp.openById(spreadsheetID);
  }

  let sheet = userSpreadsheet.getSheetByName('Nilai_Ujian');
  if (!sheet) {
    sheet = userSpreadsheet.insertSheet('Nilai_Ujian');
    sheet.appendRow(['SiswaID', 'MapelID', 'UjianMadrasah', 'UjianPraktek']);
    SpreadsheetApp.flush();
  }
  return sheet;
}
*/

function getNilaiUjianGridData(token, tipeUjian) {
  try {
    const sessionData = validateAndRefreshSession(token);
    const spreadsheetID = sessionData.spreadsheetID;
    const sekolahID = sessionData.sekolahID;
    const isGuru = (sessionData.role === 'guru');
    const assignedMapelSet = isGuru ? new Set(sessionData.assignedMapel) : null;

    const userCache = CacheService.getUserCache();
    const cacheKeySuffix = isGuru ? `_GURU_${sessionData.namaGuru.replace(/\s+/g, '')}` : '';
    const cacheKey = NILAI_GRID_CACHE_KEY_PREFIX + tipeUjian + "_" + sekolahID + cacheKeySuffix;
    
    const cachedData = userCache.get(cacheKey);
    if (cachedData != null) {
      return JSON.parse(cachedData);
    }
    
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheetSiswa = getSiswaSheet(ss);
    const dataSiswa = sheetSiswa.getDataRange().getValues();
    dataSiswa.shift();
    const siswaList = dataSiswa.map(row => ({
      id: row[0], nama: row[1], nisn: row[2], kelas: row[7], urutan: Number(row[8] || 0)
    })).sort((a, b) => {
      const kc = a.kelas.localeCompare(b.kelas);
      return kc !== 0 ? kc : a.urutan - b.urutan;
    });

    let mapelListFull = getMapelDataInternal(ss, sekolahID);
    if (isGuru) {
      mapelListFull = mapelListFull.filter(m => assignedMapelSet.has(m.id));
    }
    let filteredMapel = (tipeUjian === 'UM') ? mapelListFull.filter(m => m.isUS) : mapelListFull.filter(m => m.isUP);
    const mapelList = filteredMapel.map(m => ({ id: m.id, nama: m.nama }));

    const { firestore } = getFirestoreInstance();
    const nilaiData = {};
    const fieldToGet = (tipeUjian === 'UM') ? 'um' : 'up';

    const documents = firestore.getCollection('nilai_ujian')
                               .where('sekolahID', '==', sekolahID)
                               .getDocuments();

    for (const doc of documents) {
      const fields = doc.fields;
      if (!fields.siswaID || !fields.mapelID) continue;
      
      const key = `${fields.siswaID.stringValue}_${fields.mapelID.stringValue}`;
      let nilai = null;

      if (fields[fieldToGet] && fields[fieldToGet].integerValue) {
        nilai = parseInt(fields[fieldToGet].integerValue);
      } else if (fields[fieldToGet] && fields[fieldToGet].doubleValue) {
        nilai = parseFloat(fields[fieldToGet].doubleValue);
      }
      
      if (nilai !== null) {
        nilaiData[key] = nilai;
      }
    }

    const response = { status: "sukses", data: { siswaList, mapelList, nilaiData } };
    userCache.put(cacheKey, JSON.stringify(response), 600);
    return response;
  } catch (e) {
    Logger.log(`Gagal getNilaiUjianGridData (Firestore): ${e.message} ${e.stack}`);
    return { status: "gagal", message: e.message };
  }
}

function saveNilaiUjianBatch(token, dataToSave) {
  try {
    const sessionData = validateAndRefreshSession(token);
    const sekolahID = sessionData.sekolahID;
    const isGuru = (sessionData.role === 'guru');

    if (isGuru) {
      const assignedSet = new Set(sessionData.assignedMapel);
      for (const item of dataToSave) {
        if (!assignedSet.has(item.mapelId)) {
          throw new Error(`Akses Ditolak: Anda tidak berhak menyimpan nilai untuk mapel ${item.mapelId}`);
        }
      }
    }

    const { firestore, projectId } = getFirestoreInstance();
    const projectPath = `projects/${projectId}/databases/(default)/documents`;
    const batch = firestore.batch();
    let tipeUjianDisimpan = null;

    dataToSave.forEach(item => {
      if (!tipeUjianDisimpan) tipeUjianDisimpan = item.tipeUjian;
      
      const docId = `${sekolahID}_${item.siswaId}_${item.mapelId}`;
      const fullDocPath = `${projectPath}/nilai_ujian/${docId}`;
      const docRef = { name: fullDocPath };
      
      let nilaiBaru = null;
      if (item.nilai !== "" && item.nilai != null) {
        let num = parseFloat(item.nilai);
        if (!isNaN(num) && num >= 0 && num <= 100) nilaiBaru = num;
      }
      
      const data = {
        sekolahID: sekolahID,
        siswaID: item.siswaId,
        mapelID: item.mapelId,
        [item.tipeUjian === 'UM' ? 'um' : 'up']: nilaiBaru
      };

      batch.set(docRef, data, { merge: true });
    });

    let response = batch.commit();
    if (response.error) {
      throw new Error("Gagal commit batch Ujian: " + response.error.message);
    }

    const userCache = CacheService.getUserCache();
    if (tipeUjianDisimpan) {
        userCache.remove(NILAI_GRID_CACHE_KEY_PREFIX + tipeUjianDisimpan + "_" + sekolahID);
        if (isGuru) {
            userCache.remove(NILAI_GRID_CACHE_KEY_PREFIX + tipeUjianDisimpan + "_" + sekolahID + `_GURU_${sessionData.namaGuru.replace(/\s+/g, '')}`);
        }
    } else {
        clearNilaiUjianCache(sekolahID);
    }
    if (!isGuru) {
      clearRekapNilaiCache(sekolahID);
    }
    clearLockedKelasCache(sekolahID);
    
    return { status: "sukses", message: "Nilai tersimpan." };

  } catch (e) {
    Logger.log(`Gagal saveNilaiUjianBatch (Firestore): ${e.message} ${e.stack}`);
    return { status: "gagal", message: e.message };
  }
}

function getNilaiTemplateData(token, kelasDipilih) {
  let tempSpreadsheetId = null;
  try {
    const { sessionData } = validateAdminOrGuruSession(token);
    const namaSekolah = sessionData.namaSekolah;
    const siswaResponse = getSiswa(token);
    if (siswaResponse.status !== 'sukses') throw new Error(siswaResponse.message);
    const siswaList = siswaResponse.siswa;
    const filteredSiswa = (kelasDipilih === 'semua') ? siswaList : siswaList.filter(s => s.kelas === kelasDipilih);
    if (filteredSiswa.length === 0) return { status: "gagal", message: `Tidak ada siswa di kelas '${kelasDipilih}'.` };
    const mapelResponse = getMapel(token);
    if (mapelResponse.status !== 'sukses') throw new Error(mapelResponse.message);
    
    let allMapel = mapelResponse.mapel;
    
    // --- TAMBAHAN FILTER UNTUK GURU ---
    if (sessionData.role === 'guru') {
      const assignedMapelSet = new Set(sessionData.assignedMapel);
      allMapel = allMapel.filter(m => assignedMapelSet.has(m.id));
    }
    // --- AKHIR TAMBAHAN ---
    
    const mapelUS = allMapel.filter(m => m.isUS === true);
    const mapelUP = allMapel.filter(m => m.isUP === true);
    const timestamp = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "yyyyMMdd_HHmmss");
    const tempFileName = `[TEMP] Template Nilai - ${namaSekolah} - ${timestamp}`;
    const ss = SpreadsheetApp.create(tempFileName);
    tempSpreadsheetId = ss.getId();
    const rule = SpreadsheetApp.newDataValidation().requireNumberBetween(0, 100).setAllowInvalid(true).build();
    const sheetUS = ss.getSheetByName('Sheet1');
    const jenjangPilihan = sessionData.jenjangPilihan;
    const namaSheetUS = (jenjangPilihan === 'MI' || jenjangPilihan === 'MTS' || jenjangPilihan === 'MA') ? 'Ujian Madrasah' : 'Ujian Sekolah';
    sheetUS.setName(namaSheetUS);
    sheetUS.getRange("B:B").setNumberFormat("@");
    if (mapelUS.length > 0) {
      const headersUS = ["Nama Siswa", "NISN", "Kelas", ...mapelUS.map(m => m.id)];
      sheetUS.getRange(1, 1, 1, headersUS.length).setValues([headersUS]);
      const dataSiswaRows = filteredSiswa.map(s => [s.nama, String(s.nisn), s.kelas]);
      sheetUS.getRange(2, 1, dataSiswaRows.length, 3).setValues(dataSiswaRows);
      sheetUS.getRange(2, 4, dataSiswaRows.length, mapelUS.length).setDataValidation(rule);
      sheetUS.autoResizeColumns(1, 3);
    } else {
      sheetUS.getRange('A1').setValue(`Tidak ada mapel untuk ${namaSheetUS}.`);
    }
    const sheetUP = ss.insertSheet('Ujian Praktek');
    sheetUP.getRange("B:B").setNumberFormat("@");
    if (mapelUP.length > 0) {
      const headersUP = ["Nama Siswa", "NISN", "Kelas", ...mapelUP.map(m => m.id)];
      sheetUP.getRange(1, 1, 1, headersUP.length).setValues([headersUP]);
      const dataSiswaRows = filteredSiswa.map(s => [s.nama, String(s.nisn), s.kelas]);
      sheetUP.getRange(2, 1, dataSiswaRows.length, 3).setValues(dataSiswaRows);
      sheetUP.getRange(2, 4, dataSiswaRows.length, mapelUP.length).setDataValidation(rule);
      sheetUP.autoResizeColumns(1, 3);
    } else {
      sheetUP.getRange('A1').setValue('Tidak ada mapel untuk Ujian Praktek.');
    }
    SpreadsheetApp.flush();
    const url = "https://docs.google.com/spreadsheets/d/" + tempSpreadsheetId + "/export?format=xlsx";
    const oauthToken = ScriptApp.getOAuthToken();
    const response = UrlFetchApp.fetch(url, { headers: { 'Authorization': 'Bearer ' + oauthToken } });
    const base64Data = Utilities.base64Encode(response.getBlob().getBytes());
    return { status: "sukses", base64: base64Data, mimeType: MimeType.MICROSOFT_EXCEL, fileName: "template_nilai_ujian.xlsx" };
  } catch (e) {
    return { status: "gagal", message: "Gagal membuat template: " + e.message };
  } finally {
    if (tempSpreadsheetId) DriveApp.getFileById(tempSpreadsheetId).setTrashed(true);
  }
}

function hitungNilaiRekap(nilaiUM, nilaiUP) {
  const um = (nilaiUM === null || nilaiUM === undefined || nilaiUM === "") ? null : parseFloat(nilaiUM);
  const up = (nilaiUP === null || nilaiUP === undefined || nilaiUP === "") ? null : parseFloat(nilaiUP);
  
  const umIsValid = (um !== null && !isNaN(um));
  const upIsValid = (up !== null && !isNaN(up));
  
  if (umIsValid && upIsValid) {
    return (um + up) / 2;
  } else if (umIsValid) {
    return um;
  } else if (upIsValid) {
    return up;
  } else {
    return null;
  }
}

function getRekapitulasiNilaiData(token) {
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    const sekolahID = sessionData.sekolahID;
    const userCache = CacheService.getUserCache();
    const cacheKey = REKAP_NILAI_CACHE_KEY + "_" + sekolahID;
    const cachedData = userCache.get(cacheKey);
    if (cachedData != null) {
      return JSON.parse(cachedData);
    }
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const siswaData = getSiswa(token);
    if (siswaData.status !== 'sukses') throw new Error(siswaData.message);
    const siswaList = siswaData.siswa.map(s => ({ id: s.id, nama: s.nama, nisn: s.nisn, kelas: s.kelas }));
    const mapelListFull = getMapelDataInternal(ss, sekolahID);
    
    // --- PERUBAHAN DI SINI ---
    const { mapelList, nilaiRekapMap } = getRekapUjianInternal(ss, siswaList, mapelListFull, sekolahID);
    // --- AKHIR PERUBAHAN ---

    const nilaiRekapDataObj = {};
    nilaiRekapMap.forEach((value, key) => { nilaiRekapDataObj[key] = value; });
    const response = { status: "sukses", data: { siswaList, mapelList, nilaiRekapData: nilaiRekapDataObj } };
    userCache.put(cacheKey, JSON.stringify(response), 600);
    return response;
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function getRekapitulasiNilaiRaporData(token) {
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    const sekolahID = sessionData.sekolahID;
    const userCache = CacheService.getUserCache();
    const cacheKey = REKAP_NILAI_RAPOR_CACHE_KEY + "_" + sekolahID;
    const cachedData = userCache.get(cacheKey);
    if (cachedData != null) {
      return JSON.parse(cachedData);
    }
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const semesterListData = getSemesterList(token);
    if (semesterListData.status !== 'sukses') throw new Error(semesterListData.message);
    const semesterIds = semesterListData.semesterList.map(s => s.id);
    const siswaData = getSiswa(token);
    if (siswaData.status !== 'sukses') throw new Error(siswaData.message);
    const siswaList = siswaData.siswa.map(s => ({ id: s.id, nama: s.nama, nisn: s.nisn, kelas: s.kelas }));
    const mapelListFull = getMapelDataInternal(ss, sekolahID);

    // --- PERUBAHAN DI SINI ---
    const { mapelList, nilaiRekapMap } = getRekapRaporInternal(ss, siswaList, mapelListFull, semesterIds, sekolahID);
    // --- AKHIR PERUBAHAN ---
    
    const nilaiRekapDataObj = {};
    nilaiRekapMap.forEach((value, key) => { nilaiRekapDataObj[key] = value; });
    const response = {
      status: "sukses",
      data: { siswaList, mapelList, nilaiRekapData: nilaiRekapDataObj, jumlahSemester: semesterIds.length }
    };
    userCache.put(cacheKey, JSON.stringify(response), 600);
    return response;
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

/**
 * [DIGANTI] Mengambil pengaturan semester dari Firestore.
 */
function getSemesterSetting(token) {
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    const config = getSekolahConfigData(sessionData.sekolahID, spreadsheetID);

    return { 
      status: "sukses", 
      jenjang: sessionData.jenjang, 
      setting: config.jumlahSemester 
    };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

/**
 * [DIGANTI] Menyimpan pengaturan semester ke Firestore.
 */
function saveSemesterSetting(token, jumlahSemester) {
  try {
    const { sessionData } = validateAdminSession(token);
    const jenjang = sessionData.jenjang;
    const settingAngka = parseInt(jumlahSemester, 10);
    
    if (settingAngka !== 3 && settingAngka !== 5) return { status: "gagal", message: "Nilai semester tidak valid." };
    if (jenjang !== 'SD/MI' && settingAngka === 3) return { status: "gagal", message: "3 semester hanya untuk SD/MI." };

    const dataToSave = {
      jumlahSemester: settingAngka
    };

    const result = _saveSekolahConfig(sessionData.sekolahID, dataToSave, token);
    if (result.status === 'sukses') {
      clearNilaiRaporCache(sessionData.sekolahID);
    }
    return result;
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

/*
function getNilaiRaporSheet(ss) {
  let userSpreadsheet = ss;
  if (!userSpreadsheet) {
    const { spreadsheetID } = validateAdminSession();
    if (!spreadsheetID) throw new Error("Spreadsheet ID Sesi tidak ditemukan.");
    userSpreadsheet = SpreadsheetApp.openById(spreadsheetID);
  }

  let sheet = userSpreadsheet.getSheetByName('Nilai_Rapor_Akhir');
  if (!sheet) {
    sheet = userSpreadsheet.insertSheet('Nilai_Rapor_Akhir');
    sheet.appendRow(['SiswaID', 'MapelID', 'SemesterID', 'Nilai_P', 'Nilai_K']);
    SpreadsheetApp.flush();
  } else {
    const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    const nilaiIndex = headers.indexOf('Nilai');
    const nilaiPIndex = headers.indexOf('Nilai_P');
    
    if (nilaiIndex !== -1 && nilaiPIndex === -1) {
      sheet.getRange(1, nilaiIndex + 1).setValue('Nilai_P');
      sheet.getRange(1, headers.length + 1).setValue('Nilai_K');
      Logger.log("Migrasi skema Nilai_Rapor_Akhir: Menambahkan Nilai_P dan Nilai_K.");
    } else if (nilaiPIndex === -1) {
       sheet.clear();
       sheet.appendRow(['SiswaID', 'MapelID', 'SemesterID', 'Nilai_P', 'Nilai_K']);
    }
  }
  return sheet;
}
*/

function getSemesterList(token) {
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    const jenjang = sessionData.jenjang;
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheetSetting = getPengaturanSheet(ss);
    const data = sheetSetting.getRange('A1:B' + sheetSetting.getLastRow()).getValues();
    let jumlahSemester = 5;
    for (let i = 0; i < data.length; i++) {
      if (data[i][0] === 'Jumlah_Semester') {
        jumlahSemester = parseInt(data[i][1], 10) || 5;
        break;
      }
    }
    let semesterList = [];
    if (jenjang === 'SD/MI') {
      if (jumlahSemester === 3) {
        semesterList = [{ id: "K5_S1", nama: "Kelas 5 Ganjil", color: "#0d6efd" }, { id: "K5_S2", nama: "Kelas 5 Genap", color: "#0d6efd" }, { id: "K6_S1", nama: "Kelas 6 Ganjil", color: "#198754" }];
      } else {
        semesterList = [{ id: "K4_S1", nama: "Kelas 4 Ganjil", color: "#fd7e14" }, { id: "K4_S2", nama: "Kelas 4 Genap", color: "#fd7e14" }, { id: "K5_S1", nama: "Kelas 5 Ganjil", color: "#0d6efd" }, { id: "K5_S2", nama: "Kelas 5 Genap", color: "#0d6efd" }, { id: "K6_S1", nama: "Kelas 6 Ganjil", color: "#198754" }];
      }
    } else if (jenjang === 'SMP/MTS') {
      semesterList = [{ id: "K7_S1", nama: "Kelas 7 Ganjil", color: "#fd7e14" }, { id: "K7_S2", nama: "Kelas 7 Genap", color: "#fd7e14" }, { id: "K8_S1", nama: "Kelas 8 Ganjil", color: "#0d6efd" }, { id: "K8_S2", nama: "Kelas 8 Genap", color: "#0d6efd" }, { id: "K9_S1", nama: "Kelas 9 Ganjil", color: "#198754" }];
    } else if (jenjang === 'SMA/MA') {
      semesterList = [{ id: "K10_S1", nama: "Kelas 10 Ganjil", color: "#fd7e14" }, { id: "K10_S2", nama: "Kelas 10 Genap", color: "#fd7e14" }, { id: "K11_S1", nama: "Kelas 11 Ganjil", color: "#0d6efd" }, { id: "K11_S2", nama: "Kelas 11 Genap", color: "#0d6efd" }, { id: "K12_S1", nama: "Kelas 12 Ganjil", color: "#198754" }];
    }
    return { status: "sukses", semesterList: semesterList };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function getNilaiRaporGridData(token, semesterId) {
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    const sekolahID = sessionData.sekolahID;
    
    const userCache = CacheService.getUserCache();
    const cacheKey = NILAI_RAPOR_GRID_CACHE_KEY_PREFIX + semesterId + "_" + sekolahID;
    const cachedData = userCache.get(cacheKey);
    if (cachedData != null) {
      return JSON.parse(cachedData);
    }
    
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const siswaData = getSiswa(token);
    if (siswaData.status !== 'sukses') throw new Error(siswaData.message);
    const siswaList = siswaData.siswa.map(s => ({ id: s.id, nama: s.nama, nisn: s.nisn, kelas: s.kelas }));
    
    const mapelListFull = getMapelDataInternal(ss, sekolahID);
    const filteredMapelList = mapelListFull.filter(m => m.isUS === true || m.isUP === true);
    const mapelList = filteredMapelList.map(m => ({ id: m.id, nama: m.nama }));

    const { firestore } = getFirestoreInstance();
    const nilaiMapP = new Map();
    const nilaiMapK = new Map();
    const nilaiMapRekap = new Map();

    const documents = firestore.getCollection('nilai_rapor')
                               .where('sekolahID', '==', sekolahID)
                               .where('semesterID', '==', semesterId)
                               .getDocuments();

    for (const doc of documents) {
      const fields = doc.fields;
      if (!fields.siswaID || !fields.mapelID) continue;
      
      const key = `${fields.siswaID.stringValue}_${fields.mapelID.stringValue}`;

      let p = null, k = null;
      if (fields.p && (fields.p.integerValue || fields.p.doubleValue)) {
         p = parseFloat(fields.p.integerValue || fields.p.doubleValue);
         nilaiMapP.set(key, p);
      }
      if (fields.k && (fields.k.integerValue || fields.k.doubleValue)) {
         k = parseFloat(fields.k.integerValue || fields.k.doubleValue);
         nilaiMapK.set(key, k);
      }

      let rekapVal = null;
      if (p != null && k != null) rekapVal = (p + k) / 2;
      else if (p != null) rekapVal = p;
      else if (k != null) rekapVal = k;
      
      if (rekapVal !== null) nilaiMapRekap.set(key, Math.round(rekapVal));
    }

    const nilaiDataP = {};
    const nilaiDataK = {};
    const nilaiDataRekap = {};
    siswaList.forEach(siswa => {
      mapelList.forEach(mapel => {
        const key = `${siswa.id}_${mapel.id}`;
        if (nilaiMapP.has(key)) nilaiDataP[key] = nilaiMapP.get(key);
        if (nilaiMapK.has(key)) nilaiDataK[key] = nilaiMapK.get(key);
        if (nilaiMapRekap.has(key)) nilaiDataRekap[key] = nilaiMapRekap.get(key);
      });
    });
    
    const semesterListData = getSemesterList(token);
    let namaSemester = semesterId;
    if (semesterListData.status === 'sukses') {
      const sem = semesterListData.semesterList.find(s => s.id === semesterId);
      if (sem) namaSemester = sem.nama;
    }
    
    const response = {
      status: "sukses",
      namaSemester: namaSemester,
      dataP: { siswaList, mapelList, nilaiData: nilaiDataP },
      dataK: { siswaList, mapelList, nilaiData: nilaiDataK },
      dataRekap: { siswaList, mapelList, nilaiData: nilaiDataRekap }
    };
    userCache.put(cacheKey, JSON.stringify(response), 600);
    return response;
  } catch (e) {
    Logger.log(`Gagal getNilaiRaporGridData (Firestore): ${e.message} ${e.stack}`);
    return { status: "gagal", message: e.message };
  }
}

function saveNilaiRaporBatch(token, dataToSave, tipeNilai) {
  let sekolahID, sessionData;
  try {
    const session = validateAdminSession(token);
    sekolahID = session.sessionData.sekolahID;
    sessionData = session.sessionData;
    if (!tipeNilai || (tipeNilai !== 'P' && tipeNilai !== 'K')) return { status: "gagal", message: "Tipe nilai tidak valid." };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }

  try {
    const { firestore, projectId } = getFirestoreInstance();
    const projectPath = `projects/${projectId}/databases/(default)/documents`;
    const batch = firestore.batch();
    const semesterIdsToClear = new Set();

    dataToSave.forEach(item => {
      if (!item.semesterId) return;
      semesterIdsToClear.add(item.semesterId);
      
      const docId = `${sekolahID}_${item.siswaId}_${item.mapelId}_${item.semesterId}`;
      const fullDocPath = `${projectPath}/nilai_rapor/${docId}`;
      const docRef = { name: fullDocPath };
      
      let nilaiAngka = null;
      if (item.nilai !== "" && item.nilai != null) {
        let num = parseFloat(item.nilai);
        if (!isNaN(num) && Number.isInteger(num) && num >= 0 && num <= 100) nilaiAngka = num;
      }
      
      const data = {
        sekolahID: sekolahID,
        siswaID: item.siswaId,
        mapelID: item.mapelId,
        semesterID: item.semesterId,
        [tipeNilai === 'P' ? 'p' : 'k']: nilaiAngka
      };

      batch.set(docRef, data, { merge: true });
    });

    let response = batch.commit();
    if (response.error) {
      throw new Error("Gagal commit batch Rapor: " + response.error.message);
    }

    const userCache = CacheService.getUserCache();
    semesterIdsToClear.forEach(semId => {
      userCache.remove(NILAI_RAPOR_GRID_CACHE_KEY_PREFIX + semId + "_" + sekolahID);
    });
    clearRekapNilaiRaporCache(sekolahID);
    clearLockedKelasCache(sekolahID);
    
    return { status: "sukses", message: "Nilai rapor tersimpan." };
  } catch (e) {
    Logger.log(`Gagal saveNilaiRaporBatch (Firestore): ${e.message} ${e.stack}`);
    return { status: "gagal", message: e.message };
  }
}

/**
 * FUNGSI MIGRASI SATU KALI.
 * Jalankan ini secara manual dari editor Apps Script.
 * Ini akan mengubah semua password plain text di Sheet_Sekolah menjadi hash.
 */
function MIGRASI_PasswordLama() {
  Logger.log("Memulai migrasi password...");
  
  let masterSS;
  let sheetSekolah;
  
  try {
    masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
    sheetSekolah = masterSS.getSheetByName('Sheet_Sekolah');
    if (!sheetSekolah) {
      Logger.log("Sheet_Sekolah tidak ditemukan. Migrasi dibatalkan.");
      return;
    }
    
    const range = sheetSekolah.getDataRange();
    const values = range.getValues();
    let migratedCount = 0;
    
    // Mulai dari i = 1 untuk melewati header
    for (let i = 1; i < values.length; i++) {
      const plainPass = values[i][4]; // Kolom E
      const salt = values[i][6];      // Kolom G
      
      // Jika 'salt' KOSONG dan 'plainPass' ADA ISINYA, maka itu akun lama
      if (!salt && plainPass) {
        const newSalt = generateSalt();
        const newHash = hashPassword(plainPass, newSalt);
        
        // Update HashedPassword (Kolom E)
        sheetSekolah.getRange(i + 1, 5).setValue(newHash);
        // Update Salt (Kolom G)
        sheetSekolah.getRange(i + 1, 7).setValue(newSalt);
        
        migratedCount++;
        Logger.log(`Password untuk baris ${i+1} (Email: ${values[i][3]}) telah di-hash.`);
      }
    }
    
    if (migratedCount > 0) {
      // Bersihkan cache agar data baru dibaca
      clearMasterSheetCache();
      Logger.log(`Migrasi Selesai. ${migratedCount} password telah di-hash dan diamankan. Cache dibersihkan.`);
      SpreadsheetApp.flush();
      Browser.msgBox(`Migrasi Selesai. ${migratedCount} password telah di-hash dan diamankan.`);
    } else {
      Logger.log("Migrasi Selesai. Tidak ada password plain text yang ditemukan untuk dimigrasi.");
      Browser.msgBox("Migrasi Selesai. Tidak ada password lama yang ditemukan.");
    }
    
  } catch (e) {
    Logger.log("Gagal total saat migrasi: " + e.message);
    Browser.msgBox("Migrasi Gagal: " + e.message);
  }
}

function getNilaiRaporTemplateData(token, semesterId, kelasDipilih) {
  let tempSpreadsheetId = null;
  try {
    const { sessionData } = validateAdminSession(token);
    const namaSekolah = sessionData.namaSekolah;
    const siswaResponse = getSiswa(token);
    if (siswaResponse.status !== 'sukses') throw new Error(siswaResponse.message);
    const siswaList = siswaResponse.siswa;
    const filteredSiswa = (kelasDipilih === 'semua') ? siswaList : siswaList.filter(s => s.kelas === kelasDipilih);
    if (filteredSiswa.length === 0) return { status: "gagal", message: `Tidak ada siswa di kelas '${kelasDipilih}'.` };
    const mapelResponse = getMapel(token);
    if (mapelResponse.status !== 'sukses') throw new Error(mapelResponse.message);
    const mapelList = mapelResponse.mapel;
    if (mapelList.length === 0) return { status: "gagal", message: "Tidak ada mata pelajaran." };
    const timestamp = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "yyyyMMdd_HHmmss");
    const tempFileName = `[TEMP] Template Rapor - ${namaSekolah} - ${timestamp}`;
    const ss = SpreadsheetApp.create(tempFileName);
    tempSpreadsheetId = ss.getId();
    const rule = SpreadsheetApp.newDataValidation().requireNumberBetween(0, 100).setAllowInvalid(true).build();
    const mapelHeaders = mapelList.map(m => m.id);
    const headers = ["Nama Siswa", "NISN", "Kelas", ...mapelHeaders];
    const dataSiswaRows = filteredSiswa.map(s => [s.nama, String(s.nisn), s.kelas]);
    const sheetP = ss.getSheetByName('Sheet1');
    sheetP.setName("Pengetahuan");
    sheetP.getRange("B:B").setNumberFormat("@");
    sheetP.getRange(1, 1, 1, headers.length).setValues([headers]);
    sheetP.getRange(2, 1, dataSiswaRows.length, 3).setValues(dataSiswaRows);
    if (mapelHeaders.length > 0) sheetP.getRange(2, 4, dataSiswaRows.length, mapelHeaders.length).setDataValidation(rule);
    sheetP.autoResizeColumns(1, 3);
    const sheetK = ss.insertSheet('Keterampilan');
    sheetK.getRange("B:B").setNumberFormat("@");
    sheetK.getRange(1, 1, 1, headers.length).setValues([headers]);
    sheetK.getRange(2, 1, dataSiswaRows.length, 3).setValues(dataSiswaRows);
    if (mapelHeaders.length > 0) sheetK.getRange(2, 4, dataSiswaRows.length, mapelHeaders.length).setDataValidation(rule);
    sheetK.autoResizeColumns(1, 3);
    const metadataSheet = ss.insertSheet('Metadata');
    metadataSheet.appendRow(['SemesterID', semesterId]);
    metadataSheet.appendRow(['Kelas', kelasDipilih]);
    metadataSheet.hideSheet();
    SpreadsheetApp.flush();
    const url = "[https://docs.google.com/spreadsheets/d/](https://docs.google.com/spreadsheets/d/)" + tempSpreadsheetId + "/export?format=xlsx";
    const oauthToken = ScriptApp.getOAuthToken();
    const response = UrlFetchApp.fetch(url, { headers: { 'Authorization': 'Bearer ' + oauthToken } });
    const fileNameOutput = `template_rapor_${semesterId}_${kelasDipilih}.xlsx`;
    return { status: "sukses", base64: Utilities.base64Encode(response.getBlob().getBytes()), mimeType: MimeType.MICROSOFT_EXCEL, fileName: fileNameOutput };
  } catch (e) {
    return { status: "gagal", message: "Gagal membuat template: " + e.message };
  } finally {
    if (tempSpreadsheetId) DriveApp.getFileById(tempSpreadsheetId).setTrashed(true);
  }
}

function prosesUploadExcelNilai(token, fileData) {
  let tempExcelFileId = null;
  let tempConvertedSheetId = null;
  try {
    const { sessionData, spreadsheetID } = validateAdminOrGuruSession(token);
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheetSiswa = getSiswaSheet(ss);
    const dataSiswa = sheetSiswa.getDataRange().getValues();
    dataSiswa.shift();
    const nisnToSiswaIdMap = new Map(dataSiswa.map(row => [String(row[2]), row[0]]));
    const sheetMapel = getMapelSheet(ss);
    const dataMapel = sheetMapel.getDataRange().getValues();
    dataMapel.shift();
    const mapelIdSet = new Set(dataMapel.map(row => row[0]));

    // --- TAMBAHAN KEAMANAN UNTUK GURU ---
    const isGuru = (sessionData.role === 'guru');
    const assignedMapelSet = isGuru ? new Set(sessionData.assignedMapel) : null;
    // --- AKHIR TAMBAHAN ---

    const { base64, mimeType, fileName } = fileData;
    const decodedData = Utilities.base64Decode(base64.split(',')[1]);
    const blob = Utilities.newBlob(decodedData, mimeType, fileName);
    const tempExcelFile = DriveApp.createFile(blob);
    tempExcelFileId = tempExcelFile.getId();
    const conversionResource = { title: `[TEMP] Upload Nilai - ${fileName}`, mimeType: MimeType.GOOGLE_SHEETS };
    const convertedFile = Drive.Files.copy(conversionResource, tempExcelFileId, { convert: true });
    tempConvertedSheetId = convertedFile.id;
    const tempSheet = SpreadsheetApp.openById(tempConvertedSheetId);
    const gagalList = [];
    const dataToSave = [];
    let totalDitemukan = 0;
    const jenjangPilihan = sessionData.jenjangPilihan;
    const namaSheetUS = (jenjangPilihan === 'MI' || jenjangPilihan === 'MTS' || jenjangPilihan === 'MA') ? 'Ujian Madrasah' : 'Ujian Sekolah';
    const sheetsToProcess = [{ name: namaSheetUS, type: 'UM' }, { name: 'Ujian Praktek', type: 'Praktek' }];
    sheetsToProcess.forEach(sheetInfo => {
      const sheet = tempSheet.getSheetByName(sheetInfo.name);
      if (!sheet) {
        gagalList.push({ sheet: sheetInfo.name, baris: 'N/A', info: 'Sheet Tidak Ditemukan', alasan: 'Sheet tidak ada di file.' });
        return;
      }
      const data = sheet.getDataRange().getValues();
      if (data.length <= 1) return;
      const header = data.shift();
      const mapelHeaders = header.slice(3);
      data.forEach((row, rowIndex) => {
        const barisKe = rowIndex + 2;
        const namaSiswa = row[0];
        const nisn = String(row[1]).trim();
        const siswaId = nisnToSiswaIdMap.get(nisn);
        if (!siswaId) {
          gagalList.push({ sheet: sheetInfo.name, baris: barisKe, info: `Siswa: ${namaSiswa || nisn}`, alasan: "NISN tidak terdaftar." });
          return;
        }
        mapelHeaders.forEach((mapelId, mapelIndex) => {
          mapelId = String(mapelId).trim();
          const nilai = row[mapelIndex + 3];
          if (nilai === null || nilai === "") return;

          // --- TAMBAHAN PENGECEKAN GURU ---
          if (isGuru && !assignedMapelSet.has(mapelId)) {
            // Jika ini guru, dan mapel ini BUKAN mapel mereka,
            // lewati (jangan proses dan jangan laporkan error).
            return; // Ini sama dengan 'continue' di forEach
          }
          // --- AKHIR TAMBAHAN ---

          totalDitemukan++;
          const info = `Siswa: ${namaSiswa} (Mapel: ${mapelId})`;
          if (!mapelIdSet.has(mapelId)) {
            gagalList.push({ sheet: sheetInfo.name, baris: barisKe, info: info, alasan: `Kode Mapel '${mapelId}' tidak dikenal.` });
            return;
          }
          let num = parseFloat(nilai);
          if (isNaN(num) || !Number.isInteger(num) || num < 0 || num > 100) {
            gagalList.push({ sheet: sheetInfo.name, baris: barisKe, info: info, alasan: `Nilai '${nilai}' tidak valid (harus angka bulat 0-100).` });
            return;
          }
          dataToSave.push({ siswaId: siswaId, mapelId: mapelId, tipeUjian: sheetInfo.type, nilai: num });
        });
      });
    });
    if (dataToSave.length > 0) {
      const saveResult = saveNilaiUjianBatch(token, dataToSave);
      if (saveResult.status !== 'sukses') throw new Error(saveResult.message);
    }
    DriveApp.getFileById(tempExcelFileId).setTrashed(true);
    DriveApp.getFileById(tempConvertedSheetId).setTrashed(true);
    return { status: "sukses", totalDitemukan: totalDitemukan, berhasilDiUpload: dataToSave.length, gagalDiUpload: gagalList.length, dataGagal: gagalList };
  } catch (e) {
    if (tempExcelFileId) DriveApp.getFileById(tempExcelFileId).setTrashed(true);
    if (tempConvertedSheetId) DriveApp.getFileById(tempConvertedSheetId).setTrashed(true);
    return { status: "gagal", message: "Terjadi error: " + e.message };
  }
}

function prosesUploadExcelNilaiRapor(token, fileData, semesterIdFromModal) {
  let tempExcelFileId = null;
  let tempConvertedSheetId = null;
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const { base64, mimeType, fileName } = fileData;
    const decodedData = Utilities.base64Decode(base64.split(',')[1]);
    const blob = Utilities.newBlob(decodedData, mimeType, fileName);
    const tempExcelFile = DriveApp.createFile(blob);
    tempExcelFileId = tempExcelFile.getId();
    const conversionResource = { title: `[TEMP] Upload Rapor - ${fileName}`, mimeType: MimeType.GOOGLE_SHEETS };
    const convertedFile = Drive.Files.copy(conversionResource, tempExcelFileId, { convert: true });
    tempConvertedSheetId = convertedFile.id;
    const tempSheet = SpreadsheetApp.openById(tempConvertedSheetId);
    const metadataSheet = tempSheet.getSheetByName('Metadata');
    if (!metadataSheet) throw new Error("File template tidak valid. Sheet 'Metadata' hilang.");
    const templateSemesterId = metadataSheet.getRange('B1').getValue();
    const templateKelas = metadataSheet.getRange('B2').getValue();
    if (templateSemesterId !== semesterIdFromModal) throw new Error("Semester file tidak cocok dengan pilihan.");
    const sheetSiswa = getSiswaSheet(ss);
    const dataSiswa = sheetSiswa.getDataRange().getValues();
    dataSiswa.shift();
    const nisnToSiswaIdMap = new Map();
    dataSiswa.forEach(row => {
      if (templateKelas === 'semua' || row[7] === templateKelas) nisnToSiswaIdMap.set(String(row[2]), row[0]);
    });
    const sheetMapel = getMapelSheet(ss);
    const dataMapel = sheetMapel.getDataRange().getValues();
    dataMapel.shift();
    const mapelIdSet = new Set(dataMapel.map(row => row[0]));
    const gagalList = [];
    const dataToSaveP = [];
    const dataToSaveK = [];
    let totalDitemukan = 0;
    const sheetsToProcess = [{ name: "Pengetahuan", dataArray: dataToSaveP }, { name: 'Keterampilan', dataArray: dataToSaveK }];
    sheetsToProcess.forEach(sheetInfo => {
      const sheet = tempSheet.getSheetByName(sheetInfo.name);
      if (!sheet) {
        gagalList.push({ sheet: sheetInfo.name, baris: 'N/A', info: 'Sheet Tidak Ditemukan', alasan: 'Sheet tidak ada.' });
        return;
      }
      const data = sheet.getDataRange().getValues();
      if (data.length <= 1) return;
      const header = data.shift();
      const mapelHeaders = header.slice(3);
      data.forEach((row, rowIndex) => {
        const barisKe = rowIndex + 2;
        const namaSiswa = row[0];
        const nisn = String(row[1]).trim();
        const kelasSiswa = String(row[2]).trim();
        const siswaId = nisnToSiswaIdMap.get(nisn);
        if (templateKelas !== 'semua' && kelasSiswa !== templateKelas) {
          gagalList.push({ sheet: sheetInfo.name, baris: barisKe, info: `Siswa: ${namaSiswa}`, alasan: "Siswa salah kelas." });
          return;
        }
        if (!siswaId) {
          gagalList.push({ sheet: sheetInfo.name, baris: barisKe, info: `Siswa: ${namaSiswa || nisn}`, alasan: "NISN tidak terdaftar." });
          return;
        }
        mapelHeaders.forEach((mapelId, mapelIndex) => {
          mapelId = String(mapelId).trim();
          const nilai = row[mapelIndex + 3];
          if (nilai === null || nilai === "") return;
          totalDitemukan++;
          const info = `Siswa: ${namaSiswa} (Mapel: ${mapelId})`;
          if (!mapelIdSet.has(mapelId)) {
            gagalList.push({ sheet: sheetInfo.name, baris: barisKe, info: info, alasan: `Kode Mapel '${mapelId}' tidak dikenal.` });
            return;
          }
          let num = parseFloat(nilai);
          if (isNaN(num) || !Number.isInteger(num) || num < 0 || num > 100) {
            gagalList.push({ sheet: sheetInfo.name, baris: barisKe, info: info, alasan: `Nilai '${nilai}' tidak valid.` });
            return;
          }
          sheetInfo.dataArray.push({ siswaId, mapelId, semesterId: templateSemesterId, nilai: num });
        });
      });
    });
    let totalBerhasil = 0;
    if (dataToSaveP.length > 0) {
      const saveResultP = saveNilaiRaporBatch(token, dataToSaveP, 'P');
      if (saveResultP.status === 'sukses') totalBerhasil += dataToSaveP.length;
      else throw new Error("Gagal simpan Pengetahuan: " + saveResultP.message);
    }
    if (dataToSaveK.length > 0) {
      const saveResultK = saveNilaiRaporBatch(token, dataToSaveK, 'K');
      if (saveResultK.status === 'sukses') totalBerhasil += dataToSaveK.length;
      else throw new Error("Gagal simpan Keterampilan: " + saveResultK.message);
    }
    DriveApp.getFileById(tempExcelFileId).setTrashed(true);
    DriveApp.getFileById(tempConvertedSheetId).setTrashed(true);
    return { status: "sukses", totalDitemukan, berhasilDiUpload: totalBerhasil, gagalDiUpload: gagalList.length, dataGagal: gagalList };
  } catch (e) {
    if (tempExcelFileId) DriveApp.getFileById(tempExcelFileId).setTrashed(true);
    if (tempConvertedSheetId) DriveApp.getFileById(tempConvertedSheetId).setTrashed(true);
    return { status: "gagal", message: "Terjadi error: " + e.message };
  }
}

// --- GANTI FUNGSI INI DI Kode.gs.html ---
/**
 * [PERBAIKAN] Mengambil data mapel dari Firestore, dengan cache.
 */
function getMapelDataInternal(ss, sekolahID) { // 'ss' tidak lagi dipakai
  const cacheKey = MAPEL_CACHE_KEY + "_" + sekolahID;
  const userCache = CacheService.getUserCache();
  const cachedMapel = userCache.get(cacheKey);
  if (cachedMapel != null) {
    return JSON.parse(cachedMapel);
  }

  const { firestore } = getFirestoreInstance();
  const documents = firestore.getCollection('mapel')
                             .where('sekolahID', '==', sekolahID)
                             .getDocuments();

  const mapel = documents.map(doc => {
    const fields = doc.fields; // 'fields' sudah bersih
    return {
      id: fields.mapelID,
      nama: fields.namaMapel,
      isUS: fields.isUS || false,
      isUP: fields.isUP || false,
      urutan: Number(fields.urutan || 0)
    };
  }).filter(row => row.id).sort((a, b) => a.urutan - b.urutan);

  userCache.put(cacheKey, JSON.stringify(mapel), 600);
  return mapel;
}


/**
 * [HELPER] Fungsi untuk mem-parsing nilai dari respons Firestore.
 * (Anda seharusnya sudah memiliki ini dari langkah sebelumnya)
 */
/*
function parseValue(value) {
  if (!value) return null;
  if (value.stringValue) return value.stringValue;
  if (value.integerValue) return parseInt(value.integerValue, 10);
  if (value.doubleValue) return parseFloat(value.doubleValue);
  if (value.booleanValue) return value.booleanValue;
  if (value.hasOwnProperty('nullValue')) return null;
  if (value.timestampValue) return value.timestampValue;
  if (Array.isArray(value.arrayValue?.values)) {
    return value.arrayValue.values.map(parseValue);
  }
  return null; 
}
*/

function getRekapUjianInternal(ss, siswaList, mapelListFull, sekolahID) {
  
    const filteredMapelList = mapelListFull.filter(m => m.isUS === true || m.isUP === true);
    const mapelFlags = new Map(filteredMapelList.map(m => [m.id, { isUS: m.isUS, isUP: m.isUP }]));
    
    const { firestore } = getFirestoreInstance();
    const nilaiMap = new Map();
    
    const documents = firestore.getCollection('nilai_ujian')
                               .where('sekolahID', '==', sekolahID)
                               .getDocuments();

    for (const doc of documents) {
      const fields = doc.fields;
      if (!fields.siswaID || !fields.mapelID) continue;
      
      const key = `${fields.siswaID.stringValue}_${fields.mapelID.stringValue}`;
      
      let um = null, up = null;
      if (fields.um && (fields.um.integerValue || fields.um.doubleValue)) um = parseFloat(fields.um.integerValue || fields.um.doubleValue);
      if (fields.up && (fields.up.integerValue || fields.up.doubleValue)) up = parseFloat(fields.up.integerValue || fields.up.doubleValue);
      
      nilaiMap.set(key, { um: um, up: up });
    }
    
    const nilaiRekapData = new Map();
    siswaList.forEach(siswa => {
      filteredMapelList.forEach(mapel => {
        const key = `${siswa.id}_${mapel.id}`;
        const storedNilai = nilaiMap.get(key);
        const flags = mapelFlags.get(mapel.id);
        
        let nilaiRekap = null;
        
        if (flags && (flags.isUS || flags.isUP)) {
          let nilaiUM_to_use = null;
          let nilaiUP_to_use = null;

          if (storedNilai) {
            nilaiUM_to_use = (flags.isUS) ? storedNilai.um : null;
            nilaiUP_to_use = (flags.isUP) ? storedNilai.up : null;
          }
          
          nilaiRekap = hitungNilaiRekap(nilaiUM_to_use, nilaiUP_to_use);
        }
        
        if (nilaiRekap !== null) {
            nilaiRekapData.set(key, Math.round(nilaiRekap));
        }
      });
    });

    return { 
      mapelList: filteredMapelList.map(m => ({ id: m.id, nama: m.nama })),
      nilaiRekapMap: nilaiRekapData
    };
}

function getRekapRaporInternal(ss, siswaList, mapelListFull, semesterIds, sekolahID) {

  const semesterIdSet = new Set(semesterIds);
  const semesterCount = semesterIds.length;
  
  const filteredMapelList = mapelListFull.filter(m => m.isUS === true || m.isUP === true);
  
  const { firestore } = getFirestoreInstance();
  const nilaiMap = new Map();

  const documents = firestore.getCollection('nilai_rapor')
                             .where('sekolahID', '==', sekolahID)
                             .getDocuments();

  for (const doc of documents) {
    const fields = doc.fields;
    if (!fields.siswaID || !fields.mapelID || !fields.semesterID) continue;

    const siswaId = fields.siswaID.stringValue;
    const mapelId = fields.mapelID.stringValue;
    const semId = fields.semesterID.stringValue;
    
    if (semesterIdSet.has(semId)) {
      let nilaiP = null, nilaiK = null;
      if (fields.p && (fields.p.integerValue || fields.p.doubleValue)) nilaiP = parseFloat(fields.p.integerValue || fields.p.doubleValue);
      if (fields.k && (fields.k.integerValue || fields.k.doubleValue)) nilaiK = parseFloat(fields.k.integerValue || fields.k.doubleValue);
      
      let nilaiAkhirSem = null;
      if (nilaiP != null && nilaiK != null) nilaiAkhirSem = (nilaiP + nilaiK) / 2;
      else if (nilaiP != null) nilaiAkhirSem = nilaiP;
      else if (nilaiK != null) nilaiAkhirSem = nilaiK;

      if (nilaiAkhirSem !== null) {
        const key = `${siswaId}_${mapelId}`;
        if (!nilaiMap.has(key)) {
          nilaiMap.set(key, []);
        }
        nilaiMap.get(key).push(nilaiAkhirSem);
      }
    }
  }
  
  const nilaiRekapData = new Map();
  siswaList.forEach(siswa => {
    filteredMapelList.forEach(mapel => { 
      const key = `${siswa.id}_${mapel.id}`;
      const nilaiArray = nilaiMap.get(key);
      
      if (nilaiArray && nilaiArray.length > 0) {
        const sum = nilaiArray.reduce((acc, val) => acc + val, 0);
        const average = sum / semesterCount; 
        
        nilaiRekapData.set(key, Math.round(average));
      } else {
        nilaiRekapData.set(key, null);
      }
    });
  });

  return {
    mapelList: filteredMapelList.map(m => ({ id: m.id, nama: m.nama })),
    nilaiRekapMap: nilaiRekapData
  };
}

function getNilaiIjazahData(token) {
  try {
    const { spreadsheetID } = validateAdminSession(token);
    const ss = SpreadsheetApp.openById(spreadsheetID);
    const sheet = ss.getSheetByName(SHEET_CACHE_IJAZAH);
    if (!sheet) return { status: "gagal", message: "Data belum dikalkulasi. Klik 'Hitung Ulang Nilai' dulu." };
    const metaValues = sheet.getRange(1, 1, 1, 7).getValues()[0];
    if (metaValues[0] !== 'Meta' || !metaValues[1]) return { status: "gagal", message: "Cache rusak. Klik 'Hitung Ulang Nilai'." };
    let siswaList, mapelList;
    try {
      siswaList = JSON.parse(metaValues[5]);
      mapelList = JSON.parse(metaValues[6]);
    } catch (e) { throw new Error("Data cache rusak. Harap Hitung Ulang."); }
    const dataUjianOriginal = {};
    const dataRaporOriginal = {};
    const dataUjianWeighted = {};
    const dataRaporWeighted = {};
    const dataIjazahFinal = {};
    const lastRow = sheet.getLastRow();
    if (lastRow > 2) {
      const dataValues = sheet.getRange(3, 1, lastRow - 2, 7).getValues();
      for (let i = 0; i < dataValues.length; i++) {
        const row = dataValues[i];
        const key = `${row[0]}_${row[1]}`;
        dataUjianOriginal[key] = row[2];
        dataRaporOriginal[key] = row[3];
        dataUjianWeighted[key] = row[4];
        dataRaporWeighted[key] = row[5];
        dataIjazahFinal[key] = row[6];
      }
    }
    return {
      status: "sukses",
      data: {
        siswaList, mapelList, dataUjian: dataUjianWeighted, dataRapor: dataRaporWeighted,
        dataIjazah: dataIjazahFinal, dataUjianOriginal, dataRaporOriginal,
        kkm: metaValues[4], bobotUjianPct: metaValues[3], bobotRaporPct: metaValues[2]
      }
    };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function recalculateIjazahData(token) {
  let spreadsheetID, sessionData;
  try {
    const session = validateAdminSession(token);
    spreadsheetID = session.spreadsheetID;
    sessionData = session.sessionData;
    const ss = SpreadsheetApp.openById(spreadsheetID);
    
    const sheetSetting = getPengaturanSheet(ss);
    const settings = sheetSetting.getRange('A1:B' + sheetSetting.getLastRow()).getValues();
    let bobotRapor = 60, bobotUjian = 40, kkm = 76, jmlSemester = 5;
    settings.forEach(s => {
      if (s[0] === 'Bobot_Rapor') bobotRapor = s[1];
      if (s[0] === 'Bobot_Ujian') bobotUjian = s[1];
      if (s[0] === 'KKM') kkm = s[1];
      if (s[0] === 'Jumlah_Semester') jmlSemester = s[1];
    });

    const sheetSiswa = getSiswaSheet(ss);
    const siswaData = sheetSiswa.getDataRange().getValues();
    siswaData.shift();
    const siswaList = siswaData.map(s => ({ id: s[0], nama: s[1], nisn: s[2], kelas: s[7] }));

    const mapelListFull = getMapelDataInternal(ss, sessionData.sekolahID);
    const mapelIjazah = mapelListFull.filter(m => m.isUS || m.isUP);
    
    // --- PERUBAHAN DI SINI ---
    const { nilaiRekapMap: nilaiUjian } = getRekapUjianInternal(ss, siswaList, mapelListFull, sessionData.sekolahID);
    // --- AKHIR PERUBAHAN ---
    
    const semesterIds = [];
    const jenjang = sessionData.jenjang;
    if (jenjang === 'SD/MI') {
       if (jmlSemester === 3) semesterIds.push('K5_S1','K5_S2','K6_S1');
       else semesterIds.push('K4_S1','K4_S2','K5_S1','K5_S2','K6_S1');
    } else if (jenjang === 'SMP/MTS') {
       semesterIds.push('K7_S1','K7_S2','K8_S1','K8_S2','K9_S1');
    } else {
       semesterIds.push('K10_S1','K10_S2','K11_S1','K11_S2','K12_S1');
    }

    // --- PERUBAHAN DI SINI ---
    const { nilaiRekapMap: nilaiRapor } = getRekapRaporInternal(ss, siswaList, mapelListFull, semesterIds, sessionData.sekolahID);
    // --- AKHIR PERUBAHAN ---

    const dataToAppend = [];
    siswaList.forEach(siswa => {
      mapelIjazah.forEach(mapel => {
        const key = `${siswa.id}_${mapel.id}`;
        const nU = nilaiUjian.get(key) || 0;
        const nR = nilaiRapor.get(key) || 0;
        const final = (nU * (bobotUjian/100)) + (nR * (bobotRapor/100));
        dataToAppend.push([siswa.id, mapel.id, nU, nR, nU*(bobotUjian/100), nR*(bobotRapor/100), final]);
      });
    });

    let sheetCache = ss.getSheetByName(SHEET_CACHE_IJAZAH);
    if (!sheetCache) { sheetCache = ss.insertSheet(SHEET_CACHE_IJAZAH); sheetCache.hideSheet(); }
    sheetCache.clear();
    sheetCache.appendRow(['Meta', new Date(), bobotRapor, bobotUjian, kkm, JSON.stringify(siswaList), JSON.stringify(mapelIjazah), jmlSemester]);
    sheetCache.appendRow(['SiswaID', 'MapelID', 'UjianAsli', 'RaporAsli', 'UjianBobot', 'RaporBobot', 'IjazahFinal']);
    if (dataToAppend.length > 0) sheetCache.getRange(3, 1, dataToAppend.length, 7).setValues(dataToAppend);

    const db = SpreadsheetApp.openById(MASTER_KELULUSAN_DB_ID);
    const sheetHasil = db.getSheetByName('Sheet_Hasil_Publikasi');
    const hasilData = sheetHasil.getDataRange().getValues();
    for (let i = 1; i < hasilData.length; i++) {
      if (hasilData[i][0] === sessionData.sekolahID) {
        _internalPublishLogic(spreadsheetID, sessionData.sekolahID, sessionData.namaSekolah, hasilData[i][1]);
        break;
      }
    }

    return { status: "sukses", message: "Nilai berhasil dihitung.", isDirty: false };
  } catch (e) {
    return { status: "gagal", message: e.message, isDirty: true };
  }
}

function exportDataIjazah(token, tipeFile, tipeData, kelasFilter, isWeighted) {
  let tempSpreadsheetId = null;
  try {
    const { sessionData } = validateAdminSession(token);
    const namaSekolah = sessionData.namaSekolah;
    const jenjangPilihan = sessionData.jenjangPilihan;
    const ijazahResponse = getNilaiIjazahData(token);
    if (ijazahResponse.status !== 'sukses') throw new Error(ijazahResponse.message);
    const data = ijazahResponse.data;
    let dataToExport, title = "", kkmInfo = "";
    if (tipeData === 'ujian') {
      dataToExport = isWeighted ? data.dataUjian : data.dataUjianOriginal;
      title = (jenjangPilihan === 'MI' || jenjangPilihan === 'MTS' || jenjangPilihan === 'MA') ? "NILAI UJIAN MADRASAH" : "NILAI UJIAN SEKOLAH";
      kkmInfo = isWeighted ? `(Bobot ${data.bobotUjianPct}%)` : "(Nilai Asli)";
    } else if (tipeData === 'rapor') {
      dataToExport = isWeighted ? data.dataRapor : data.dataRaporOriginal;
      title = "NILAI RAPOR";
      kkmInfo = isWeighted ? `(Bobot ${data.bobotRaporPct}%)` : "(Nilai Asli)";
    } else {
      dataToExport = data.dataIjazah;
      title = "NILAI IJAZAH";
      kkmInfo = `(KKM: ${data.kkm})`;
    }
    const filteredSiswaList = (kelasFilter === 'semua') ? data.siswaList : data.siswaList.filter(s => s.kelas === kelasFilter);
    const dataPayload = {
      namaSekolah, title, kkmInfo, kelasFilter, siswaList: filteredSiswaList,
      mapelList: data.mapelList, nilaiData: dataToExport, tipeData, isWeighted, kkmValue: data.kkm
    };
    const tempSS = buatSpreadsheetEksporIjazah(dataPayload);
    tempSpreadsheetId = tempSS.getId();
    let blob, fileName, mimeType;
    const timestamp = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "yyyyMMdd");
    const safeTitle = title.replace(/ /g, '_'), safeKelas = kelasFilter.replace(/ /g, '_');
    if (tipeFile === 'pdf') {
      blob = generatePdfBlobFromSheet(tempSS);
      fileName = `Nilai_${safeTitle}_${safeKelas}_${timestamp}.pdf`;
      mimeType = MimeType.PDF;
    } else {
      blob = generateExcelBlobFromSheet(tempSS);
      fileName = `Nilai_${safeTitle}_${safeKelas}_${timestamp}.xlsx`;
      mimeType = MimeType.MICROSOFT_EXCEL;
    }
    return { status: "sukses", base64: Utilities.base64Encode(blob.getBytes()), mimeType, fileName };
  } catch (e) {
    return { status: "gagal", message: e.message };
  } finally {
    if (tempSpreadsheetId) DriveApp.getFileById(tempSpreadsheetId).setTrashed(true);
  }
}

function buatSpreadsheetEksporIjazah(dataPayload) {
  const { namaSekolah, title, kkmInfo, kelasFilter, siswaList, mapelList, nilaiData, tipeData, isWeighted, kkmValue } = dataPayload;
  
  const ss = SpreadsheetApp.create(`[TEMP] Ekspor ${title}`);
  const sheet = ss.getSheetByName('Sheet1');
  sheet.setName('Data Nilai');

  sheet.getRange('A1').setValue(namaSekolah.toUpperCase()).setFontSize(14).setFontWeight('bold');
  sheet.getRange('A2').setValue(`REKAPITULASI ${title.toUpperCase()} ${kkmInfo}`).setFontSize(12).setFontWeight('bold');
  sheet.getRange('A3').setValue(`Kelas: ${(kelasFilter === 'semua') ? 'Semua Kelas' : kelasFilter}`).setFontSize(12).setFontWeight('bold');

  const headers = ["No", "Nama Siswa", "NISN", "Kelas", ...mapelList.map(m => m.id), "Jumlah", "Rata-Rata"];
  if (tipeData === 'ijazah') {
    headers.push("Status");
  }
  
  const headerRange = sheet.getRange(5, 1, 1, headers.length);
  headerRange.setValues([headers]);
  headerRange.setFontWeight('bold').setHorizontalAlignment('center').setVerticalAlignment('middle');
  headerRange.setBackground("#666666").setFontColor("#ffffff");

  headerRange.setWrap(false);
  sheet.getRange(5, 2).setWrap(true);
  sheet.getRange(5, 5, 1, mapelList.length).setWrap(true);

  const dataRows = [];
  
  siswaList.forEach((siswa, index) => {
    const row = [index + 1, siswa.nama, "'" + siswa.nisn, siswa.kelas];
    let sum = 0;
    let count = 0;
    
    mapelList.forEach(mapel => {
      const key = `${siswa.id}_${mapel.id}`;
      const nilai = nilaiData[key];
      
      if (nilai !== null && nilai !== undefined) {
        const nilaiAngka = parseFloat(nilai);
        if (tipeData === 'ijazah' || !isWeighted) {
          const nilaiTampil = Math.round(nilaiAngka);
          sum += nilaiTampil;
          row.push(nilaiTampil); 
        } else {
          const nilaiTampil = parseFloat(nilaiAngka.toFixed(2));
          sum += nilaiTampil;
          row.push("'" + nilaiTampil.toFixed(2).replace('.', ',')); 
        }
        count++;
      } else {
        row.push(null); 
      }
    });
    
    const average = (count > 0) ? (sum / count) : 0;
    
    if (tipeData === 'ijazah' || !isWeighted) {
      row.push(Math.round(sum)); 
    } else {
      row.push("'" + sum.toFixed(2).replace('.', ',')); 
    }
    
    row.push("'" + average.toFixed(2).replace('.', ',')); 

    if (tipeData === 'ijazah') {
      row.push(average >= kkmValue ? 'LULUS' : 'TIDAK LULUS');
    }
    
    dataRows.push(row);
  });

  if (dataRows.length > 0) {
    const dataRange = sheet.getRange(6, 1, dataRows.length, headers.length);
    dataRange.setValues(dataRows);
    dataRange.applyRowBanding(SpreadsheetApp.BandingTheme.LIGHT_GREY, false, false);
    
    dataRange.setVerticalAlignment('middle'); 
    sheet.getRange(6, 2, dataRows.length, 1).setWrap(true); 
    
    sheet.getRange(6, 1, dataRows.length, 1).setHorizontalAlignment('center'); // Kolom No (A) -> Rata Tengah
    sheet.getRange(6, 2, dataRows.length, 1).setHorizontalAlignment('left');  // Kolom Nama (B) -> Rata Kiri
    
    // --- PERBAIKAN RATA TENGAH NISN ---
    sheet.getRange(6, 3, dataRows.length, 1).setHorizontalAlignment('center'); // Kolom NISN (C) -> Rata Tengah
    sheet.getRange(6, 4, dataRows.length, headers.length - 3).setHorizontalAlignment('center'); // Kolom Kelas (D) -> dst
    // --- AKHIR PERBAIKAN ---
    
    const tableRange = sheet.getRange(5, 1, dataRows.length + 1, headers.length);
    tableRange.setBorder(true, true, true, true, true, true);
    tableRange.setFontSize(11); 
    
    const legendStartRow = 6 + dataRows.length + 2; 
    
    const mergeStartCol = 3; 
    const mergeEndCol = 12;  
    const mergeCount = mergeEndCol - mergeStartCol + 1; 
    
    sheet.getRange(legendStartRow, mergeStartCol, 1, mergeCount).merge(); 
    
    // --- PERBAIKAN RATA KIRI LEGENDA ---
    sheet.getRange(legendStartRow, mergeStartCol).setValue("Keterangan Kode Mapel :")
         .setFontWeight('bold').setFontSize(11).setHorizontalAlignment('left');
    // --- AKHIR PERBAIKAN ---
         
    const legendData = [];
    mapelList.forEach(mapel => {
      legendData.push([mapel.id, "'=", mapel.nama]); 
    });
    
    if (legendData.length > 0) {
      const legendDataRange = sheet.getRange(legendStartRow + 1, 3, legendData.length, 3);
      legendDataRange.setValues(legendData);
      
      legendDataRange.setFontSize(11);
      
      // --- PERBAIKAN RATA KIRI LEGENDA ---
      sheet.getRange(legendStartRow + 1, 3, legendData.length, 1).setFontWeight('bold').setHorizontalAlignment('left'); // Kolom C (Kode)
      // --- AKHIR PERBAIKAN ---
      
      sheet.getRange(legendStartRow + 1, 4, legendData.length, 1).setHorizontalAlignment('center'); // Kolom D (=)

      for (let i = 0; i < legendData.length; i++) {
        let row = legendStartRow + 1 + i;
        sheet.getRange(row, 5, 1, 8).merge(); 
        sheet.getRange(row, 5).setHorizontalAlignment('left').setVerticalAlignment('middle');
      }
    }
  }

  sheet.setColumnWidth(1, 40); 
  sheet.setColumnWidth(2, 220); 
  sheet.setColumnWidth(3, 100); 
  sheet.setColumnWidth(4, 60);  
  
  const mapelColStart = 5;
  for(let i = 0; i < mapelList.length; i++) {
    const colIndex = mapelColStart + i;
    sheet.setColumnWidth(colIndex, 60); 
  }

  const rekapColStart = mapelColStart + mapelList.length;
  sheet.setColumnWidth(rekapColStart, 80); 
  sheet.setColumnWidth(rekapColStart + 1, 80); 
  if (tipeData === 'ijazah') {
    sheet.setColumnWidth(rekapColStart + 2, 100); 
  }

  SpreadsheetApp.flush();

  return ss;
}

function generatePdfBlobFromSheet(spreadsheet) {
  const spreadsheetId = spreadsheet.getId();
  const file = DriveApp.getFileById(spreadsheetId);
  
  const marginInches = 0.2 / 2.54; 
  
  const url = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/export?` +
    'format=pdf&' +
    'size=a4&' +
    'portrait=false&' + 
    'fitw=true&' + 
    'sheetnames=false&' +
    'printtitle=false&' +
    'pagenumbers=false&' +
    'gridlines=false&' +
    'fzr=false&' +
    'gid=' + spreadsheet.getSheets()[0].getSheetId() + '&' +
    `top_margin=${marginInches}&` +
    `bottom_margin=${marginInches}&` +
    `left_margin=${marginInches}&` +
    `right_margin=${marginInches}`;
    
  const token = ScriptApp.getOAuthToken();
  const response = UrlFetchApp.fetch(url, {
    headers: {
      'Authorization': 'Bearer ' + token
    }
  });

  return response.getBlob().setName(spreadsheet.getName() + ".pdf");
}

function generateExcelBlobFromSheet(spreadsheet) {
  const spreadsheetId = spreadsheet.getId();
  const url = "https://docs.google.com/spreadsheets/d/" + spreadsheetId + "/export?format=xlsx";
  const token = ScriptApp.getOAuthToken();
  
  const response = UrlFetchApp.fetch(url, {
    headers: {
      'Authorization': 'Bearer ' + token
    }
  });

  return response.getBlob().setName(spreadsheet.getName() + ".xlsx");
}

function clearAllCaches(token) {
  try {
    const { sessionData } = validateAdminSession(token);
    clearSiswaCache(sessionData.sekolahID);
    clearMapelCache(sessionData.sekolahID);
    clearMasterSheetCache();
    return { status: "sukses" };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function getValidationData(token) {
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    const sekolahID = sessionData.sekolahID;
    const ss = SpreadsheetApp.openById(spreadsheetID);
    
    // 1. Ambil data master dari Google Sheets (Siswa, Mapel, Semester)
    const siswaSheet = getSiswaSheet(ss);
    const siswaDataValues = siswaSheet.getDataRange().getValues();
    siswaDataValues.shift();
    const siswaList = siswaDataValues.map(s => ({ id: s[0], nama: s[1], nisn: s[2], kelas: s[7], urutan: s[8] }))
      .sort((a, b) => a.kelas.localeCompare(b.kelas) || (Number(a.urutan) || 0) - (Number(b.urutan) || 0));

    const mapelListFull = getMapelDataInternal(ss, sekolahID);
    const requiredMapelList = mapelListFull.filter(m => m.isUS === true || m.isUP === true);
    const requiredMapelIds = new Set(requiredMapelList.map(m => m.id));
    const mapelInfoMap = new Map(requiredMapelList.map(m => [m.id, { isUS: m.isUS, isUP: m.isUP }]));

    const semesterListData = getSemesterList(token);
    if (semesterListData.status !== 'sukses') throw new Error("Gagal mengambil daftar semester.");
    const requiredSemesterList = semesterListData.semesterList;
    const semesterListWithCodes = requiredSemesterList.map(sem => {
      const parts = sem.id.split('_');
      return { ...sem, shortCode: (parts.length === 2) ? `${parts[0].replace('K', '')}.${parts[1].replace('S', '')}` : '' };
    });
    const requiredSemesterIdSet = new Set(requiredSemesterList.map(s => s.id));

    // 2. Ambil data nilai dari Firestore
    const { firestore } = getFirestoreInstance();
    const raporMap = new Map(); // Map<SiswaID, Map<MapelID, Map<SemesterID, {P: bool, K: bool}>>>
    const ujianMap = new Map(); // Map<SiswaID, Map<MapelID, {UM: bool, UP: bool}>>

    // Kueri Nilai Rapor
    const raporDocs = firestore.getCollection('nilai_rapor')
                               .where('sekolahID', '==', sekolahID)
                               .getDocuments();
                               
    for (const doc of raporDocs) {
      const fields = doc.fields;
      if (!fields.siswaID || !fields.mapelID || !fields.semesterID) continue;
      
      const siswaId = fields.siswaID.stringValue;
      const mapelId = fields.mapelID.stringValue;
      const semId = fields.semesterID.stringValue;

      if (requiredSemesterIdSet.has(semId) && requiredMapelIds.has(mapelId)) {
        if (!raporMap.has(siswaId)) raporMap.set(siswaId, new Map());
        if (!raporMap.get(siswaId).has(mapelId)) raporMap.get(siswaId).set(mapelId, new Map());
        
        // Pengecekan "tidak null". fields.p ada DAN bukan nullValue.
        const hasP = (fields.p && typeof fields.p.nullValue === 'undefined');
        const hasK = (fields.k && typeof fields.k.nullValue === 'undefined');
        
        raporMap.get(siswaId).get(mapelId).set(semId, { P: hasP, K: hasK });
      }
    }

    // Kueri Nilai Ujian
    const ujianDocs = firestore.getCollection('nilai_ujian')
                               .where('sekolahID', '==', sekolahID)
                               .getDocuments();

    for (const doc of ujianDocs) {
      const fields = doc.fields;
      if (!fields.siswaID || !fields.mapelID) continue;
      
      const siswaId = fields.siswaID.stringValue;
      const mapelId = fields.mapelID.stringValue;

      if (requiredMapelIds.has(mapelId)) {
        if (!ujianMap.has(siswaId)) ujianMap.set(siswaId, new Map());
        
        const hasUM = (fields.um && typeof fields.um.nullValue === 'undefined');
        const hasUP = (fields.up && typeof fields.up.nullValue === 'undefined');
        
        ujianMap.get(siswaId).set(mapelId, { UM: hasUM, UP: hasUP });
      }
    }

    // 3. Bangun hasil validasi (logika ini sama seperti sebelumnya)
    const validationResults = {};
    let globalNeedsUM = false, globalNeedsUP = false;
    mapelInfoMap.forEach(info => { if (info.isUS) globalNeedsUM = true; if (info.isUP) globalNeedsUP = true; });

    siswaList.forEach(siswa => {
      const resultSiswa = { rapor: {}, ujian: {} };
      if (globalNeedsUM) resultSiswa.ujian.UM = true;
      if (globalNeedsUP) resultSiswa.ujian.UP = true;
      requiredSemesterList.forEach(sem => { resultSiswa.rapor[`${sem.id}_P`] = true; resultSiswa.rapor[`${sem.id}_K`] = true; });

      for (const mapel of requiredMapelList) {
        const mapelInfo = mapelInfoMap.get(mapel.id);
        
        // Validasi Rapor
        for (const sem of requiredSemesterList) {
          const rData = raporMap.get(siswa.id)?.get(mapel.id)?.get(sem.id) || { P: false, K: false };
          if (resultSiswa.rapor[`${sem.id}_P`] && !rData.P) resultSiswa.rapor[`${sem.id}_P`] = false;
          if (resultSiswa.rapor[`${sem.id}_K`] && !rData.K) resultSiswa.rapor[`${sem.id}_K`] = false;
        }
        
        // Validasi Ujian
        const uData = ujianMap.get(siswa.id)?.get(mapel.id) || { UM: false, UP: false };
        if (globalNeedsUM && mapelInfo.isUS && !uData.UM) resultSiswa.ujian.UM = false;
        if (globalNeedsUP && mapelInfo.isUP && !uData.UP) resultSiswa.ujian.UP = false;
      }
      
      if (!globalNeedsUM) delete resultSiswa.ujian.UM;
      if (!globalNeedsUP) delete resultSiswa.ujian.UP;
      validationResults[siswa.id] = resultSiswa;
    });
    
    return { status: "sukses", data: { siswaList: siswaList.map(s => ({ id: s.id, nama: s.nama, nisn: s.nisn, kelas: s.kelas })), requiredSemesters: semesterListWithCodes, validationData: validationResults } };
  } catch (e) {
    Logger.log(`Gagal getValidationData (Firestore): ${e.message} ${e.stack}`);
    return { status: "gagal", message: e.message };
  }
}

/**
 * FUNGSI UNTUK DIJALANKAN MANUAL SEKALI SAJA
 * * CARA MENJALANKAN:
 * 1. Buka file Kode.gs.html Anda.
 * 2. Salin dan tempel (paste) fungsi ini di bagian paling bawah file.
 * 3. UBAH 'email_superadmin@anda.com', 'Nama Super Admin', dan 'password_rahasia_anda'.
 * 4. Simpan file (Ctrl+S atau ikon Simpan).
 * 5. Di bagian atas editor, pilih nama fungsi "BUAT_SUPERADMIN_PERTAMA_KALI" dari menu dropdown (di sebelah "Debug" dan "Run").
 * 6. Klik tombol "Run" ().
 * 7. Periksa log (View > Logs) untuk pesan "BERHASIL!".
 * 8. Hapus atau beri komentar (//) pada fungsi ini setelah selesai.
 */
/*
function BUAT_SUPERADMIN_PERTAMA_KALI() {
  try {
    // --- SESUAIKAN DATA DI BAWAH INI ---
    const EMAIL_SUPERADMIN = "syamsulbahri.agro27b@gmail.com";
    const NAMA_SUPERADMIN = "Syamsul Bahri";
    const PASSWORD_SUPERADMIN = "Andhika9619!"; // Ganti dengan password yang kuat
    // --- BATAS PENYESUAIAN ---

    if (PASSWORD_SUPERADMIN === "password_rahasia_anda" || EMAIL_SUPERADMIN === "superadmin@email.com") {
      Logger.log("PENTING: Harap ubah email dan password di dalam kode fungsi sebelum menjalankan.");
      Browser.msgBox("PENTING: Harap ubah email dan password di dalam kode fungsi sebelum menjalankan.");
      return;
    }

    const masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
    const sheet = getSheetSuperadmin(masterSS); // Fungsi ini akan membuat sheet jika belum ada

    // Cek apakah email sudah ada
    const data = sheet.getDataRange().getValues();
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] === EMAIL_SUPERADMIN) {
        Logger.log("Akun Superadmin dengan email " + EMAIL_SUPERADMIN + " sudah ada.");
        Browser.msgBox("Akun Superadmin dengan email " + EMAIL_SUPERADMIN + " sudah ada.");
        return;
      }
    }

    // Buat hash dan salt baru (memanggil fungsi yang sudah ada di script Anda)
    const newSalt = generateSalt();
    const newHash = hashPassword(PASSWORD_SUPERADMIN, newSalt);

    // Tambahkan ke sheet
    sheet.appendRow([EMAIL_SUPERADMIN, NAMA_SUPERADMIN, newHash, newSalt]);

    Logger.log("BERHASIL! Akun Superadmin " + EMAIL_SUPERADMIN + " telah dibuat.");
    Browser.msgBox("BERHASIL! Akun Superadmin " + EMAIL_SUPERADMIN + " telah dibuat. Anda sekarang dapat login.");

  } catch (e) {
    Logger.log("Gagal membuat Superadmin: " + e.message);
    Browser.msgBox("Gagal membuat Superadmin: " + e.message);
  }
}
*/

/**
 * Memvalidasi sesi Admin ATAU Guru.
 */
function validateAdminOrGuruSession(token) {
  const sessionData = validateAndRefreshSession(token);
  
  if (sessionData.role !== 'admin' && sessionData.role !== 'guru') {
    throw new Error("Akses ditolak. API ini hanya untuk Admin atau Guru.");
  }
  
  if (!sessionData.spreadsheetID) {
    throw new Error("Sesi tidak valid (Spreadsheet ID tidak ditemukan).");
  }
  
  // Mengembalikan data lengkap untuk digunakan di fungsi pemanggil
  return { sessionData, spreadsheetID: sessionData.spreadsheetID };
}

function validateAdminSession(token) {
  const sessionData = validateAndRefreshSession(token);
  if (sessionData.role !== 'admin') {
    throw new Error("Akses ditolak. API ini hanya untuk Admin Sekolah.");
  }
  if (!sessionData.spreadsheetID) {
    throw new Error("Sesi Admin tidak valid (Spreadsheet ID tidak ditemukan).");
  }
  return { sessionData, spreadsheetID: sessionData.spreadsheetID };
}

/**
 * FUNGSI HELPER BARU
 * Berisi logika inti untuk mempublikasikan hasil.
 * Dipanggil oleh publishKelulusan() dan recalculateIjazahData().
 * Mengasumsikan validasi sesi dan lock sudah ditangani oleh pemanggil.
 */
function _internalPublishLogic(spreadsheetID, sekolahID, namaSekolah, tanggalPengumumanISO) {
  const ss = SpreadsheetApp.openById(spreadsheetID);

  // 1. Ambil data siswa (NISN, Nama, Tgl Lahir)
  const sheetSiswa = getSiswaSheet(ss);
  const siswaData = sheetSiswa.getDataRange().getValues();
  siswaData.shift(); 
  const siswaMap = new Map();
  const nisnList = [];
  siswaData.forEach(row => {
    let nisn = String(row[2]).trim();
    if (nisn.startsWith("'")) {
      nisn = nisn.substring(1);
    }
    const namaSiswa = row[1];
    const tglLahir = (row[6] instanceof Date) ? Utilities.formatDate(row[6], Session.getScriptTimeZone(), "yyyy-MM-dd") : row[6];
    if (nisn && tglLahir && namaSiswa) {
      siswaMap.set(nisn, { id: row[0], dob: tglLahir, nama: namaSiswa });
      nisnList.push(nisn);
    }
  });

  // 2. Ambil data nilai akhir (dari cache yang sudah di-recalculate)
  const sheetCacheIjazah = ss.getSheetByName(SHEET_CACHE_IJAZAH);
  if (!sheetCacheIjazah) {
    throw new Error("Data Ijazah belum pernah dikalkulasi. Silakan hitung ulang nilai ijazah terlebih dahulu.");
  }
  const kkm = sheetCacheIjazah.getRange('E1').getValue();
  const ijazahData = sheetCacheIjazah.getRange('A3:G' + sheetCacheIjazah.getLastRow()).getValues();
  
  const rekapMap = new Map();
  ijazahData.forEach(row => {
    const siswaId = row[0];
    const finalNilai = row[6]; // Kolom G (IjazahFinal)
    if (!rekapMap.has(siswaId)) {
      rekapMap.set(siswaId, { sum: 0, count: 0 });
    }
    const data = rekapMap.get(siswaId);
    data.sum += finalNilai;
    data.count++;
  });

  // 3. Tentukan status kelulusan
  const hasilKelulusan = {};
  siswaMap.forEach((data, nisn) => {
    const rekap = rekapMap.get(data.id);
    let status = 'TIDAK LULUS'; // Default
    if (rekap && rekap.count > 0) {
      const average = rekap.sum / rekap.count;
      if (average >= kkm) {
        status = 'LULUS';
      }
    }
    hasilKelulusan[nisn] = {
      dob: data.dob,
      status: status,
      nama: data.nama
    };
  });
  
  const hasilKelulusanJson = JSON.stringify(hasilKelulusan);
  
  // 4. Tulis/Timpa ke Database Master Kelulusan
  const db = SpreadsheetApp.openById(MASTER_KELULUSAN_DB_ID);
  const sheetHasil = db.getSheetByName('Sheet_Hasil_Publikasi');
  const hasilData = sheetHasil.getDataRange().getValues();
  let rowUpdated = false;
  for (let i = 1; i < hasilData.length; i++) {
    if (hasilData[i][0] === sekolahID) {
      // Timpa data yang ada
      sheetHasil.getRange(i + 1, 2, 1, 3).setValues([[tanggalPengumumanISO, hasilKelulusanJson, namaSekolah]]);
      rowUpdated = true;
      break;
    }
  }
  if (!rowUpdated) {
    // Tambah data baru jika belum ada
    sheetHasil.appendRow([sekolahID, tanggalPengumumanISO, hasilKelulusanJson, namaSekolah]);
  }
  
  // 5. Update Master Index (Hapus lama, tambah baru)
  const sheetIndex = db.getSheetByName('Sheet_Master_Index');
  const indexData = sheetIndex.getDataRange().getDisplayValues(); 
  const rowsToDelete = [];
  for (let i = indexData.length - 1; i >= 1; i--) { 
    if (indexData[i][1] === sekolahID) {
      rowsToDelete.push(i + 1);
    }
  }
  rowsToDelete.forEach(rowNum => {
    sheetIndex.deleteRow(rowNum);
  });
  
  const nisnRowsToAdd = nisnList.map(nisn => ["'" + nisn, sekolahID]); 
  if (nisnRowsToAdd.length > 0) {
    sheetIndex.getRange(sheetIndex.getLastRow() + 1, 1, nisnRowsToAdd.length, 2).setValues(nisnRowsToAdd);
  }
  
  // 6. Bersihkan Cache Publik
  const scriptCache = CacheService.getScriptCache();
  scriptCache.remove(MASTER_NISN_INDEX_KEY);
  scriptCache.remove(HASIL_KELULUSAN_PREFIX + sekolahID);
  
  // Bangun ulang cache publik agar data baru segera tersedia
  rebuildKelulusanCacheFromDB(); 

  // Kembalikan jumlah siswa untuk pesan sukses
  return nisnList.length;
}

function publishKelulusan(token, tanggalPengumumanISO) {
  const lock = LockService.getScriptLock();
  lock.waitLock(30000);
  try {
    const session = validateAdminSession(token);
    const nisnListLength = _internalPublishLogic(session.spreadsheetID, session.sessionData.sekolahID, session.sessionData.namaSekolah, tanggalPengumumanISO);
    return { status: "sukses", message: `Hasil kelulusan dipublikasikan untuk ${nisnListLength} siswa.` };
  } catch (e) {
    return { status: "gagal", message: e.message };
  } finally {
    lock.releaseLock();
  }
}

function getPublishedStatus(token) {
  try {
    const { sessionData } = validateAdminSession(token);
    const scriptCache = CacheService.getScriptCache();
    const dataWrapperJson = scriptCache.get(HASIL_KELULUSAN_PREFIX + sessionData.sekolahID);
    if (dataWrapperJson) {
      return { status: "sukses", isPublished: true, publishDate: JSON.parse(dataWrapperJson).tanggalPengumuman };
    } else {
      return { status: "sukses", isPublished: false };
    }
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function unpublishKelulusan(token) {
  const lock = LockService.getScriptLock();
  lock.waitLock(30000);
  try {
    const { sessionData } = validateAdminSession(token);
    const sekolahID = sessionData.sekolahID;
    const db = SpreadsheetApp.openById(MASTER_KELULUSAN_DB_ID);
    const sheetHasil = db.getSheetByName('Sheet_Hasil_Publikasi');
    const hasilData = sheetHasil.getDataRange().getValues();
    for (let i = hasilData.length - 1; i >= 1; i--) {
      if (hasilData[i][0] === sekolahID) {
        sheetHasil.deleteRow(i + 1);
        break;
      }
    }
    const sheetIndex = db.getSheetByName('Sheet_Master_Index');
    const indexData = sheetIndex.getDataRange().getDisplayValues();
    const rowsToDelete = [];
    let nisnRemovedCount = 0;
    for (let i = indexData.length - 1; i >= 1; i--) {
      if (indexData[i][1] === sekolahID) {
        rowsToDelete.push(i + 1);
        nisnRemovedCount++;
      }
    }
    rowsToDelete.forEach(rowNum => sheetIndex.deleteRow(rowNum));
    const scriptCache = CacheService.getScriptCache();
    scriptCache.remove(MASTER_NISN_INDEX_KEY);
    scriptCache.remove(HASIL_KELULUSAN_PREFIX + sekolahID);
    return { status: "sukses", message: `Publikasi ditarik (${nisnRemovedCount} NISN dihapus).` };
  } catch (e) {
    return { status: "gagal", message: e.message };
  } finally {
    lock.releaseLock();
  }
}

function cekStatusSiswa(nisn, tglLahir) {
  try {
    if (!nisn || !tglLahir) {
      return { status: 'error', message: 'NISN dan Tanggal Lahir harus diisi.' };
    }
    
    const scriptCache = CacheService.getScriptCache();
    let allHasilWrappers = null;
    let masterIndex;
    
    const masterIndexJson = scriptCache.get(MASTER_NISN_INDEX_KEY);
    
    if (!masterIndexJson) {
      Logger.log("CACHE MISS: Master Index. Membangun ulang dari DB...");
      const rebuiltData = rebuildKelulusanCacheFromDB();
      masterIndex = rebuiltData.masterIndex;
      allHasilWrappers = rebuiltData.allHasilWrappers;
    } else {
      masterIndex = JSON.parse(masterIndexJson);
    }
    
    const nisnTrimmed = String(nisn).trim();
    const sekolahID = masterIndex[nisnTrimmed];
    
    if (!sekolahID) {
      return { status: 'error', message: 'NISN tidak terdaftar.' };
    }
    
    let dataWrapper;
    if (allHasilWrappers) {
      dataWrapper = allHasilWrappers[sekolahID];
    } else {
      const dataWrapperJson = scriptCache.get(HASIL_KELULUSAN_PREFIX + sekolahID);
      if (!dataWrapperJson) {
        Logger.log(`CACHE MISS: Hasil Sekolah ${sekolahID}. Membangun ulang dari DB...`);
        const rebuiltData = rebuildKelulusanCacheFromDB();
        dataWrapper = rebuiltData.allHasilWrappers[sekolahID];
      } else {
        dataWrapper = JSON.parse(dataWrapperJson);
      }
    }
    
    if (!dataWrapper) {
      return { status: 'error', message: 'Hasil kelulusan untuk sekolah ini belum dipublikasikan oleh Admin.' };
    }
    
    const dataSiswa = dataWrapper.hasil[nisnTrimmed];
    
    if (!dataSiswa) {
      return { status: 'error', message: 'NISN tidak terdaftar di sekolah ini.' };
    }
    
    if (dataSiswa.dob !== tglLahir) {
      return { status: 'error', message: 'NISN dan Tanggal Lahir tidak cocok.' };
    }
    
    const tanggalPengumuman = new Date(dataWrapper.tanggalPengumuman);
    const sekarang = new Date();
    
    const responsePayload = {
      namaSekolah: dataWrapper.namaSekolah,
      namaSiswa: dataSiswa.nama
    };
    
    if (sekarang < tanggalPengumuman) {
      return { 
        ...responsePayload,
        status: 'countdown', 
        targetDate: dataWrapper.tanggalPengumuman 
      };
    } else {
      return { 
        ...responsePayload,
        status: 'hasil', 
        result: dataSiswa.status 
      };
    }
    
  } catch (e) {
    Logger.log("Gagal cekStatusSiswa: " + e.message);
    return { status: 'error', message: 'Terjadi kesalahan server: ' + e.message };
  }
}

function rebuildKelulusanCacheFromDB() {
  Logger.log("Memulai Pembangunan Ulang Cache Kelulusan dari DB...");
  const scriptCache = CacheService.getScriptCache();
  let masterIndex = {};
  let allHasilWrappers = {};

  try {
    const db = SpreadsheetApp.openById(MASTER_KELULUSAN_DB_ID);
    
    const sheetIndex = db.getSheetByName('Sheet_Master_Index');
    const indexData = sheetIndex.getRange(2, 1, sheetIndex.getLastRow() - 1, 2).getDisplayValues(); 
    indexData.forEach(row => {
      masterIndex[row[0]] = row[1]; 
    });

    const sheetHasil = db.getSheetByName('Sheet_Hasil_Publikasi');
    const hasilData = sheetHasil.getRange(2, 1, sheetHasil.getLastRow() - 1, 4).getValues();
    
    hasilData.forEach(row => {
      const sekolahID = row[0];
      const tanggalISO = row[1];
      const hasilJson = row[2];
      const namaSekolah = row[3];
      
      try {
        const dataWrapper = {
          tanggalPengumuman: tanggalISO,
          namaSekolah: namaSekolah,
          hasil: JSON.parse(hasilJson)
        };
        allHasilWrappers[sekolahID] = dataWrapper;
        scriptCache.put(HASIL_KELULUSAN_PREFIX + sekolahID, JSON.stringify(dataWrapper), 21600);
      } catch (e) {
        Logger.log(`Gagal mem-parse JSON untuk ${sekolahID}: ${e.message}`);
      }
    });
    
    scriptCache.put(MASTER_NISN_INDEX_KEY, JSON.stringify(masterIndex), 21600);
    Logger.log(`Pembangunan Ulang Cache Selesai. ${indexData.length} NISN dan ${hasilData.length} sekolah dimuat.`);
    
  } catch (e) {
    Logger.log(`FATAL: Gagal membangun ulang cache: ${e.message}`);
  }
  
  return { masterIndex, allHasilWrappers };
}

// ====================================================================
// BAGIAN C: MIGRASI Akun_Guru -> koleksi 'akun_guru'
// ====================================================================

/**
 * [DIGANTI] Login guru, mencari sekolah dari Firestore.
 */
function prosesLoginGuru(npsn, email, password) {
  try {
    const { firestore } = getFirestoreInstance();
    npsn = npsn.trim();
    email = email.trim().toLowerCase();

    // 1. Cari Sekolah berdasarkan NPSN dari Firestore
    const sekolahDocs = firestore.getCollection('sekolah')
                                 .where('npsn', '==', npsn)
                                 .getDocuments();
    
    let targetSekolah = null;
    if (sekolahDocs.length > 0) {
      targetSekolah = sekolahDocs[0].fields;
    } else {
      // Fallback ke Nama Sekolah (untuk sekolah lama atau jika user salah input)
      const namaDocs = firestore.getCollection('sekolah')
                                .where('namaSekolah', '==', npsn.toUpperCase())
                                .getDocuments();
      if (namaDocs.length > 0) {
        targetSekolah = namaDocs[0].fields;
      }
    }

    if (!targetSekolah) {
      return { status: "gagal", message: "NPSN/Kode Sekolah tidak ditemukan." };
    }
    
    const sekolahID = parseValue(targetSekolah.sekolahID);
    const spreadsheetID = parseValue(targetSekolah.spreadsheetID);

    // 2. Cari Guru di Firestore
    const guruDocs = firestore.getCollection('akun_guru')
                              .where('sekolahID', '==', sekolahID)
                              .where('email', '==', email)
                              .getDocuments();

    if (guruDocs.length > 0) {
      const guruData = guruDocs[0].fields;
      const hashedPassword = parseValue(guruData.hashedPassword);
      const salt = parseValue(guruData.salt);
      
      if (verifyPassword(password, hashedPassword, salt)) {
        
        // Ambil config sekolah (untuk jenjangPilihan)
        const config = getSekolahConfigData(sekolahID, spreadsheetID);
        const assignedMapel = parseValue(guruData.mapelIDs) || [];
        const allMapel = getMapelDataInternal(null, sekolahID); // 'ss' (null) tidak lagi diperlukan
        
        const mapelUPSet = new Set();
        const mapelUMSet = new Set();
        allMapel.forEach(m => {
          if (m.isUP) mapelUPSet.add(m.id);
          if (m.isUS) mapelUMSet.add(m.id);
        });
        
        let hasPraktek = false;
        let hasMadrasah = false;
        for (const mapelId of assignedMapel) {
          if (mapelUPSet.has(mapelId)) hasPraktek = true;
          if (mapelUMSet.has(mapelId)) hasMadrasah = true;
        }
        
        const token = Utilities.getUuid();
        const namaGuru = parseValue(guruData.nama);
        const sessionData = {
          role: 'guru',
          sekolahID: sekolahID,
          namaSekolah: parseValue(targetSekolah.namaSekolah),
          jenjang: parseValue(targetSekolah.jenjang),
          spreadsheetID: spreadsheetID,
          jenjangPilihan: config.jenjangPilihan,
          namaGuru: namaGuru,
          assignedMapel: assignedMapel,
          hasUjianPraktek: hasPraktek,
          hasUjianMadrasah: hasMadrasah,
          lastActivity: new Date().getTime()
        };
        CacheService.getScriptCache().put('SESSION_' + token, JSON.stringify(sessionData), 21600);
        
        return {
          status: "sukses",
          role: "guru",
          namaSekolah: sessionData.namaSekolah,
          namaGuru: namaGuru,
          jenjangPilihan: config.jenjangPilihan,
          hasUjianPraktek: hasPraktek,
          hasUjianMadrasah: hasMadrasah,
          token: token
        };
      }
    }
    return { status: "gagal", message: "Email atau password guru salah." };
  } catch (e) {
    return { status: "gagal", message: "Terjadi error: " + e.message };
  }
}

// --- FUNGSI KELOLA GURU (Admin) ---

function getGuruSheet(ss) {
  let sheet = ss.getSheetByName('Akun_Guru');
  if (!sheet) {
    sheet = ss.insertSheet('Akun_Guru');
    // Header: Email, Nama, Password (Hash), Salt, MapelIDs (koma separated)
    sheet.appendRow(['Email', 'Nama', 'HashedPassword', 'Salt', 'MapelIDs']);
    sheet.setFrozenRows(1);
  }
  return sheet;
}

// --- GANTI FUNGSI INI DI Kode.gs.html ---
/**
 * [PERBAIKAN] Mengambil daftar guru dari Firestore.
 */
function getGuru(token) {
  try {
    const { sessionData } = validateAdminSession(token);
    const sekolahID = sessionData.sekolahID;

    const { firestore } = getFirestoreInstance();
    const documents = firestore.getCollection('akun_guru')
                               .where('sekolahID', '==', sekolahID)
                               .getDocuments();

    const guruList = documents.map(doc => {
      const fields = doc.fields; // 'fields' sudah bersih
      return {
        email: fields.email,
        nama: fields.nama,
        mapelIds: fields.mapelIDs || [] // 'mapelIDs' adalah array
      };
    }).filter(g => g.email);

    return { status: "sukses", guru: guruList };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

/**
 * [DIGANTI] Menyimpan data guru ke Firestore.
 * Catatan: Fungsi ini berasumsi 'email' adalah ID unik. Mengubah email
 * akan menjadi operasi Hapus + Buat.
 */
function saveGuru(token, guruData) {
  try {
    const { sessionData } = validateAdminSession(token);
    const sekolahID = sessionData.sekolahID;

    const { firestore, projectId } = getFirestoreInstance();
    const projectPath = `projects/${projectId}/databases/(default)/documents`;
    const batch = firestore.batch();

    const mode = guruData.mode;
    const newEmail = guruData.email.trim().toLowerCase();
    const originalEmail = guruData.originalEmail.trim().toLowerCase();

    if (!guruData.nama || !newEmail) {
      return { status: "gagal", message: "Nama dan Email wajib diisi." };
    }

    // Tentukan path dokumen
    const newDocId = `${sekolahID}_${newEmail}`;
    const newDocPath = `${projectPath}/akun_guru/${newDocId}`;
    const newDocRef = { name: newDocPath };

    const fieldsToSave = {
      sekolahID: sekolahID,
      email: newEmail,
      nama: guruData.nama,
      mapelIDs: guruData.mapelIds // Ini seharusnya sudah array
    };
    
    if (mode === 'add') {
      if (!guruData.password) return { status: "gagal", message: "Password wajib untuk guru baru." };
      
      // Cek duplikat
      try {
        const existing = firestore.getDocument(`akun_guru/${newDocId}`);
        if (existing.fields) return { status: "gagal", message: "Email guru sudah terdaftar." };
      } catch (e) {/* Diharapkan error not found */}

      const newSalt = generateSalt();
      const newHash = hashPassword(guruData.password, newSalt);
      fieldsToSave.hashedPassword = newHash;
      fieldsToSave.salt = newSalt;
      
      batch.create(newDocRef, fieldsToSave);

    } else { // Mode 'edit'
      const oldDocId = `${sekolahID}_${originalEmail}`;
      const oldDocPath = `${projectPath}/akun_guru/${oldDocId}`;
      const oldDocRef = { name: oldDocPath };

      // Jika email TIDAK berubah
      if (newEmail === originalEmail) {
        if (guruData.password) {
          const newSalt = generateSalt();
          const newHash = hashPassword(guruData.password, newSalt);
          fieldsToSave.hashedPassword = newHash;
          fieldsToSave.salt = newSalt;
        }
        batch.set(oldDocRef, fieldsToSave, { merge: true }); // set-merge lebih aman
      
      } else { // Jika email BERUBAH
        // Cek duplikat di email baru
        try {
          const existing = firestore.getDocument(`akun_guru/${newDocId}`);
          if (existing.fields) return { status: "gagal", message: "Email baru sudah terdaftar." };
        } catch (e) {/* Diharapkan error not found */}

        // Ambil data lama
        const oldDoc = firestore.getDocument(`akun_guru/${oldDocId}`);
        fieldsToSave.hashedPassword = parseValue(oldDoc.fields.hashedPassword);
        fieldsToSave.salt = parseValue(oldDoc.fields.salt);

        // Jika password juga diubah
        if (guruData.password) {
          const newSalt = generateSalt();
          const newHash = hashPassword(guruData.password, newSalt);
          fieldsToSave.hashedPassword = newHash;
          fieldsToSave.salt = newSalt;
        }
        
        // Operasi Hapus + Buat
        batch.delete(oldDocRef);
        batch.create(newDocRef, fieldsToSave);
      }
    }
    
    batch.commit();
    return { status: "sukses", message: "Data guru berhasil disimpan." };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

/**
 * [DIGANTI] Menghapus guru dari Firestore.
 */
function deleteGuru(token, emailGuru) {
  try {
    const { sessionData } = validateAdminSession(token);
    const sekolahID = sessionData.sekolahID;
    
    const { firestore } = getFirestoreInstance();
    const docId = `${sekolahID}_${emailGuru.trim().toLowerCase()}`;
    const docPath = `akun_guru/${docId}`;
    
    firestore.deleteDocument(docPath);
    
    return { status: "sukses", message: "Guru berhasil dihapus." };
  } catch (e) {
    return { status: "gagal", message: e.message };
  }
}

function getGuruTemplateData(token) {
  let tempSpreadsheetId = null;
  try {
    const { sessionData, spreadsheetID } = validateAdminSession(token);
    const ss = SpreadsheetApp.openById(spreadsheetID);
    
    const mapelList = getMapelDataInternal(ss, sessionData.sekolahID);
    
    const namaSekolah = sessionData.namaSekolah;
    const timestamp = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "yyyyMMdd_HHmmss");
    const tempFileName = `[TEMP] Template Guru - ${namaSekolah} - ${timestamp}`;
    
    const tempSS = SpreadsheetApp.create(tempFileName);
    tempSpreadsheetId = tempSS.getId();
    
    const sheetTemplate = tempSS.getSheetByName('Sheet1');
    sheetTemplate.setName('Template Guru');
    
    const sheetMapel = tempSS.insertSheet('Daftar Mapel');
    
    sheetMapel.appendRow(['KODE MAPEL', 'NAMA MATA PELAJARAN']);
    if (mapelList.length > 0) {
      const mapelData = mapelList.map(m => [m.id, m.nama]);
      sheetMapel.getRange(2, 1, mapelData.length, 2).setValues(mapelData);
      sheetMapel.autoResizeColumns(1, 2);
    }
    sheetMapel.setFrozenRows(1);
    
    sheetTemplate.appendRow(['NamaGuru', 'Email', 'Password', 'MapelIDs']);
    sheetTemplate.appendRow([
      'Budi Santoso, S.Pd.', 
      'budi.santoso@email.com', 
      'PasswordMin8Karakter', 
      'PAI,MTK,BIN'
    ]);
    sheetTemplate.getRange('A1:D1').setFontWeight('bold');
    
    const helpText = "Kolom A, B, dan C wajib diisi. Kolom D (MapelIDs) diisi dengan KODE MAPEL dari sheet 'Daftar Mapel'. Pisahkan beberapa kode mapel dengan koma (,) tanpa spasi.";
    sheetTemplate.getRange('A3').setValue(helpText).setFontStyle('italic').setFontColor('#666');
    sheetTemplate.getRange('A3:D3').merge();
    
    sheetTemplate.getRange('D:D').setNumberFormat('@');
    sheetTemplate.autoResizeColumns(1, 4);
    
    SpreadsheetApp.flush(); 

    const url = "https://docs.google.com/spreadsheets/d/" + tempSpreadsheetId + "/export?format=xlsx";
    const oauthToken = ScriptApp.getOAuthToken();
    const response = UrlFetchApp.fetch(url, { headers: { 'Authorization': 'Bearer ' + oauthToken } });
    
    const fileNameOutput = `template_import_guru_${namaSekolah}.xlsx`;
    
    return { 
      status: "sukses", 
      base64: Utilities.base64Encode(response.getBlob().getBytes()), 
      mimeType: MimeType.MICROSOFT_EXCEL, 
      fileName: fileNameOutput 
    };
    
  } catch (e) {
    return { status: "gagal", message: "Gagal membuat template: " + e.message };
  } finally {
    if (tempSpreadsheetId) DriveApp.getFileById(tempSpreadsheetId).setTrashed(true);
  }
}

/**
 * [DIGANTI] Memproses import guru ke Firestore.
 */
function prosesImportExcelGuru(token, fileData) {
  let tempExcelFileId = null;
  let tempConvertedSheetId = null;
  
  try {
    const { sessionData } = validateAdminSession(token);
    const sekolahID = sessionData.sekolahID;
    
    const { firestore, projectId } = getFirestoreInstance();
    const projectPath = `projects/${projectId}/databases/(default)/documents`;
    const batch = firestore.batch();
    
    // 1. Dapatkan guru & mapel yang ada
    const guruDocs = firestore.getCollection('akun_guru')
                               .where('sekolahID', '==', sekolahID)
                               .getDocuments();
    const existingEmailSet = new Set(guruDocs.map(doc => parseValue(doc.fields.email).trim().toLowerCase()));

    const mapelList = getMapelDataInternal(null, sekolahID); // 'ss' tidak lagi relevan
    const validMapelIdSet = new Set(mapelList.map(m => m.id));

    // 2. Proses File
    const { base64, mimeType, fileName } = fileData;
    const decodedData = Utilities.base64Decode(base64.split(',')[1]);
    const blob = Utilities.newBlob(decodedData, mimeType, fileName);
    
    const tempExcelFile = DriveApp.createFile(blob);
    tempExcelFileId = tempExcelFile.getId();
    const conversionResource = { title: `[TEMP] Import Guru - ${fileName}`, mimeType: MimeType.GOOGLE_SHEETS };
    const convertedFile = Drive.Files.copy(conversionResource, tempExcelFileId, { convert: true });
    tempConvertedSheetId = convertedFile.id;
    
    const tempSheet = SpreadsheetApp.openById(tempConvertedSheetId);
    const dataSheet = tempSheet.getSheetByName('Template Guru');
    if (!dataSheet) throw new Error("File Excel tidak valid. Sheet 'Template Guru' tidak ditemukan.");
    
    const excelData = dataSheet.getDataRange().getValues();
    if (excelData.length <= 1) throw new Error("File Excel kosong.");
    excelData.shift(); 

    // 3. Validasi dan Persiapan Batch
    const gagalList = [];
    let successCount = 0;
    
    for (let i = 0; i < excelData.length; i++) {
      const row = excelData[i];
      const barisKe = i + 2;
      
      const nama = (row[0] ? String(row[0]) : '').trim();
      const email = (row[1] ? String(row[1]) : '').trim().toLowerCase();
      const password = (row[2] ? String(row[2]) : '');
      const mapelIdsStr = (row[3] ? String(row[3]) : '').trim();

      // Validasi
      if (!nama || !email || !password) {
        gagalList.push({ baris: barisKe, nama: nama, email: email, alasan: "Nama, Email, atau Password kosong." }); continue;
      }
      if (existingEmailSet.has(email)) {
        gagalList.push({ baris: barisKe, nama: nama, email: email, alasan: "Email sudah terdaftar." }); continue;
      }
      if (password.length < 8) {
         gagalList.push({ baris: barisKe, nama: nama, email: email, alasan: "Password kurang dari 8 karakter." }); continue;
      }
      const mapelIds = mapelIdsStr.split(',').map(id => id.trim()).filter(id => id);
      let mapelValid = true;
      let mapelInvalid = '';
      for (const id of mapelIds) {
        if (!validMapelIdSet.has(id)) {
          mapelValid = false; mapelInvalid = id; break;
        }
      }
      if (!mapelValid) {
        gagalList.push({ baris: barisKe, nama: nama, email: email, alasan: `Kode Mapel '${mapelInvalid}' tidak valid.` }); continue;
      }

      // Persiapan Doc
      const newSalt = generateSalt();
      const newHash = hashPassword(password, newSalt);
      const docId = `${sekolahID}_${email}`;
      const fullDocPath = `${projectPath}/akun_guru/${docId}`;
      const docRef = { name: fullDocPath };

      const newDoc = {
        sekolahID: sekolahID,
        email: email,
        nama: nama,
        hashedPassword: newHash,
        salt: newSalt,
        mapelIDs: mapelIds // Simpan sebagai array
      };

      batch.create(docRef, newDoc);
      existingEmailSet.add(email);
      successCount++;
    }

    // 4. Commit Batch
    if (successCount > 0) {
      batch.commit();
    }

    // 5. Cleanup
    DriveApp.getFileById(tempExcelFileId).setTrashed(true);
    DriveApp.getFileById(tempConvertedSheetId).setTrashed(true);
    
    return {
      status: "sukses",
      totalDiProses: excelData.length,
      berhasilDiUpload: successCount,
      gagalDiUpload: gagalList.length,
      dataGagal: gagalList
    };
    
  } catch (e) {
    if (tempExcelFileId) { try { DriveApp.getFileById(tempExcelFileId).setTrashed(true); } catch (err) {} }
    if (tempConvertedSheetId) { try { DriveApp.getFileById(tempConvertedSheetId).setTrashed(true); } catch (err) {} }
    return { status: "gagal", message: "Terjadi error: " + e.message };
  }
}


/**
 * FUNGSI MIGRASI - BAGIAN 1: UJIAN
 * Jalankan fungsi ini untuk memigrasi Nilai_Ujian saja.
 */
function MIGRASI_1_NilaiUjian_KeFirestore() {
  let token;
  try {
    token = Browser.inputBox(
      "Otorisasi Migrasi (Bagian 1: Ujian)",
      "Tempel sessionToken Anda (F12 > Application > Local Storage):",
      Browser.Buttons.OK_CANCEL
    );
    if (token === 'cancel' || !token) throw new Error("Migrasi dibatalkan.");

    const { sessionData, spreadsheetID } = validateAdminSession(token);
    const sekolahID = sessionData.sekolahID;
    
    // --- PERUBAHAN DI SINI ---
    const { firestore, projectId } = getFirestoreInstance();
    const projectPath = `projects/${projectId}/databases/(default)/documents`;
    // --- AKHIR PERUBAHAN ---

    const ss = SpreadsheetApp.openById(spreadsheetID);
    
    let batch = firestore.batch();
    let count = 0;
    
    Logger.log(`Memulai migrasi UJIAN untuk Sekolah: ${sekolahID}`);

    const sheetUjian = getNilaiUjianSheet(ss);
    if (sheetUjian.getLastRow() > 1) {
      const dataUjian = sheetUjian.getRange("A2:D" + sheetUjian.getLastRow()).getValues();
      Logger.log(`Ditemukan ${dataUjian.length} data di Nilai_Ujian...`);
      
      for (const row of dataUjian) {
        const siswaID = row[0]; const mapelID = row[1];
        if (!siswaID || !mapelID) continue;
        
        const docId = `${sekolahID}_${siswaID}_${mapelID}`;

        // --- PERUBAHAN DI SINI ---
        // Buat path dokumen lengkap secara manual
        const fullDocPath = `${projectPath}/nilai_ujian/${docId}`;
        // Buat objek 'docRef' palsu yang hanya berisi properti .name
        const docRef = { name: fullDocPath };
        // --- AKHIR PERUBAHAN ---
        
        const data = {
          sekolahID: sekolahID, siswaID: siswaID, mapelID: mapelID,
          um: (row[2] === "" || row[2] === null) ? null : row[2],
          up: (row[3] === "" || row[3] === null) ? null : row[3]
        };
        batch.set(docRef, data);
        count++;

        if (count >= 400) { 
          let response = batch.commit();
          if (response.error) {
            throw new Error("Gagal commit batch Ujian (400): " + response.error.message);
          }
          Logger.log(`Batch Ujian ${count} data terkirim...`);
          batch = firestore.batch();
          count = 0;
        }
      }
      if (count > 0) {
        let response = batch.commit();
        if (response.error) {
          throw new Error("Gagal commit batch Ujian terakhir: " + response.error.message);
        }
        Logger.log(`Batch Ujian ${count} data terakhir terkirim.`);
      }
    }
    
    Logger.log("MIGRASI UJIAN SELESAI.");
    Browser.msgBox("MIGRASI UJIAN SELESAI.", "Silakan periksa Firebase, lalu jalankan MIGRASI_2_NilaiRapor_KeFirestore.", Browser.Buttons.OK);
  } catch (e) {
    Logger.log(e);
    Browser.msgBox("MIGRASI GAGAL", `Error: ${e.message}`, Browser.Buttons.OK);
  }
}

/**
 * FUNGSI MIGRASI - BAGIAN 2: RAPOR
 * Jalankan fungsi ini SETELAH Bagian 1 selesai.
 */
function MIGRASI_2_NilaiRapor_KeFirestore() {
  let token;
  try {
    token = Browser.inputBox(
      "Otorisasi Migrasi (Bagian 2: Rapor)",
      "Tempel sessionToken Anda (F12 > Application > Local Storage):",
      Browser.Buttons.OK_CANCEL
    );
    if (token === 'cancel' || !token) throw new Error("Migrasi dibatalkan.");

    const { sessionData, spreadsheetID } = validateAdminSession(token);
    const sekolahID = sessionData.sekolahID;

    // --- PERUBAHAN DI SINI ---
    const { firestore, projectId } = getFirestoreInstance();
    const projectPath = `projects/${projectId}/databases/(default)/documents`;
    // --- AKHIR PERUBAHAN ---

    const ss = SpreadsheetApp.openById(spreadsheetID);
    
    let batch = firestore.batch();
    let count = 0;
    
    Logger.log(`Memulai migrasi RAPOR untuk Sekolah: ${sekolahID}`);

    const sheetRapor = getNilaiRaporSheet(ss);
    if (sheetRapor.getLastRow() > 1) {
      const dataRapor = sheetRapor.getRange("A2:E" + sheetRapor.getLastRow()).getValues();
      Logger.log(`Ditemukan ${dataRapor.length} data di Nilai_Rapor_Akhir...`);

      for (const row of dataRapor) {
        const siswaID = row[0]; const mapelID = row[1]; const semesterID = row[2];
        if (!siswaID || !mapelID || !semesterID) continue;
        
        const docId = `${sekolahID}_${siswaID}_${mapelID}_${semesterID}`;

        // --- PERUBAHAN DI SINI ---
        const fullDocPath = `${projectPath}/nilai_rapor/${docId}`;
        const docRef = { name: fullDocPath };
        // --- AKHIR PERUBAHAN ---
        
        const data = {
          sekolahID: sekolahID, siswaID: siswaID, mapelID: mapelID, semesterID: semesterID,
          p: (row[3] === "" || row[3] === null) ? null : row[3],
          k: (row[4] === "" || row[4] === null) ? null : row[4]
        };
        
        batch.set(docRef, data);
        count++;

        if (count >= 400) {
          let response = batch.commit();
          if (response.error) {
            throw new Error("Gagal commit batch Rapor (400): " + response.error.message);
          }
          Logger.log(`Batch Rapor ${count} data terkirim...`);
          batch = firestore.batch();
          count = 0;
        }
      }
      if (count > 0) {
        let response = batch.commit();
        if (response.error) {
          throw new Error("Gagal commit batch Rapor terakhir: " + response.error.message);
        }
        Logger.log(`Batch Rapor ${count} data terakhir terkirim.`);
      }
    }
    
    Logger.log("MIGRASI RAPOR SELESAI.");
    Browser.msgBox("MIGRASI RAPOR SELESAI.", "Seluruh data nilai telah berhasil dipindahkan ke Firestore.", Browser.Buttons.OK);
  } catch (e) {
    Logger.log(e);
    Browser.msgBox("MIGRASI GAGAL", `Error: ${e.message}`, Browser.Buttons.OK);
  }
}

// --- Tambahkan fungsi ini, jalankan SATU KALI, lalu HAPUS ---
function MIGRASI_MASTER_DATABASE_ke_Firestore() {
  try {
    const { firestore, projectId } = getFirestoreInstance();
    const projectPath = `projects/${projectId}/databases/(default)/documents`;
    const masterSS = SpreadsheetApp.openById(MASTER_SHEET_ID);
    
    let batch = firestore.batch();
    let count = 0;
    
    Logger.log("Memulai migrasi...");

    // 1. Migrasi Sheet_Superadmin
    const sheetSuperadmin = masterSS.getSheetByName("Sheet_Superadmin");
    const dataSuperadmin = sheetSuperadmin.getDataRange().getValues();
    dataSuperadmin.shift(); // Hapus header
    
    Logger.log(`Memigrasi ${dataSuperadmin.length} Superadmin...`);
    dataSuperadmin.forEach(row => {
      const email = row[0].trim().toLowerCase();
      if (!email) return; // Lewati baris kosong
      
      const docPath = `${projectPath}/superadmin/${email}`;
      const docRef = { name: docPath };
      const data = {
        email: email,
        nama: row[1],
        hashedPassword: row[2],
        salt: row[3]
      };
      batch.set(docRef, data); // Gunakan set() untuk menimpa jika ada
      count++;
    });
    Logger.log("Migrasi Superadmin selesai di batch.");

    // 2. Migrasi Sheet_Sekolah
    const sheetSekolah = masterSS.getSheetByName("Sheet_Sekolah");
    const dataSekolah = sheetSekolah.getDataRange().getValues();
    dataSekolah.shift(); // Hapus header
    
    Logger.log(`Memigrasi ${dataSekolah.length} Sekolah...`);
    dataSekolah.forEach(row => {
      const sekolahID = row[0];
      if (!sekolahID) return; // Lewati baris kosong
      
      const docPath = `${projectPath}/sekolah/${sekolahID}`;
      const docRef = { name: docPath };
      const data = {
        sekolahID: sekolahID,
        namaSekolah: row[1],
        jenjang: row[2],
        emailAdmin: row[3].trim().toLowerCase(),
        hashedPassword: row[4],
        spreadsheetID: row[5],
        salt: row[6],
        npsn: row[7] || ""
      };
      batch.set(docRef, data);
      count++;
      if (count >= 400) {
        batch.commit();
        Logger.log("Batch 400 sekolah terkirim...");
        batch = firestore.batch();
        count = 0;
      }
    });
    Logger.log("Migrasi Sekolah selesai di batch.");
    
    // 3. Migrasi Sheet_Registrasi_Pending
    const sheetPending = masterSS.getSheetByName("Registrasi_Pending");
    const dataPending = sheetPending.getDataRange().getValues();
    dataPending.shift(); // Hapus header
    
    Logger.log(`Memigrasi ${dataPending.length} Registrasi Pending...`);
    dataPending.forEach(row => {
      const token = row[6];
      if (!token) return; // Lewati jika tidak ada token
      
      const docPath = `${projectPath}/registrasi_pending/${token}`;
      const docRef = { name: docPath };
      const data = {
        email: row[0].trim().toLowerCase(),
        namaSekolah: row[1],
        npsn: row[2],
        jenjang: row[3],
        hashedPassword: row[4],
        salt: row[5],
        timestamp: new Date(row[7]).toISOString()
      };
      batch.set(docRef, data);
      count++;
      if (count >= 400) {
        batch.commit();
        Logger.log("Batch 400 pending terkirim...");
        batch = firestore.batch();
        count = 0;
      }
    });
    Logger.log("Migrasi Pending selesai di batch.");

    // Commit sisa batch
    if (count > 0) {
      batch.commit();
      Logger.log(`Batch final ${count} data terkirim.`);
    }

    Logger.log("--- MIGRASI MASTER DATABASE SELESAI ---");
    Browser.msgBox("MIGRASI MASTER DATABASE SELESAI", "Semua data admin, sekolah, dan pending telah dipindah ke Firestore.", Browser.Buttons.OK);

  } catch (e) {
    Logger.log(e);
    Browser.msgBox("MIGRASI GAGAL", `Error: ${e.message}`, Browser.Buttons.OK);
  }
}

// --- GANTI FUNGSI LAMA DENGAN VERSI BARU INI DI Kode.gs.html ---

/**
 * [KONSTANTA] Ukuran batch untuk Firestore
 */
const MIGRASI_BATCH_SIZE = 400; // Firestore merekomendasikan maks 500

/**
 * [KONSTANTA] Default config dari Langkah 3 (disertakan lagi untuk kelengkapan)
 */
const DEFAULTS_CONFIG_MIGRASI = {
  bobotRapor: 60, bobotUjian: 40, kkm: 76, jumlahSemester: 5,
  jenjangPilihan: '', npsn: '', nsm: '', alamat: '', provinsi: '',
  kabKot: '', pilihanKabKot: 'Kabupaten', kecamatan: '', kelDes: '',
  pilihanKelDes: 'Kelurahan', kodePos: '', telepon: '', email: '',
  website: '', namaKepsek: '', nipKepsek: ''
};

/**
 * [HELPER] Fungsi untuk mem-parsing nilai dari respons Firestore.
 * (Anda seharusnya sudah memiliki ini dari langkah sebelumnya)
 */
function parseValue(value) {
  if (!value) return null;
  if (value.stringValue) return value.stringValue;
  if (value.integerValue) return parseInt(value.integerValue, 10);
  if (value.doubleValue) return parseFloat(value.doubleValue);
  if (value.booleanValue) return value.booleanValue;
  if (value.hasOwnProperty('nullValue')) return null;
  if (value.timestampValue) return value.timestampValue;
  if (Array.isArray(value.arrayValue?.values)) {
    return value.arrayValue.values.map(parseValue);
  }
  return null; 
}

/**
 * [HELPER MIGRASI] Mengambil data dari sheet dengan aman.
 */
function _migrasiGetSheetData(ss, sheetName) {
  try {
    const sheet = ss.getSheetByName(sheetName);
    if (!sheet) {
      Logger.log(`     - Peringatan: Sheet '${sheetName}' tidak ditemukan.`);
      return [];
    }
    if (sheet.getLastRow() <= 1) {
      Logger.log(`     - Info: Sheet '${sheetName}' kosong.`);
      return [];
    }
    const data = sheet.getRange(2, 1, sheet.getLastRow() - 1, sheet.getLastColumn()).getValues();
    Logger.log(`     - Ditemukan ${data.length} baris di '${sheetName}'.`);
    return data;
  } catch (e) {
    Logger.log(`     - Gagal membaca sheet '${sheetName}': ${e.message}`);
    return [];
  }
}

/**
 * [HELPER MIGRASI] Menangani pengiriman batch.
 */
function _migrasiHandleBatch(batch, count, firestore, logPrefix) {
  if (count >= MIGRASI_BATCH_SIZE) {
    batch.commit();
    Logger.log(`     > ${logPrefix}: Batch ${count} data terkirim.`);
    return { batch: firestore.batch(), count: 0 }; // Buat batch baru
  }
  return { batch: batch, count: count };
}

/**
 * ====================================================================
 * FUNGSI MIGRASI UTAMA (JALANKAN INI SATU KALI) - VERSI PERBAIKAN
 * ====================================================================
 */
function MIGRASI_SEMUA_DATA_SEKOLAH_ke_Firestore() {
  try {
    const { firestore, projectId } = getFirestoreInstance();
    const projectPath = `projects/${projectId}/databases/(default)/documents`;
    
    Logger.log("Memulai Migrasi Massal Data Sekolah ke Firestore...");
    
    // 1. Dapatkan daftar semua sekolah dari Firestore (hasil Langkah 4)
    const allSekolahDocs = firestore.getCollection('sekolah').getDocuments();
    Logger.log(`Ditemukan ${allSekolahDocs.length} sekolah untuk diproses.`);
    
    // 2. Loop setiap sekolah
    for (const sekolahDoc of allSekolahDocs) {
      // 'sekolahDoc.fields' SUDAH merupakan objek JavaScript yang bersih
      // karena dikembalikan oleh konstruktor 'new Document()' di dalam getDocuments()
      
      // --- PERBAIKAN DI SINI: Hapus semua parseValue() ---
      const fields = sekolahDoc.fields; 
      const sekolahID = fields.sekolahID;
      const spreadsheetID = fields.spreadsheetID;
      const namaSekolah = fields.namaSekolah;
      // --- AKHIR PERBAIKAN ---

      if (!spreadsheetID) {
        Logger.log(`--- SKIP: ${namaSekolah} (ID: ${sekolahID}) ---`);
        Logger.log("   Alasan: spreadsheetID tidak ada atau null di dokumen Firestore.\n");
        continue;
      }

      Logger.log(`--- MEMPROSES: ${namaSekolah} (ID: ${sekolahID}) ---`);
      
      let batch = firestore.batch();
      let count = 0;
      let totalCount = 0;

      try {
        const ss = SpreadsheetApp.openById(spreadsheetID);

        // A. Migrasi Config (Data_Sekolah + Pengaturan)
        // ----------------------------------------------------
        Logger.log("   Migrasi Config (1 Dokumen)...");
        const configDoc = { ...DEFAULTS_CONFIG_MIGRASI }; // Salin default
        configDoc.sekolahID = sekolahID; // Tambahkan sekolahID
        
        // --- PERBAIKAN DI SINI: Gunakan 'fields' yang sudah bersih ---
        configDoc.npsn = fields.npsn || ''; // Ambil NPSN dari data 'sekolah'
        // --- AKHIR PERBAIKAN ---

        // Ambil dari Sheet 'Data_Sekolah'
        try {
          const sheetData = ss.getSheetByName('Data_Sekolah');
          if (sheetData && sheetData.getLastRow() > 1) {
            const data = sheetData.getRange('A2:P2').getValues()[0];
            configDoc.jenjangPilihan = data[0] || configDoc.jenjangPilihan;
            // configDoc.npsn (sudah diambil dari 'sekolah')
            configDoc.nsm = data[2] || configDoc.nsm;
            configDoc.alamat = data[3] || configDoc.alamat;
            configDoc.provinsi = data[4] || configDoc.provinsi;
            configDoc.kabKot = data[5] || configDoc.kabKot;
            configDoc.pilihanKabKot = data[6] || configDoc.pilihanKabKot;
            configDoc.kecamatan = data[7] || configDoc.kecamatan;
            configDoc.kelDes = data[8] || configDoc.kelDes;
            configDoc.pilihanKelDes = data[9] || configDoc.pilihanKelDes;
            configDoc.kodePos = data[10] || configDoc.kodePos;
            configDoc.telepon = data[11] || configDoc.telepon;
            configDoc.email = data[12] || configDoc.email;
            configDoc.website = data[13] || configDoc.website;
            configDoc.namaKepsek = data[14] || configDoc.namaKepsek;
            configDoc.nipKepsek = data[15] || configDoc.nipKepsek;
          }
        } catch (e) { Logger.log(`     - Peringatan: Gagal membaca Sheet 'Data_Sekolah': ${e.message}`); }

        // Ambil dari Sheet 'Pengaturan'
        try {
          const dataPengaturan = _migrasiGetSheetData(ss, 'Pengaturan');
          dataPengaturan.forEach(row => {
            if (row[0] === 'Bobot_Rapor') configDoc.bobotRapor = row[1];
            if (row[0] === 'Bobot_Ujian') configDoc.bobotUjian = row[1];
            if (row[0] === 'KKM') configDoc.kkm = row[1];
            if (row[0] === 'Jumlah_Semester') configDoc.jumlahSemester = row[1];
          });
        } catch (e) { Logger.log(`     - Peringatan: Gagal membaca Sheet 'Pengaturan': ${e.message}`); }
        
        const configDocPath = `${projectPath}/sekolah_config/${sekolahID}`;
        batch.set({ name: configDocPath }, configDoc); // set() akan menimpa
        count++;
        totalCount++;

        // B. Migrasi Kelas
        // ----------------------------------------------------
        const dataKelas = _migrasiGetSheetData(ss, 'Kelas');
        for (const row of dataKelas) {
          const namaKelas = row[0];
          if (!namaKelas) continue;
          const docId = `${sekolahID}_${namaKelas.replace(/[^a-zA-Z0-9]/g, '_')}`;
          const docPath = `${projectPath}/kelas/${docId}`;
          batch.set({ name: docPath }, { sekolahID: sekolahID, namaKelas: namaKelas });
          count++;
        }
        totalCount += dataKelas.length;
        
        // C. Migrasi Mapel
        // ----------------------------------------------------
        const dataMapel = _migrasiGetSheetData(ss, 'Mapel');
        for (const [index, row] of dataMapel.entries()) {
          const mapelID = row[0];
          if (!mapelID) continue;
          const docId = `${sekolahID}_${mapelID}`;
          const docPath = `${projectPath}/mapel/${docId}`;
          const data = {
            sekolahID: sekolahID, mapelID: mapelID, namaMapel: row[1],
            isUS: row[2] || false, isUP: row[3] || false,
            urutan: Number(row[4] || index + 1)
          };
          batch.set({ name: docPath }, data);
          count++;
          let batchRes = _migrasiHandleBatch(batch, count, firestore, "Mapel");
          batch = batchRes.batch; count = batchRes.count;
        }
        totalCount += dataMapel.length;

        // D. Migrasi Siswa
        // ----------------------------------------------------
        const dataSiswa = _migrasiGetSheetData(ss, 'Siswa');
        for (const row of dataSiswa) {
          const siswaID = row[0];
          if (!siswaID) continue;
          const docId = `${sekolahID}_${siswaID}`;
          const docPath = `${projectPath}/siswa/${docId}`;
          const idNum = parseInt((siswaID || 'SIS-0').split('-')[1] || 0);
          let tglLahir = (row[6] instanceof Date) ? Utilities.formatDate(row[6], Session.getScriptTimeZone(), "yyyy-MM-dd") : (row[6] || null);

          const data = {
            sekolahID: sekolahID, siswaID: siswaID,
            namaSiswa: row[1], nisn: row[2], nisLokal: row[3] || null,
            jenisKelamin: row[4] || null, tempatLahir: row[5] || null,
            tglLahir: tglLahir, kelas: row[7] || null,
            urutan: Number(row[8] || idNum)
          };
          batch.set({ name: docPath }, data);
          count++;
          let batchRes = _migrasiHandleBatch(batch, count, firestore, "Siswa");
          batch = batchRes.batch; count = batchRes.count;
        }
        totalCount += dataSiswa.length;

        // E. Migrasi Akun_Guru
        // ----------------------------------------------------
        const dataGuru = _migrasiGetSheetData(ss, 'Akun_Guru');
        for (const row of dataGuru) {
          const email = (row[0] || '').trim().toLowerCase();
          if (!email) continue;
          const docId = `${sekolahID}_${email}`;
          const docPath = `${projectPath}/akun_guru/${docId}`;
          const data = {
            sekolahID: sekolahID, email: email, nama: row[1],
            hashedPassword: row[2], salt: row[3],
            mapelIDs: (row[4] ? String(row[4]).split(',').map(s => s.trim()) : [])
          };
          batch.set({ name: docPath }, data);
          count++;
          let batchRes = _migrasiHandleBatch(batch, count, firestore, "Akun_Guru");
          batch = batchRes.batch; count = batchRes.count;
        }
        totalCount += dataGuru.length;

        // F. Migrasi Nilai_Ujian
        // ----------------------------------------------------
        const dataUjian = _migrasiGetSheetData(ss, 'Nilai_Ujian');
        for (const row of dataUjian) {
          const siswaID = row[0]; const mapelID = row[1];
          if (!siswaID || !mapelID) continue;
          const docId = `${sekolahID}_${siswaID}_${mapelID}`;
          const docPath = `${projectPath}/nilai_ujian/${docId}`;
          const data = {
            sekolahID: sekolahID, siswaID: siswaID, mapelID: mapelID,
            um: (row[2] === "" || row[2] === null) ? null : row[2],
            up: (row[3] === "" || row[3] === null) ? null : row[3]
          };
          batch.set({ name: docPath }, data, { merge: true }); // set-merge jika sudah ada
          count++;
          let batchRes = _migrasiHandleBatch(batch, count, firestore, "Nilai_Ujian");
          batch = batchRes.batch; count = batchRes.count;
        }
        totalCount += dataUjian.length;

        // G. Migrasi Nilai_Rapor_Akhir
        // ----------------------------------------------------
        const dataRapor = _migrasiGetSheetData(ss, 'Nilai_Rapor_Akhir');
        for (const row of dataRapor) {
          const siswaID = row[0]; const mapelID = row[1]; const semesterID = row[2];
          if (!siswaID || !mapelID || !semesterID) continue;
          const docId = `${sekolahID}_${siswaID}_${mapelID}_${semesterID}`;
          const docPath = `${projectPath}/nilai_rapor/${docId}`;
          const data = {
            sekolahID: sekolahID, siswaID: siswaID, mapelID: mapelID, semesterID: semesterID,
            p: (row[3] === "" || row[3] === null) ? null : row[3],
            k: (row[4] === "" || row[4] === null) ? null : row[4]
          };
          batch.set({ name: docPath }, data, { merge: true });
          count++;
          let batchRes = _migrasiHandleBatch(batch, count, firestore, "Nilai_Rapor");
          batch = batchRes.batch; count = batchRes.count;
        }
        totalCount += dataRapor.length;

        // Commit sisa batch
        if (count > 0) {
          batch.commit();
          Logger.log(`     > Batch final ${count} data terkirim.`);
        }
        
        Logger.log(`--- SUKSES: ${namaSekolah} (Total ${totalCount} dokumen diproses) ---`);

      } catch (e) {
        Logger.log(`!!! GAGAL TOTAL UNTUK ${namaSekolah}: ${e.message} !!!`);
        Logger.log(`   SpreadsheetID: ${spreadsheetID}`);
        // Lanjutkan ke sekolah berikutnya
      }
    } // Akhir loop sekolah

    Logger.log("=== SEMUA MIGRASI DATA SEKOLAH SELESAI ===");
    Browser.msgBox("MIGRASI DATA SEKOLAH SELESAI.", "Semua data dari semua spreadsheet sekolah telah dimigrasikan ke Firestore.", Browser.Buttons.OK);

  } catch (e) {
    Logger.log(e);
    Browser.msgBox("MIGRASI GAGAL TOTAL", `Error: ${e.message}`, Browser.Buttons.OK);
  }
}
