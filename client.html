<script>
  /**
   * Manajer sederhana untuk melacak riwayat Undo/Redo
   */
  const undoManager = {
    history: [],
    historyIndex: -1,
    
    /**
     * @param {Array<Object>} changes - Array objek {input, oldValue, newValue}
     */
    pushState: function(changes) {
      if (!changes || changes.length === 0) return;
      
      // Hapus riwayat "redo" jika kita membuat perubahan baru
      if (this.historyIndex < this.history.length - 1) {
        this.history = this.history.slice(0, this.historyIndex + 1);
      }
      
      this.history.push(changes);
      this.historyIndex = this.history.length - 1;
      
      // Batasi riwayat agar tidak terlalu besar (opsional)
      if (this.history.length > 50) {
        this.history.shift();
        this.historyIndex--;
      }
    },
    
    clearHistory: function() {
      this.history = [];
      this.historyIndex = -1;
    },

    undo: function() {
      if (this.historyIndex < 0) return;
      isFormDirty = true; 
      
      const changes = this.history[this.historyIndex];
      const affectedSiswaIds = new Set();
      
      for (let i = changes.length - 1; i >= 0; i--) {
        const change = changes[i];
        change.input.value = change.oldValue;
        affectedSiswaIds.add(change.input.dataset.siswaId);
      }
      
      this.historyIndex--;
      this.triggerTotalUpdates(changes[0].input, affectedSiswaIds);
    },
    
    redo: function() {
      if (this.historyIndex >= this.history.length - 1) return;
      isFormDirty = true; 
      
      this.historyIndex++;
      const changes = this.history[this.historyIndex];
      const affectedSiswaIds = new Set();
      
      for (const change of changes) {
        change.input.value = change.newValue;
        affectedSiswaIds.add(change.input.dataset.siswaId);
      }
      
      this.triggerTotalUpdates(changes[0].input, affectedSiswaIds);
    },
    
    triggerTotalUpdates: function(anyInput, siswaIds) {
      const page = anyInput.closest('.container');
      
      if (page.id === 'halaman-input-nilai-detail') {
        const mapelCount = globalGridData.mapelList.length;
        siswaIds.forEach(siswaId => updateRowTotals(siswaId, mapelCount));
      } else if (page.id === 'halaman-input-rapor-detail') {
        const tabPane = anyInput.closest('.tab-content');
        const tipeNilai = (tabPane.id === 'tab-keterampilan-content') ? 'K' : 'P';
        const data = (tipeNilai === 'P') ? globalRaporData.P : globalRaporData.K;
        const mapelCount = data.mapelList.length;
        siswaIds.forEach(siswaId => updateRowTotalsRapor(siswaId, mapelCount, tipeNilai));
      }
    }
  };

  let jenjangBaseCache = '';
  let jenjangPilihanCache = '';
  const LAST_PAGE_KEY = 'lastVisitedPageId';
  let siswaTelahDiImport = false;
  let nilaiTelahDiUpload = false;
  let nilaiRaporTelahDiUpload = false; 
  let guruTelahDiImport = false;
  let globalSiswaList = [];
  let isSiswaOrderDirty = false;
  // --- TAMBAHKAN INI ---
  let globalDonasiStatus = 'NONE';
  let globalDonasiDetail = {}; // Cache untuk detail (file url, alasan)
  // --- AKHIR TAMBAHAN ---
  let isMapelTipeDirty = false;
  let globalMapelList = [];
  let isMapelOrderDirty = false;
  let globalGridData = {
    siswaList: [],
    mapelList: [],
    nilaiData: {}
  };
  let globalRaporData = {
    P: { siswaList: [], mapelList: [], nilaiData: {} },
    K: { siswaList: [], mapelList: [], nilaiData: {} },
    Rekap: { siswaList: [], mapelList: [], nilaiRekapData: {} }
  };

  let currentProsesToast = null;

  let isImpersonatingCache = false;
  let currentUserRole = ''
  let guruHasPraktek = false;
  let guruHasMadrasah = false;
  let globalAppUrl = '';

  // --- TAMBAHAN BARU ---
  let inactivityTimer = null;
  const INACTIVITY_TIMEOUT_MS = 3 * 60 * 60 * 1000; // 3 Jam
  // --- AKHIR TAMBAHAN BARU ---

  let originalButtonContent = new Map();

  let globalIjazahData = {
    siswaList: [],
    mapelList: [],
    dataUjian: {},
    dataRapor: {},
    dataIjazah: {}
  };

  let showWeightedUjian = true;
  let showWeightedRapor = true;

  // --- TAMBAHKAN INI ---
  let isFormDirty = false;
  // --- AKHIR TAMBAHAN ---

  function getToken() {
    return localStorage.getItem('sessionToken');
  }

  function handleKeyDown(e) {
    // Ctrl+Z untuk Undo
    if (e.ctrlKey && e.key === 'z') {
      e.preventDefault();
      undoManager.undo();
    }
    // Ctrl+Y atau Ctrl+Shift+Z untuk Redo
    if (e.ctrlKey && (e.key === 'y' || (e.shiftKey && e.key === 'Z'))) {
      e.preventDefault();
      undoManager.redo();
    }
  }

  function handlePasteEvent(e) {
    const anchorInput = e.target;
    
    if (!anchorInput || !anchorInput.classList.contains('input-nilai')) {
      return;
    }
    
    e.preventDefault();
    
    const pasteData = (e.clipboardData || window.clipboardData).getData('text');
    if (!pasteData) return;

    const dataRows = pasteData.replace(/\r/g, '').split('\n').map(row => row.split('\t'));
    
    const table = anchorInput.closest('.input-nilai-table');
    if (!table) return;

    const visibleRows = Array.from(table.querySelectorAll('tbody tr'));
    const visibleInputsGrid = visibleRows.map(row => Array.from(row.querySelectorAll('.input-nilai')));
    
    let anchorRowIndex = -1;
    let anchorColIndex = -1;
    
    for (let i = 0; i < visibleInputsGrid.length; i++) {
      const j = visibleInputsGrid[i].indexOf(anchorInput);
      if (j > -1) {
        anchorRowIndex = i;
        anchorColIndex = j;
        break;
      }
    }
    
    if (anchorRowIndex === -1) return; 
    
    const changes = [];
    const affectedSiswaIds = new Set();
    
    for (let i = 0; i < dataRows.length; i++) {
      const targetRowIndex = anchorRowIndex + i;
      
      if (!visibleInputsGrid[targetRowIndex]) break; 
      
      const dataCells = dataRows[i];
      
      for (let j = 0; j < dataCells.length; j++) {
        const targetColIndex = anchorColIndex + j;
        
        const targetInput = visibleInputsGrid[targetRowIndex][targetColIndex];
        if (!targetInput) break; 
        
        let newValue = dataCells[j].trim().replace(/[^\d]/g, ''); 
        
        if (newValue !== '') {
          let numValue = parseInt(newValue, 10);
          if (numValue > 100) numValue = 100; 
          if (numValue < 0) numValue = 0;   
          newValue = numValue.toString();
        }
        
        const oldValue = targetInput.value;
        
        if (oldValue !== newValue) {
          targetInput.value = newValue;
          changes.push({ input: targetInput, oldValue, newValue });
          affectedSiswaIds.add(targetInput.dataset.siswaId);
        }
      }
    }
    
    if (changes.length > 0) {
      undoManager.pushState(changes);
      isFormDirty = true;
    }
    
    const page = anchorInput.closest('.container');
    if (page.id === 'halaman-input-nilai-detail') {
      const mapelCount = globalGridData.mapelList.length;
      affectedSiswaIds.forEach(siswaId => updateRowTotals(siswaId, mapelCount));
    } else if (page.id === 'halaman-input-rapor-detail') {
      const tabPane = anchorInput.closest('.tab-content');
      const tipeNilai = (tabPane.id === 'tab-keterampilan-content') ? 'K' : 'P';
      const data = (tipeNilai === 'P') ? globalRaporData.P : globalRaporData.K;
      const mapelCount = data.mapelList.length;
      affectedSiswaIds.forEach(siswaId => updateRowTotalsRapor(siswaId, mapelCount, tipeNilai));
    }
  }

  /**
   * Menampilkan status loading di dalam tombol.
   * @param {HTMLElement} button Tombol yang akan diubah.
   * @param {string} loadingText Teks yang ditampilkan saat loading.
   */
  function setButtonLoading(button, loadingText = "Memproses...") {
    if (!button) return;
    
    // Simpan konten asli jika belum disimpan
    if (!originalButtonContent.has(button.id)) {
      originalButtonContent.set(button.id, button.innerHTML);
    }
    
    // Nonaktifkan tombol dan tambahkan class
    button.disabled = true;
    button.classList.add('loading');
    
    // Set konten loading baru
    button.innerHTML = `
      <span class="spinner-inline"></span>
      <span>${loadingText}</span>
    `;
  }

  /**
   * Mengembalikan tombol ke status semula.
   * @param {HTMLElement} button Tombol yang akan dikembalikan.
   */
  function resetButtonLoading(button) {
    if (!button) return;
    
    // Kembalikan konten asli
    if (originalButtonContent.has(button.id)) {
      button.innerHTML = originalButtonContent.get(button.id);
      originalButtonContent.delete(button.id);
    }
    
    // Aktifkan kembali
    button.disabled = false;
    button.classList.remove('loading');
  }

  // --- FUNGSI NOTIFIKASI "MORPHING" (ANTI-BLINK TOTAL) ---
  function showToast(message, type = 'proses', duration = 4000) {
    const container = document.getElementById('global-toast-container');
    if (!container) return;

    let toast = null;
    let isRecycled = false;

    // 1. CEK APAKAH BISA RECYCLE (Gunakan notifikasi proses yang sedang aktif)
    // Ini kunci agar tidak ada blink: kita pakai elemen yang SAMA.
    if (currentProsesToast && document.body.contains(currentProsesToast)) {
        toast = currentProsesToast;
        isRecycled = true;
        
        // Reset status agar tidak hilang tiba-tiba
        toast.classList.remove('hide');
        toast.isDismissing = false;
        if (toast.dismissTimer) clearTimeout(toast.dismissTimer);
    } else {
        // Jika tidak ada yang bisa di-recycle, buat baru
        toast = document.createElement('div');
        // Pasang listener swipe hanya sekali saat pembuatan elemen
        attachSwipeListeners(toast);
        container.prepend(toast);
    }

    // 2. UPDATE TAMPILAN INSTAN (MORPHING)
    // Reset semua kelas tipe dulu agar tidak bentrok (misal dari toast-gagal jadi toast-proses)
    toast.classList.remove('toast-proses', 'toast-sukses', 'toast-gagal');
    // Tambahkan kelas dasar dan tipe baru
    toast.classList.add('global-toast', `toast-${type}`);
    
    // Pastikan notifikasi terlihat
    if (!toast.classList.contains('show')) {
         void toast.offsetWidth; // Force reflow agar animasi 'show' berjalan mulus untuk elemen baru
         toast.classList.add('show');
    }

    // Siapkan konten baru
    let iconHtml = '';
    if (type === 'proses') {
      iconHtml = '<div class="spinner-toast"></div>';
      duration = 0; // Proses tidak punya timer auto-close
    } else if (type === 'sukses') {
      iconHtml = '<i class="fas fa-check-circle"></i>';
    } else if (type === 'gagal') {
      iconHtml = '<i class="fas fa-exclamation-circle"></i>';
      duration = 5000; // Tampilkan error sedikit lebih lama
    }

    // Timpa isi HTML notifikasi dengan yang baru
    toast.innerHTML = `
      <div class="toast-icon">${iconHtml}</div>
      <div class="toast-message">${message}</div>
      <div class="toast-close"><i class="fas fa-times"></i></div>
    `;

    // 3. UPDATE POINTER GLOBAL
    if (type === 'proses') {
        currentProsesToast = toast;
    } else if (isRecycled && toast === currentProsesToast) {
        // Jika notifikasi ini tadinya 'proses' tapi sekarang sudah berubah (jadi sukses/gagal),
        // lepaskan dari variabel global agar tidak diganggu proses lain.
        currentProsesToast = null;
    }

    // 4. FUNGSI TUTUP LOKAL (Diperbarui setiap kali showToast dipanggil)
    const dismiss = () => {
        if (toast.isDismissing) return;
        toast.isDismissing = true;
        
        if (toast === currentProsesToast) currentProsesToast = null;

        toast.classList.remove('show');
        toast.classList.add('hide');
        
        // Hapus elemen hanya setelah animasi CSS selesai
        toast.addEventListener('animationend', (e) => {
            if (e.target === toast && toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, { once: true });
    };

    // Simpan fungsi dismiss di elemen agar bisa diakses oleh swipe listener
    toast.dismissFunc = dismiss;

    // Pasang listener untuk tombol close yang baru dibuat
    const closeBtn = toast.querySelector('.toast-close');
    if (closeBtn) {
        // Gunakan satu handler untuk click dan touchstart agar responsif
        const handleClose = (e) => {
            e.stopPropagation();
            e.preventDefault(); // Mencegah double-fire pada beberapa device
            if (toast.dismissTimer) clearTimeout(toast.dismissTimer);
            dismiss();
        };
        closeBtn.addEventListener('click', handleClose);
        closeBtn.addEventListener('touchstart', handleClose, { passive: false });
    }

    // 5. JALANKAN TIMER AUTO-CLOSE (Jika bukan tipe proses)
    if (duration > 0) {
        toast.dismissTimer = setTimeout(dismiss, duration);
    }
  }

  // --- FUNGSI BANTUAN: SWIPE LISTENER ---
  // Dipisahkan agar kode lebih rapi dan hanya dipasang sekali per elemen notifikasi
  function attachSwipeListeners(toastElement) {
      let touchStartX = 0;
      let isSwiping = false;

      toastElement.addEventListener('touchstart', (e) => {
          touchStartX = e.touches[0].clientX;
          isSwiping = true;
          // Stop timer saat disentuh agar user punya waktu membaca
          if (toastElement.dismissTimer) clearTimeout(toastElement.dismissTimer);
          toastElement.style.transition = 'none'; // Matikan transisi agar geseran instan
      }, { passive: true });

      toastElement.addEventListener('touchmove', (e) => {
          if (!isSwiping) return;
          const diffX = e.touches[0].clientX - touchStartX;
          toastElement.style.transform = `translateX(${diffX}px)`;
          // Efek memudar saat digeser
          toastElement.style.opacity = `${1 - Math.abs(diffX) / 150}`;
      }, { passive: true });

      toastElement.addEventListener('touchend', (e) => {
          isSwiping = false;
          toastElement.style.transition = 'transform 0.3s ease-out, opacity 0.3s ease-out';
          const diffX = e.changedTouches[0].clientX - touchStartX;
          
          if (Math.abs(diffX) > 70) { // Jika digeser cukup jauh (>70px) -> Tutup
              if (toastElement.dismissFunc) toastElement.dismissFunc();
              // Lanjutkan animasi geser keluar agar mulus
              toastElement.style.transform = `translateX(${diffX > 0 ? '100%' : '-100%'})`;
              toastElement.style.opacity = '0';
          } else { // Jika geser sedikit -> Kembalikan ke posisi semula
              toastElement.style.transform = 'translateX(0)';
              toastElement.style.opacity = '1';
          }
      });
  }

  function autoScrollToBottom() {
    // Gunakan timeout kecil untuk memberi waktu DOM render/paint
    // sebelum kita menghitung tinggi halaman.
    setTimeout(() => {
      window.scrollTo({
          top: document.body.scrollHeight,
          behavior: 'auto' // 'auto' untuk instan
      });
    }, 100); 
  }

  function jalankanLogin() {
    hideMessage('login-error'); 
    
    const email = document.getElementById('login-email').value.trim();
    const pass = document.getElementById('login-password').value;
    
    if (!email || !pass) {
      showToast("Email dan Password harus dilengkapi.", 'gagal');
      return; 
    }
    
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      showToast("Format email yang dimasukkan tidak valid.", 'gagal');
      return; 
    }
    
    // --- GANTI BARIS INI ---
    // setLoading(true, 'Login...', false);
    // --- MENJADI INI ---
    setButtonLoading(document.getElementById('btn-login'), 'Login...');
    
    google.script.run
      .withSuccessHandler(hasilLogin)
      .withFailureHandler(onGagal)
      .prosesLogin(email, pass);
  }

  function hideToast() {
    // PERBAIKAN: Jangan hanya mengandalkan variabel currentProsesToast.
    // Cari SEMUA toast tipe 'proses' yang mungkin masih nyangkut dan hilangkan mereka.
    const container = document.getElementById('global-toast-container');
    if (!container) return;

    const prosesToasts = container.querySelectorAll('.toast-proses');
    prosesToasts.forEach(toast => {
      if (!toast.isDismissing) {
        toast.isDismissing = true;
        toast.classList.remove('show');
        toast.classList.add('hide');
        
        // Paksa hapus jika animasi macet (fallback safety)
        setTimeout(() => {
           if (toast.parentNode) toast.parentNode.removeChild(toast);
        }, 500); 

        toast.addEventListener('animationend', () => {
          if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
          }
        });
      }
    });
    
    currentProsesToast = null;
  }

  function setLoading(isLoading, message = 'Memuat data...', blockUI = true, showLoadingToast = true) {
    document.getElementById('loader').style.display = 'none';
    
    const uiBlocker = document.getElementById('global-ui-blocker');

    if (isLoading) {
      
      // --- PERUBAHAN DI SINI ---
      // Hanya tampilkan toast jika showLoadingToast adalah true
      if (showLoadingToast) {
        showToast(message, 'proses');
      }
      // --- AKHIR PERUBAHAN ---
      
      if (uiBlocker && blockUI) {
        uiBlocker.style.display = 'block';
      }
    } else {
      hideToast();
      if (uiBlocker) {
        uiBlocker.style.display = 'none';
      }
    }
  }

  function toProperCase(str) {
    if (!str) return '';
    return str.toLowerCase().replace(/\b\w/g, char => char.toUpperCase());
  }

  function formatNamaSiswa(namaLengkap) {
    if (!namaLengkap) return '';
    const parts = namaLengkap.split(' ');
    if (parts.length >= 3) {
      const barisSatu = parts.slice(0, 2).join(' ');
      const barisDua = parts.slice(2).join(' ');
      // Ganti <br> dengan dua span yang bisa di-styling
      return `<span class="nama-baris-1">${barisSatu}</span> <span class="nama-baris-2">${barisDua}</span>`;
    }
    return namaLengkap;
  }

  function showMessage(elementId, message, isError) {
    if (typeof isError === 'undefined' || isError === null) {
      isError = true;
    }

    if (isError) {
      showToast(message, 'gagal');
    } else {
      showToast(message, 'sukses');
    }
  }

  function hideMessage(elementId) {
  }

  function tampilHalaman(idHalaman) {
    /* --- =================================== --- */
    /* ---      TAMBAHAN BARU: Hentikan Video    --- */
    /* --- =GET-VIDEO-STATE-FAILED================================== --- */
    // Cek apakah player video donasi (ytPlayerDonasi) ada
    // dan memiliki fungsi stopVideo.
    if (ytPlayerDonasi && typeof ytPlayerDonasi.stopVideo === 'function') {
      
      // Jika halaman yang dituju BUKAN halaman donasi,
      // panggil .stopVideo() untuk menghentikannya.
      if (idHalaman !== 'halaman-donasi') {
        ytPlayerDonasi.stopVideo();
        
        // Pastikan juga navigasi slider muncul kembali
        const sliderEl = document.querySelector('.donasi-slider');
        if (sliderEl) {
            sliderEl.classList.remove('video-is-playing');
        }
      }
    }
    /* --- =================================== --- */
    /* ---      AKHIR TAMBAHAN BARU            --- */
    /* --- =================================== --- */

    const allPages = [
      'auth-container', 'halaman-utama', 'halaman-mapel',
      'halaman-data-sekolah', 'halaman-bobot', 'halaman-kelas', 'halaman-siswa',
      'halaman-input-ujian', 'halaman-input-nilai-detail',
      'halaman-rekap-nilai', 'halaman-semester',
      'halaman-input-rapor', 'halaman-input-rapor-detail', 'halaman-rekap-rapor',
      'halaman-nilai-ijazah', 'halaman-validasi-nilai',
      'halaman-superadmin',
      'halaman-kelola-kelulusan', 'halaman-hasil-siswa',
      'halaman-guru', 'halaman-donasi'
    ];
    
    const authSubPages = [
      'halaman-login', 
      'halaman-registrasi',
      'halaman-login-siswa',
      'halaman-login-guru' // <-- Pastikan ini ada
    ];

    allPages.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.style.display = 'none';
    });
    hideMessage('login-error');
    hideMessage('reg-message');
    hideMessage('data-sekolah-message');
    hideMessage('bobot-message');
    hideMessage('kelas-message');
    hideMessage('siswa-message');
    hideMessage('input-nilai-message');
    hideMessage('mapel-message');
    hideMessage('template-message');
    hideMessage('template-nilai-message');
    hideMessage('rekap-nilai-message');
    hideMessage('semester-message');
    hideMessage('input-rapor-message');
    hideMessage('rekap-rapor-message');
    hideMessage('nilai-ijazah-message');
    hideMessage('validasi-message');
    hideMessage('superadmin-message'); 
    hideMessage('modal-sekolah-error'); 
    hideMessage('kelulusan-message');
    hideMessage('login-siswa-error');
    
    // --- TAMBAHAN BARU ---
    hideMessage('pengaturan-guru-message');
    // --- AKHIR TAMBAHAN ---

    const targetElement = document.getElementById(idHalaman);
    if (targetElement) {
        if (authSubPages.includes(idHalaman)) {
            document.getElementById('auth-container').style.display = 'block';
            
            // Sembunyikan semua sub-halaman dulu
            authSubPages.forEach(subId => {
                const subEl = document.getElementById(subId);
                if (subEl) subEl.style.display = 'none';
            });

            // Tampilkan target
            targetElement.style.display = 'block';
            localStorage.removeItem(LAST_PAGE_KEY);

            // --- PERBAIKAN LOGIKA DI SINI ---
            // Logika ini HANYA untuk mengubah teks tombol "Login Admin"
            // JANGAN atur tab aktif di sini. activateAuthTab() akan menanganinya.
            const adminTab = document.getElementById('tab-btn-admin');
            if (adminTab) {
              if (idHalaman === 'halaman-registrasi') {
                adminTab.innerText = 'Buat Akun';
                // Hapus logika .classList.add('active') dari sini
              } else if (idHalaman === 'halaman-login') {
                adminTab.innerText = 'Login Admin';
                // Hapus logika .classList.add('active') dari sini
              }
            }
            // --- AKHIR PERBAIKAN ---

        } else {
            targetElement.style.display = 'block';
            localStorage.setItem(LAST_PAGE_KEY, idHalaman);
        }
    } else {
        console.warn("Halaman tidak ditemukan:", idHalaman, ". Menampilkan dashboard.");
        document.getElementById('halaman-utama').style.display = 'block';
        localStorage.setItem(LAST_PAGE_KEY, 'halaman-utama');
    }
  }

  function setFormDisabled(formId, isDisabled) {
    const form = document.getElementById(formId);
    if (!form) return;

    const inputs = form.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
      if (input.id !== 'data-nama-sekolah' && input.id !== 'data-npsn') { // <-- TAMBAHKAN INI
        input.disabled = isDisabled;
      }
    });

    const submitButton = form.querySelector('button[type="submit"]');
    if (submitButton) {
      submitButton.disabled = isDisabled;
    }
  }

  function showConfirmationModal(title, message, onConfirmCallback, okButtonType = 'danger') {
    const modal = document.getElementById('confirmation-modal');
    document.getElementById('confirm-modal-title').innerText = title;
    document.getElementById('confirm-modal-body').innerHTML = message;

    const okButton = document.getElementById('btn-confirm-ok');

    if (okButtonType === 'danger') {
      okButton.style.backgroundColor = 'var(--danger-color)';
    } else {
      okButton.style.backgroundColor = 'var(--primary-color)';
    }

    modal.onConfirm = onConfirmCallback;

    modal.classList.add('show');
  }

  function hideConfirmationModal() {
    const modal = document.getElementById('confirmation-modal');
    modal.classList.remove('show');
    modal.onConfirm = null;
  }

  function showInfoModal(title, message, isError, onOkCallback) {
    showToast(message, isError ? 'gagal' : 'sukses');

    if (!isError && typeof onOkCallback === 'function') {
      setTimeout(onOkCallback, 500); 
    }
  }

  function hideInfoModal() {
    const modal = document.getElementById('info-modal');
    modal.classList.remove('show');

    if (typeof modal.onOk === 'function') {
      modal.onOk();
    }
    modal.onOk = null;
  }

  let dynamicTooltipTimer = null;

  function hideDynamicTooltip() {
    if (dynamicTooltipTimer) {
      clearTimeout(dynamicTooltipTimer);
      dynamicTooltipTimer = null;
    }
    const existingTooltip = document.getElementById('dynamic-tooltip'); 
    if (existingTooltip) {
      existingTooltip.classList.remove('show');
      setTimeout(() => {
         const currentTooltip = document.getElementById('dynamic-tooltip');
         if(currentTooltip) {
           currentTooltip.remove();
         }
      }, 200);
    }
  }

  function showDynamicTooltip(targetElement, textToShow) {
    hideDynamicTooltip();

    const tooltip = document.createElement('div');
    tooltip.id = 'dynamic-tooltip';
    tooltip.className = 'dynamic-tooltip';
    tooltip.innerText = textToShow;

    tooltip.addEventListener('click', (e) => {
      e.stopPropagation(); 
      hideDynamicTooltip();
    });

    document.body.appendChild(tooltip);

    const rect = targetElement.getBoundingClientRect();
    const tooltipRect = tooltip.getBoundingClientRect();
    const scrollY = window.scrollY;
    const scrollX = window.scrollX;

    let top = rect.top + scrollY - tooltipRect.height - 8;
    let left = rect.left + scrollX + (rect.width / 2) - (tooltipRect.width / 2);

    if (left < scrollX + 8) left = scrollX + 8;
    if (left + tooltipRect.width > scrollX + window.innerWidth - 8) {
      left = scrollX + window.innerWidth - tooltipRect.width - 8;
    }
    
    if (top < scrollY + 8) {
      top = rect.bottom + scrollY + 8;
      tooltip.classList.add('bottom');
    } else {
      tooltip.classList.add('top');
    }

    tooltip.style.top = `${top}px`;
    tooltip.style.left = `${left}px`;

    requestAnimationFrame(() => {
      tooltip.classList.add('show');
    });

    dynamicTooltipTimer = setTimeout(() => {
      hideDynamicTooltip();
    }, 3000); 
  }

  function bukaHalamanTersimpan(pageId) {
    switch (pageId) {
        case 'halaman-utama':
            tampilHalaman('halaman-utama');
            break;
        case 'halaman-mapel':
            bukaHalamanMapel();
            break;
        case 'halaman-data-sekolah':
            bukaHalamanDataSekolah();
            break;
        case 'halaman-bobot':
            bukaHalamanBobot();
            break;
        case 'halaman-kelas':
            bukaHalamanKelas();
            break;
        case 'halaman-siswa':
            bukaHalamanSiswa();
            break;
        case 'halaman-input-ujian':
            bukaHalamanInputUjian();
            break;
        case 'halaman-input-nilai-detail':
            bukaHalamanInputUjian(); 
            break;
        case 'halaman-rekap-nilai':
            bukaHalamanInputUjian();
            break;
        case 'halaman-semester':
            bukaHalamanSemester();
            break;
        case 'halaman-input-rapor':
            bukaHalamanInputRapor();
            break;
        case 'halaman-input-rapor-detail':
            bukaHalamanInputRapor();
            break;
        case 'halaman-rekap-rapor':
            bukaHalamanInputRapor();
            break;
        case 'halaman-nilai-ijazah':
            bukaHalamanNilaiIjazah();
            break;
        case 'halaman-validasi-nilai':
            bukaHalamanValidasi();
            break;
        default:
            console.warn("ID halaman tersimpan tidak valid:", pageId, ". Menampilkan dashboard.");
            tampilHalaman('halaman-utama');
    }
  }

  function setMapelTipeDirty(isDirty) {
    isMapelTipeDirty = isDirty;
    updateMapelFloatingActions();
  }

  document.addEventListener('DOMContentLoaded', (event) => {

    // --- TAMBAHAN BARU: Set Tahun di Footer ---
    try {
      const yearSpan = document.getElementById('footer-year');
      if (yearSpan) {
        yearSpan.innerText = new Date().getFullYear();
      }
    } catch (e) {
      console.error("Gagal set tahun footer:", e);
    }
    // --- AKHIR TAMBAHAN ---

    document.getElementById('btn-login').addEventListener('click', jalankanLogin);

    /* --- =================================== --- */
    /* ---      MODIFIKASI: Jebak Tombol Back --- */
    /* --- =================================== --- */
    window.addEventListener('popstate', function(event) {
      // Cek apakah kita masih di dalam aplikasi (token masih ada)
      const token = localStorage.getItem('sessionToken');
      
      if (token) {
        // Pengguna menekan "back".
        
        // 1. Dorong kembali state "jebakan" kita
        //    untuk "mengunci" pengguna di aplikasi.
        history.pushState(null, "", location.href);
        
        // 2. [TAMBAHAN BARU] Atasi "halaman kosong" di mobile
        //    dengan memuat ulang UI halaman saat ini.
        const currentPageId = localStorage.getItem(LAST_PAGE_KEY);
        
        if (currentPageId && currentPageId !== 'halaman-login' && currentPageId !== 'halaman-registrasi') {
          // Panggil ulang fungsi navigasi yang sesuai untuk
          // me-render ulang halaman yang sedang dilihat.
          
          // Note: Kita tidak bisa panggil bukaHalamanTersimpan() karena
          // itu akan memanggil setLoading(true), yang tidak kita inginkan di sini.
          // Kita panggil tampilHalaman() secara langsung.
          tampilHalaman(currentPageId);
          
        } else {
          // Jika tidak ada halaman tersimpan, pastikan kita ada di dashboard
          // (atau di halaman superadmin jika itu perannya)
          if (currentUserRole === 'superadmin') {
             tampilHalaman('halaman-superadmin');
          } else if (currentUserRole === 'admin' || currentUserRole === 'guru') {
             tampilHalaman('halaman-utama');
          }
        }
      }
      // Jika token tidak ada (sudah logout), biarkan "back" berfungsi normal.
    });
    /* --- =================================== --- */
    /* ---      AKHIR MODIFIKASI            --- */
    /* --- =================================== --- */

    document.getElementById('btn-registrasi').addEventListener('click', () => {
      const btnReg = document.getElementById('btn-registrasi');

      hideMessage('reg-message');

      const namaSekolah = document.getElementById('reg-nama-sekolah').value.toUpperCase();
      const npsn = document.getElementById('reg-npsn').value.trim();
      const jenjang = document.getElementById('reg-jenjang').value;
      const email = document.getElementById('reg-email').value;
      const password = document.getElementById('reg-password').value;

      if (!namaSekolah || !npsn || !jenjang || !email || !password) {
        showMessage('reg-message', "Semua field wajib diisi.", true);
        return;
      }

      if (!validateEmailFormat()) {
        showMessage('reg-message', 'Format email yang Anda masukkan tidak valid.', true);
        return;
      }

      if (password.length < 8) {
        showMessage('reg-message', "Password minimal harus 8 karakter.", true);
        return;
      }
      if (!/[a-z]/.test(password)) {
        showMessage('reg-message', "Password harus mengandung minimal satu huruf kecil.", true);
        return;
      }
      if (!/[A-Z]/.test(password)) {
        showMessage('reg-message', "Password harus mengandung minimal satu huruf besar.", true);
        return;
      }
      if (!/\d/.test(password)) {
        showMessage('reg-message', "Password harus mengandung minimal satu angka.", true);
        return;
      }
      if (!/[^a-zA-Z0-9]/.test(password)) {
        showMessage('reg-message', "Password harus mengandung minimal satu simbol.", true);
        return;
      }

      const confirmPassword = document.getElementById('reg-password-confirm').value;
      if (password !== confirmPassword) {
        showMessage('reg-message', 'Password dan Konfirmasi Password tidak cocok.', true);

        const tooltip = document.getElementById('reg-password-confirm-tooltip');
        if (tooltip) tooltip.classList.add('show');

        return;
      }

      setButtonLoading(btnReg, 'Mendaftar...');
      google.script.run
        .withSuccessHandler(hasilRegistrasi)
        .withFailureHandler(onGagal)
        .prosesRegistrasi(namaSekolah, npsn, jenjang, email, password);
    });

    // Ganti listener untuk tombol Logout di dalam 'DOMContentLoaded'
    document.getElementById('btn-logout').addEventListener('click', () => {
      if (isFormDirty) {
        const callback = function() {
          isFormDirty = false;
          forceLogoutInstan();
          google.script.run.prosesLogout(getToken());
        };
        showConfirmationModal(
          "Perubahan Belum Disimpan",
          "Anda memiliki <strong>perubahan nilai yang belum disimpan</strong>. Jika logout, perubahan akan hilang.<br><br>Yakin tetap logout?",
          callback,
          'danger'
        );
        return;
      }
      forceLogoutInstan();
      google.script.run.prosesLogout(getToken());
    });

    // Ganti listener untuk tombol Logout Superadmin di dalam 'DOMContentLoaded'
    document.getElementById('btn-superadmin-logout').addEventListener('click', () => {
      forceLogoutInstan();
      google.script.run.prosesLogout(getToken());
    });

    document.getElementById('btn-buka-kelola-kelulusan').addEventListener('click', () => {
      handleNavigationConfirm(bukaHalamanKelolaKelulusan);
    });
    document.getElementById('btn-kembali-ke-dashboard-11').addEventListener('click', () => {
      handleNavigationConfirm(() => tampilHalaman('halaman-utama'));
    });
    document.getElementById('btn-publikasikan-hasil').addEventListener('click', konfirmasiPublishKelulusan);
    document.getElementById('btn-tarik-publikasi').addEventListener('click', konfirmasiTarikKelulusan);
    
    document.getElementById('tab-btn-admin').addEventListener('click', () => activateAuthTab('admin'));
    document.getElementById('tab-btn-siswa').addEventListener('click', () => activateAuthTab('siswa'));

    document.getElementById('tab-btn-guru').addEventListener('click', () => activateAuthTab('guru'));

    document.getElementById('login-guru-form').addEventListener('submit', (e) => {
      e.preventDefault();
      jalankanLoginGuru();
    });

    document.getElementById('toggle-login-guru-password').addEventListener('click', function() {
      const passwordInput = document.getElementById('login-guru-password');
      const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
      passwordInput.setAttribute('type', type);
      this.classList.toggle('fa-eye');
      this.classList.toggle('fa-eye-slash');
    });

    // --- Event Listeners untuk Guru ---
    document.getElementById('btn-buka-guru').addEventListener('click', () => {
        handleNavigationConfirm(bukaHalamanGuru);
    });
    document.getElementById('btn-kembali-ke-dashboard-guru').addEventListener('click', () => {
        handleNavigationConfirm(() => tampilHalaman('halaman-utama'));
    });
    document.getElementById('btn-tambah-guru-baru').addEventListener('click', () => {
        showModalGuru('add');
    });
    document.getElementById('btn-tutup-modal-guru').addEventListener('click', tutupModalGuru);
    document.getElementById('btn-batal-modal-guru').addEventListener('click', tutupModalGuru);
    document.getElementById('btn-simpan-guru').addEventListener('click', simpanGuru);

    // --- TAMBAHAN BARU: Listener untuk Cetak Kartu ---
    document.getElementById('btn-cetak-kartu-guru').addEventListener('click', konfirmasiCetakKartu);
    document.getElementById('btn-tutup-halaman-cetak').addEventListener('click', () => {
      document.getElementById('halaman-cetak-kartu').style.display = 'none';
      document.getElementById('kartu-container').innerHTML = ''; // Kosongkan kartu
    });
    document.getElementById('btn-print-kartu').addEventListener('click', () => window.print());
    // --- AKHIR TAMBAHAN ---
    
    document.getElementById('toggle-guru-password').addEventListener('click', function() {
      const passwordInput = document.getElementById('modal-guru-password');
      const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
      passwordInput.setAttribute('type', type);
      this.classList.toggle('fa-eye');
      this.classList.toggle('fa-eye-slash');
    });

    // Listener untuk tombol Edit/Hapus di tabel guru
    document.getElementById('guru-table-container').addEventListener('click', (e) => {
        const target = e.target.closest('button');
        if (!target) return;

        if (target.classList.contains('btn-edit-guru')) {
            const dataStr = target.dataset.guru;
            try {
                const guruData = JSON.parse(dataStr); // Kita akan simpan data lengkap di atribut data-guru
                showModalGuru('edit', guruData);
            } catch(e) { console.error("Gagal parse data guru", e); }
        } else if (target.classList.contains('btn-delete-guru')) {
            const email = target.dataset.email;
            const nama = target.dataset.nama;
            konfirmasiHapusGuru(email, nama);
        }
    });

    // --- TAMBAHKAN BLOK BARU INI TEPAT SETELAHNYA ---
    // Listener untuk form pengaturan guru
    document.getElementById('toggle-waktu-input').addEventListener('change', (e) => {
        const container = document.getElementById('container-tanggal-input-guru');
        if (e.target.checked) {
          container.style.display = 'block';
        } else {
          container.style.display = 'none';
        }
    });
    
    document.getElementById('btn-simpan-pengaturan-guru').addEventListener('click', simpanPengaturanGuru);
    // --- AKHIR TAMBAHAN ---

    const mapelSearchInput = document.getElementById('modal-guru-mapel-search');
    const mapelSuggestionsContainer = document.getElementById('modal-guru-mapel-suggestions');
    const mapelSelectedContainer = document.getElementById('modal-guru-mapel-selected');

    mapelSearchInput.addEventListener('input', updateMapelSuggestions);
    mapelSearchInput.addEventListener('focus', updateMapelSuggestions);

    mapelSearchInput.addEventListener('blur', () => {
      setTimeout(() => {
        document.getElementById('modal-guru-mapel-suggestions').style.display = 'none';
      }, 150);
    });

    mapelSuggestionsContainer.addEventListener('mousedown', (e) => {
      const target = e.target.closest('.mapel-suggestion-item');
      if (target) {
        e.preventDefault();
        const mapelId = target.dataset.id;
        const mapelNama = target.dataset.nama;
        addSelectedMapelTag(mapelId, mapelNama); // UI Lama
      }
    });

    mapelSelectedContainer.addEventListener('click', (e) => {
      const target = e.target.closest('.selected-mapel-tag-remove');
      if (target) {
        const mapelId = target.dataset.id;
        removeSelectedMapelTag(mapelId);
        updateMapelSuggestions();
      }
    });

    // TAMBAHKAN LISTENER BARU DI SINI
    document.getElementById('btn-sync-guru-kelas').addEventListener('click', konfirmasiSyncGuruKelas);

    // --- TAMBAHAN BARU: Listener untuk Cetak Kartu ---
    document.getElementById('btn-cetak-kartu-guru').addEventListener('click', konfirmasiCetakKartu);

    // --- ============================================= ---
    // --- ===== LISTENER BARU UNTUK UI MULTI-KELAS ==== ---
    // --- ============================================= ---
    const mapelKelasSearchInput = document.getElementById('modal-guru-mapel-kelas-search');
    const mapelKelasSuggestionsContainer = document.getElementById('modal-guru-mapel-kelas-suggestions');
    const mapelKelasListContainer = document.getElementById('modal-guru-mapel-kelas-list');

    mapelKelasSearchInput.addEventListener('input', updateMapelSuggestions);
    mapelKelasSearchInput.addEventListener('focus', updateMapelSuggestions);

    mapelKelasSearchInput.addEventListener('blur', () => {
      setTimeout(() => {
        mapelKelasSuggestionsContainer.style.display = 'none';
      }, 150);
    });

    // Saat mengklik saran di UI BARU
    mapelKelasSuggestionsContainer.addEventListener('mousedown', (e) => {
      const target = e.target.closest('.mapel-suggestion-item');
      if (target) {
        e.preventDefault();
        const mapelId = target.dataset.id;
        const mapelNama = target.dataset.nama;
        addMapelKelasRow(mapelId, mapelNama); // Panggil fungsi UI BARU
      }
    });

    // Saat mengklik tombol Hapus (X) di list UI BARU
    mapelKelasListContainer.addEventListener('click', (e) => {
      const target = e.target.closest('.mapel-kelas-remove');
      if (target) {
        const row = target.closest('.mapel-kelas-row');
        if (row) {
          row.remove();
          updateMapelSuggestions(); // Perbarui saran
        }
      }
    });
    // --- ============================================= ---
    // --- =====         AKHIR LISTENER BARU         ===== ---
    // --- ============================================= ---
    
    document.getElementById('btn-cek-kelulusan').addEventListener('click', jalankanCekKelulusan);
    document.getElementById('btn-logout-siswa').addEventListener('click', () => tampilHalaman('halaman-login-siswa'));
    document.getElementById('btn-logout-siswa-2').addEventListener('click', () => tampilHalaman('halaman-login-siswa'));
    document.getElementById('btn-logout-siswa-3').addEventListener('click', () => tampilHalaman('halaman-login-siswa'));

    // Ganti listener tombol 'Kembali ke Superadmin' di dalam 'DOMContentLoaded'
    document.getElementById('btn-kembali-ke-superadmin').addEventListener('click', () => {
      setLoading(true, 'Kembali ke Superadmin...', true);
      google.script.run
        .withSuccessHandler(onReturnToSuperadmin)
        .withFailureHandler(onGagal)
        .superadminReturn(getToken());
    });

    // --- TAMBAHKAN BLOK BARU INI ---
    document.getElementById('btn-buka-donasi').addEventListener('click', () => {
      handleNavigationConfirm(bukaHalamanDonasi);
    });
    document.getElementById('btn-kembali-ke-dashboard-12').addEventListener('click', () => {
      handleNavigationConfirm(() => tampilHalaman('halaman-utama'));
    });
    document.getElementById('btn-kirim-donasi').addEventListener('click', submitDonasiForm);
    document.getElementById('btn-batalkan-donasi').addEventListener('click', konfirmasiBatalkanDonasi);
    document.getElementById('btn-lihat-file-donasi').addEventListener('click', () => {
      if (globalDonasiDetail.fileUrl) {
        window.open(globalDonasiDetail.fileUrl, '_blank');
      } else {
        showToast("Link file tidak ditemukan.", 'gagal');
      }
    });

    // Listener dinamis untuk tombol verifikasi Superadmin
    document.getElementById('superadmin-donasi-list').addEventListener('click', (e) => {
      const target = e.target.closest('button');
      if (!target) return;
      
      const sekolahID = target.dataset.id;
      if (target.classList.contains('btn-donasi-setujui')) {
        handleDonasiVerify(sekolahID, true);
      // --- BLOK INI AKAN DIMODIFIKASI ---
      } else if (target.classList.contains('btn-donasi-tolak')) {
        // Ambil nama sekolah dari card terdekat
        const card = target.closest('.donasi-card');
        const namaSekolah = card ? card.querySelector('h4').innerText : 'Sekolah';

        const title = "Konfirmasi Penolakan Donasi";
        const message = `Masukkan alasan penolakan untuk sekolah: <strong><span id="alasan-modal-nama-sekolah"></span></strong>`;

        // Siapkan callback yang akan dieksekusi oleh modal
        const callback = function(id, alasan) {
            setLoading(true, 'Menolak donasi...');
            google.script.run
              .withSuccessHandler(onDonasiDiverifikasi)
              .withFailureHandler(onGagal)
              .verifikasiDonasi(getToken(), id, false, alasan); // Kirim isApproved = false
        };
        
        // Panggil modal kustom, bukan prompt()
        showAlasanModal(title, message, sekolahID, namaSekolah, callback);
        
      // --- AKHIR MODIFIKASI ---
      } else if (target.classList.contains('btn-donasi-lihat')) {
        window.open(target.dataset.url, '_blank');
      }
    });
    // --- AKHIR BLOK BARU ---

    document.getElementById('link-ke-registrasi').addEventListener('click', (e) => {
      e.preventDefault();
      handleNavigationConfirm(() => tampilHalaman('halaman-registrasi'));
    });

    document.getElementById('link-ke-login').addEventListener('click', (e) => {
      e.preventDefault();
      handleNavigationConfirm(() => tampilHalaman('halaman-login'));
    });
    
    document.getElementById('login-form').addEventListener('submit', (e) => {
      e.preventDefault();
      jalankanLogin(); 
    });

    document.getElementById('login-password').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.keyCode === 13) {
        e.preventDefault(); 
        jalankanLogin();    
      }
    });

    document.getElementById('login-email').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.keyCode === 13) {
        
        const passInput = document.getElementById('login-password');
        
        if (passInput.value === "") {
          e.preventDefault();
          passInput.focus();
        } else {
          e.preventDefault();
          jalankanLogin();
        }
      }
    });

    document.getElementById('reg-form').addEventListener('submit', (e) => {
      e.preventDefault();
    });

    document.getElementById('toggle-login-password').addEventListener('click', function() {
      const passwordInput = document.getElementById('login-password');
      const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
      passwordInput.setAttribute('type', type);
      this.classList.toggle('fa-eye');
      this.classList.toggle('fa-eye-slash');
    });

    document.getElementById('toggle-reg-password').addEventListener('click', function() {
      const passwordInput = document.getElementById('reg-password');
      const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
      passwordInput.setAttribute('type', type);
      this.classList.toggle('fa-eye');
      this.classList.toggle('fa-eye-slash');
    });

    // --- TAMBAHAN BARU: Event listener untuk Email ---
    const regEmailInput = document.getElementById('reg-email');
    if (regEmailInput) {
      // Tampilkan error saat pengguna pindah (blur)
      regEmailInput.addEventListener('blur', validateEmailFormat);

      // Sembunyikan error saat pengguna mulai mengetik lagi untuk memperbaiki
      regEmailInput.addEventListener('input', () => {
        const tooltip = document.getElementById('reg-email-tooltip');
        if (tooltip) {
          tooltip.classList.remove('show');
        }
      });
    }
    // --- AKHIR TAMBAHAN ---

    // --- TAMBAHAN BARU: Event listener untuk tooltip password ---
    const regPassInput = document.getElementById('reg-password');
    const regPassTooltip = document.getElementById('reg-password-tooltip');

    if (regPassInput && regPassTooltip) {
      // Panggil validasi saat pengguna mengetik
      regPassInput.addEventListener('input', validatePasswordTooltip);

      // --- TAMBAHAN BARU ---
      // Panggil juga validasi "match" jika password utama diubah
      regPassInput.addEventListener('input', validatePasswordMatch);
      // --- AKHIR TAMBAHAN ---

      // Tampilkan tooltip saat fokus
      regPassInput.addEventListener('focus', () => {
        // Validasi status saat ini
        validatePasswordTooltip();
        // Tampilkan tooltip (CSS akan menanganinya via :focus)
      });

      // Biarkan CSS menangani show/hide via :focus
    }
    // --- AKHIR TAMBAHAN ---

    // --- ============================================= ---
    // ---       TAMBAHKAN BLOK BARU INI DI SINI       ---
    // --- ============================================= ---
    // --- Listener untuk Konfirmasi Password ---
    const regPassConfirmInput = document.getElementById('reg-password-confirm');
    if (regPassConfirmInput) {
      // Validasi kecocokan setiap kali mengetik di kotak konfirmasi
      regPassConfirmInput.addEventListener('input', validatePasswordMatch);
    }

    // Toggle untuk ikon mata konfirmasi
    document.getElementById('toggle-reg-confirm-password').addEventListener('click', function() {
      const passwordInput = document.getElementById('reg-password-confirm');
      const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
      passwordInput.setAttribute('type', type);
      this.classList.toggle('fa-eye');
      this.classList.toggle('fa-eye-slash');
    });
    // --- ============================================= ---
    // ---             AKHIR BLOK TAMBAHAN             ---
    // --- ============================================= ---

    document.getElementById('btn-buka-data-sekolah').addEventListener('click', () => {
      handleNavigationConfirm(bukaHalamanDataSekolah);
    });
    document.getElementById('btn-kembali-ke-dashboard-2').addEventListener('click', () => {
      handleNavigationConfirm(() => tampilHalaman('halaman-utama'));
    });

    document.getElementById('btn-buka-bobot').addEventListener('click', () => {
      handleNavigationConfirm(bukaHalamanBobot);
    });
    document.getElementById('btn-kembali-ke-dashboard-3').addEventListener('click', () => {
      handleNavigationConfirm(() => tampilHalaman('halaman-utama'));
    });

    document.getElementById('btn-buka-kelas').addEventListener('click', () => {
      handleNavigationConfirm(bukaHalamanKelas);
    });
    document.getElementById('btn-kembali-ke-dashboard-4').addEventListener('click', () => {
      handleNavigationConfirm(() => tampilHalaman('halaman-utama'));
    });

    document.getElementById('btn-buka-siswa').addEventListener('click', () => {
      handleNavigationConfirm(bukaHalamanSiswa);
    });
    document.getElementById('btn-kembali-ke-dashboard-5').addEventListener('click', () => {
      handleNavigationConfirm(() => tampilHalaman('halaman-utama'));
    });

    document.getElementById('btn-buka-input-ujian').addEventListener('click', () => {
      handleNavigationConfirm(bukaHalamanInputUjian);
    });
    document.getElementById('btn-kembali-ke-dashboard-6').addEventListener('click', () => {
      handleNavigationConfirm(() => tampilHalaman('halaman-utama'));
    });
    document.getElementById('btn-kembali-ke-input-ujian').addEventListener('click', () => {
      handleNavigationConfirm(bukaHalamanInputUjian);
    });
    document.getElementById('btn-kembali-ke-input-ujian-2').addEventListener('click', () => {
      handleNavigationConfirm(bukaHalamanInputUjian);
    });
    document.getElementById('btn-buka-upload-nilai').addEventListener('click', bukaModalUploadNilai);

    document.getElementById('btn-buka-input-um').addEventListener('click', () => {
      handleNavigationConfirm(() => bukaHalamanInputNilaiDetail('UM'));
    });
    document.getElementById('btn-buka-input-praktek').addEventListener('click', () => {
      handleNavigationConfirm(() => bukaHalamanInputNilaiDetail('Praktek'));
    });
    document.getElementById('btn-buka-rekap-nilai').addEventListener('click', () => {
      handleNavigationConfirm(bukaHalamanRekapNilai);
    });
    document.getElementById('btn-buka-semester').addEventListener('click', () => {
      handleNavigationConfirm(bukaHalamanSemester);
    });
    document.getElementById('btn-kembali-ke-dashboard-7').addEventListener('click', () => {
      handleNavigationConfirm(() => tampilHalaman('halaman-utama'));
    });
    document.getElementById('form-semester').addEventListener('submit', (e) => {
      e.preventDefault();
      simpanSemester();
    });
    document.getElementById('btn-simpan-input-nilai').addEventListener('click', simpanInputNilai);
    
    document.getElementById('btn-bersihkan-input-nilai').addEventListener('click', konfirmasiBersihkanNilai);

    document.getElementById('halaman-input-nilai-detail').addEventListener('input', (e) => {
      if (e.target.classList.contains('input-nilai')) {
        isFormDirty = true; 
        
        let input = e.target;
        let value = input.value;
        
        let cleanedValue = value.replace(/[^\d]/g, ''); 
        
        if (cleanedValue !== value) {
          input.value = cleanedValue;
        }
        
        if (cleanedValue !== '') {
          let numValue = parseInt(cleanedValue, 10);
          
          if (numValue > 100) {
            input.value = ''; 
          } else {
            input.value = numValue.toString();
          }
        }
        
        const siswaId = e.target.dataset.siswaId;
        const table = e.target.closest('.input-nilai-table');
        
        const mapelCount = table.querySelectorAll('th.col-mapel').length;
        
        updateRowTotals(siswaId, mapelCount);
      }
    });

    document.getElementById('halaman-rekap-nilai').addEventListener('click', (e) => {
      e.stopPropagation();
      
      const targetNama = e.target.closest('.clickable-nama-siswa');
      if (targetNama) {
        const nisn = targetNama.dataset.nisn;
        showDynamicTooltip(targetNama, `NISN: ${nisn}`);
        return; 
      }

      const targetMapel = e.target.closest('.clickable-mapel-header');
      if (targetMapel) {
        const namaMapel = targetMapel.dataset.mapelNama;
        showDynamicTooltip(targetMapel, namaMapel);
      }
    });

    document.getElementById('halaman-input-nilai-detail').addEventListener('click', (e) => {
      e.stopPropagation();
      
      const targetNama = e.target.closest('.clickable-nama-siswa');
      if (targetNama) {
        const nisn = targetNama.dataset.nisn;
        showDynamicTooltip(targetNama, `NISN: ${nisn}`);
        return; 
      }

      const targetMapel = e.target.closest('.clickable-mapel-header');
      if (targetMapel) {
        const namaMapel = targetMapel.dataset.mapelNama;
        showDynamicTooltip(targetMapel, namaMapel);
      }
    });

    document.getElementById('input-nilai-filter-kelas').addEventListener('change', renderNilaiGridTable);
    document.getElementById('rekap-nilai-filter-kelas').addEventListener('change', renderRekapNilaiTable);

    document.getElementById('btn-buka-mapel').addEventListener('click', () => {
      handleNavigationConfirm(bukaHalamanMapel);
    });
     document.getElementById('btn-kembali-ke-dashboard').addEventListener('click', () => {
      handleNavigationConfirm(() => tampilHalaman('halaman-utama'));
    });

    document.getElementById('form-data-sekolah').addEventListener('submit', (e) => {
      e.preventDefault();
      simpanDataSekolah();
    });

    document.getElementById('data-jenjang-pilihan').addEventListener('change', updateTampilanNSM);

    document.getElementById('form-data-sekolah').addEventListener('input', () => {
      isFormDirty = true;
    });

    const dataSekolahFieldsToWatch = [
      'data-jenjang-pilihan', 'data-npsn', 'data-alamat', 'data-kepsek', 'data-nsm'
    ];
    
    dataSekolahFieldsToWatch.forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        const eventType = (el.tagName.toLowerCase() === 'select') ? 'change' : 'input';
        el.addEventListener(eventType, () => {
          el.classList.remove('input-error');
        });
      }
    });

    const modalSiswaFieldsToWatch = [
      'modal-siswa-nama', 
      'modal-siswa-nisn', 
      'modal-siswa-jk', 
      'modal-siswa-kelas'
    ];
    
    modalSiswaFieldsToWatch.forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        const eventType = (el.tagName.toLowerCase() === 'select') ? 'change' : 'input';
        el.addEventListener(eventType, () => {
          el.classList.remove('input-error');
        });
      }
    });

    document.getElementById('form-bobot').addEventListener('submit', (e) => {
      e.preventDefault();
      simpanBobot();
    });
    document.getElementById('form-bobot').addEventListener('input', () => {
      isFormDirty = true;
    });
    document.getElementById('bobot-rapor').addEventListener('input', () => { sinkronkanBobot('rapor'); });
    document.getElementById('bobot-ujian').addEventListener('input', () => { sinkronkanBobot('ujian'); });

    document.getElementById('form-kelas').addEventListener('submit', (e) => {
      e.preventDefault();
      simpanKelas();
    });
    
    document.getElementById('kelas-list-container').addEventListener('click', (e) => {
      const target = e.target;

      if (target.classList.contains('btn-add-kelas') || target.classList.contains('btn-remove-kelas')) {
        isFormDirty = true;
      }
      
      if (target.classList.contains('btn-add-kelas')) {
        
        const allRows = document.querySelectorAll('#kelas-list-container .kelas-input-row');
        const currentList = [];

        allRows.forEach(row => {
          const lockedSpan = row.querySelector('.kelas-input-locked');
          const unlockedInput = row.querySelector('input[type="text"]');

          if (lockedSpan) {
            currentList.push({
              nama: lockedSpan.textContent.trim(),
              isLocked: true
            });
          } else if (unlockedInput) {
            currentList.push({
              nama: unlockedInput.value,
              isLocked: false 
            });
          }
        });

        currentList.push({ nama: '', isLocked: false });
        renderKelasList(currentList);
        
        const lastInput = document.querySelector('#kelas-list-container .kelas-input-row:last-child input');
        if (lastInput) {
          lastInput.focus();
        }
      
      } 
      else if (target.classList.contains('btn-remove-kelas')) {
        
        const rowToRemove = target.parentElement;
        const allRows = Array.from(document.querySelectorAll('#kelas-list-container .kelas-input-row'));
        const indexToRemove = allRows.indexOf(rowToRemove);

        const currentList = [];
        allRows.forEach(row => {
          const lockedSpan = row.querySelector('.kelas-input-locked');
          const unlockedInput = row.querySelector('input[type="text"]');

          if (lockedSpan) {
            currentList.push({
              nama: lockedSpan.textContent.trim(),
              isLocked: true
            });
          } else if (unlockedInput) {
            currentList.push({
              nama: unlockedInput.value,
              isLocked: false
            });
          }
        });
        
        if (indexToRemove > -1) {
          currentList.splice(indexToRemove, 1);
        }
        
        renderKelasList(currentList);
      }
    });

    document.getElementById('kelas-list-container').addEventListener('input', (e) => {
      if (e.target.tagName === 'INPUT') {
        isFormDirty = true;
      }
    });

    document.getElementById('btn-recalculate-ijazah').addEventListener('click', jalankanRekalkulasiIjazah);

    document.getElementById('btn-buka-validasi-nilai').addEventListener('click', () => {
      handleNavigationConfirm(bukaHalamanValidasi);
    });
    document.getElementById('btn-kembali-ke-dashboard-10').addEventListener('click', () => {
      handleNavigationConfirm(() => tampilHalaman('halaman-utama'));
    });
    document.getElementById('validasi-filter-kelas').addEventListener('change', renderValidasiTable);

    document.getElementById('btn-import-siswa').addEventListener('click', bukaModalImportSiswa);
    document.getElementById('btn-tambah-siswa-baru').addEventListener('click', () => { showModalSiswa('add', {}); });
    document.getElementById('btn-hapus-semua-siswa').addEventListener('click', hapusSemuaSiswa);
    document.getElementById('btn-simpan-siswa').addEventListener('click', simpanSiswa);
    document.getElementById('btn-tutup-modal-siswa').addEventListener('click', tutupModalSiswa);
    document.getElementById('btn-batal-modal-siswa').addEventListener('click', tutupModalSiswa);
    document.getElementById('siswa-table-container').addEventListener('click', (e) => {
      const target = e.target.closest('button');
      if (!target) return;

      if (target.classList.contains('btn-edit-siswa')) {
          const dataset = target.dataset;
          const siswaData = { id: dataset.id, nama: dataset.nama, nisn: dataset.nisn, nisLokal: dataset.nisLokal, jk: dataset.jk, tempatLahir: dataset.tempatLahir, tglLahir: dataset.tglLahir, kelas: dataset.kelas };
          showModalSiswa('edit', siswaData);
      
      } else if (target.classList.contains('btn-delete-siswa')) {
          const id = target.getAttribute('data-id');
          const nama = target.getAttribute('data-nama');
          hapusSiswa(id, nama);
      
      } 
      else if (target.classList.contains('btn-move-up') || target.classList.contains('btn-move-down')) {
          
          const siswaID = target.dataset.id;
          const direction = target.classList.contains('btn-move-up') ? 'up' : 'down';

          const targetSiswa = globalSiswaList.find(s => s.id === siswaID);
          if (!targetSiswa) return;

          const classmates = globalSiswaList
                              .filter(s => s.kelas === targetSiswa.kelas)
                              .sort((a,b) => a.urutan - b.urutan);
          
          const targetIndexInClass = classmates.findIndex(s => s.id === siswaID);

          let swapSiswa = null;
          if (direction === 'up' && targetIndexInClass > 0) {
            swapSiswa = classmates[targetIndexInClass - 1];
          } else if (direction === 'down' && targetIndexInClass < classmates.length - 1) {
            swapSiswa = classmates[targetIndexInClass + 1];
          }

          if (swapSiswa) {
            const tempUrutan = targetSiswa.urutan;
            targetSiswa.urutan = swapSiswa.urutan;
            swapSiswa.urutan = tempUrutan;
            
            applySiswaFiltersAndRender();
            checkSiswaDirtyState();
          }
      }
    });

    document.getElementById('btn-batal-siswa-actions').addEventListener('click', cancelSiswaChanges);

    // Update listener 'Simpan Urutan Siswa'
    document.getElementById('btn-simpan-urutan-siswa').addEventListener('click', () => {
      setLoading(true, 'Menyimpan urutan...');
      hideMessage('siswa-message');
      const urutanData = globalSiswaList.map(siswa => ({ id: siswa.id, urutan: siswa.urutan }));
      google.script.run.withSuccessHandler(onSiswaUrutanSaved).withFailureHandler(onGagal).saveSiswaUrutanBatch(getToken(), urutanData);
    });

    document.getElementById('siswa-filter-kelas').addEventListener('change', applySiswaFiltersAndRender);
    document.getElementById('siswa-sort-by').addEventListener('change', applySiswaFiltersAndRender);

    // Update listener untuk tombol 'Ambil Mapel Default'
    document.getElementById('btn-ambil-default').addEventListener('click', () => {
      const title = "Ambil Mapel Default";
      const message = "Lanjutkan sinkronisasi mapel default?";
      const callback = function() { setLoading(true, 'Sinkronisasi...'); google.script.run.withSuccessHandler(onTableRefreshed).withFailureHandler(onGagal).syncDefaultMapel(getToken()); };
      showConfirmationModal(title, message, callback, 'primary');
    });

    // Update listener untuk tombol 'Hapus Semua Mapel'
    document.getElementById('btn-hapus-semua').addEventListener('click', () => {
      const title = "PERINGATAN!";
      const message = "Hapus SEMUA mata pelajaran? Tidak bisa dibatalkan.";
      const callback = function() { setLoading(true, 'Menghapus semua...'); google.script.run.withSuccessHandler(onTableRefreshed).withFailureHandler(onGagal).deleteAllMapel(getToken()); };
      showConfirmationModal(title, message, callback, 'danger');
    });

    document.getElementById('btn-tambah-mapel-baru').addEventListener('click', () => { showModalMapel('add'); });
    document.getElementById('btn-tutup-modal').addEventListener('click', tutupModalMapel);
    document.getElementById('btn-batal-modal').addEventListener('click', tutupModalMapel);
    document.getElementById('btn-simpan-mapel').addEventListener('click', simpanMapel);
    document.getElementById('btn-simpan-tipe-ujian').addEventListener('click', simpanTipeUjian);

    // Update listener 'Simpan Urutan Mapel'
    document.getElementById('btn-simpan-urutan-mapel').addEventListener('click', () => {
      setLoading(true, 'Menyimpan urutan...');
      hideMessage('mapel-message');
      const urutanData = globalMapelList.map(mapel => ({ id: mapel.id, urutan: mapel.urutan }));
      google.script.run.withSuccessHandler(onMapelUrutanSaved).withFailureHandler(onGagal).saveMapelUrutanBatch(getToken(), urutanData);
    });

    document.getElementById('btn-batal-mapel-actions').addEventListener('click', cancelMapelChanges);

    document.getElementById('mapel-table-container').addEventListener('change', (e) => {
        if (e.target.classList.contains('mapel-tipe-cek')) {
          checkMapelDirtyState();
        }
    });

    document.getElementById('mapel-table-container').addEventListener('click', (e) => {
        const target = e.target.closest('button');
        if (!target) return;
        
        if (target.classList.contains('btn-edit')) {
            const id = target.getAttribute('data-id');
            const nama = target.getAttribute('data-nama');
            showModalMapel('edit', id, nama);
        } else if (target.classList.contains('btn-delete')) {
            const id = target.getAttribute('data-id');
            hapusMapel(id);
        } else if (target.classList.contains('btn-move-up-mapel') || target.classList.contains('btn-move-down-mapel')) {
          
          const mapelID = target.dataset.id;
          const direction = target.classList.contains('btn-move-up-mapel') ? 'up' : 'down';

          const targetIndex = globalMapelList.findIndex(s => s.id === mapelID);
          if (targetIndex === -1) return;
          
          let swapIndex = -1;
          if (direction === 'up' && targetIndex > 0) {
            swapIndex = targetIndex - 1;
          } else if (direction === 'down' && targetIndex < globalMapelList.length - 1) {
            swapIndex = targetIndex + 1;
          }

          if (swapIndex > -1) {
            const targetMapel = globalMapelList[targetIndex];
            const swapMapel = globalMapelList[swapIndex];

            const tempUrutan = targetMapel.urutan;
            targetMapel.urutan = swapMapel.urutan;
            swapMapel.urutan = tempUrutan;
            
            globalMapelList.sort((a,b) => a.urutan - b.urutan);
            
            onMapelLoaded({ status: "sukses", mapel: globalMapelList, isReRender: true });
            
            checkMapelDirtyState();
          }
        }
    });

    document.getElementById('btn-confirm-cancel').addEventListener('click', hideConfirmationModal);
    document.getElementById('btn-confirm-close').addEventListener('click', hideConfirmationModal);
    document.getElementById('btn-confirm-ok').addEventListener('click', () => {
        const modal = document.getElementById('confirmation-modal');
        if (typeof modal.onConfirm === 'function') { modal.onConfirm(); }
        hideConfirmationModal();
    });
    document.getElementById('btn-info-close').addEventListener('click', hideInfoModal);
    document.getElementById('btn-info-ok').addEventListener('click', hideInfoModal);

    document.getElementById('btn-tutup-modal-import-siswa').addEventListener('click', tutupModalImportSiswa);
    document.getElementById('btn-batal-modal-import-siswa').addEventListener('click', tutupModalImportSiswa);
    document.getElementById('btn-download-template-siswa').addEventListener('click', downloadTemplateSiswa);
    document.getElementById('btn-proses-import-siswa').addEventListener('click', prosesImportFileSiswa);

    const fileUploadZone = document.getElementById('file-upload-zone');
    const fileUploadInput = document.getElementById('file-upload-siswa');
    const fileUploadText = document.getElementById('file-upload-text');
    const btnProsesImport = document.getElementById('btn-proses-import-siswa');

    fileUploadInput.addEventListener('change', (e) => {
        const fileInput = e.target;
        if (fileInput.files.length > 0) {
            const fileName = fileInput.files[0].name;
            if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                fileUploadText.innerText = `File dipilih: ${fileName}`;
                fileUploadText.classList.add('file-chosen');
                btnProsesImport.disabled = false;
                hideMessage('template-message');
            } else {
                fileUploadText.innerText = 'File harus berekstensi .xlsx atau .xls';
                fileUploadText.classList.remove('file-chosen');
                btnProsesImport.disabled = true;
            }
        } else {
            fileUploadText.innerText = 'Klik untuk memilih file atau seret & letakkan di sini.';
            fileUploadText.classList.remove('file-chosen');
            btnProsesImport.disabled = true;
        }
    });

    fileUploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        fileUploadZone.classList.add('drag-over');
    });

    fileUploadZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        fileUploadZone.classList.remove('drag-over');
    });

    fileUploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        fileUploadZone.classList.remove('drag-over');
        
        if (e.dataTransfer.files.length > 0) {
          fileUploadInput.files = e.dataTransfer.files;
          const changeEvent = new Event('change');
          fileUploadInput.dispatchEvent(changeEvent);
        }
    });

    document.getElementById('btn-import-guru').addEventListener('click', bukaModalImportGuru);
    document.getElementById('btn-tutup-modal-import-guru').addEventListener('click', tutupModalImportGuru);
    document.getElementById('btn-batal-modal-import-guru').addEventListener('click', tutupModalImportGuru);
    document.getElementById('btn-download-template-guru').addEventListener('click', downloadTemplateGuru);
    document.getElementById('btn-proses-import-guru').addEventListener('click', prosesImportFileGuru);

    const fileUploadZoneGuru = document.getElementById('file-upload-zone-guru');
    const fileUploadInputGuru = document.getElementById('file-upload-guru');
    const fileUploadTextGuru = document.getElementById('file-upload-text-guru');
    const btnProsesImportGuru = document.getElementById('btn-proses-import-guru');

    fileUploadInputGuru.addEventListener('change', (e) => {
        const fileInput = e.target;
        if (fileInput.files.length > 0) {
            const fileName = fileInput.files[0].name;
            if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                fileUploadTextGuru.innerText = `File dipilih: ${fileName}`;
                fileUploadTextGuru.classList.add('file-chosen');
                btnProsesImportGuru.disabled = false;
                hideMessage('template-guru-message');
            } else {
                fileUploadTextGuru.innerText = 'File harus berekstensi .xlsx atau .xls';
                fileUploadTextGuru.classList.remove('file-chosen');
                btnProsesImportGuru.disabled = true;
            }
        } else {
            fileUploadTextGuru.innerText = 'Klik untuk memilih file atau seret & letakkan di sini.';
            fileUploadTextGuru.classList.remove('file-chosen');
            btnProsesImportGuru.disabled = true;
        }
    });

    fileUploadZoneGuru.addEventListener('dragover', (e) => {
        e.preventDefault();
        fileUploadZoneGuru.classList.add('drag-over');
    });

    fileUploadZoneGuru.addEventListener('dragleave', (e) => {
        e.preventDefault();
        fileUploadZoneGuru.classList.remove('drag-over');
    });

    fileUploadZoneGuru.addEventListener('drop', (e) => {
        e.preventDefault();
        fileUploadZoneGuru.classList.remove('drag-over');

        if (e.dataTransfer.files.length > 0) {
          fileUploadInputGuru.files = e.dataTransfer.files;
          const changeEvent = new Event('change');
          fileUploadInputGuru.dispatchEvent(changeEvent);
        }
    });

    document.getElementById('btn-tutup-modal-upload-nilai').addEventListener('click', tutupModalUploadNilai);
    document.getElementById('btn-batal-modal-upload-nilai').addEventListener('click', tutupModalUploadNilai);
    document.getElementById('btn-download-template-nilai').addEventListener('click', downloadTemplateNilai);
    document.getElementById('btn-proses-upload-nilai').addEventListener('click', prosesUploadFileNilai);

    const fileUploadZoneNilai = document.getElementById('file-upload-zone-nilai');
    const fileUploadInputNilai = document.getElementById('file-upload-nilai');
    const fileUploadTextNilai = document.getElementById('file-upload-text-nilai');
    const btnProsesUploadNilai = document.getElementById('btn-proses-upload-nilai');

    fileUploadInputNilai.addEventListener('change', (e) => {
        const fileInput = e.target;
        if (fileInput.files.length > 0) {
            const fileName = fileInput.files[0].name;
            if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                fileUploadTextNilai.innerText = `File dipilih: ${fileName}`;
                fileUploadTextNilai.classList.add('file-chosen');
                btnProsesUploadNilai.disabled = false;
                hideMessage('template-nilai-message');
            } else {
                fileUploadTextNilai.innerText = 'File harus berekstensi .xlsx atau .xls';
                fileUploadTextNilai.classList.remove('file-chosen');
                btnProsesUploadNilai.disabled = true;
            }
        } else {
            fileUploadTextNilai.innerText = 'Klik untuk memilih file atau seret & letakkan di sini.';
            fileUploadTextNilai.classList.remove('file-chosen');
            btnProsesUploadNilai.disabled = true;
        }
    });

    fileUploadZoneNilai.addEventListener('dragover', (e) => {
        e.preventDefault();
        fileUploadZoneNilai.classList.add('drag-over');
    });

    fileUploadZoneNilai.addEventListener('dragleave', (e) => {
        e.preventDefault();
        fileUploadZoneNilai.classList.remove('drag-over');
    });

    fileUploadZoneNilai.addEventListener('drop', (e) => {
        e.preventDefault();
        fileUploadZoneNilai.classList.remove('drag-over');
        
        if (e.dataTransfer.files.length > 0) {
          fileUploadInputNilai.files = e.dataTransfer.files;
          const changeEvent = new Event('change');
          fileUploadInputNilai.dispatchEvent(changeEvent);
        }
    });

    window.addEventListener('click', (e) => {
      if (!e.target.closest('#dynamic-tooltip') && !e.target.closest('.clickable-nama-siswa') && !e.target.closest('.clickable-mapel-header')) {
        hideDynamicTooltip();
      }
    });

    window.addEventListener('scroll', hideDynamicTooltip, true);

    document.querySelector('#halaman-input-rapor-detail .tab-bar').addEventListener('click', (e) => {
      if (e.target.classList.contains('tab-link')) {
        const tabName = e.target.dataset.tab;
        activateRaporTab(tabName);
      }
    });

    document.getElementById('btn-buka-upload-rapor').addEventListener('click', bukaModalUploadNilaiRapor);
    document.getElementById('btn-tutup-modal-upload-nilai-rapor').addEventListener('click', tutupModalUploadNilaiRapor);
    document.getElementById('btn-batal-modal-upload-nilai-rapor').addEventListener('click', tutupModalUploadNilaiRapor);
    document.getElementById('btn-download-template-rapor').addEventListener('click', downloadTemplateNilaiRapor);
    document.getElementById('btn-proses-upload-nilai-rapor').addEventListener('click', prosesUploadFileNilaiRapor);

    const fileUploadZoneRapor = document.getElementById('file-upload-zone-rapor');
    const fileUploadInputRapor = document.getElementById('file-upload-rapor');
    const fileUploadTextRapor = document.getElementById('file-upload-text-rapor');
    const btnProsesUploadRapor = document.getElementById('btn-proses-upload-nilai-rapor');

    fileUploadInputRapor.addEventListener('change', (e) => {
        const fileInput = e.target;
        if (fileInput.files.length > 0) {
            const fileName = fileInput.files[0].name;
            if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                fileUploadTextRapor.innerText = `File dipilih: ${fileName}`;
                fileUploadTextRapor.classList.add('file-chosen');
                btnProsesUploadRapor.disabled = false;
                hideMessage('template-rapor-message');
            } else {
                fileUploadTextRapor.innerText = 'File harus berekstensi .xlsx atau .xls';
                fileUploadTextRapor.classList.remove('file-chosen');
                btnProsesUploadRapor.disabled = true;
            }
        } else {
            fileUploadTextRapor.innerText = 'Klik untuk memilih file atau seret & letakkan di sini.';
            fileUploadTextRapor.classList.remove('file-chosen');
            btnProsesUploadRapor.disabled = true;
        }
    });

    fileUploadZoneRapor.addEventListener('dragover', (e) => {
        e.preventDefault();
        fileUploadZoneRapor.classList.add('drag-over');
    });

    fileUploadZoneRapor.addEventListener('dragleave', (e) => {
        e.preventDefault();
        fileUploadZoneRapor.classList.remove('drag-over');
    });

    fileUploadZoneRapor.addEventListener('drop', (e) => {
        e.preventDefault();
        fileUploadZoneRapor.classList.remove('drag-over');
        
        if (e.dataTransfer.files.length > 0) {
          fileUploadInputRapor.files = e.dataTransfer.files;
          const changeEvent = new Event('change');
          fileUploadInputRapor.dispatchEvent(changeEvent);
        }
    });

    document.getElementById('btn-buka-input-rapor').addEventListener('click', () => {
      handleNavigationConfirm(bukaHalamanInputRapor);
    });
    document.getElementById('btn-kembali-ke-dashboard-8').addEventListener('click', () => {
      handleNavigationConfirm(() => tampilHalaman('halaman-utama'));
    });
    document.getElementById('btn-buka-rekap-rapor').addEventListener('click', () => {
      handleNavigationConfirm(bukaHalamanRekapRapor);
    });
    document.getElementById('btn-kembali-ke-input-rapor').addEventListener('click', () => {
      handleNavigationConfirm(bukaHalamanInputRapor);
    });
    document.getElementById('btn-kembali-ke-input-rapor-2').addEventListener('click', () => {
      handleNavigationConfirm(bukaHalamanInputRapor);
    });

    document.getElementById('btn-simpan-input-rapor-p').addEventListener('click', () => simpanInputNilaiRapor('P'));
    document.getElementById('btn-bersihkan-input-rapor-p').addEventListener('click', () => konfirmasiBersihkanNilaiRapor('P'));
    
    document.getElementById('btn-simpan-input-rapor-k').addEventListener('click', () => simpanInputNilaiRapor('K'));
    document.getElementById('btn-bersihkan-input-rapor-k').addEventListener('click', () => konfirmasiBersihkanNilaiRapor('K'));

    document.getElementById('halaman-input-rapor-detail').addEventListener('input', (e) => {
      if (e.target.classList.contains('input-nilai')) {
        isFormDirty = true; 

        let input = e.target;
        let value = input.value;
        let cleanedValue = value.replace(/[^\d]/g, ''); 
        if (cleanedValue !== value) {
          input.value = cleanedValue;
        }
        if (cleanedValue !== '') {
          let numValue = parseInt(cleanedValue, 10);
          if (numValue > 100) {
            input.value = ''; 
          } else {
            input.value = numValue.toString();
          }
        }
        
        const tableContainer = e.target.closest('.input-nilai-table-container');
        if (!tableContainer) return;

        const tipeNilai = (tableContainer.id === 'input-rapor-keterampilan-table-container') ? 'K' : 'P';
        const data = (tipeNilai === 'P') ? globalRaporData.P : globalRaporData.K;
        const mapelCount = data.mapelList.length;
        const siswaId = e.target.dataset.siswaId;

        updateRowTotalsRapor(siswaId, mapelCount, tipeNilai);
      }
    });

    document.getElementById('halaman-input-rapor-detail').addEventListener('click', (e) => {
      e.stopPropagation();
      const targetNama = e.target.closest('.clickable-nama-siswa');
      if (targetNama) {
        const nisn = targetNama.dataset.nisn;
        showDynamicTooltip(targetNama, `NISN: ${nisn}`);
        return; 
      }
      const targetMapel = e.target.closest('.clickable-mapel-header');
      if (targetMapel) {
        const namaMapel = targetMapel.dataset.mapelNama;
        showDynamicTooltip(targetMapel, namaMapel);
      }
    });

    document.getElementById('halaman-rekap-rapor').addEventListener('click', (e) => {
      e.stopPropagation();
      const targetNama = e.target.closest('.clickable-nama-siswa');
      if (targetNama) {
        const nisn = targetNama.dataset.nisn;
        showDynamicTooltip(targetNama, `NISN: ${nisn}`);
        return; 
      }
      const targetMapel = e.target.closest('.clickable-mapel-header');
      if (targetMapel) {
        const namaMapel = targetMapel.dataset.mapelNama;
        showDynamicTooltip(targetMapel, namaMapel);
      }
    });

    document.getElementById('input-rapor-filter-kelas').addEventListener('change', () => {
      renderNilaiRaporGridTable('P');
      renderNilaiRaporGridTable('K');
      renderRekapRaporSemesterTable();
    });
    document.getElementById('rekap-rapor-filter-kelas').addEventListener('change', renderRekapRaporTable);

    document.getElementById('btn-buka-nilai-ijazah').addEventListener('click', () => {
      handleNavigationConfirm(bukaHalamanNilaiIjazah);
    });
    document.getElementById('btn-kembali-ke-dashboard-9').addEventListener('click', () => {
      handleNavigationConfirm(() => tampilHalaman('halaman-utama'));
    });
    document.getElementById('ijazah-tab-bar').addEventListener('click', (e) => {
      if (e.target.classList.contains('tab-link')) {
        const tabName = e.target.dataset.tab;
        activateIjazahTab(tabName);
      }
    });
    document.getElementById('ijazah-filter-kelas').addEventListener('change', () => {
      renderNilaiIjazahTabel('ujian');
      renderNilaiIjazahTabel('rapor');
      renderNilaiIjazahTabel('ijazah');
    });

    document.getElementById('btn-toggle-ujian-view').addEventListener('click', toggleUjianView);
    document.getElementById('btn-toggle-rapor-view').addEventListener('click', toggleRaporView);

    document.getElementById('halaman-nilai-ijazah').addEventListener('click', (e) => {
      const exportButton = e.target.closest('.btn-export-icon');
      if (exportButton) {
        e.preventDefault();
        const tipeFile = exportButton.dataset.tipe;
        const tipeData = exportButton.dataset.tab;
        handleExportClick(exportButton, tipeFile, tipeData);
        return; 
      }
      
      e.stopPropagation();
      const targetNama = e.target.closest('.clickable-nama-siswa');
      if (targetNama) {
        const nisn = targetNama.dataset.nisn;
        showDynamicTooltip(targetNama, `NISN: ${nisn}`);
        return; 
      }
      const targetMapel = e.target.closest('.clickable-mapel-header');
      if (targetMapel) {
        const namaMapel = targetMapel.dataset.mapelNama;
        showDynamicTooltip(targetMapel, namaMapel);
      }
    });

    document.getElementById('halaman-validasi-nilai').addEventListener('click', (e) => {
      e.stopPropagation();
      
      // Cek klik pada nama siswa
      const targetNama = e.target.closest('.clickable-nama-siswa');
      if (targetNama) {
        const nisn = targetNama.dataset.nisn;
        showDynamicTooltip(targetNama, `NISN: ${nisn}`);
        return; 
      }

      // Cek klik pada header mapel
      const targetMapel = e.target.closest('.clickable-mapel-header');
      if (targetMapel) {
        const namaMapel = targetMapel.dataset.mapelNama;
        showDynamicTooltip(targetMapel, namaMapel);
      }
    });

    // Update listener tombol 'Update Semua Data'
    document.getElementById('btn-update-semua-data').addEventListener('click', () => {
      const title = "Konfirmasi Update Data";
      const message = "Bersihkan cache dan muat ulang data dari server?";
      const callback = function() {
        setLoading(true, 'Membersihkan cache...');
        google.script.run.withSuccessHandler(onUpdateSemuaDataSukses).withFailureHandler(onGagal).clearAllCaches(getToken());
      };
      showConfirmationModal(title, message, callback, 'primary');
    });

    // --- TAMBAHAN BARU: Listener untuk Halaman Superadmin ---
    document.getElementById('btn-tambah-sekolah-baru').addEventListener('click', () => {
      showModalSekolah('add', {});
    });
    
    document.getElementById('btn-tutup-modal-sekolah').addEventListener('click', tutupModalSekolah);
    document.getElementById('btn-batal-modal-sekolah').addEventListener('click', tutupModalSekolah);
    document.getElementById('btn-simpan-sekolah').addEventListener('click', simpanSekolah);

    document.getElementById('superadmin-sekolah-list').addEventListener('click', (e) => {
      const target = e.target.closest('button');
      if (!target) return;

      if (target.classList.contains('btn-edit-sekolah')) {
          const dataset = target.dataset;
          const sekolahData = { 
            id: dataset.id, 
            nama: dataset.nama, 
            jenjang: dataset.jenjang, 
            email: dataset.email,
            spreadsheetId: dataset.ssid
          };
          showModalSekolah('edit', sekolahData);
      
      } else if (target.classList.contains('btn-delete-sekolah')) {
          const id = target.dataset.id;
          const nama = target.dataset.nama;
          const ssid = target.dataset.ssid;
          konfirmasiHapusSekolah(id, nama, ssid);
      
      // --- TAMBAHAN BARU DI SINI ---
      } else if (target.classList.contains('btn-impersonate-sekolah')) {
          const id = target.dataset.id;
          const nama = target.dataset.nama;
          konfirmasiImpersonate(id, nama);
      // --- AKHIR TAMBAHAN ---
      // --- TAMBAHKAN BLOK ELSE IF BARU DI BAWAH INI ---
      } else if (target.classList.contains('btn-batalkan-premium')) {
          const id = target.dataset.id;
          const nama = target.dataset.nama;
          konfirmasiBatalkanPremium(id, nama);
      } 
      // --- AKHIR BLOK BARU ---
    });
    // --- AKHIR TAMBAHAN ---

    // --- TAMBAHKAN LISTENER MODAL ALASAN BARU ---
    document.getElementById('btn-alasan-close').addEventListener('click', tutupAlasanModal);
    document.getElementById('btn-alasan-cancel').addEventListener('click', tutupAlasanModal);
    document.getElementById('btn-alasan-ok').addEventListener('click', handleAlasanConfirm);
    // --- AKHIR TAMBAHAN ---

    // --- TAMBAHKAN LISTENER UNTUK FILE UPLOAD DONASI ---
    const fileUploadZoneDonasi = document.getElementById('file-upload-zone-donasi');
    const fileUploadInputDonasi = document.getElementById('donasi-file');
    const fileUploadTextDonasi = document.getElementById('file-upload-text-donasi');

    if (fileUploadInputDonasi) {
      fileUploadInputDonasi.addEventListener('change', (e) => {
          const fileInput = e.target;
          if (fileInput.files.length > 0) {
              const fileName = fileInput.files[0].name;
              fileUploadTextDonasi.innerText = `File dipilih: ${fileName}`;
              fileUploadTextDonasi.classList.add('file-chosen');
              hideMessage('donasi-message');
          } else {
              fileUploadTextDonasi.innerText = 'Klik untuk memilih file...';
              fileUploadTextDonasi.classList.remove('file-chosen');
          }
      });
    }

    if (fileUploadZoneDonasi) {
      fileUploadZoneDonasi.addEventListener('dragover', (e) => {
          e.preventDefault();
          fileUploadZoneDonasi.classList.add('drag-over');
      });

      fileUploadZoneDonasi.addEventListener('dragleave', (e) => {
          e.preventDefault();
          fileUploadZoneDonasi.classList.remove('drag-over');
      });

      fileUploadZoneDonasi.addEventListener('drop', (e) => {
          e.preventDefault();
          fileUploadZoneDonasi.classList.remove('drag-over');
          
          if (e.dataTransfer.files.length > 0) {
            fileUploadInputDonasi.files = e.dataTransfer.files;
            const changeEvent = new Event('change');
            fileUploadInputDonasi.dispatchEvent(changeEvent);
          }
      });
    }
    // --- AKHIR LISTENER FILE UPLOAD DONASI ---

    document.addEventListener('keydown', handleKeyDown);
    
    document.getElementById('halaman-input-nilai-detail')
      .addEventListener('paste', handlePasteEvent);
      
    document.getElementById('halaman-input-rapor-detail')
      .addEventListener('paste', handlePasteEvent);

    window.addEventListener('mousemove', resetInactivityTimer);
    window.addEventListener('mousedown', resetInactivityTimer);
    window.addEventListener('keypress', resetInactivityTimer);
    window.addEventListener('touchstart', resetInactivityTimer);
    window.addEventListener('scroll', resetInactivityTimer);

    // --- LOGIKA PEMUATAN AWAL (ROUTING) YANG SUDAH DIPERBAIKI ---
    const token = localStorage.getItem('sessionToken');

    if (token) {
      // Tampilkan loading screen penuh. Biarkan onTokenCheck yang memutuskan halaman.
      setLoading(true, 'Memverifikasi sesi...', true, true); 
      
      google.script.run
        .withSuccessHandler(onTokenCheck) 
        .withFailureHandler(onTokenCheckFailed)
        .checkToken(token);
        
    } else {
      // TIDAK ADA TOKEN (Pengguna belum login)
            
      // Periksa apakah URL memiliki hash
      if (window.location.hash === '#login-guru') {
        // Jika ya, langsung tampilkan halaman login guru dan aktifkan tab-nya
        tampilHalaman('halaman-login-guru');
        activateAuthTab('guru');
      } else if (window.location.hash === '#login-siswa') {
        // Bonus: tambahkan juga untuk siswa jika diperlukan
        tampilHalaman('halaman-login-siswa');
        activateAuthTab('siswa');
      } else {
        // Jika tidak ada hash, tampilkan halaman login admin default
        tampilHalaman('halaman-login');
        activateAuthTab('admin'); // Aktifkan tab admin secara eksplisit
      }
    }
    // --- AKHIR LOGIKA PEMUATAN AWAL ---
  });

  function activateRaporTab(tabName) {
    const page = document.getElementById('halaman-input-rapor-detail');
    
    const tabClasses = ['tab-pengetahuan-active', 'tab-keterampilan-active', 'tab-rekap-active'];
    let newActiveClass = '';

    page.querySelectorAll('.tab-link').forEach(link => {
      link.classList.remove('active');
    });

    page.querySelectorAll('.tab-content').forEach(content => {
      content.classList.remove('active');
    });

    page.querySelector(`.tab-link[data-tab="${tabName}"]`).classList.add('active');
    page.querySelector(`#tab-${tabName}-content`).classList.add('active');
    
    if (tabName === 'pengetahuan') {
      newActiveClass = 'tab-pengetahuan-active';
    } else if (tabName === 'keterampilan') {
      newActiveClass = 'tab-keterampilan-active';
    } else if (tabName === 'rekap') {
      newActiveClass = 'tab-rekap-active';
    }
    
    page.classList.remove(...tabClasses);
    if (newActiveClass) {
      page.classList.add(newActiveClass);
    }

    if (tabName === 'pengetahuan' || tabName === 'keterampilan') {
      autoScrollToBottom();
    }
  }

  function onTokenCheck(response) {
    setLoading(false);
    resetInactivityTimer();

    // --- TAMBAHAN BARU: Mendorong state "jebakan" ---
    // Ini menambahkan entri history baru sehingga "back"
    // tidak langsung keluar dari aplikasi.
    history.pushState(null, "", location.href);
    // --- AKHIR TAMBAHAN BARU ---

    const lastPageId = localStorage.getItem(LAST_PAGE_KEY);

    globalAppUrl = response.appUrl || '';
    updateRecalculateButtonState();

    isImpersonatingCache = false;
    document.getElementById('btn-kembali-ke-superadmin').style.display = 'none';

    currentUserRole = response.role;

    if (response.role === 'superadmin') {
      document.getElementById('salam-superadmin').innerText = `Selamat Datang, ${response.nama || response.namaSekolah}`;

      bukaHalamanSuperadmin();

    } else if (response.role === 'admin') {
      document.getElementById('salam-sekolah').innerText = `Selamat Datang, Admin ${response.namaSekolah}`;
      jenjangBaseCache = response.jenjang;
      jenjangPilihanCache = response.jenjangPilihan;

      if (response.isImpersonating) {
        isImpersonatingCache = true;
        document.getElementById('btn-kembali-ke-superadmin').style.display = 'inline-flex';
      }

      // --- TAMBAHKAN 2 BARIS INI ---
      globalDonasiStatus = response.donasiStatus || "NONE";
      updatePremiumFeatures(globalDonasiStatus);
      // --- AKHIR TAMBAHAN ---

      if (lastPageId && lastPageId !== 'halaman-superadmin' && lastPageId !== 'halaman-login' && lastPageId !== 'halaman-login-guru') {
        bukaHalamanTersimpan(lastPageId);
      } else {
        tampilHalaman('halaman-utama');
      }

    } else if (response.role === 'guru') {
      guruHasPraktek = response.hasUjianPraktek;
      guruHasMadrasah = response.hasUjianMadrasah;
      jenjangPilihanCache = response.jenjangPilihan;
      tampilkanDashboardGuru(response.namaGuru || 'Guru', response.namaSekolah);

      if (lastPageId === 'halaman-input-ujian' || lastPageId === 'halaman-input-nilai-detail') {
          bukaHalamanTersimpan(lastPageId);
      }

    } else {
      onTokenCheckFailed({ message: 'Peran pengguna tidak dikenal.' });
    }
  }

  function hasilLogin(response) {
    setLoading(false);
    resetButtonLoading(document.getElementById('btn-login'));
    resetButtonLoading(document.getElementById('btn-login-guru'));

    if (response.status === "sukses") {
      localStorage.setItem('sessionToken', response.token);
      resetInactivityTimer();
      
      // --- TAMBAHAN BARU: Mendorong state "jebakan" ---
      history.pushState(null, "", location.href);
      // --- AKHIR TAMBAHAN BARU ---

      globalAppUrl = response.appUrl || '';

      isImpersonatingCache = false;
      document.getElementById('btn-kembali-ke-superadmin').style.display = 'none';

      currentUserRole = response.role;

      if (response.role === 'superadmin') {
        document.getElementById('salam-superadmin').innerText = `Selamat Datang, ${response.nama}`;
        tampilHalaman('halaman-superadmin');
        bukaHalamanSuperadmin();

      } else if (response.role === 'admin') {
        jenjangBaseCache = response.jenjang;
        jenjangPilihanCache = response.jenjangPilihan;
        document.getElementById('salam-sekolah').innerText = `Selamat Datang, Admin ${response.namaSekolah}`;

        if (response.isImpersonating) {
          isImpersonatingCache = true;
          document.getElementById('btn-kembali-ke-superadmin').style.display = 'inline-flex';
        }

        // --- TAMBAHKAN 2 BARIS INI ---
        globalDonasiStatus = response.donasiStatus || "NONE";
        updatePremiumFeatures(globalDonasiStatus);
        // --- AKHIR TAMBAHAN ---

        tampilHalaman('halaman-utama');

      } else if (response.role === 'guru') {
        guruHasPraktek = response.hasUjianPraktek;
        guruHasMadrasah = response.hasUjianMadrasah;
        jenjangPilihanCache = response.jenjangPilihan;
        tampilkanDashboardGuru(response.namaGuru, response.namaSekolah);
      }

    } else {
      if (document.getElementById('halaman-login-guru').style.display !== 'none') {
          showMessage('login-guru-error', response.message, true);
      } else {
          showMessage('login-error', response.message, true);

          const loginPage = document.getElementById('halaman-login');
          if (loginPage.style.display !== 'none') {
            loginPage.classList.remove('login-fail-shake');
            void loginPage.offsetWidth; 
            loginPage.classList.add('login-fail-shake');
            setTimeout(() => {
              loginPage.classList.remove('login-fail-shake');
            }, 600);
          }
      }
    }
  }

  function hasilRegistrasi(response) {
      resetButtonLoading(document.getElementById('btn-registrasi'));
      
      if (response.status === "pending") {
        // Tampilkan pesan sukses (bukan error)
        showMessage('reg-message', response.message, false); 

        // Kosongkan form
        document.getElementById('reg-nama-sekolah').value = "";
        document.getElementById('reg-jenjang').value = "";
        document.getElementById('reg-email').value = "";
        document.getElementById('reg-password').value = "";
        document.getElementById('reg-password-confirm').value = "";
        
        // Reset validasi tooltip email
        validateEmailFormat(); 
        
        // Reset validasi tooltip password
        validatePasswordTooltip();
        
        // Reset validasi match
        validatePasswordMatch(); 

        // Pastikan tooltip password tidak lagi 'all-valid'
        const tooltipContainer = document.getElementById('reg-password-tooltip');
        if(tooltipContainer) {
          tooltipContainer.classList.remove('all-valid');
        }

      } else if (response.status === "gagal") {
        // Ini adalah GAGAL (email sudah ada, dll)
        showMessage('reg-message', response.message, true);
      
      } else {
        // Fallback untuk status 'sukses' (seharusnya tidak terjadi lagi dari registrasi)
        showMessage('reg-message', "Registrasi berhasil! (Status tidak dikenal)", false);
        // Pindahkan ke login jika status 'sukses' lama masih ada
        setTimeout(() => {
          tampilHalaman('halaman-login');
        }, 2500);
      }
    }

  function onLogout(response) {
    // Logika utama sekarang ada di forceLogoutInstan()
    // google.script.run.prosesLogout() hanya membersihkan sisi server.
  }

  function onGagal(error) {
    setLoading(false); 

    const pageNilaiUjian = document.getElementById('halaman-input-nilai-detail');
    const pageNilaiRapor = document.getElementById('halaman-input-rapor-detail');

    if (pageNilaiUjian && pageNilaiUjian.classList.contains('loading-in-progress')) {
      setTableInputLock('halaman-input-nilai-detail', false);
    }
    if (pageNilaiRapor && pageNilaiRapor.classList.contains('loading-in-progress')) {
      setTableInputLock('halaman-input-rapor-detail', false);
    }
    
    const btnLogin = document.getElementById('btn-login');
    if (btnLogin && btnLogin.classList.contains('loading')) {
      resetButtonLoading(btnLogin);
    }
    const btnReg = document.getElementById('btn-registrasi');
    if (btnReg && btnReg.classList.contains('loading')) {
      resetButtonLoading(btnReg);
    }
    // --- TAMBAHAN BARU ---
    const btnSimpanPengaturanGuru = document.getElementById('btn-simpan-pengaturan-guru');
    if (btnSimpanPengaturanGuru && btnSimpanPengaturanGuru.classList.contains('loading')) {
      resetButtonLoading(btnSimpanPengaturanGuru);
    }
    // --- AKHIR TAMBAHAN ---
    
    const errorMsg = error.message;

    if (errorMsg.includes("Sesi") || errorMsg.includes("Token")) {
      localStorage.removeItem('sessionToken');
      localStorage.removeItem(LAST_PAGE_KEY);
      tampilHalaman('halaman-login');
      showMessage('login-error', errorMsg, true);
    }
    else if (document.getElementById('halaman-login').style.display !== 'none') {
      showMessage('login-error', 'Error: ' + errorMsg, true);
    } else if (document.getElementById('halaman-registrasi').style.display !== 'none') {
      showMessage('reg-message', 'Error: ' + errorMsg, true);
    
    } else if (document.getElementById('mapel-modal').classList.contains('show')) {
      showMessage('modal-mapel-error', 'Error: ' + errorMsg, true);
    } else if (document.getElementById('siswa-modal').classList.contains('show')) {
      showMessage('modal-siswa-error', 'Error: ' + errorMsg, true);
    }
    else if (document.getElementById('import-siswa-modal').classList.contains('show')) {
      showMessage('template-message', 'Error: ' + errorMsg, true);
    }
    else if (document.getElementById('upload-nilai-modal').classList.contains('show')) {
      showMessage('template-nilai-message', 'Error: ' + errorMsg, true);
    }
    else if (document.getElementById('halaman-data-sekolah').style.display !== 'none') {
      setFormDisabled('form-data-sekolah', false);
      showMessage('data-sekolah-message', 'Error: ' + errorMsg, true);
    }
    else if (document.getElementById('halaman-bobot').style.display !== 'none') {
      setFormDisabled('form-bobot', false);
      showMessage('bobot-message', 'Error: ' + errorMsg, true);
    }
    else if (document.getElementById('halaman-kelas').style.display !== 'none') {
      setFormDisabled('form-kelas', false);
      showMessage('kelas-message', 'Error: ' + errorMsg, true);
    }
    else if (document.getElementById('halaman-siswa').style.display !== 'none') {
      document.getElementById('btn-tambah-siswa-baru').disabled = false;
      document.getElementById('btn-import-siswa').disabled = false;
      document.getElementById('btn-hapus-semua-siswa').disabled = false;
      document.getElementById('siswa-filter-kelas').disabled = false;
      document.getElementById('siswa-sort-by').disabled = false;
      showMessage('siswa-message', 'Error: ' + errorMsg, true);
    }
    else if (document.getElementById('halaman-mapel').style.display !== 'none') {
      document.getElementById('btn-tambah-mapel-baru').disabled = false;
      document.getElementById('btn-ambil-default').disabled = false;
      document.getElementById('btn-hapus-semua').disabled = false;
      showMessage('mapel-message', 'Error: ' + errorMsg, true);
    }
    else if (document.getElementById('halaman-input-nilai-detail').style.display !== 'none') {
      showMessage('input-nilai-message', 'Error: ' + errorMsg, true);
    }
    else if (document.getElementById('halaman-rekap-nilai').style.display !== 'none') {
      showMessage('rekap-nilai-message', 'Error: ' + errorMsg, true);
    }
    else if (document.getElementById('halaman-input-rapor-detail').style.display !== 'none') {
      showMessage('input-rapor-message', 'Error: ' + errorMsg, true);
    }
    else if (document.getElementById('halaman-rekap-rapor').style.display !== 'none') {
      showMessage('rekap-rapor-message', 'Error: ' + errorMsg, true);
    }
    else if (document.getElementById('halaman-semester').style.display !== 'none') {
      setFormDisabled('form-semester', false);
      showMessage('semester-message', 'Error: ' + errorMsg, true);
    }
    else if (document.getElementById('halaman-validasi-nilai').style.display !== 'none') {
      showMessage('validasi-message', 'Error: ' + errorMsg, true);
    }
    else if (document.getElementById('halaman-superadmin').style.display !== 'none') {
      showMessage('superadmin-message', 'Error: ' + errorMsg, true);
    }
    // --- BLOK 'ELSE IF' BERIKUT INI TELAH DIMODIFIKASI ---
    else if (document.getElementById('halaman-guru').style.display !== 'none') {
      // Cek apakah errornya di modal atau di halaman utama
      if (document.getElementById('guru-modal').classList.contains('show')) {
         showMessage('modal-guru-error', 'Error: ' + errorMsg, true);
      } else {
         // Tampilkan error di halaman guru (bisa di tabel atau di form pengaturan)
         showMessage('pengaturan-guru-message', 'Error: ' + errorMsg, true);
         
         // Aktifkan kembali tombol jika gagal memuat
         document.getElementById('btn-tambah-guru-baru').disabled = false;
         document.getElementById('btn-import-guru').disabled = false;
         document.getElementById('btn-simpan-pengaturan-guru').disabled = false;

         // Tampilkan error di dalam container tabel jika tabel gagal muat
         const tableContainer = document.getElementById('guru-table-container');
         if (tableContainer.innerHTML.includes("Memuat data guru...")) {
           tableContainer.innerHTML = `<p class="message error" style="display:block;">Gagal memuat: ${errorMsg}</p>`;
         }
      }
    }
    // --- AKHIR MODIFIKASI ---
    else if (document.getElementById('superadmin-sekolah-modal').classList.contains('show')) {
      showMessage('modal-sekolah-error', 'Error: ' + errorMsg, true);
    }
    else {
      showInfoModal('Terjadi Error', errorMsg, true);
    }
  }

  function bukaHalamanMapel() {
    tampilHalaman('halaman-mapel');
    setLoading(true, 'Memuat data mapel...', false, false);
    isFormDirty = false;
    setMapelTipeDirty(false);
    setMapelOrderDirty(false);
    document.getElementById('mapel-table-container').innerHTML = "<p>Memuat data mapel...</p>";
    document.getElementById('btn-tambah-mapel-baru').disabled = true;
    document.getElementById('btn-ambil-default').disabled = true;
    document.getElementById('btn-hapus-semua').disabled = true;
    google.script.run
      .withSuccessHandler(onMapelLoaded)
      .withFailureHandler(onGagal)
      .getMapel(getToken());
  }

  function onMapelLoaded(response) {
      setLoading(false);

      document.getElementById('btn-tambah-mapel-baru').disabled = false;
      document.getElementById('btn-ambil-default').disabled = false;
      document.getElementById('btn-hapus-semua').disabled = false;

      const container = document.getElementById('mapel-table-container');

      if (response.status === "sukses") {
        
        if (!response.isReRender) {
          response.mapel.forEach(m => {
            m.originalUrutan = m.urutan;
            m.originalIsUS = m.isUS || false;
            m.originalIsUP = m.isUP || false;
          });
        }
        globalMapelList = response.mapel;

        const jenjangPilihan = jenjangPilihanCache;
        const labelUjian = (jenjangPilihan === 'MI' || jenjangPilihan === 'MTS' || jenjangPilihan === 'MA') ? 'UM' : 'US';

        let html = '<table class="mapel-table">';
        html += `<thead><tr><th>Kode Mapel</th><th>Nama Mapel</th><th class="col-cek">${labelUjian}</th><th class="col-cek col-up">UP</th><th>Aksi</th></tr></thead>`;
        
        html += '<tbody>';
        if (globalMapelList.length === 0) {
          html += '<tr><td colspan="5" style="text-align: center;">Belum ada data mapel.</td></tr>';
        }

        globalMapelList.forEach((mapel, index) => {
          const isUS = mapel.isUS || false;
          const isUP = mapel.isUP || false;
          
          const isFirst = (index === 0);
          const isLast = (index === globalMapelList.length - 1);
          
          html += `
            <tr>
              <td>${mapel.id}</td>
              <td>${mapel.nama}</td>
              <td class="col-cek">
                <input type="checkbox" class="mapel-tipe-cek" data-id="${mapel.id}" data-tipe="us" ${isUS ? 'checked' : ''}>
              </td>
              <td class="col-cek col-up">
                <input type="checkbox" class="mapel-tipe-cek" data-id="${mapel.id}" data-tipe="up" ${isUP ? 'checked' : ''}>
              </td>
              <td>
                <div class="btn-grup-gerak">
                  <button 
                    class="btn-aksi btn-move-up btn-move-up-mapel" 
                    data-id="${mapel.id}" 
                    ${isFirst ? 'disabled' : ''}
                    title="Naikkan posisi">
                      <i class="fas fa-arrow-up"></i>
                  </button>
                  <button 
                    class="btn-aksi btn-move-down btn-move-down-mapel" 
                    data-id="${mapel.id}" 
                    ${isLast ? 'disabled' : ''}
                    title="Turunkan posisi">
                        <i class="fas fa-arrow-down"></i>
                  </button>
                </div>
                <div class="btn-grup-aksi">
                  <button class="btn-aksi btn-edit" data-id="${mapel.id}" data-nama="${mapel.nama}"><i class="fas fa-pencil-alt"></i>Edit</button>
                  <button class="btn-aksi btn-delete" data-id="${mapel.id}"><i class="fas fa-trash-alt"></i>Hapus</button>
                </div>
              </td>
            </tr>
          `;
        });

        html += '</tbody></table>';
        container.innerHTML = html;
      } else {
        globalMapelList = [];
        container.innerHTML = `<p class="message error" style="display:block;">Gagal memuat mapel: ${response.message}</p>`;
      }
  }

  function showModalMapel(mode, id = '', nama = '') {
      document.getElementById('modal-mapel-mode').value = mode;
      hideMessage('modal-mapel-error');

      const idInput = document.getElementById('modal-mapel-id');

      if (mode === 'add') {
        document.getElementById('modal-title').innerText = "Tambah Mapel Baru";
        idInput.value = "";
        idInput.readOnly = false;
        document.getElementById('modal-mapel-nama').value = "";
      }
      else if (mode === 'edit') {
        document.getElementById('modal-title').innerText = "Edit Mapel";
        idInput.value = id;
        idInput.readOnly = true;
        document.getElementById('modal-mapel-nama').value = nama;
      }

      document.getElementById('mapel-modal').classList.add('show');
  }

  function tutupModalMapel() {
      document.getElementById('mapel-modal').classList.remove('show');
  }

  function simpanMapel() {
    setLoading(true, 'Menyimpan mapel...');
    hideMessage('modal-mapel-error');
    const mode = document.getElementById('modal-mapel-mode').value;
    const id = document.getElementById('modal-mapel-id').value;
    const nama = document.getElementById('modal-mapel-nama').value;
    if (mode === 'add') {
      google.script.run.withSuccessHandler(onMapelSaved).withFailureHandler(onGagal).createMapel(getToken(), id, nama);
    } else {
      google.script.run.withSuccessHandler(onMapelSaved).withFailureHandler(onGagal).updateMapel(getToken(), id, nama);
    }
  }

  function hapusMapel(id) {
    const title = "Konfirmasi Hapus";
    const message = `Hapus mapel ID: <strong>${id}</strong>? Data nilai terkait mungkin hilang.`;
    const callback = function() {
      setLoading(true, 'Menghapus mapel...');
      google.script.run.withSuccessHandler(onMapelSaved).withFailureHandler(onGagal).deleteMapel(getToken(), id);
    };
    showConfirmationModal(title, message, callback, 'danger');
  }

  function onTableRefreshed(response) {
      setLoading(false);

      if (response.status === "sukses") {
        setIjazahDirty(true);// <-- TAMBAHKAN INI
        if (response.message) {
          showInfoModal("Sukses", response.message, false, bukaHalamanMapel);
        } else {
          bukaHalamanMapel();
        }
      } else {
        showInfoModal("Error", response.message, true, null);
      }
  }

  function onMapelSaved(response) {
      setLoading(false);

      if (response.status === "sukses") {
        setIjazahDirty(true);// <-- TAMBAHKAN INI
        tutupModalMapel();
        setMapelOrderDirty(false); 
        bukaHalamanMapel();
      } else {
        showMessage('modal-mapel-error', response.message, true);
      }
  }

  function simpanTipeUjian() {
    setLoading(true, 'Menyimpan tipe ujian...');
    hideMessage('mapel-message');
    const allCheckboxes = document.querySelectorAll('#mapel-table-container .mapel-tipe-cek');
    const dataMap = new Map();
    allCheckboxes.forEach(checkbox => {
      const id = checkbox.dataset.id;
      const tipe = checkbox.dataset.tipe;
      const isChecked = checkbox.checked;
      if (!dataMap.has(id)) dataMap.set(id, { id: id, isUS: false, isUP: false });
      const mapelData = dataMap.get(id);
      if (tipe === 'us') mapelData.isUS = isChecked;
      else if (tipe === 'up') mapelData.isUP = isChecked;
    });
    const dataToSave = Array.from(dataMap.values());
    google.script.run.withSuccessHandler(onMapelTipeUjianSaved).withFailureHandler(onGagal).saveMapelTipeUjianBatch(getToken(), dataToSave);
  }
  
  function onMapelTipeUjianSaved(response) {
    setLoading(false);
    if (response.status === 'sukses') {
      setIjazahDirty(true);
      globalMapelList.forEach(m => {
        const cb_us = document.querySelector(`.mapel-tipe-cek[data-id="${m.id}"][data-tipe="us"]`);
        const cb_up = document.querySelector(`.mapel-tipe-cek[data-id="${m.id}"][data-tipe="up"]`);
        if (cb_us) m.originalIsUS = cb_us.checked;
        if (cb_up) m.originalIsUP = cb_up.checked;
      });
      setMapelTipeDirty(false); 
      isFormDirty = false; 
      showMessage('mapel-message', 'Tipe ujian berhasil disimpan!', false);
    } else {
      showMessage('mapel-message', response.message, true);
    }
  }

  function bukaHalamanDataSekolah() {
    tampilHalaman('halaman-data-sekolah');
    setLoading(true, 'Memuat data sekolah...', false);
    isFormDirty = false;
    hideMessage('data-sekolah-message');
    document.getElementById('form-data-sekolah').reset();
    setFormDisabled('form-data-sekolah', true);
    google.script.run
      .withSuccessHandler(onDataSekolahLoaded)
      .withFailureHandler(onGagal)
      .getSchoolData(getToken());
  }

  function onDataSekolahLoaded(response) {
      setLoading(false);
      setFormDisabled('form-data-sekolah', false);

      if (response.status !== 'sukses') {
        showMessage('data-sekolah-message', response.message, true);
        return;
      }

      const data = response.data;
      jenjangBaseCache = data.jenjangBase;
      jenjangPilihanCache = data.jenjangPilihan;
      populateSelectJenjang(data.jenjangBase, data.jenjangPilihan);

      document.getElementById('data-nama-sekolah').value = data.namaSekolah;
      document.getElementById('data-npsn').value = data.npsn || '';
      document.getElementById('data-nsm').value = data.nsm || '';
      document.getElementById('data-alamat').value = data.alamat || '';
      document.getElementById('data-provinsi').value = data.provinsi || '';
      document.getElementById('data-kabkot').value = data.kabKot || '';
      document.getElementById('data-pilihan-kabkot').value = data.pilihanKabKot || 'Kabupaten';
      document.getElementById('data-kecamatan').value = data.kecamatan || '';
      document.getElementById('data-keldes').value = data.kelDes || '';
      document.getElementById('data-pilihan-keldes').value = data.pilihanKelDes || 'Kelurahan';
      document.getElementById('data-kodepos').value = data.kodePos || '';
      document.getElementById('data-telepon').value = data.telepon || '';
      document.getElementById('data-email').value = data.email || '';
      document.getElementById('data-website').value = data.website || '';
      document.getElementById('data-kepsek').value = data.namaKepsek || '';
      document.getElementById('data-nip-kepsek').value = data.nipKepsek || '';

      updateTampilanNSM();
  }

  function populateSelectJenjang(jenjangBase, selectedValue) {
      const select = document.getElementById('data-jenjang-pilihan');
      select.innerHTML = '';

      let options = [];
      if (jenjangBase === 'SD/MI') {
        options = ['SD', 'MI'];
      } else if (jenjangBase === 'SMP/MTS') {
        options = ['SMP', 'MTS'];
      } else if (jenjangBase === 'SMA/MA') {
        options = ['SMA', 'MA'];
      } else {
        options = [jenjangBase];
      }

      select.innerHTML = '<option value="">-- Pilih Jenjang --</option>';
      options.forEach(opt => {
        select.innerHTML += `<option value="${opt}">${opt}</option>`;
      });

      if (selectedValue) {
        select.value = selectedValue;
      } else if (options.length > 1) {
        select.value = options[1];
      }
  }

  function updateTampilanNSM() {
      const jenjangPilihan = document.getElementById('data-jenjang-pilihan').value;
      const grupNSM = document.getElementById('grup-nsm');
      const labelNSM = grupNSM.querySelector('label');

      if (jenjangPilihan === 'MI' || jenjangPilihan === 'MTS' || jenjangPilihan === 'MA') {
        labelNSM.innerText = 'NSM (Wajib)';
      } else {
        labelNSM.innerText = 'NSM (Opsional)';
      }
  }

  function simpanDataSekolah() {
    setLoading(true, 'Menyimpan data sekolah...');
    hideMessage('data-sekolah-message');
    const requiredFieldIds = ['data-jenjang-pilihan', 'data-npsn', 'data-alamat', 'data-kepsek'];
    requiredFieldIds.forEach(id => document.getElementById(id)?.classList.remove('input-error'));
    document.getElementById('data-nsm').classList.remove('input-error');
    const dataToSave = {
      jenjangPilihan: document.getElementById('data-jenjang-pilihan').value,
      npsn: document.getElementById('data-npsn').value.trim(),
      nsm: document.getElementById('data-nsm').value.trim(),
      alamat: document.getElementById('data-alamat').value.trim(),
      provinsi: document.getElementById('data-provinsi').value.trim(),
      kabKot: document.getElementById('data-kabkot').value.trim(),
      pilihanKabKot: document.getElementById('data-pilihan-kabkot').value,
      kecamatan: document.getElementById('data-kecamatan').value.trim(),
      kelDes: document.getElementById('data-keldes').value.trim(),
      pilihanKelDes: document.getElementById('data-pilihan-keldes').value,
      kodePos: document.getElementById('data-kodepos').value.trim(),
      telepon: document.getElementById('data-telepon').value.trim(),
      email: document.getElementById('data-email').value.trim(),
      website: document.getElementById('data-website').value.trim(),
      namaKepsek: document.getElementById('data-kepsek').value.trim(),
      nipKepsek: document.getElementById('data-nip-kepsek').value.trim()
    };
    const errorFieldIds = [];
    if (!dataToSave.jenjangPilihan) errorFieldIds.push('data-jenjang-pilihan');
    if (!dataToSave.npsn) errorFieldIds.push('data-npsn');
    if (!dataToSave.alamat) errorFieldIds.push('data-alamat');
    if (!dataToSave.namaKepsek) errorFieldIds.push('data-kepsek');
    const isMadrasah = (dataToSave.jenjangPilihan === 'MI' || dataToSave.jenjangPilihan === 'MTS' || dataToSave.jenjangPilihan === 'MA');
    if (isMadrasah && !dataToSave.nsm) errorFieldIds.push('data-nsm');
    if (errorFieldIds.length > 0) {
      setLoading(false);
      errorFieldIds.forEach(id => document.getElementById(id)?.classList.add('input-error'));
      document.getElementById(errorFieldIds[0]).focus();
      showMessage('data-sekolah-message', "Harap lengkapi field wajib.", true);
      return;
    }
    jenjangPilihanCache = dataToSave.jenjangPilihan;
    google.script.run
      .withSuccessHandler(onDataSekolahSaved)
      .withFailureHandler(onGagal)
      .saveSchoolData(getToken(), dataToSave);
  }

  function onDataSekolahSaved(response) {
      setLoading(false);
      if (response.status === 'sukses') {
        isFormDirty = false; 
        showMessage('data-sekolah-message', 'Data sekolah berhasil disimpan!', false);
      } else {
        showMessage('data-sekolah-message', response.message, true);
      }
  }

  function sinkronkanBobot(sumber) {
      const inputRapor = document.getElementById('bobot-rapor');
      const inputUjian = document.getElementById('bobot-ujian');

      let nilaiRapor = parseInt(inputRapor.value, 10);
      let nilaiUjian = parseInt(inputUjian.value, 10);

      if (sumber === 'rapor') {
        if (isNaN(nilaiRapor)) { inputUjian.value = ''; return; }
        if (nilaiRapor > 100) { nilaiRapor = 100; inputRapor.value = 100; }
        if (nilaiRapor < 0) { nilaiRapor = 0; inputRapor.value = 0; }
        inputUjian.value = 100 - nilaiRapor;
      } else if (sumber === 'ujian') {
        if (isNaN(nilaiUjian)) { inputRapor.value = ''; return; }
        if (nilaiUjian > 100) { nilaiUjian = 100; inputUjian.value = 100; }
        if (nilaiUjian < 0) { nilaiUjian = 0; inputUjian.value = 0; }
        inputRapor.value = 100 - nilaiUjian;
      }
  }

  function bukaHalamanBobot() {
    tampilHalaman('halaman-bobot');
    setLoading(true, 'Memuat data bobot...', false);
    isFormDirty = false;
    hideMessage('bobot-message');
    document.getElementById('form-bobot').reset();
    setFormDisabled('form-bobot', true);
    google.script.run
      .withSuccessHandler(onBobotLoaded)
      .withFailureHandler(onGagal)
      .getBobotData(getToken());
  }

  function onBobotLoaded(response) {
      setLoading(false);
      setFormDisabled('form-bobot', false);

      if (response.status !== 'sukses') {
        showMessage('bobot-message', response.message, true);
        return;
      }
      document.getElementById('bobot-rapor').value = response.bobotRapor;
      document.getElementById('bobot-ujian').value = response.bobotUjian;
      document.getElementById('bobot-kkm').value = response.kkm;
  }

  function simpanBobot() {
    setLoading(true, 'Menyimpan data bobot...');
    hideMessage('bobot-message');
    const bobotRapor = parseInt(document.getElementById('bobot-rapor').value, 10) || 0;
    const bobotUjian = parseInt(document.getElementById('bobot-ujian').value, 10) || 0;
    const kkm = parseInt(document.getElementById('bobot-kkm').value, 10);
    if ((bobotRapor + bobotUjian) !== 100) {
      setLoading(false);
      showMessage('bobot-message', 'Total bobot harus 100%.', true);
      return;
    }
    if (isNaN(kkm) || kkm < 0 || kkm > 100) {
      setLoading(false);
      showMessage('bobot-message', 'KKM tidak valid.', true);
      return;
    }
    google.script.run
      .withSuccessHandler(onBobotSaved)
      .withFailureHandler(onGagal)
      .saveBobotData(getToken(), bobotRapor, bobotUjian, kkm);
  }

  function onBobotSaved(response) {
      setLoading(false);
      if (response.status === 'sukses') {
        isFormDirty = false; 
        setIjazahDirty(true);
        showMessage('bobot-message', 'Data bobot berhasil disimpan!', false);
      } else {
        showMessage('bobot-message', response.message, true);
      }
  }

  function getCurrentKelasList() {
      const allRows = document.querySelectorAll('#kelas-list-container .kelas-input-row');
      const list = [];
      
      allRows.forEach(row => {
        const lockedSpan = row.querySelector('.kelas-input-locked');
        const unlockedInput = row.querySelector('input[type="text"]');

        if (lockedSpan) {
          list.push(lockedSpan.textContent.trim());
        } else if (unlockedInput) {
          list.push(unlockedInput.value);
        }
      });
      
      return list;
  }

  function renderKelasList(kelasList) { // kelasList sekarang [ {nama, isLocked}, ... ]
    const container = document.getElementById('kelas-list-container');
    container.innerHTML = '';

    let listToRender = kelasList;
    if (listToRender.length === 0) {
      listToRender = [{ nama: '', isLocked: false }];
    }

    listToRender.forEach((kelas, index) => {
      const div = document.createElement('div');
      div.className = 'kelas-input-row';
      
      const isLocked = kelas.isLocked || false;
      const titleAttr = isLocked ? 'Kelas ini tidak bisa diubah/dihapus karena sudah terpakai oleh siswa yang memiliki nilai.' : '';

      let html = '';

      if (isLocked) {
        html = `<span class="kelas-input-locked" title="${titleAttr}">
                  ${kelas.nama}
                </span>`;
      } else {
        html = `<input type="text" 
                      placeholder="Nama Kelas (Contoh: VI A)" 
                      value="${kelas.nama}" 
                      title="">`;
      }

      if (!isLocked && listToRender.length > 1) {
        html += '<button type="button" class="btn-aksi-kelas btn-remove-kelas">&times;</button>';
      } else if (isLocked) {
        html += `<span class="btn-aksi-kelas-locked" title="${titleAttr}"><i class="fas fa-lock"></i></span>`;
      }

      if (index === listToRender.length - 1 && !isLocked) {
        html += '<button type="button" class="btn-aksi-kelas btn-add-kelas">+</button>';
      } else if (index === listToRender.length - 1 && isLocked) {
        html += '<button type="button" class="btn-aksi-kelas btn-add-kelas">+</button>';
      }

      div.innerHTML = html;
      container.appendChild(div);
    });
  }

  function bukaHalamanKelas() {
    tampilHalaman('halaman-kelas');
    setLoading(true, 'Memuat data kelas...', false, false);
    isFormDirty = false;
    hideMessage('kelas-message');
    document.getElementById('kelas-list-container').innerHTML = "<p>Memuat data kelas...</p>";
    setFormDisabled('form-kelas', true);
    google.script.run
      .withSuccessHandler(onKelasLoaded)
      .withFailureHandler(onGagal)
      .getKelas(getToken());
  }

  function onKelasLoaded(response) {
    setLoading(false);
    setFormDisabled('form-kelas', false);

    if (response.status !== 'sukses') {
      showMessage('kelas-message', response.message, true);
      document.getElementById('kelas-list-container').innerHTML = '';
      return;
    }
    
    // Diperbarui untuk menggunakan response.kelasList (bukan response.kelas)
    renderKelasList(response.kelasList || []);
  }

  function simpanKelas() {
    setLoading(true, 'Menyimpan data kelas...');
    hideMessage('kelas-message');
    const list = getCurrentKelasList().map(n => String(n).trim()).filter(n => n.length > 0);
    const uniqueList = new Set(list.map(n => n.toUpperCase()));
    if (uniqueList.size !== list.length) {
      setLoading(false);
      showMessage('kelas-message', 'Nama kelas duplikat.', true);
      return;
    }
    google.script.run
      .withSuccessHandler(onKelasSaved)
      .withFailureHandler(onGagal)
      .saveKelas(getToken(), list);
  }

  function onKelasSaved(response) {
      setLoading(false);
      if (response.status === 'sukses') {
        isFormDirty = false; 
        showMessage('kelas-message', 'Data kelas berhasil disimpan!', false);
      } else {
        showMessage('kelas-message', response.message, true);
      }
  }

  function bukaHalamanSiswa() {
    tampilHalaman('halaman-siswa');
    setLoading(true, 'Memuat data siswa...', false, false);
    isFormDirty = false;
    document.getElementById('siswa-table-container').innerHTML = "<p>Memuat data siswa...</p>";
    document.getElementById('btn-tambah-siswa-baru').disabled = true;
    document.getElementById('btn-import-siswa').disabled = true;
    document.getElementById('btn-hapus-semua-siswa').disabled = true;
    document.getElementById('siswa-filter-kelas').disabled = true;
    document.getElementById('siswa-sort-by').disabled = true;
    google.script.run
      .withSuccessHandler(onSiswaLoaded)
      .withFailureHandler(onGagal)
      .getSiswa(getToken());
  }

  function onSiswaLoaded(response) {
      setLoading(false);
      
      document.getElementById('btn-tambah-siswa-baru').disabled = false;
      document.getElementById('btn-import-siswa').disabled = false;
      document.getElementById('btn-hapus-semua-siswa').disabled = false;
      document.getElementById('siswa-filter-kelas').disabled = false;
      document.getElementById('siswa-sort-by').disabled = false;

      const container = document.getElementById('siswa-table-container');

      if (response.status === "sukses") {
        response.siswa.forEach(s => {
          s.originalUrutan = s.urutan;
        });
        globalSiswaList = response.siswa;
        
        populateSiswaFilters();
        applySiswaFiltersAndRender();
        setSiswaOrderDirty(false);
      } else {
        globalSiswaList = [];
        container.innerHTML = `<p class="message error" style="display:block;">Gagal memuat siswa: ${response.message}</p>`;
      }
  }

  function setSiswaOrderDirty(isDirty) {
    isSiswaOrderDirty = isDirty;
    updateSiswaFloatingActions();
  }

  function onSiswaUrutanSaved(response) {
    setLoading(false);
    if (response.status === 'sukses') {
      globalSiswaList.forEach(s => {
        s.originalUrutan = s.urutan;
      });
      setSiswaOrderDirty(false);
      isFormDirty = false; 
      showMessage('siswa-message', 'Urutan siswa berhasil disimpan!', false);
    } else {
      showMessage('siswa-message', response.message, true);
    }
  }

function populateSiswaFilters() {
    const selectKelas = document.getElementById('siswa-filter-kelas');
    const selectedValue = selectKelas.value;
    
    const kelasSet = new Set(globalSiswaList.map(siswa => siswa.kelas));
    const kelasList = Array.from(kelasSet).sort();
  
    let optionsHtml = '<option value="semua">-- Tampilkan Semua Kelas --</option>';
    kelasList.forEach(kelas => {
      optionsHtml += `<option value="${kelas}">${kelas}</option>`;
    });
  
    selectKelas.innerHTML = optionsHtml;
    
    selectKelas.value = selectedValue || (kelasList.length === 1 ? kelasList[0] : 'semua');
  }
  
  function applySiswaFiltersAndRender() {
    const selectedKelas = document.getElementById('siswa-filter-kelas').value;
    const selectedSort = document.getElementById('siswa-sort-by').value;
  
    let processedSiswa = [...globalSiswaList];
  
    if (selectedKelas !== 'semua') {
      processedSiswa = processedSiswa.filter(siswa => siswa.kelas === selectedKelas);
    }
  
    switch (selectedSort) {
      case 'nama-az':
        processedSiswa.sort((a, b) => a.nama.localeCompare(b.nama));
        break;
      case 'nama-za':
        processedSiswa.sort((a, b) => b.nama.localeCompare(a.nama));
        break;
      case 'nisn-asc':
        processedSiswa.sort((a, b) => a.nisn.localeCompare(b.nisn, undefined, { numeric: true }));
        break;
      case 'nisn-desc':
        processedSiswa.sort((a, b) => b.nisn.localeCompare(a.nisn, undefined, { numeric: true }));
        break;
      case 'default':
      default:
        processedSiswa.sort((a, b) => {
          const kelasCompare = a.kelas.localeCompare(b.kelas);
          if (kelasCompare !== 0) {
            return kelasCompare;
          }
          
          const urutanA = Number(a.urutan) || 0;
          const urutanB = Number(b.urutan) || 0;
          
          return urutanA - urutanB;
        });
        break;
    }
  
    renderSiswaTable(processedSiswa);
  }
  
  function renderSiswaTable(siswaList) {
    const container = document.getElementById('siswa-table-container');
    
    let html = '<table class="siswa-table">';
    html += '<thead><tr><th>Nama Siswa</th><th>NISN</th><th>Kelas</th><th>Aksi</th></tr></thead>';
  
    html += '<tbody>';
    if (siswaList.length === 0) {
      html += '<tr><td colspan="4" style="text-align: center;">Tidak ada data siswa yang sesuai dengan filter.</td></tr>';
    }
  
    let currentKelas = null;
    const selectedSort = document.getElementById('siswa-sort-by').value;
    const isDefaultSort = (selectedSort === 'default');

    siswaList.forEach((siswa, index) => {
      
      const isFirstOfClass = (siswa.kelas !== currentKelas);
      currentKelas = siswa.kelas;
      
      const nextSiswa = siswaList[index + 1];
      const isLastOfClass = (!nextSiswa || nextSiswa.kelas !== siswa.kelas);
      
      let moveButtonsHtml = '';
      if (isDefaultSort) {
        moveButtonsHtml = `
          <button 
            class="btn-aksi btn-move-up" 
            data-id="${siswa.id}" 
            ${isFirstOfClass ? 'disabled' : ''}
            title="Naikkan posisi">
              <i class="fas fa-arrow-up"></i>
          </button>
          <button 
            class="btn-aksi btn-move-down" 
            data-id="${siswa.id}" 
            ${isLastOfClass ? 'disabled' : ''}
            title="Turunkan posisi">
                <i class="fas fa-arrow-down"></i>
          </button>
        `;
      }
      
      html += `
        <tr>
          <td>${siswa.nama}</td>
          <td>${siswa.nisn}</td>
          <td>${siswa.kelas}</td>
          <td>
            <div class="btn-grup-gerak">
              ${moveButtonsHtml}
            </div>
            <div class="btn-grup-aksi">
              <button class="btn-aksi btn-edit btn-edit-siswa"
                data-id="${siswa.id}" data-nama="${siswa.nama}" data-nisn="${siswa.nisn}" data-nis-lokal="${siswa.nisLokal}" data-jk="${siswa.jk}" data-tempat-lahir="${siswa.tempatLahir}" data-tgl-lahir="${siswa.tglLahir}" data-kelas="${siswa.kelas}"
              ><i class="fas fa-pencil-alt"></i>Edit</button>
              <button class="btn-aksi btn-delete btn-delete-siswa" data-id="${siswa.id}" data-nama="${siswa.nama}"><i class="fas fa-trash-alt"></i>Hapus</button>
            </div>
          </td>
        </tr>
      `;
    });
  
    html += '</tbody></table>';
    container.innerHTML = html;
  }

  function tutupModalSiswa() {
      document.getElementById('siswa-modal').classList.remove('show');
  }

  function showModalSiswa(mode, siswaData) {
    hideMessage('modal-siswa-error');
    document.getElementById('modal-siswa-mode').value = mode;
    document.getElementById('modal-siswa-id').value = siswaData.id || '';
    document.getElementById('modal-siswa-nama').value = '';
    document.getElementById('modal-siswa-nisn').value = '';
    document.getElementById('modal-siswa-nis-lokal').value = '';
    document.getElementById('modal-siswa-jk').value = '';
    document.getElementById('modal-siswa-tempat-lahir').value = '';
    document.getElementById('modal-siswa-tgl-lahir').value = '';
    const selectKelas = document.getElementById('modal-siswa-kelas');
    selectKelas.innerHTML = '<option value="">-- Memuat kelas... --</option>';
    document.getElementById('btn-simpan-siswa').disabled = true;
    if (mode === 'add') {
      document.getElementById('modal-siswa-title').innerText = "Tambah Siswa Baru";
      document.getElementById('modal-siswa-nisn').readOnly = false;
    } else {
      document.getElementById('modal-siswa-title').innerText = "Edit Data Siswa";
      document.getElementById('modal-siswa-nisn').readOnly = false;
      document.getElementById('modal-siswa-id').value = siswaData.id;
      document.getElementById('modal-siswa-nama').value = siswaData.nama;
      document.getElementById('modal-siswa-nisn').value = siswaData.nisn;
      document.getElementById('modal-siswa-nis-lokal').value = siswaData.nisLokal;
      document.getElementById('modal-siswa-jk').value = siswaData.jk;
      document.getElementById('modal-siswa-tempat-lahir').value = siswaData.tempatLahir;
      document.getElementById('modal-siswa-tgl-lahir').value = siswaData.tglLahir;
    }
    document.getElementById('siswa-modal').classList.add('show');
    google.script.run
      .withSuccessHandler((response) => onKelasListLoadedForModal(response, siswaData))
      .withFailureHandler(onGagal)
      .getKelas(getToken());
  }

  // GANTI FUNGSI LAMA ANDA DENGAN YANG INI
  function onKelasListLoadedForModal(response, siswaData) {
    const selectKelas = document.getElementById('modal-siswa-kelas');
    const btnSimpan = document.getElementById('btn-simpan-siswa');
    hideMessage('modal-siswa-error');
    
    const currentMode = document.getElementById('modal-siswa-mode').value;

    // --- PERBAIKAN: Membaca 'response.kelasList' (bukan 'response.kelas') ---
    if (response.status !== 'sukses' || !response.kelasList || response.kelasList.length === 0) {
      selectKelas.innerHTML = '<option value="">-- Tidak ada data kelas --</option>';
      showMessage('modal-siswa-error', "Tidak dapat menambah/edit siswa. Harap isi data kelas terlebih dahulu di menu 'Kelola Kelas'.", true);
      btnSimpan.disabled = true;
    
    } else {
      // --- PERBAIKAN: Membaca 'response.kelasList' ---
      const kelasList = response.kelasList; // Ini adalah array objek [ {nama, isLocked}, ... ]
      selectKelas.innerHTML = '<option value="">-- Pilih Kelas --</option>';
      
      // --- PERBAIKAN: Looping objek dan gunakan 'kelasObj.nama' ---
      kelasList.forEach(kelasObj => { 
        selectKelas.innerHTML += `<option value="${kelasObj.nama}">${kelasObj.nama}</option>`;
      });
      
      btnSimpan.disabled = false;

      if (currentMode === 'edit') {
        document.getElementById('modal-siswa-kelas').value = siswaData.kelas;
      } else if (currentMode === 'add' && kelasList.length === 1) {
        // --- PERBAIKAN: Gunakan 'kelasList[0].nama' ---
        document.getElementById('modal-siswa-kelas').value = kelasList[0].nama; 
      }
    }
  }

  function simpanSiswa() {
    setLoading(true, 'Menyimpan data siswa...');
    hideMessage('modal-siswa-error');
    const requiredFieldIds = ['modal-siswa-nama', 'modal-siswa-nisn', 'modal-siswa-jk', 'modal-siswa-kelas'];
    requiredFieldIds.forEach(id => document.getElementById(id).classList.remove('input-error'));
    const dataSiswa = {
      id: document.getElementById('modal-siswa-id').value,
      nama: document.getElementById('modal-siswa-nama').value.trim(),
      nisn: document.getElementById('modal-siswa-nisn').value.trim(),
      nisLokal: document.getElementById('modal-siswa-nis-lokal').value.trim(),
      jk: document.getElementById('modal-siswa-jk').value,
      tempatLahir: document.getElementById('modal-siswa-tempat-lahir').value.trim(),
      tglLahir: document.getElementById('modal-siswa-tgl-lahir').value,
      kelas: document.getElementById('modal-siswa-kelas').value
    };
    const errorFieldIds = [];
    if (!dataSiswa.nama) errorFieldIds.push("modal-siswa-nama");
    if (!dataSiswa.nisn) errorFieldIds.push("modal-siswa-nisn");
    if (!dataSiswa.jk) errorFieldIds.push("modal-siswa-jk");
    if (!dataSiswa.kelas) errorFieldIds.push("modal-siswa-kelas");
    if (errorFieldIds.length > 0) {
      setLoading(false);
      errorFieldIds.forEach(id => document.getElementById(id).classList.add('input-error'));
      document.getElementById(errorFieldIds[0]).focus();
      showMessage('modal-siswa-error', "Harap lengkapi field wajib.", true);
      return;
    }
    const mode = document.getElementById('modal-siswa-mode').value;
    if (mode === 'add') {
      google.script.run.withSuccessHandler(onSiswaSaved).withFailureHandler(onGagal).createSiswa(getToken(), dataSiswa);
    } else {
      google.script.run.withSuccessHandler(onSiswaSaved).withFailureHandler(onGagal).updateSiswa(getToken(), dataSiswa);
    }
  }

  function onSiswaSaved(response) {
      setLoading(false);

      if (response.status === "sukses") {
        setIjazahDirty(true);// <-- TAMBAHKAN INI
        tutupModalSiswa();
        bukaHalamanSiswa();
      } else {
        showMessage('modal-siswa-error', response.message, true);
      }
  }

  function hapusSiswa(siswaID, namaSiswa) {
    const title = "Konfirmasi Hapus";
    const message = `Hapus siswa: <strong>${namaSiswa}</strong>? Nilai terkait akan hilang.`;
    const callback = function() {
      setLoading(true, 'Menghapus siswa...');
      google.script.run.withSuccessHandler(onSiswaSaved).withFailureHandler(onGagal).deleteSiswa(getToken(), siswaID);
    };
    showConfirmationModal(title, message, callback, 'danger');
  }

  function hapusSemuaSiswa() {
    const title = "PERINGATAN BESAR!";
    const message = "Hapus SEMUA siswa? Tidak bisa dibatalkan.";
    const callback = function() {
      setLoading(true, 'Menghapus semua...');
      google.script.run.withSuccessHandler(onSiswaTableRefreshed).withFailureHandler(onGagal).deleteAllSiswa(getToken());
    };
    showConfirmationModal(title, message, callback, 'danger');
  }

  function onSiswaTableRefreshed(response) {
      setLoading(false);
      if (response.status === "sukses") {
        setIjazahDirty(true);// <-- TAMBAHKAN INI
        showInfoModal("Sukses", response.message, false, bukaHalamanSiswa);
      } else {
        showInfoModal("Error", response.message, true, null);
      }
  }

  function bukaModalImportSiswa() {
    document.getElementById('file-upload-siswa').value = null;
    document.getElementById('btn-proses-import-siswa').disabled = true;
    document.getElementById('import-siswa-results').style.display = 'none';
    document.getElementById('import-siswa-results').innerHTML = '';
    hideMessage('template-message');
    
    const fileUploadText = document.getElementById('file-upload-text');
    fileUploadText.innerText = 'Klik untuk memilih file atau seret & letakkan di sini.';
    fileUploadText.classList.remove('file-chosen');
    document.getElementById('file-upload-zone').classList.remove('drag-over');

    siswaTelahDiImport = false;
    
    document.getElementById('import-siswa-modal').classList.add('show');
  }

  function tutupModalImportSiswa() {
    document.getElementById('import-siswa-modal').classList.remove('show');
    if (siswaTelahDiImport) {
      siswaTelahDiImport = false;
      bukaHalamanSiswa();
    }
  }

  function downloadTemplateSiswa() {
    setLoading(true, 'Membuat template...');
    hideMessage('template-message');
    google.script.run
      .withSuccessHandler(onTemplateUrlReceived)
      .withFailureHandler(onGagal)
      .getSiswaTemplateUrl(getToken());
  }
  
  function onTemplateUrlReceived(response) {
    setLoading(false);
    
    if (response.status === 'sukses') {
      showMessage('template-message', 'Template berhasil dibuat. Mengunduh...', false);

      try {
        const dataUrl = `data:${response.mimeType};base64,${response.base64}`;
        
        const link = document.createElement('a');
        link.setAttribute('href', dataUrl);
        link.setAttribute('download', response.fileName);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        
        link.click();
        
        document.body.removeChild(link);

      } catch (e) {
        showMessage('template-message', 'Gagal memproses unduhan di browser: ' + e.message, true);
      }

    } else {
      showMessage('template-message', response.message, true);
    }
  }

  function prosesImportFileSiswa() {
    setLoading(true, 'Mengimpor siswa...');
    document.getElementById('import-siswa-results').style.display = 'none';
    hideMessage('template-message');
    const file = document.getElementById('file-upload-siswa').files[0];
    if (!file) { setLoading(false); showMessage('template-message', 'Pilih file Excel.', true); return; }
    const reader = new FileReader();
    reader.onload = (e) => {
      const fileData = { base64: e.target.result, mimeType: file.type, fileName: file.name };
      google.script.run.withSuccessHandler(onImportSiswaFinished).withFailureHandler(onGagal).prosesImportExcelSiswa(getToken(), fileData);
    };
    reader.onerror = (e) => { setLoading(false); showMessage('template-message', 'Gagal baca file.', true); };
    reader.readAsDataURL(file);
  }

  function onImportSiswaFinished(response) {
    setLoading(false);
    const resultsContainer = document.getElementById('import-siswa-results');

    if (response.status !== 'sukses') {
      showMessage('template-message', response.message, true);
      resultsContainer.style.display = 'none';
      return;
    }

    if (response.berhasilDiUpload > 0) {
      setIjazahDirty(true);// <-- TAMBAHKAN INI
      siswaTelahDiImport = true;
    }

    let html = '<h4><i class="fas fa-check-circle"></i>Proses Import Selesai</h4>';
    html += `<p>Total data diproses: <strong>${response.totalDiProses}</strong></p>`;
    html += `<p style="color: var(--success-color);">Berhasil ditambah: <strong>${response.berhasilDiUpload}</strong></p>`;
    html += `<p style="color: var(--danger-color);">Gagal/Dilewati: <strong>${response.gagalDiUpload}</strong></p>`;

    if (response.dataGagal && response.dataGagal.length > 0) {
      html += `<hr><p><strong>Detail Data yang Gagal:</strong></p>`;
      html += '<table class="import-gagal-table">';
      html += '<tr><th>Baris</th><th>Nama</th><th>NISN</th><th>Alasan Gagal</th></tr>';
      
      response.dataGagal.forEach(item => {
        html += `
          <tr>
            <td>${item.baris}</td>
            <td>${item.nama || '(Kosong)'}</td>
            <td>${item.nisn || '(Kosong)'}</td>
            <td>${item.alasan}</td>
          </tr>
        `;
      });
      html += '</table>';
    }

    resultsContainer.innerHTML = html;
    resultsContainer.style.display = 'block';

    document.getElementById('file-upload-siswa').value = null;
    document.getElementById('btn-proses-import-siswa').disabled = true;
  }

  function bukaModalUploadNilai() {
    document.getElementById('file-upload-nilai').value = null;
    document.getElementById('btn-proses-upload-nilai').disabled = true;
    document.getElementById('import-nilai-results').style.display = 'none';
    document.getElementById('import-nilai-results').innerHTML = '';
    hideMessage('template-nilai-message');
    const fileUploadText = document.getElementById('file-upload-text-nilai');
    fileUploadText.innerText = 'Klik untuk memilih file atau seret & letakkan di sini.';
    fileUploadText.classList.remove('file-chosen');
    document.getElementById('file-upload-zone-nilai').classList.remove('drag-over');
    nilaiTelahDiUpload = false;
    document.getElementById('upload-nilai-modal').classList.add('show');
    const selectKelas = document.getElementById('upload-nilai-filter-kelas');
    selectKelas.innerHTML = '<option value="">-- Memuat kelas... --</option>';
    google.script.run
      .withSuccessHandler(onKelasListLoadedForUploadModal)
      .withFailureHandler(onGagal)
      .getKelas(getToken());
  }

  function onKelasListLoadedForUploadModal(response) {
    const selectKelas = document.getElementById('upload-nilai-filter-kelas');
    hideMessage('template-nilai-message');

    if (response.status !== 'sukses' || !response.kelasList || response.kelasList.length === 0) {
      selectKelas.innerHTML = '<option value="">-- Tidak ada data kelas --</option>';
      showMessage('template-nilai-message', "Tidak dapat membuat template. Harap isi data kelas terlebih dahulu di menu 'Kelola Kelas'.", true);
    } else {
      const kelasList = response.kelasList.map(k => k.nama);
      selectKelas.innerHTML = '<option value="semua">-- Semua Kelas --</option>';
      kelasList.forEach(namaKelas => {
        selectKelas.innerHTML += `<option value="${namaKelas}">${namaKelas}</option>`;
      });
      
      if (kelasList.length === 1) {
        selectKelas.value = kelasList[0];
      } else {
        selectKelas.value = 'semua';
      }
    }
  }

  function tutupModalUploadNilai() {
    document.getElementById('upload-nilai-modal').classList.remove('show');
    if (nilaiTelahDiUpload) {
      nilaiTelahDiUpload = false;
    }
  }

  function downloadTemplateNilai() {
    setLoading(true, 'Membuat template nilai...');
    hideMessage('template-nilai-message');
    const kelasDipilih = document.getElementById('upload-nilai-filter-kelas').value;
    if (!kelasDipilih) { setLoading(false); showMessage('template-nilai-message', 'Pilih kelas dulu.', true); return; }
    google.script.run.withSuccessHandler(onTemplateNilaiUrlReceived).withFailureHandler(onGagal).getNilaiTemplateData(getToken(), kelasDipilih);
  }

  function onTemplateNilaiUrlReceived(response) {
    setLoading(false);
    
    if (response.status === 'sukses') {
      showMessage('template-nilai-message', 'Template berhasil dibuat. Mengunduh...', false);

      try {
        const dataUrl = `data:${response.mimeType};base64,${response.base64}`;
        const link = document.createElement('a');
        link.setAttribute('href', dataUrl);
        link.setAttribute('download', response.fileName);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      } catch (e) {
        showMessage('template-nilai-message', 'Gagal memproses unduhan: ' + e.message, true);
      }

    } else {
      showMessage('template-nilai-message', response.message, true);
    }
  }

  function prosesUploadFileNilai() {
    setLoading(true, 'Mengupload nilai...');
    document.getElementById('import-nilai-results').style.display = 'none';
    hideMessage('template-nilai-message');
    const file = document.getElementById('file-upload-nilai').files[0];
    if (!file) { setLoading(false); showMessage('template-nilai-message', 'Pilih file Excel.', true); return; }
    const reader = new FileReader();
    reader.onload = (e) => {
      const fileData = { base64: e.target.result, mimeType: file.type, fileName: file.name };
      google.script.run.withSuccessHandler(onUploadNilaiFinished).withFailureHandler(onGagal).prosesUploadExcelNilai(getToken(), fileData);
    };
    reader.onerror = (e) => { setLoading(false); showMessage('template-nilai-message', 'Gagal baca file.', true); };
    reader.readAsDataURL(file);
  }

  function onUploadNilaiFinished(response) {
    setLoading(false);
    const resultsContainer = document.getElementById('import-nilai-results');

    if (response.status !== 'sukses') {
      showMessage('template-nilai-message', response.message, true);
      resultsContainer.style.display = 'none';
      return;
    }

    if (response.berhasilDiUpload > 0) {
      setIjazahDirty(true);// <-- TAMBAHKAN INI
      nilaiTelahDiUpload = true;
    }

    let html = '<h4><i class="fas fa-check-circle"></i>Proses Upload Selesai</h4>';
    html += `<p>Total nilai terdeteksi: <strong>${response.totalDitemukan}</strong></p>`;
    html += `<p style="color: var(--success-color);">Berhasil disimpan/diperbarui: <strong>${response.berhasilDiUpload}</strong></p>`;
    html += `<p style="color: var(--danger-color);">Gagal/Dilewati: <strong>${response.gagalDiUpload}</strong></p>`;

    if (response.dataGagal && response.dataGagal.length > 0) {
      html += `<hr><p><strong>Detail Data yang Gagal:</strong></p>`;
      html += '<table class="import-gagal-table">';
      html += '<tr><th>Sheet</th><th>Baris</th><th>Info</th><th>Alasan Gagal</th></tr>';
      
      response.dataGagal.forEach(item => {
        html += `
          <tr>
            <td>${item.sheet || 'N/A'}</td>
            <td>${item.baris || 'N/A'}</td>
            <td>${item.info || 'N/A'}</td>
            <td>${item.alasan}</td>
          </tr>
        `;
      });
      html += '</table>';
    }

    resultsContainer.innerHTML = html;
    resultsContainer.style.display = 'block';

    document.getElementById('file-upload-nilai').value = null;
    document.getElementById('btn-proses-upload-nilai').disabled = true;
    
    const fileUploadText = document.getElementById('file-upload-text-nilai');
    fileUploadText.innerText = 'Klik untuk memilih file atau seret & letakkan di sini.';
    fileUploadText.classList.remove('file-chosen');
  }

  function bukaModalUploadNilaiRapor() {
    document.getElementById('file-upload-rapor').value = null;
    document.getElementById('btn-proses-upload-nilai-rapor').disabled = true;
    document.getElementById('import-rapor-results').style.display = 'none';
    document.getElementById('import-rapor-results').innerHTML = '';
    hideMessage('template-rapor-message');
    const fileUploadText = document.getElementById('file-upload-text-rapor');
    fileUploadText.innerText = 'Klik untuk memilih file atau seret & letakkan di sini.';
    fileUploadText.classList.remove('file-chosen');
    document.getElementById('file-upload-zone-rapor').classList.remove('drag-over');
    nilaiRaporTelahDiUpload = false;
    document.getElementById('upload-nilai-rapor-modal').classList.add('show');
    const selectSemester = document.getElementById('upload-rapor-filter-semester');
    selectSemester.innerHTML = '<option value="">-- Memuat semester... --</option>';
    const selectKelas = document.getElementById('upload-rapor-filter-kelas');
    selectKelas.innerHTML = '<option value="">-- Pilih Semester Dulu --</option>';
    google.script.run.withSuccessHandler(onSemesterListLoadedForUploadModal).withFailureHandler(onGagal).getSemesterList(getToken());
  }

  // Helper untuk modal upload rapor (memanggil getKelas juga)
  function onSemesterListLoadedForUploadModal(response) {
    const selectSemester = document.getElementById('upload-rapor-filter-semester');
    hideMessage('template-rapor-message');
    if (response.status !== 'sukses' || !response.semesterList || response.semesterList.length === 0) {
      selectSemester.innerHTML = '<option value="">-- Gagal memuat semester --</option>';
      showMessage('template-rapor-message', "Gagal memuat semester.", true);
    } else {
      selectSemester.innerHTML = '<option value="">-- Pilih Semester --</option>';
      response.semesterList.forEach(semester => {
        selectSemester.innerHTML += `<option value="${semester.id}">${semester.nama}</option>`;
      });
      google.script.run.withSuccessHandler(onKelasListLoadedForUploadRaporModal).withFailureHandler(onGagal).getKelas(getToken());
    }
  }

  function onKelasListLoadedForUploadRaporModal(response) {
    const selectKelas = document.getElementById('upload-rapor-filter-kelas');
    hideMessage('template-rapor-message');

    if (response.status !== 'sukses' || !response.kelasList || response.kelasList.length === 0) {
      selectKelas.innerHTML = '<option value="">-- Tidak ada data kelas --</option>';
      showMessage('template-rapor-message', "Tidak dapat membuat template. Harap isi data kelas terlebih dahulu.", true);
    } else {
      const kelasList = response.kelasList.map(k => k.nama);
      selectKelas.innerHTML = '<option value="semua">-- Semua Kelas --</option>';
      kelasList.forEach(namaKelas => {
        selectKelas.innerHTML += `<option value="${namaKelas}">${namaKelas}</option>`;
      });
      
      if (kelasList.length === 1) {
        selectKelas.value = kelasList[0];
      } else if (kelasList.length > 1) {
        selectKelas.value = 'semua';
      }
    }
  }

  function tutupModalUploadNilaiRapor() {
    document.getElementById('upload-nilai-rapor-modal').classList.remove('show');
    if (nilaiRaporTelahDiUpload) {
      nilaiRaporTelahDiUpload = false;
    }
  }

  function downloadTemplateNilaiRapor() {
    setLoading(true, 'Membuat template...');
    hideMessage('template-rapor-message');
    const semesterDipilih = document.getElementById('upload-rapor-filter-semester').value;
    const kelasDipilih = document.getElementById('upload-rapor-filter-kelas').value;
    if (!semesterDipilih) { setLoading(false); showMessage('template-rapor-message', 'Pilih semester dulu.', true); return; }
    if (!kelasDipilih) { setLoading(false); showMessage('template-rapor-message', 'Pilih kelas dulu.', true); return; }
    google.script.run.withSuccessHandler(onTemplateNilaiRaporUrlReceived).withFailureHandler(onGagal).getNilaiRaporTemplateData(getToken(), semesterDipilih, kelasDipilih);
  }

  function onTemplateNilaiRaporUrlReceived(response) {
    setLoading(false);
    
    if (response.status === 'sukses') {
      showMessage('template-rapor-message', 'Template berhasil dibuat. Mengunduh...', false);

      try {
        const dataUrl = `data:${response.mimeType};base64,${response.base64}`;
        const link = document.createElement('a');
        link.setAttribute('href', dataUrl);
        link.setAttribute('download', response.fileName);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      } catch (e) {
        showMessage('template-rapor-message', 'Gagal memproses unduhan: ' + e.message, true);
      }

    } else {
      showMessage('template-rapor-message', response.message, true);
    }
  }

  function prosesUploadFileNilaiRapor() {
    setLoading(true, 'Mengupload nilai rapor...');
    document.getElementById('import-rapor-results').style.display = 'none';
    hideMessage('template-rapor-message');
    const file = document.getElementById('file-upload-rapor').files[0];
    const semesterId = document.getElementById('upload-rapor-filter-semester').value;
    if (!file) { setLoading(false); showMessage('template-rapor-message', 'Pilih file Excel.', true); return; }
    if (!semesterId) { setLoading(false); showMessage('template-rapor-message', 'Pilih semester.', true); return; }
    const reader = new FileReader();
    reader.onload = (e) => {
      const fileData = { base64: e.target.result, mimeType: file.type, fileName: file.name };
      google.script.run.withSuccessHandler(onUploadNilaiRaporFinished).withFailureHandler(onGagal).prosesUploadExcelNilaiRapor(getToken(), fileData, semesterId);
    };
    reader.onerror = (e) => { setLoading(false); showMessage('template-rapor-message', 'Gagal baca file.', true); };
    reader.readAsDataURL(file);
  }

  function onUploadNilaiRaporFinished(response) {
    setLoading(false);
    const resultsContainer = document.getElementById('import-rapor-results');

    if (response.status !== 'sukses') {
      showMessage('template-rapor-message', response.message, true);
      resultsContainer.style.display = 'none';
      return;
    }

    if (response.berhasilDiUpload > 0) {
      setIjazahDirty(true);// <-- TAMBAHKAN INI
      nilaiRaporTelahDiUpload = true;
    }

    let html = '<h4><i class="fas fa-check-circle"></i>Proses Upload Selesai</h4>';
    html += `<p>Total nilai terdeteksi: <strong>${response.totalDitemukan}</strong></p>`;
    html += `<p style="color: var(--success-color);">Berhasil disimpan/diperbarui: <strong>${response.berhasilDiUpload}</strong></p>`;
    html += `<p style="color: var(--danger-color);">Gagal/Dilewati: <strong>${response.gagalDiUpload}</strong></p>`;

    if (response.dataGagal && response.dataGagal.length > 0) {
      html += `<hr><p><strong>Detail Data yang Gagal:</strong></p>`;
      html += '<table class="import-gagal-table">';
      html += '<tr><th>Sheet</th><th>Baris</th><th>Info</th><th>Alasan Gagal</th></tr>';
      
      response.dataGagal.forEach(item => {
        html += `
          <tr>
            <td>${item.sheet || 'N/A'}</td>
            <td>${item.baris || 'N/A'}</td>
            <td>${item.info || 'N/A'}</td>
            <td>${item.alasan}</td>
          </tr>
        `;
      });
      html += '</table>';
    }

    resultsContainer.innerHTML = html;
    resultsContainer.style.display = 'block';

    document.getElementById('file-upload-rapor').value = null;
    document.getElementById('btn-proses-upload-nilai-rapor').disabled = true;
    
    const fileUploadText = document.getElementById('file-upload-text-rapor');
    fileUploadText.innerText = 'Klik untuk memilih file atau seret & letakkan di sini.';
    fileUploadText.classList.remove('file-chosen');
  }

  function bukaHalamanInputUjian() {
    tampilHalaman('halaman-input-ujian');

    const labelUjianUtama = document.getElementById('label-ujian-utama');

    const jenjangPilihan = jenjangPilihanCache;
    if (jenjangPilihan === 'MI' || jenjangPilihan === 'MTS' || jenjangPilihan === 'MA') {
      labelUjianUtama.innerText = 'Ujian Madrasah';
    } else {
      labelUjianUtama.innerText = 'Ujian Sekolah';
    }

    const btnRekapUjian = document.getElementById('btn-buka-rekap-nilai');
    const btnPraktek = document.getElementById('btn-buka-input-praktek');
    const btnMadrasah = document.getElementById('btn-buka-input-um');

    // --- PERUBAHAN: Dapatkan kontainer grid ---
    const gridContainer = document.querySelector('#halaman-input-ujian .dashboard-menu-grid');
    
    // --- PERUBAHAN: Hapus pesan lama (jika ada) ---
    const oldMessage = gridContainer.querySelector('.guru-no-mapel-message');
    if (oldMessage) {
      oldMessage.remove();
    }

    if (currentUserRole === 'guru') {
      if (btnRekapUjian) {
        btnRekapUjian.style.display = 'none';
      }
      
      // --- PERUBAHAN: Gunakan flag untuk melacak konten ---
      let hasContent = false;
      
      if (btnPraktek) {
        if (guruHasPraktek) {
          btnPraktek.style.display = 'flex';
          hasContent = true; // Tandai ada konten
        } else {
          btnPraktek.style.display = 'none';
        }
      }
      if (btnMadrasah) {
        if (guruHasMadrasah) {
          btnMadrasah.style.display = 'flex';
          hasContent = true; // Tandai ada konten
        } else {
          btnMadrasah.style.display = 'none';
        }
      }

      // --- PERUBAHAN: Tampilkan pesan jika tidak ada konten ---
      if (!hasContent && gridContainer) {
        const messageEl = document.createElement('p');
        messageEl.className = 'guru-no-mapel-message'; // Untuk styling & penghapusan
        messageEl.innerHTML = `
          <i class="fas fa-info-circle"></i>
          <strong>Mata pelajaran Anda belum diatur.</strong>
          <br>
          Silakan hubungi Admin sekolah untuk mengatur mapel yang Anda ampu (Ujian Madrasah/Sekolah atau Praktek) agar menu input nilai dapat tampil.
        `;
        gridContainer.appendChild(messageEl);
      }
      
    } else {
      // Ini logika untuk Admin (tidak berubah)
      if (btnRekapUjian) {
        btnRekapUjian.style.display = 'flex';
      }
      if (btnPraktek) {
        btnPraktek.style.display = 'flex';
      }
      if (btnMadrasah) {
        btnMadrasah.style.display = 'flex';
      }
    }
  }

  function bukaHalamanInputNilaiDetail(tipeUjian) {
    isFormDirty = false;
    tampilHalaman('halaman-input-nilai-detail');
    hideMessage('input-nilai-message');
    const page = document.getElementById('halaman-input-nilai-detail');
    const judulHalaman = document.getElementById('judul-halaman-input-nilai');
    const tableContainer = document.getElementById('input-nilai-table-container');
    const btnSimpan = document.getElementById('btn-simpan-input-nilai');
    const btnBersihkan = document.getElementById('btn-bersihkan-input-nilai');
    tableContainer.innerHTML = '<p>Memuat data...</p>';
    btnSimpan.disabled = true;
    btnBersihkan.disabled = true;
    document.getElementById('input-nilai-filter-kelas').innerHTML = '<option value="semua">-- Tampilkan Semua Kelas --</option>';
    globalGridData = { siswaList: [], mapelList: [], nilaiData: {} };
    if (tipeUjian === 'UM') {
      const label = (jenjangPilihanCache === 'MI' || jenjangPilihanCache === 'MTS' || jenjangPilihanCache === 'MA') ? 'Ujian Madrasah' : 'Ujian Sekolah';
      judulHalaman.innerText = `Input Nilai ${label}`;
      judulHalaman.dataset.tipeUjian = 'UM';
      page.classList.remove('tipe-ujian-praktek'); page.classList.add('tipe-ujian-um');
    } else {
      judulHalaman.innerText = 'Input Nilai Ujian Praktek';
      judulHalaman.dataset.tipeUjian = 'Praktek';
      page.classList.remove('tipe-ujian-um'); page.classList.add('tipe-ujian-praktek');
    }
    setLoading(true, 'Memuat data nilai...', false, false);
    google.script.run.withSuccessHandler(onNilaiGridLoaded).withFailureHandler(onGagal).getNilaiUjianGridData(getToken(), tipeUjian);
  }

  function populateNilaiFilter(siswaList) {
    const selectKelas = document.getElementById('input-nilai-filter-kelas');
    const selectedValue = selectKelas.value;
  
    const kelasSet = new Set(siswaList.map(siswa => siswa.kelas));
    const kelasList = Array.from(kelasSet).sort();
  
    let optionsHtml = '<option value="semua">-- Tampilkan Semua Kelas --</option>';
    kelasList.forEach(kelas => {
      optionsHtml += `<option value="${kelas}">${kelas}</option>`;
    });
  
    selectKelas.innerHTML = optionsHtml;
    selectKelas.value = selectedValue || (kelasList.length === 1 ? kelasList[0] : 'semua');
  }

  function onNilaiGridLoaded(response) {
    setLoading(false);
    const container = document.getElementById('input-nilai-table-container');
    const btnSimpan = document.getElementById('btn-simpan-input-nilai');
    const btnBersihkan = document.getElementById('btn-bersihkan-input-nilai');
    
    // Hapus pesan error lama (jika ada)
    hideMessage('input-nilai-message');

    if (response.status !== 'sukses') {
      container.innerHTML = `<p class="message error" style="display:block;">Gagal memuat data: ${response.message}</p>`;
      btnSimpan.disabled = true;
      btnBersihkan.disabled = true;
      globalGridData = { siswaList: [], mapelList: [], nilaiData: {} };
      return;
    }

    // --- BLOK LOGIKA BARU UNTUK KUNCI WAKTU (GURU) ---
    const isInputDiizinkan = response.data.isInputDiizinkan;
    const pesanInput = response.data.pesanInput;
    
    if (currentUserRole === 'guru' && !isInputDiizinkan) {
      // Jika guru dan input TIDAK diizinkan
      globalGridData = { siswaList: [], mapelList: [], nilaiData: {} };
      
      // Tampilkan pesan error
      container.innerHTML = `<p class="message error" style="display:block;">${pesanInput}</p>`;
      
      // Nonaktifkan semua tombol
      btnSimpan.disabled = true;
      btnBersihkan.disabled = true;
      
      // Tampilkan toast error juga
      showToast(pesanInput, 'gagal');
      
      // Hentikan eksekusi fungsi
      return; 
    }
    // --- AKHIR BLOK LOGIKA BARU ---

    globalGridData = response.data;

    populateNilaiFilter(globalGridData.siswaList);

    renderNilaiGridTable(); 

    const { siswaList, mapelList } = globalGridData;
    if (siswaList && siswaList.length > 0 && mapelList && mapelList.length > 0) {
      btnSimpan.disabled = false;
      btnBersihkan.disabled = false;
    } else {
      btnSimpan.disabled = true;
      btnBersihkan.disabled = true;
    }

    // --- PERUBAHAN DI SINI ---
    autoScrollToBottom();
    // --- AKHIR PERUBAHAN ---
  }

  function renderNilaiGridTable() {
    const container = document.getElementById('input-nilai-table-container');
    
    // --- PERBAIKAN: Ambil mapelKelasData ---
    const { siswaList, mapelList, nilaiData, mapelKelasData } = globalGridData;
    // --- AKHIR PERBAIKAN ---
    
    const selectedKelas = document.getElementById('input-nilai-filter-kelas').value;
    
    if (!siswaList || siswaList.length === 0) {
      let pesan = 'Belum ada data siswa.';
      if (currentUserRole === 'admin') {
        pesan += ' Harap isi di menu "Kelola Data Siswa".';
      }
      container.innerHTML = `<p style="text-align: center; padding: 20px;">${pesan}</p>`;
      return;
    }
    
    if (!mapelList || mapelList.length === 0) {
      const tipeUjian = document.getElementById('judul-halaman-input-nilai').dataset.tipeUjian;
      const pesan = `Tidak ada mapel yang diatur untuk ${tipeUjian === 'UM' ? 'Ujian Sekolah/Madrasah' : 'Ujian Praktek'}. Harap centang di menu "Kelola Mapel".`;
      container.innerHTML = `<p style="text-align: center; padding: 20px;">${pesan}</p>`;
      return;
    }

    const filteredSiswaList = (selectedKelas === 'semua')
      ? siswaList
      : siswaList.filter(siswa => siswa.kelas === selectedKelas);

    if (filteredSiswaList.length === 0 && selectedKelas !== 'semua') {
        container.innerHTML = '<p style="text-align: center; padding: 20px;">Tidak ada siswa di kelas yang dipilih.</p>';
        return;
    } else if (filteredSiswaList.length === 0 && selectedKelas === 'semua') {
       container.innerHTML = '<p style="text-align: center; padding: 20px;">Tidak ada data siswa.</p>';
       return;
    }

    const mapelCount = mapelList.length;
    
    let tableClass = 'guru-view';
    if (currentUserRole === 'guru' && mapelCount > 4) { 
      tableClass += ' guru-view-many-mapels';
    }
    
    let html = `<table class="input-nilai-table ${tableClass}">`;
    
    html += '<thead><tr>';
    html += '<th>Nama Siswa</th>';
    mapelList.forEach(mapel => {
      html += `<th 
                class="col-mapel clickable-mapel-header" 
                data-mapel-nama="${mapel.nama}" 
                title="Klik untuk lihat nama mapel"
              >
                ${mapel.id}
              </th>`;
    });
    html += '<th class="th-total th-total-jumlah">Jumlah</th>';
    html += '<th class="th-total th-total-rata">Rata-Rata</th>';
    html += '</tr></thead>';
    
    html += '<tbody>';
    filteredSiswaList.forEach(siswa => {
      html += '<tr>';
      
      const namaProper = toProperCase(siswa.nama);
      const namaFormatted = formatNamaSiswa(namaProper);
      
      html += `
        <td>
          <span 
            class="clickable-nama-siswa" 
            data-nisn="${siswa.nisn}" 
            data-nama-lengkap="${siswa.nama}"
            title="Klik untuk lihat NISN"
          >
            ${namaFormatted}
          </span>
        </td>`;
      
      mapelList.forEach(mapel => {
        const key = `${siswa.id}_${mapel.id}`;
        
        const storedNilai = nilaiData[key];
        let nilai = '';
        
        if (storedNilai === 0 || storedNilai === '0') {
            nilai = 0;
        } else if (storedNilai) {
            nilai = storedNilai;
        }

        // --- ============================================= ---
        // --- ===== LOGIKA BARU UNTUK DISABLE INPUT ===== ---
        // --- ============================================= ---
        let isCellDisabled = false;
        if (currentUserRole === 'guru' && mapelKelasData) {
          const allowedClassesForMapel = mapelKelasData[mapel.id];
          if (allowedClassesForMapel) {
            // Jika guru ini mengajar mapel ini, cek kelasnya
            if (!allowedClassesForMapel.includes(siswa.kelas) && !allowedClassesForMapel.includes("*")) {
              // Guru mengajar mapel ini, TAPI tidak di kelas siswa ini
              isCellDisabled = true;
            }
          } else {
            // Guru ini TIDAK mengajar mapel ini (seharusnya tidak terjadi, tapi sbg pengaman)
            isCellDisabled = true;
          }
        }
        // --- AKHIR LOGIKA BARU ---
        
        html += `<td class="col-mapel">
            <input 
              type="number" 
              class="input-nilai" 
              min="0" 
              max="100" 
              placeholder="-"
              value="${nilai}"
              data-siswa-id="${siswa.id}" 
              data-mapel-id="${mapel.id}"
              ${isCellDisabled ? 'disabled' : ''} 
            >
          </td>`;
      });
      html += `<td class="col-total col-total-jumlah" id="jumlah_${siswa.id}">0</td>`;
      html += `<td class="col-total col-total-rata" id="rata_${siswa.id}">0.00</td>`;
      html += '</tr>';
    });
    html += '</tbody></table>';

    container.innerHTML = html;

    if (mapelCount > 0) {
      filteredSiswaList.forEach(siswa => {
        updateRowTotals(siswa.id, mapelCount);
      });
    }
  }

  function updateRowTotals(siswaId, mapelCount) {
    const jumlahCell = document.getElementById(`jumlah_${siswaId}`);
    const rataCell = document.getElementById(`rata_${siswaId}`);
    
    if (!jumlahCell || !rataCell) return;

    const rowInputs = document.querySelectorAll(`.input-nilai[data-siswa-id="${siswaId}"]`);
    
    let sum = 0;
    let count = 0; 

    rowInputs.forEach(input => {
      const value = input.value; 
      
      if (value !== "" && value !== null && value !== undefined) {
        const numValue = parseFloat(value);
        if (!isNaN(numValue) && numValue >= 0 && numValue <= 100) {
          sum += numValue;
          count++; 
        }
      }
    });

    const average = (count > 0) ? (sum / count) : 0;
    
    jumlahCell.innerText = sum;
    rataCell.innerText = average.toFixed(2);
  }

  function simpanInputNilai() {
    setTableInputLock('halaman-input-nilai-detail', true, 'Menyimpan nilai ujian...');
    undoManager.clearHistory();
    hideMessage('input-nilai-message');
    const tipeUjian = document.getElementById('judul-halaman-input-nilai').dataset.tipeUjian;
    const inputs = document.querySelectorAll('#input-nilai-table-container .input-nilai');
    const dataToSave = [];
    inputs.forEach(input => {
      dataToSave.push({ siswaId: input.dataset.siswaId, mapelId: input.dataset.mapelId, tipeUjian: tipeUjian, nilai: input.value });
    });
    google.script.run
      .withSuccessHandler((response) => onNilaiUjianSaved(response, dataToSave))
      .withFailureHandler(onGagal)
      .saveNilaiUjianBatch(getToken(), dataToSave);
  }

  // Fungsi callback untuk simpan nilai ujian (re-fetch juga butuh token)
  function onNilaiUjianSaved(response, savedData) {
    if (response.status === 'sukses') {
      setTableInputLock('halaman-input-nilai-detail', true, 'Sukses! Memuat ulang data...');
      isFormDirty = false;
      setIjazahDirty(true);
      const tipeUjian = document.getElementById('judul-halaman-input-nilai').dataset.tipeUjian;
      google.script.run.withSuccessHandler(onNilaiGridLoaded).withFailureHandler(onGagal).getNilaiUjianGridData(getToken(), tipeUjian);
    } else {
      setTableInputLock('halaman-input-nilai-detail', false);
      showMessage('input-nilai-message', response.message, true);
    }
  }

  function bukaHalamanRekapNilai() {
    tampilHalaman('halaman-rekap-nilai');
    hideMessage('rekap-nilai-message');
    document.getElementById('rekap-nilai-table-container').innerHTML = '<p>Memuat data...</p>';
    document.getElementById('rekap-nilai-filter-kelas').innerHTML = '<option value="semua">-- Tampilkan Semua Kelas --</option>';
    globalGridData = { siswaList: [], mapelList: [], nilaiRekapData: {} };
    setLoading(true, 'Membuat rekap...', false, false);
    google.script.run.withSuccessHandler(onRekapNilaiLoaded).withFailureHandler(onGagal).getRekapitulasiNilaiData(getToken());
  }

  function onRekapNilaiLoaded(response) {
    setLoading(false);
    const container = document.getElementById('rekap-nilai-table-container');
    
    if (response.status !== 'sukses') {
      container.innerHTML = `<p class="message error" style="display:block;">Gagal memuat data: ${response.message}</p>`;
      globalGridData = { siswaList: [], mapelList: [], nilaiRekapData: {} };
      return;
    }

    globalGridData = response.data;
    
    populateRekapNilaiFilter(globalGridData.siswaList);

    renderRekapNilaiTable();
  }

  function populateRekapNilaiFilter(siswaList) {
    const selectKelas = document.getElementById('rekap-nilai-filter-kelas');
    const selectedValue = selectKelas.value;
  
    const kelasSet = new Set(siswaList.map(siswa => siswa.kelas));
    const kelasList = Array.from(kelasSet).sort();
  
    let optionsHtml = '<option value="semua">-- Tampilkan Semua Kelas --</option>';
    kelasList.forEach(kelas => {
      optionsHtml += `<option value="${kelas}">${kelas}</option>`;
    });
  
    selectKelas.innerHTML = optionsHtml;
    selectKelas.value = selectedValue || (kelasList.length === 1 ? kelasList[0] : 'semua');
  }

  function renderRekapNilaiTable() {
    const container = document.getElementById('rekap-nilai-table-container');
    
    const { siswaList, mapelList, nilaiRekapData } = globalGridData;
    
    const selectedKelas = document.getElementById('rekap-nilai-filter-kelas').value;
    
    if (!siswaList || siswaList.length === 0) {
      container.innerHTML = '<p style="text-align: center; padding: 20px;">Belum ada data siswa.</p>';
      return;
    }
    
    if (!mapelList || mapelList.length === 0) {
      const tipeUjian = document.getElementById('judul-halaman-input-nilai').dataset.tipeUjian;
      const pesan = `Tidak ada mapel yang diatur untuk ${tipeUjian === 'UM' ? 'Ujian Sekolah/Madrasah' : 'Ujian Praktek'}. Harap centang di menu "Kelola Mapel".`;
      container.innerHTML = `<p style="text-align: center; padding: 20px;">${pesan}</p>`;
      return;
    }

    const filteredSiswaList = (selectedKelas === 'semua')
      ? siswaList
      : siswaList.filter(siswa => siswa.kelas === selectedKelas);

    if (filteredSiswaList.length === 0 && selectedKelas !== 'semua') {
        container.innerHTML = '<p style="text-align: center; padding: 20px;">Tidak ada siswa di kelas yang dipilih.</p>';
        return;
    } else if (filteredSiswaList.length === 0 && selectedKelas === 'semua') {
       container.innerHTML = '<p style="text-align: center; padding: 20px;">Tidak ada data siswa.</p>';
       return;
    }

    let html = '<table class="input-nilai-table">';
    
    html += '<thead><tr>';
    html += '<th>Nama Siswa</th>';
    mapelList.forEach(mapel => {
      html += `<th 
                class="col-mapel clickable-mapel-header" 
                data-mapel-nama="${mapel.nama}" 
                title="Klik untuk lihat nama mapel"
              >
                ${mapel.id}
              </th>`;
    });
    html += '<th class="th-total th-total-jumlah">Jumlah</th>';
    html += '<th class="th-total th-total-rata">Rata-Rata</th>';
    html += '<th class="th-total th-total-bulat">Pembulatan</th>';
    html += '</tr></thead>';
    
    html += '<tbody>';
    filteredSiswaList.forEach(siswa => {
      html += '<tr>';
      
      const namaProper = toProperCase(siswa.nama);
      const namaFormatted = formatNamaSiswa(namaProper);
      
      html += `
        <td>
          <span 
            class="clickable-nama-siswa" 
            data-nisn="${siswa.nisn}" 
            data-nama-lengkap="${siswa.nama}"
            title="Klik untuk lihat NISN"
          >
            ${namaFormatted}
          </span>
        </td>`;
      
      let sum = 0;
      let count = 0; 
      
      mapelList.forEach(mapel => {
        const key = `${siswa.id}_${mapel.id}`;
        const nilai = nilaiRekapData[key];
        
        let nilaiTampil = '-';
        if (nilai !== null && nilai !== undefined) {
            if (nilai === 0) {
              nilaiTampil = 0;
            } else {
              if (nilai % 1 === 0) {
                nilaiTampil = nilai.toFixed(0);
              } else {
                nilaiTampil = nilai.toFixed(2); 
              }
            }
            sum += nilai;
            count++; 
        }
        
        html += `<td class="col-mapel" style="text-align: center; font-weight: 500;">
            ${nilaiTampil}
          </td>`;
      });
      
      const average = (count > 0) ? (sum / count) : 0;
      
      const pembulatan = Math.round(average);
      const sumTampil = parseFloat(sum.toFixed(2));
      
      html += `<td class="col-total col-total-jumlah">${sumTampil}</td>`;
      html += `<td class="col-total col-total-rata">${average.toFixed(2)}</td>`;
      html += `<td class="col-total col-total-bulat">${pembulatan}</td>`;
      html += '</tr>';
    });
    html += '</tbody></table>';

    container.innerHTML = html;
  }

  function konfirmasiBersihkanNilai() {
    const title = "Konfirmasi Bersihkan Formulir";
    const message = "Ingin memulai lembar baru? <br><br>Ini akan <strong>mengosongkan semua nilai</strong> yang tampil di layar. Data yang sudah tersimpan di server <strong>tetap aman</strong>.";
    
    showConfirmationModal(title, message, bersihkanInputNilai, 'danger');
  }

  function bersihkanInputNilai() {
    const inputs = document.querySelectorAll('#input-nilai-table-container .input-nilai');
    
    const mapelCount = globalGridData.mapelList.length;
    
    const siswaIdsToUpdate = new Set();

    inputs.forEach(input => {
      input.value = '';
      siswaIdsToUpdate.add(input.dataset.siswaId);
    });

    isFormDirty = true; // <-- TAMBAHKAN INI

    if (mapelCount > 0) {
      siswaIdsToUpdate.forEach(siswaId => {
        updateRowTotals(siswaId, mapelCount);
      });
    }

    showMessage('input-nilai-message', 'Semua nilai di formulir telah dibersihkan.', false);
  }

  function bukaHalamanInputRapor() {
    tampilHalaman('halaman-input-rapor');
    setLoading(true, 'Memuat daftar semester...', false, false);
    document.getElementById('rapor-semester-card-container').innerHTML = '<p>Memuat...</p>';
    google.script.run.withSuccessHandler(onSemesterListLoaded).withFailureHandler(onGagal).getSemesterList(getToken());
  }

  function onSemesterListLoaded(response) {
    setLoading(false);
    const container = document.getElementById('rapor-semester-card-container');
    if (response.status !== 'sukses') {
      container.innerHTML = `<p class="message error" style="display:block;">${response.message}</p>`;
      return;
    }

    if (response.semesterList.length === 0) {
      container.innerHTML = '<p>Tidak ada daftar semester yang ditemukan. Periksa pengaturan jenjang dan semester.</p>';
      return;
    }

    let html = '';
    response.semesterList.forEach(semester => {
      const hoverStyle = `onmouseover="this.style.backgroundColor='${semester.color}'; this.style.color='white';" 
                          onmouseout="this.style.backgroundColor='white'; this.style.color='${semester.color}';"`;
      
      html += `
        <button class="dashboard-card" onclick="bukaHalamanInputRaporDetail('${semester.id}')" 
                style="color: ${semester.color || '#0d6efd'};" ${hoverStyle}>
          <i class="fas fa-edit"></i>
          <span>${semester.nama}</span>
        </button>
      `;
    });
    container.innerHTML = html;
  }

  function bukaHalamanInputRaporDetail(semesterId) {
    isFormDirty = false;
    tampilHalaman('halaman-input-rapor-detail');
    hideMessage('input-rapor-message');
    document.getElementById('input-rapor-table-container').innerHTML = '<p>Memuat data...</p>';
    document.getElementById('input-rapor-keterampilan-table-container').innerHTML = '<p>Memuat data...</p>';
    document.getElementById('rekap-rapor-semester-table-container').innerHTML = '<p>Memuat data...</p>';
    ['btn-simpan-input-rapor-p', 'btn-bersihkan-input-rapor-p', 'btn-simpan-input-rapor-k', 'btn-bersihkan-input-rapor-k']
      .forEach(id => document.getElementById(id).disabled = true);
    document.getElementById('input-rapor-filter-kelas').innerHTML = '<option value="semua">-- Tampilkan Semua Kelas --</option>';
    globalRaporData = { P: { siswaList: [], mapelList: [], nilaiData: {} }, K: { siswaList: [], mapelList: [], nilaiData: {} }, Rekap: { siswaList: [], mapelList: [], nilaiRekapData: {} } };
    const judulHalaman = document.getElementById('judul-halaman-input-rapor');
    judulHalaman.innerText = `Input Nilai Rapor...`;
    judulHalaman.dataset.semesterId = semesterId;
    setLoading(true, 'Memuat data nilai rapor...', false, false);
    google.script.run.withSuccessHandler(onNilaiRaporGridLoaded).withFailureHandler(onGagal).getNilaiRaporGridData(getToken(), semesterId);
  }

  function onNilaiRaporGridLoaded(response) {
    setLoading(false);
    
    // --- PERBAIKAN DI SINI: Ambil referensi tombol lagi ---
    const btnSimpanP = document.getElementById('btn-simpan-input-rapor-p');
    const btnBersihkanP = document.getElementById('btn-bersihkan-input-rapor-p');
    const btnSimpanK = document.getElementById('btn-simpan-input-rapor-k');
    const btnBersihkanK = document.getElementById('btn-bersihkan-input-rapor-k');
    // --- AKHIR PERBAIKAN ---

    if (response.status !== 'sukses') {
      document.getElementById('input-rapor-table-container').innerHTML = `<p class="message error" style="display:block;">Gagal memuat data: ${response.message}</p>`;
      document.getElementById('input-rapor-keterampilan-table-container').innerHTML = "";
      document.getElementById('rekap-rapor-semester-table-container').innerHTML = "";
      // (Tombol-tombol tetap nonaktif jika gagal)
      return;
    }

    if (response.namaSemester) {
        document.getElementById('judul-halaman-input-rapor').innerText = `Input Nilai ${response.namaSemester}`;
    }

    // Simpan 3 set data
    globalRaporData.P = response.dataP;
    globalRaporData.K = response.dataK;
    globalRaporData.Rekap = response.dataRekap;
    
    // Populate filter (cukup pakai 1 list siswa, misal P)
    populateNilaiRaporFilter(globalRaporData.P.siswaList);
    
    // Render 3 tabel
    renderNilaiRaporGridTable('P'); 
    renderNilaiRaporGridTable('K');
    renderRekapRaporSemesterTable();
    
    // Aktifkan tab pertama
    activateRaporTab('pengetahuan');
    
    // --- PERBAIKAN DI SINI: Aktifkan tombol jika data ada ---
    // Cek apakah tombol P perlu diaktifkan
    const { siswaList: siswaListP, mapelList: mapelListP } = globalRaporData.P;
    if (siswaListP && siswaListP.length > 0 && mapelListP && mapelListP.length > 0) {
      btnSimpanP.disabled = false;
      btnBersihkanP.disabled = false;
    }
    
    // Cek apakah tombol K perlu diaktifkan
    const { siswaList: siswaListK, mapelList: mapelListK } = globalRaporData.K;
    if (siswaListK && siswaListK.length > 0 && mapelListK && mapelListK.length > 0) {
      btnSimpanK.disabled = false;
      btnBersihkanK.disabled = false;
    }
    // --- AKHIR PERBAIKAN ---
  }
  
  function populateNilaiRaporFilter(siswaList) {
    const selectKelas = document.getElementById('input-rapor-filter-kelas');
    const selectedValue = selectKelas.value;
    const kelasSet = new Set(siswaList.map(siswa => siswa.kelas));
    const kelasList = Array.from(kelasSet).sort();
    let optionsHtml = '<option value="semua">-- Tampilkan Semua Kelas --</option>';
    kelasList.forEach(kelas => {
      optionsHtml += `<option value="${kelas}">${kelas}</option>`;
    });
    selectKelas.innerHTML = optionsHtml;
    selectKelas.value = selectedValue || (kelasList.length === 1 ? kelasList[0] : 'semua');
  }

  function renderNilaiRaporGridTable(tipeNilai) {
    const data = (tipeNilai === 'P') ? globalRaporData.P : globalRaporData.K;
    const containerId = (tipeNilai === 'P') ? 'input-rapor-table-container' : 'input-rapor-keterampilan-table-container';
    const totalIdPrefix = (tipeNilai === 'P') ? 'p' : 'k';

    const container = document.getElementById(containerId);
    const { siswaList, mapelList, nilaiData } = data;
    const selectedKelas = document.getElementById('input-rapor-filter-kelas').value;

    if (!siswaList || siswaList.length === 0) {
      container.innerHTML = '<p style="text-align: center; padding: 20px;">Belum ada data siswa.</p>';
      return;
    }
    if (!mapelList || mapelList.length === 0) {
      container.innerHTML = `<p style="text-align: center; padding: 20px;">Belum ada data mata pelajaran.</p>`;
      return;
    }

    const filteredSiswaList = (selectedKelas === 'semua')
      ? siswaList
      : siswaList.filter(siswa => siswa.kelas === selectedKelas);

    if (filteredSiswaList.length === 0) {
        container.innerHTML = '<p style="text-align: center; padding: 20px;">Tidak ada siswa di kelas yang dipilih.</p>';
        return;
    }

    let html = '<table class="input-nilai-table guru-view">';
    html += '<thead><tr><th>Nama Siswa</th>';
    mapelList.forEach(mapel => {
      html += `<th class="col-mapel clickable-mapel-header" data-mapel-nama="${mapel.nama}" title="Klik untuk lihat nama mapel">${mapel.id}</th>`;
    });
    html += '<th class="th-total th-total-jumlah">Jumlah</th>';
    html += '<th class="th-total th-total-rata">Rata-Rata</th>';
    html += '</tr></thead>';

    html += '<tbody>';
    filteredSiswaList.forEach(siswa => {
      html += '<tr>';
      const namaProper = toProperCase(siswa.nama);
      const namaFormatted = formatNamaSiswa(namaProper);
      html += `<td><span class="clickable-nama-siswa" data-nisn="${siswa.nisn}" data-nama-lengkap="${siswa.nama}" title="Klik untuk lihat NISN">${namaFormatted}</span></td>`;

      mapelList.forEach(mapel => {
        const key = `${siswa.id}_${mapel.id}`;
        const storedNilai = nilaiData[key];
        let nilai = '';
        if (storedNilai === 0 || storedNilai === '0') {
            nilai = 0;
        } else if (storedNilai) {
            nilai = storedNilai;
        }
        html += `<td class="col-mapel"><input type="number" class="input-nilai" min="0" max="100" placeholder="-" value="${nilai}" data-siswa-id="${siswa.id}" data-mapel-id="${mapel.id}"></td>`;
      });
      html += `<td class="col-total col-total-jumlah" id="jumlah_rapor_${totalIdPrefix}_${siswa.id}">0</td>`;
      html += `<td class="col-total col-total-rata" id="rata_rapor_${totalIdPrefix}_${siswa.id}">0.00</td>`;
      html += '</tr>';
    });
    html += '</tbody></table>';
    container.innerHTML = html;

    const mapelCount = mapelList.length;
    if (mapelCount > 0) {
      filteredSiswaList.forEach(siswa => {
        updateRowTotalsRapor(siswa.id, mapelCount, tipeNilai);
      });
    }
  }

  function updateRowTotalsRapor(siswaId, mapelCount, tipeNilai) {
    const containerSelector = (tipeNilai === 'P') ? '#input-rapor-table-container' : '#input-rapor-keterampilan-table-container';
    const totalIdPrefix = (tipeNilai === 'P') ? 'p' : 'k';
    
    const jumlahCell = document.getElementById(`jumlah_rapor_${totalIdPrefix}_${siswaId}`);
    const rataCell = document.getElementById(`rata_rapor_${totalIdPrefix}_${siswaId}`);
    if (!jumlahCell || !rataCell) return;

    const rowInputs = document.querySelectorAll(`${containerSelector} .input-nilai[data-siswa-id="${siswaId}"]`);
    
    let sum = 0;
    let count = 0; 
    rowInputs.forEach(input => {
      const value = input.value; 
      if (value !== "" && value !== null && value !== undefined) {
        const numValue = parseFloat(value);
        if (!isNaN(numValue) && numValue >= 0 && numValue <= 100) {
          sum += numValue;
          count++; 
        }
      }
    });
    
    const average = (count > 0) ? (sum / count) : 0;
    
    jumlahCell.innerText = sum;
    rataCell.innerText = average.toFixed(2);
  }

  function simpanInputNilaiRapor(tipeNilai) {
    const tipeText = (tipeNilai === 'P') ? 'Pengetahuan' : 'Keterampilan';
    setTableInputLock('halaman-input-rapor-detail', true, `Menyimpan nilai ${tipeText}...`);
    undoManager.clearHistory();
    hideMessage('input-rapor-message');
    const containerSelector = (tipeNilai === 'P') ? '#input-rapor-table-container' : '#input-rapor-keterampilan-table-container';
    const semesterId = document.getElementById('judul-halaman-input-rapor').dataset.semesterId;
    const inputs = document.querySelectorAll(`${containerSelector} .input-nilai`);
    const dataToSave = [];
    inputs.forEach(input => {
      dataToSave.push({ siswaId: input.dataset.siswaId, mapelId: input.dataset.mapelId, semesterId: semesterId, nilai: input.value });
    });
    google.script.run
      .withSuccessHandler((response) => onNilaiRaporSaved(response, tipeNilai, semesterId))
      .withFailureHandler(onGagal)
      .saveNilaiRaporBatch(getToken(), dataToSave, tipeNilai);
  }

  // Callback simpan rapor (perlu token untuk fetch ulang)
  function onNilaiRaporSaved(response, tipeNilai, semesterId) {
    if (response.status === 'sukses') {
      setLoading(true, 'Memperbarui rekap semester...', false);
      google.script.run.withSuccessHandler(onRekapSemesterUpdated).withFailureHandler(onGagal).getNilaiRaporGridData(getToken(), semesterId);
    } else {
      setTableInputLock('halaman-input-rapor-detail', false);
      showMessage('input-rapor-message', response.message, true);
    }
  }

  function onRekapSemesterUpdated(response) {
    // --- PERUBAHAN DI SINI ---
    // Ini adalah akhir dari keseluruhan proses save rapor, BUKA KUNCI.
    setTableInputLock('halaman-input-rapor-detail', false);
    // --- AKHIR PERUBAHAN ---

    if (response.status === 'sukses') {
      // Perbarui SEMUA data lokal (P, K, dan Rekap) dengan data baru
      isFormDirty = false; // <-- TAMBAHKAN INI
      setIjazahDirty(true);// <-- TAMBAHKAN INI
      globalRaporData.P = response.dataP;
      globalRaporData.K = response.dataK;
      globalRaporData.Rekap = response.dataRekap;
      
      // Render ulang SEMUA tiga tabel
      renderNilaiRaporGridTable('P');
      renderNilaiRaporGridTable('K');
      renderRekapRaporSemesterTable();
      
      console.log("Semua data Rapor (P, K, Rekap) telah diperbarui.");
      
      // Tampilkan pesan sukses
      showMessage('input-rapor-message', 'Nilai berhasil disimpan dan rekapitulasi telah diperbarui.', false);
      
    } else {
      // (setTableInputLock(false) sudah dipanggil di atas)
      showMessage('input-rapor-message', 'Gagal memperbarui rekap: ' + response.message, true);
    }
  }

  // --- FUNGSI DIPERBARUI: konfirmasiBersihkanNilaiRapor (Generik) ---
  function konfirmasiBersihkanNilaiRapor(tipeNilai) {
    const tipeText = (tipeNilai === 'P') ? 'Pengetahuan' : 'Keterampilan';
    const title = `Konfirmasi Bersihkan Formulir ${tipeText}`;
    const message = `Ini akan <strong>mengosongkan semua nilai ${tipeText}</strong> yang tampil di layar. Data yang sudah tersimpan <strong>tetap aman</strong>.`;
    
    // Kita gunakan closure untuk melewatkan tipeNilai
    const callback = function() {
      bersihkanInputNilaiRapor(tipeNilai);
    };
    
    showConfirmationModal(title, message, callback, 'danger');
  }

  // --- FUNGSI DIPERBARUI: bersihkanInputNilaiRapor (Generik) ---
  function bersihkanInputNilaiRapor(tipeNilai) {
    const containerSelector = (tipeNilai === 'P') ? '#input-rapor-table-container' : '#input-rapor-keterampilan-table-container';
    const data = (tipeNilai === 'P') ? globalRaporData.P : globalRaporData.K;
    
    const inputs = document.querySelectorAll(`${containerSelector} .input-nilai`);
    const mapelCount = data.mapelList.length;
    const siswaIdsToUpdate = new Set();

    inputs.forEach(input => {
      input.value = '';
      siswaIdsToUpdate.add(input.dataset.siswaId);
    });

    isFormDirty = true; // <-- TAMBAHKAN INI

    if (mapelCount > 0) {
      siswaIdsToUpdate.forEach(siswaId => {
        updateRowTotalsRapor(siswaId, mapelCount, tipeNilai);
      });
    }
    const tipeText = (tipeNilai === 'P') ? 'Pengetahuan' : 'Keterampilan';
    showMessage('input-rapor-message', `Formulir ${tipeText} telah dibersihkan.`, false);
  }

  function renderRekapRaporSemesterTable() {
    const container = document.getElementById('rekap-rapor-semester-table-container');
    const { siswaList, mapelList, nilaiRekapData } = globalRaporData.Rekap; 
    const selectedKelas = document.getElementById('input-rapor-filter-kelas').value;

    if (!siswaList || siswaList.length === 0) {
      container.innerHTML = '<p style="text-align: center; padding: 20px;">Belum ada data siswa.</p>';
      return;
    }
    if (!mapelList || mapelList.length === 0) {
      container.innerHTML = '<p style="text-align: center; padding: 20px;">Belum ada data mata pelajaran.</p>';
      return;
    }

    const filteredSiswaList = (selectedKelas === 'semua')
      ? siswaList
      : siswaList.filter(siswa => siswa.kelas === selectedKelas);

    if (filteredSiswaList.length === 0) {
        container.innerHTML = '<p style="text-align: center; padding: 20px;">Tidak ada siswa di kelas yang dipilih.</p>';
        return;
    }

    let html = '<table class="input-nilai-table guru-view">';

    html += '<thead><tr><th>Nama Siswa</th>';
    mapelList.forEach(mapel => {
      html += `<th class="col-mapel clickable-mapel-header" data-mapel-nama="${mapel.nama}" title="Klik untuk lihat nama mapel">${mapel.id}</th>`;
    });

    html += '<th class="th-total th-total-jumlah">Jumlah</th>';
    html += '<th class="th-total th-total-rata">Rata-Rata</th>';
    html += '<th class="th-total th-total-bulat">Pembulatan</th>';

    html += '</tr></thead>';

    html += '<tbody>';
    filteredSiswaList.forEach(siswa => {
      html += '<tr>';
      const namaProper = toProperCase(siswa.nama);
      const namaFormatted = formatNamaSiswa(namaProper);
      html += `<td><span class="clickable-nama-siswa" data-nisn="${siswa.nisn}" data-nama-lengkap="${siswa.nama}" title="Klik untuk lihat NISN">${namaFormatted}</span></td>`; 

      let sum = 0;
      let count = 0;

      mapelList.forEach(mapel => {
        const key = `${siswa.id}_${mapel.id}`;
        const nilai = nilaiRekapData[key];

        let nilaiTampil = '-';
        if (nilai !== null && nilai !== undefined) {
          nilaiTampil = nilai;

          sum += parseFloat(nilai);
          count++;
        }

        html += `<td class="col-mapel" style="text-align: center; font-weight: 500;">${nilaiTampil}</td>`;
      });

      const average = (count > 0) ? (sum / count) : 0;
      const pembulatan = Math.round(average);
      const sumTampil = parseFloat(sum.toFixed(2));

      html += `<td class="col-total col-total-jumlah">${sumTampil}</td>`;
      html += `<td class="col-total col-total-rata">${average.toFixed(2)}</td>`;
      html += `<td class="col-total col-total-bulat">${pembulatan}</td>`;

      html += '</tr>';
    });
    html += '</tbody></table>';

    container.innerHTML = html;
  }

  function bukaHalamanRekapRapor() {
    tampilHalaman('halaman-rekap-rapor');
    hideMessage('rekap-rapor-message');
    document.getElementById('rekap-rapor-table-container').innerHTML = '<p>Memuat data...</p>';
    document.getElementById('rekap-rapor-filter-kelas').innerHTML = '<option value="semua">-- Tampilkan Semua Kelas --</option>';
    globalRaporGridData = { siswaList: [], mapelList: [], nilaiRekapData: {} };
    setLoading(true, 'Membuat rekap...', false, false);
    google.script.run.withSuccessHandler(onRekapRaporLoaded).withFailureHandler(onGagal).getRekapitulasiNilaiRaporData(getToken());
  }

  function onRekapRaporLoaded(response) {
    setLoading(false);
    const container = document.getElementById('rekap-rapor-table-container');
    
    if (response.status !== 'sukses') {
      container.innerHTML = `<p class="message error" style="display:block;">Gagal memuat data: ${response.message}</p>`;
      globalRaporGridData = { siswaList: [], mapelList: [], nilaiRekapData: {} };
      return;
    }

    document.getElementById('judul-halaman-rekap-rapor').innerText = `Rekapitulasi Rapor (${response.data.jumlahSemester} Semester)`;

    globalRaporGridData = response.data;
    populateRekapRaporFilter(globalRaporGridData.siswaList);
    renderRekapRaporTable();
  }

  function populateRekapRaporFilter(siswaList) {
    const selectKelas = document.getElementById('rekap-rapor-filter-kelas');
    const selectedValue = selectKelas.value;
    const kelasSet = new Set(siswaList.map(siswa => siswa.kelas));
    const kelasList = Array.from(kelasSet).sort();
    let optionsHtml = '<option value="semua">-- Tampilkan Semua Kelas --</option>';
    kelasList.forEach(kelas => {
      optionsHtml += `<option value="${kelas}">${kelas}</option>`;
    });
    selectKelas.innerHTML = optionsHtml;
    selectKelas.value = selectedValue || (kelasList.length === 1 ? kelasList[0] : 'semua');
  }

  function renderRekapRaporTable() {
    const container = document.getElementById('rekap-rapor-table-container');
    const { siswaList, mapelList, nilaiRekapData } = globalRaporGridData; 
    const selectedKelas = document.getElementById('rekap-rapor-filter-kelas').value;

    if (!siswaList || siswaList.length === 0) {
      container.innerHTML = '<p style="text-align: center; padding: 20px;">Belum ada data siswa.</p>';
      return;
    }
    if (!mapelList || mapelList.length === 0) {
      container.innerHTML = '<p style="text-align: center; padding: 20px;">Belum ada data mata pelajaran.</p>';
      return;
    }

    const filteredSiswaList = (selectedKelas === 'semua')
      ? siswaList
      : siswaList.filter(siswa => siswa.kelas === selectedKelas);

    if (filteredSiswaList.length === 0) {
        container.innerHTML = '<p style="text-align: center; padding: 20px;">Tidak ada siswa di kelas yang dipilih.</p>';
        return;
    }

    let html = '<table class="input-nilai-table">';
    
    html += '<thead><tr><th>Nama Siswa</th>';
    mapelList.forEach(mapel => {
      html += `<th class="col-mapel clickable-mapel-header" data-mapel-nama="${mapel.nama}" title="Klik untuk lihat nama mapel">${mapel.id}</th>`;
    });
    html += '<th class="th-total th-total-jumlah">Jumlah</th>';
    html += '<th class="th-total th-total-rata">Rata-Rata</th>';
    html += '<th class="th-total th-total-bulat">Pembulatan</th>';
    html += '</tr></thead>';
    
    html += '<tbody>';
    filteredSiswaList.forEach(siswa => {
      html += '<tr>';
      const namaProper = toProperCase(siswa.nama);
      const namaFormatted = formatNamaSiswa(namaProper);
      html += `<td><span class="clickable-nama-siswa" data-nisn="${siswa.nisn}" data-nama-lengkap="${siswa.nama}" title="Klik untuk lihat NISN">${namaFormatted}</span></td>`; 
      
      let sum = 0;
      let count = 0;
      
      mapelList.forEach(mapel => {
        const key = `${siswa.id}_${mapel.id}`;
        const nilai = nilaiRekapData[key];
        
        let nilaiTampil = '-';
        if (nilai !== null && nilai !== undefined) {
            if (nilai === 0) {
              nilaiTampil = 0;
            } else {
              if (nilai % 1 !== 0) {
                nilaiTampil = nilai.toFixed(2); 
              } else {
                nilaiTampil = nilai.toFixed(0);
              }
            }
            sum += nilai;
            count++;
        }
        
        html += `<td class="col-mapel" style="text-align: center; font-weight: 500;">${nilaiTampil}</td>`;
      });
      
      const average = (count > 0) ? (sum / count) : 0;
      const pembulatan = Math.round(average);
      const sumTampil = parseFloat(sum.toFixed(2));
      
      html += `<td class="col-total col-total-jumlah">${sumTampil}</td>`;
      html += `<td class="col-total col-total-rata">${average.toFixed(2)}</td>`;
      html += `<td class="col-total col-total-bulat">${pembulatan}</td>`;
      html += '</tr>';
    });
    html += '</tbody></table>';

    container.innerHTML = html;
  }

  function bukaHalamanSemester() {
    tampilHalaman('halaman-semester');
    setLoading(true, 'Memuat pengaturan semester...', false, false);
    hideMessage('semester-message');
    document.getElementById('form-semester').reset();
    setFormDisabled('form-semester', true);
    document.getElementById('pilihan-semester').innerHTML = '<option value="">Memuat...</option>';
    google.script.run
      .withSuccessHandler(onSemesterSettingLoaded)
      .withFailureHandler(onGagal)
      .getSemesterSetting(getToken());
  }

  function onSemesterSettingLoaded(response) {
    setLoading(false);
    setFormDisabled('form-semester', false);
    const select = document.getElementById('pilihan-semester');
    select.innerHTML = '';
    select.disabled = false;
    document.getElementById('btn-simpan-semester').disabled = false;

    if (response.status !== 'sukses') {
      showMessage('semester-message', response.message, true);
      return;
    }

    const jenjang = response.jenjang;
    const setting = response.setting || 5;

    if (jenjang === 'SD/MI') {
      select.innerHTML = '<option value="5">5 Semester (Default)</option>';
      select.innerHTML += '<option value="3">3 Semester</option>';
    } else {
      select.innerHTML = '<option value="5">5 Semester (Otomatis)</option>';
      select.disabled = true;
      document.getElementById('btn-simpan-semester').disabled = true;
    }
    
    select.value = setting;
  }

  function simpanSemester() {
    setLoading(true, 'Menyimpan data semester...');
    hideMessage('semester-message');
    const nilaiSemester = document.getElementById('pilihan-semester').value;
    google.script.run
      .withSuccessHandler(onSemesterSettingSaved)
      .withFailureHandler(onGagal)
      .saveSemesterSetting(getToken(), nilaiSemester);
  }

  function onSemesterSettingSaved(response) {
    setLoading(false);
    if (response.status === 'sukses') {
      setIjazahDirty(true);// <-- TAMBAHKAN INI
      showMessage('semester-message', 'Pengaturan semester berhasil disimpan!', false);
    } else {
      showMessage('semester-message', response.message, true);
    }
  }

  function forceLogout(message) {
    const authContainer = document.getElementById('auth-container');
    if (authContainer && authContainer.style.display !== 'none') return;
    if (inactivityTimer) { clearTimeout(inactivityTimer); inactivityTimer = null; }
    showToast(message || 'Sesi berakhir.', 'gagal', 6000);
    google.script.run.prosesLogout(getToken());
    localStorage.removeItem('sessionToken');
    localStorage.removeItem(LAST_PAGE_KEY);
    globalSiswaList = [];
    globalGridData = { siswaList: [], mapelList: [], nilaiData: {} };
    globalRaporData = { P: { siswaList: [], mapelList: [], nilaiData: {} }, K: { siswaList: [], mapelList: [], nilaiData: {} }, Rekap: { siswaList: [], mapelList: [], nilaiRekapData: {} } };
    jenjangBaseCache = '';
    jenjangPilihanCache = '';
    tampilHalaman('halaman-login');
    setLoading(false);
    hideToast();
  }

  // --- FUNGSI BARU UNTUK RESET TIMER ---
  function resetInactivityTimer() {
    if (inactivityTimer) {
      clearTimeout(inactivityTimer);
    }
    
    // Cek jika kita di halaman login, jangan mulai timer
    const authContainer = document.getElementById('auth-container');
    if (authContainer && authContainer.style.display !== 'none') {
        inactivityTimer = null;
        return;
    }
    
    inactivityTimer = setTimeout(() => {
      // --- PERUBAHAN DI SINI ---
      forceLogout('Anda telah otomatis logout setelah 3 jam tidak aktif.');
      // --- AKHIR PERUBAHAN ---
    }, INACTIVITY_TIMEOUT_MS);
  }

  /**
   * FUNGSI BARU
   * Mengunci atau membuka form input nilai di halaman detail.
   * Ini akan menonaktifkan input & tombol, lalu menampilkan overlay,
   * tapi membiarkan tabel tetap bisa di-scroll.
   * @param {string} pageId - ID halaman ('halaman-input-nilai-detail' or 'halaman-input-rapor-detail')
   * @param {boolean} isLocked - True untuk mengunci, false untuk membuka.
   * @param {string} [message] - Pesan loading (opsional).
   */
  function setTableInputLock(pageId, isLocked, message = 'Menyimpan...') {
    const pageElement = document.getElementById(pageId);
    if (!pageElement) return;

    let inputs;
    let buttons;

    if (pageId === 'halaman-input-nilai-detail') {
      inputs = pageElement.querySelectorAll('.input-nilai');
      buttons = [
        document.getElementById('btn-simpan-input-nilai'),
        document.getElementById('btn-bersihkan-input-nilai')
      ];
    } else if (pageId === 'halaman-input-rapor-detail') {
      inputs = pageElement.querySelectorAll('.input-nilai');
      buttons = [
        document.getElementById('btn-simpan-input-rapor-p'),
        document.getElementById('btn-bersihkan-input-rapor-p'),
        document.getElementById('btn-simpan-input-rapor-k'),
        document.getElementById('btn-bersihkan-input-rapor-k')
      ];
    } else {
      return; // Halaman tidak didukung
    }

    if (isLocked) {
      // Tampilkan toast loading, TAPI JANGAN BLOKIR UI GLOBAL
      // (parameter ketiga `false` berarti jangan pakai global blocker)
      setLoading(true, message, false); 
      
      // Tambah class ke halaman untuk memicu overlay CSS
      pageElement.classList.add('loading-in-progress');

      // Nonaktifkan semua input dan tombol
      inputs.forEach(input => input.disabled = true);
      buttons.forEach(btn => btn.disabled = true);

    } else {
      // Sembunyikan toast
      setLoading(false); 
      
      // Hapus class loading
      pageElement.classList.remove('loading-in-progress');
      
      // Aktifkan kembali input dan tombol
      inputs.forEach(input => input.disabled = false);
      
      // Hanya enable tombol yang relevan (misal, jika ada data)
      if (pageId === 'halaman-input-nilai-detail') {
        const { siswaList, mapelList } = globalGridData;
        if (siswaList && siswaList.length > 0 && mapelList && mapelList.length > 0) {
          document.getElementById('btn-simpan-input-nilai').disabled = false;
          document.getElementById('btn-bersihkan-input-nilai').disabled = false;
        }
      } else if (pageId === 'halaman-input-rapor-detail') {
        const { siswaList: siswaP, mapelList: mapelP } = globalRaporData.P;
        if (siswaP && siswaP.length > 0 && mapelP && mapelP.length > 0) {
          document.getElementById('btn-simpan-input-rapor-p').disabled = false;
          document.getElementById('btn-bersihkan-input-rapor-p').disabled = false;
        }
        const { siswaList: siswaK, mapelList: mapelK } = globalRaporData.K;
        if (siswaK && siswaK.length > 0 && mapelK && mapelK.length > 0) {
          document.getElementById('btn-simpan-input-rapor-k').disabled = false;
          document.getElementById('btn-bersihkan-input-rapor-k').disabled = false;
        }
      }
    }
  }

  function bukaHalamanNilaiIjazah() {
    tampilHalaman('halaman-nilai-ijazah');
    hideMessage('nilai-ijazah-message');
    document.getElementById('ijazah-ujian-table-container').innerHTML = '<p>Memuat data...</p>';
    document.getElementById('ijazah-rapor-table-container').innerHTML = '<p>Memuat data...</p>';
    document.getElementById('ijazah-final-table-container').innerHTML = '<p>Memuat data...</p>';
    document.getElementById('ijazah-filter-kelas').innerHTML = '<option value="semua">-- Tampilkan Semua Kelas --</option>';
    globalIjazahData = { siswaList: [], mapelList: [], dataUjian: {}, dataRapor: {}, dataIjazah: {} };
    showWeightedUjian = true; showWeightedRapor = true;
    document.querySelector('#ijazah-tab-bar .tab-link[data-tab="ujian"]').innerText = 'Nilai Ujian (...)';
    document.querySelector('#ijazah-tab-bar .tab-link[data-tab="rapor"]').innerText = 'Nilai Rapor (...)';
    document.querySelector('#ijazah-tab-bar .tab-link[data-tab="ijazah"]').innerText = 'Nilai Ijazah (...)';
    setLoading(true, 'Memuat nilai ijazah...', false, false);
    google.script.run.withSuccessHandler(onNilaiIjazahLoaded).withFailureHandler(onGagal).getNilaiIjazahData(getToken());
  }

  function onNilaiIjazahLoaded(response) {
    setLoading(false);
    
    const btnToggleUjian = document.getElementById('btn-toggle-ujian-view');
    const btnToggleRapor = document.getElementById('btn-toggle-rapor-view');
    
    const exportControlsUjian = document.getElementById('export-controls-ujian');
    const exportControlsRapor = document.getElementById('export-controls-rapor');
    const exportControlsIjazah = document.getElementById('export-controls-ijazah');

    const infoUpdateEl = document.getElementById('ijazah-info-update');
    infoUpdateEl.style.display = 'none';

    if (response.status !== 'sukses') {
      document.getElementById('ijazah-ujian-table-container').innerHTML = `<p class="message error" style="display:block;">Gagal memuat data: ${response.message}</p>`;
      document.getElementById('ijazah-rapor-table-container').innerHTML = '';
      document.getElementById('ijazah-final-table-container').innerHTML = '';
      globalIjazahData = { siswaList: [], mapelList: [], dataUjian: {}, dataRapor: {}, dataIjazah: {} };
      
      const tabUjian = document.querySelector('#ijazah-tab-bar .tab-link[data-tab="ujian"]');
      if (tabUjian) tabUjian.innerText = 'Nilai Ujian (Gagal)';
      const tabRapor = document.querySelector('#ijazah-tab-bar .tab-link[data-tab="rapor"]');
      if (tabRapor) tabRapor.innerText = 'Nilai Rapor (Gagal)';
      const tabIjazah = document.querySelector('#ijazah-tab-bar .tab-link[data-tab="ijazah"]');
      if (tabIjazah) tabIjazah.innerText = 'Nilai Ijazah (Gagal)';
      
      if (btnToggleUjian) btnToggleUjian.style.display = 'none';
      if (btnToggleRapor) btnToggleRapor.style.display = 'none';
      
      if (exportControlsUjian) exportControlsUjian.style.display = 'none';
      if (exportControlsRapor) exportControlsRapor.style.display = 'none';
      if (exportControlsIjazah) exportControlsIjazah.style.display = 'none';

      if (response.message.includes("belum pernah dikalkulasi")) {
        showToast(response.message, 'gagal');
      }
      return;
    }

    if (btnToggleUjian) {
      btnToggleUjian.style.display = 'inline-flex';
      btnToggleUjian.innerText = 'Lihat Nilai Asli';
      btnToggleUjian.classList.remove('toggled');
      document.querySelector('#tab-ujian-content .table-content-header').innerText = 'Nilai Ujian (Setelah Diberi Bobot)';
    }
    if (btnToggleRapor) {
      btnToggleRapor.style.display = 'inline-flex';
      btnToggleRapor.innerText = 'Lihat Nilai Asli';
      btnToggleRapor.classList.remove('toggled');
      document.querySelector('#tab-rapor-content .table-content-header').innerText = 'Nilai Rapor (Setelah Diberi Bobot)';
    }

    const bobotUjian = response.data.bobotUjianPct || 0;
    const bobotRapor = response.data.bobotRaporPct || 0;
    const kkmValue = response.data.kkm || 0;
    
    const tabUjian = document.querySelector('#ijazah-tab-bar .tab-link[data-tab="ujian"]');
    if (tabUjian) {
      tabUjian.innerText = `Nilai Ujian (${bobotUjian}%)`;
    }
    
    const tabRapor = document.querySelector('#ijazah-tab-bar .tab-link[data-tab="rapor"]');
    if (tabRapor) {
      tabRapor.innerText = `Nilai Rapor (${bobotRapor}%)`;
    }
    
    const tabIjazah = document.querySelector('#ijazah-tab-bar .tab-link[data-tab="ijazah"]');
    if (tabIjazah) {
      tabIjazah.innerText = `Nilai Ijazah (${kkmValue})`;
    }

    globalIjazahData = response.data;
    
    populateNilaiIjazahFilter(globalIjazahData.siswaList);

    renderNilaiIjazahTabel('ujian');
    renderNilaiIjazahTabel('rapor');
    renderNilaiIjazahTabel('ijazah');
    
    if (exportControlsUjian) exportControlsUjian.style.display = 'flex';
    if (exportControlsRapor) exportControlsRapor.style.display = 'flex';
    if (exportControlsIjazah) exportControlsIjazah.style.display = 'flex';
    
    activateIjazahTab('ujian');
  }

  function populateNilaiIjazahFilter(siswaList) {
    const selectKelas = document.getElementById('ijazah-filter-kelas');
    const selectedValue = selectKelas.value;
  
    const kelasSet = new Set(siswaList.map(siswa => siswa.kelas));
    const kelasList = Array.from(kelasSet).sort();
  
    let optionsHtml = '<option value="semua">-- Tampilkan Semua Kelas --</option>';
    kelasList.forEach(kelas => {
      optionsHtml += `<option value="${kelas}">${kelas}</option>`;
    });
  
    selectKelas.innerHTML = optionsHtml;
    selectKelas.value = selectedValue || (kelasList.length === 1 ? kelasList[0] : 'semua');
  }

  function activateIjazahTab(tabName) {
    const page = document.getElementById('halaman-nilai-ijazah');

    const tabClasses = ['tab-ujian-active', 'tab-rapor-active', 'tab-ijazah-active'];
    let newActiveClass = '';

    page.querySelectorAll('.tab-link').forEach(link => {
      link.classList.remove('active');
    });

    page.querySelectorAll('.tab-content').forEach(content => {
      content.classList.remove('active');
    });

    page.querySelector(`.tab-link[data-tab="${tabName}"]`).classList.add('active');
    page.querySelector(`#tab-${tabName}-content`).classList.add('active');
    
    if (tabName === 'ujian') {
      newActiveClass = 'tab-ujian-active';
    } else if (tabName === 'rapor') {
      newActiveClass = 'tab-rapor-active';
    } else if (tabName === 'ijazah') {
      newActiveClass = 'tab-ijazah-active';
    }
    
    page.classList.remove(...tabClasses);
    if (newActiveClass) {
      page.classList.add(newActiveClass);
    }
  }

  function renderNilaiIjazahTabel(tipeTabel) {
    let container;
    let nilaiDataMap;
    let showStatusColumn = false;
    let useOriginal = false;

    if (tipeTabel === 'ujian') {
      container = document.getElementById('ijazah-ujian-table-container');
      useOriginal = !showWeightedUjian;
      nilaiDataMap = useOriginal ? globalIjazahData.dataUjianOriginal : globalIjazahData.dataUjian;
    } else if (tipeTabel === 'rapor') {
      container = document.getElementById('ijazah-rapor-table-container');
      useOriginal = !showWeightedRapor;
      nilaiDataMap = useOriginal ? globalIjazahData.dataRaporOriginal : globalIjazahData.dataRapor;
    } else {
      container = document.getElementById('ijazah-final-table-container');
      nilaiDataMap = globalIjazahData.dataIjazah;
      showStatusColumn = true; 
    }
    
    const { siswaList, mapelList, kkm } = globalIjazahData; 
    const kkmValue = kkm || 76; 
    
    const selectedKelas = document.getElementById('ijazah-filter-kelas').value;
    
    if (!siswaList || siswaList.length === 0) {
      container.innerHTML = '<p style="text-align: center; padding: 20px;">Belum ada data siswa.</p>';
      return;
    }
    if (!mapelList || mapelList.length === 0) {
      container.innerHTML = `<p style="text-align: center; padding: 20px;">Belum ada mapel yang diatur untuk Ijazah.</p>`;
      return;
    }

    const filteredSiswaList = (selectedKelas === 'semua')
      ? siswaList
      : siswaList.filter(siswa => siswa.kelas === selectedKelas);

    if (filteredSiswaList.length === 0) {
        container.innerHTML = '<p style="text-align: center; padding: 20px;">Tidak ada siswa di kelas yang dipilih.</p>';
        return;
    }

    let html = '<table class="input-nilai-table guru-view">';
    html += '<thead><tr><th>Nama Siswa</th>';
    mapelList.forEach(mapel => {
      html += `<th class="col-mapel clickable-mapel-header" data-mapel-nama="${mapel.nama}" title="Klik untuk lihat nama mapel">${mapel.id}</th>`;
    });
    html += '<th class="th-total th-total-jumlah">Jumlah</th>';
    html += '<th class="th-total th-total-rata">Rata-Rata</th>';
    if (showStatusColumn) { 
      html += '<th class="th-total th-total-bulat">Status</th>'; 
    }
    html += '</tr></thead>';
    
    html += '<tbody>';
    filteredSiswaList.forEach(siswa => {
      html += '<tr>';
      const namaProper = toProperCase(siswa.nama);
      const namaFormatted = formatNamaSiswa(namaProper);
      html += `<td><span class="clickable-nama-siswa" data-nisn="${siswa.nisn}" data-nama-lengkap="${siswa.nama}" title="Klik untuk lihat NISN">${namaFormatted}</span></td>`; 
      
      let sum = 0;
      let count = 0;
      
      mapelList.forEach(mapel => {
        const key = `${siswa.id}_${mapel.id}`;
        const nilai = nilaiDataMap[key];
        
        let nilaiTampil = '-';
        if (nilai !== null && nilai !== undefined) {
            const nilaiAngka = parseFloat(nilai);
            
            if (tipeTabel === 'ijazah' || useOriginal) {
              nilaiTampil = Math.round(nilaiAngka);
              sum += Math.round(nilaiAngka);
            } else {
              nilaiTampil = nilaiAngka.toFixed(2);
              sum += nilaiAngka;
            }
            count++;
        }
        
        html += `<td class="col-mapel" style="text-align: center; font-weight: 500;">${nilaiTampil}</td>`;
      });
      
      const average = (count > 0) ? (sum / count) : 0;
      
      if (tipeTabel === 'ijazah' || useOriginal) {
         html += `<td class="col-total col-total-jumlah">${Math.round(sum)}</td>`;
      } else {
         html += `<td class="col-total col-total-jumlah">${sum.toFixed(2)}</td>`;
      }

      html += `<td class="col-total col-total-rata">${average.toFixed(2)}</td>`;
      
      if (showStatusColumn) { 
        let statusText = '';
        let statusClass = '';
        
        const nilaiAkhirIjazah = (count > 0) ? (sum / count) : 0;
        
        if (nilaiAkhirIjazah >= kkmValue) {
          statusText = 'LULUS';
          statusClass = 'status-lulus';
        } else {
          statusText = 'TIDAK LULUS';
          statusClass = 'status-tidak-lulus';
        }
        html += `<td class="col-total col-total-bulat ${statusClass}">${statusText}</td>`; 
      }
      
      html += '</tr>';
    });
    html += '</tbody></table>';

    container.innerHTML = html;
  }

  function toggleUjianView() {
    showWeightedUjian = !showWeightedUjian;
    const btn = document.getElementById('btn-toggle-ujian-view');
    const header = document.querySelector('#tab-ujian-content .table-content-header');
    
    if (showWeightedUjian) {
      btn.innerText = 'Lihat Nilai Asli';
      btn.classList.remove('toggled');
      header.innerText = 'Nilai Ujian (Setelah Diberi Bobot)';
    } else {
      btn.innerText = 'Lihat Nilai Bobot';
      btn.classList.add('toggled');
      header.innerText = 'Nilai Ujian (Asli/Sebelum Bobot)';
    }
    
    renderNilaiIjazahTabel('ujian');
  }

  function toggleRaporView() {
    showWeightedRapor = !showWeightedRapor;
    const btn = document.getElementById('btn-toggle-rapor-view');
    const header = document.querySelector('#tab-rapor-content .table-content-header');
    
    if (showWeightedRapor) {
      btn.innerText = 'Lihat Nilai Asli';
      btn.classList.remove('toggled');
      header.innerText = 'Nilai Rapor (Setelah Diberi Bobot)';
    } else {
      btn.innerText = 'Lihat Nilai Bobot';
      btn.classList.add('toggled');
      header.innerText = 'Nilai Rapor (Asli/Sebelum Bobot)';
    }
    
    renderNilaiIjazahTabel('rapor');
  }

  function setMapelOrderDirty(isDirty) {
    isMapelOrderDirty = isDirty;
    updateMapelFloatingActions();
  }

  function onMapelUrutanSaved(response) {
    setLoading(false);
    if (response.status === 'sukses') {
      globalMapelList.forEach(m => {
        m.originalUrutan = m.urutan;
      });
      setMapelOrderDirty(false); 
      isFormDirty = false; 
      showMessage('mapel-message', 'Urutan mapel berhasil disimpan!', false);
    } else {
      showMessage('mapel-message', response.message, true);
    }
  }

  function checkMapelDirtyState() {
    if (!globalMapelList) return;

    let orderIsDirty = false;
    let tipeIsDirty = false;

    const currentTipeState = new Map();
    document.querySelectorAll('#mapel-table-container .mapel-tipe-cek').forEach(cb => {
      const id = cb.dataset.id;
      const tipe = cb.dataset.tipe;
      if (!currentTipeState.has(id)) {
        currentTipeState.set(id, { isUS: false, isUP: false });
      }
      if (tipe === 'us') currentTipeState.get(id).isUS = cb.checked;
      if (tipe === 'up') currentTipeState.get(id).isUP = cb.checked;
    });

    for (const mapel of globalMapelList) {
      if (mapel.urutan != mapel.originalUrutan) {
        orderIsDirty = true;
      }
      
      const currentTipes = currentTipeState.get(mapel.id);
      if (currentTipes) {
        if (currentTipes.isUS != mapel.originalIsUS || currentTipes.isUP != mapel.originalIsUP) {
          tipeIsDirty = true;
        }
      }

      if (orderIsDirty && tipeIsDirty) break;
    }
    
    setMapelOrderDirty(orderIsDirty);
    setMapelTipeDirty(tipeIsDirty);
    
    if (orderIsDirty || tipeIsDirty) {
      isFormDirty = true;
    }
  }

  function updateMapelFloatingActions() {
    const container = document.getElementById('mapel-floating-actions');
    const tableContainer = document.getElementById('mapel-table-container');
    if (!container || !tableContainer) return;
    
    const btnUrutan = document.getElementById('btn-simpan-urutan-mapel');
    const btnTipe = document.getElementById('btn-simpan-tipe-ujian');
    
    btnUrutan.disabled = !isMapelOrderDirty;
    btnTipe.disabled = !isMapelTipeDirty;
    
    if (isMapelOrderDirty || isMapelTipeDirty) {
      container.classList.add('show-actions');
      tableContainer.classList.add('table-container-with-actions');
    } else {
      container.classList.remove('show-actions');
      tableContainer.classList.remove('table-container-with-actions');
    }
  }

  function cancelMapelChanges() {
    if (!globalMapelList) return;

    globalMapelList.forEach(m => {
      m.urutan = m.originalUrutan;
      m.isUS = m.originalIsUS;
      m.isUP = m.originalIsUP;
    });
    
    globalMapelList.sort((a,b) => a.urutan - b.urutan);
    
    onMapelLoaded({ status: "sukses", mapel: globalMapelList, isReRender: true });
    
    setMapelOrderDirty(false);
    setMapelTipeDirty(false);
    isFormDirty = false; 
    
    showMessage('mapel-message', 'Perubahan dibatalkan.', false);
  }

  function checkSiswaDirtyState() {
    if (!globalSiswaList) return;

    let orderIsDirty = false;
    for (const siswa of globalSiswaList) {
      if (siswa.urutan != siswa.originalUrutan) {
        orderIsDirty = true;
        break;
      }
    }
    
    setSiswaOrderDirty(orderIsDirty);
    if (orderIsDirty) {
      isFormDirty = true;
    }
  }

  function updateSiswaFloatingActions() {
    const container = document.getElementById('siswa-floating-actions');
    const tableContainer = document.getElementById('siswa-table-container');
    if (!container || !tableContainer) return;
    
    const btnUrutan = document.getElementById('btn-simpan-urutan-siswa');
    
    btnUrutan.disabled = !isSiswaOrderDirty;
    
    if (isSiswaOrderDirty) {
      container.classList.add('show-actions');
      tableContainer.classList.add('table-container-with-actions');
    } else {
      container.classList.remove('show-actions');
      tableContainer.classList.remove('table-container-with-actions');
    }
  }

  function cancelSiswaChanges() {
    if (!globalSiswaList) return;

    globalSiswaList.forEach(s => {
      s.urutan = s.originalUrutan;
    });
    
    setSiswaOrderDirty(false);
    isFormDirty = false; 
    
    applySiswaFiltersAndRender();
    
    showMessage('siswa-message', 'Urutan siswa dikembalikan.', false);
  }

  function setExportButtonsLoading(isLoading, button) {
    const allExportButtons = document.querySelectorAll('#halaman-nilai-ijazah .btn-export-icon');
    
    if (isLoading && button) {
      allExportButtons.forEach(btn => {
        if (btn !== button) {
          btn.disabled = true;
          btn.style.opacity = '0.5';
        }
      });
      setButtonLoading(button, '');
      button.style.width = '40px'; 
    } else {
      allExportButtons.forEach(btn => {
        btn.disabled = false;
        btn.style.opacity = '1';
        if (btn.classList.contains('loading')) {
          resetButtonLoading(btn);
        }
      });
    }
  }

  function handleExportClick(button, tipeFile, tipeData) {
    if (button.disabled) return;
    setExportButtonsLoading(true, button);
    const kelasFilter = document.getElementById('ijazah-filter-kelas').value;
    let isWeighted = true;
    if (tipeData === 'ujian') isWeighted = showWeightedUjian;
    else if (tipeData === 'rapor') isWeighted = showWeightedRapor;
    google.script.run.withSuccessHandler(onDataExported).withFailureHandler(onGagalExport).exportDataIjazah(getToken(), tipeFile, tipeData, kelasFilter, isWeighted);
  }

  function onDataExported(response) {
    setExportButtonsLoading(false, null);

    if (response.status === 'sukses') {
      showToast('File ekspor berhasil dibuat. Mengunduh...', 'sukses');
      try {
        const dataUrl = `data:${response.mimeType};base64,${response.base64}`;
        const link = document.createElement('a');
        link.setAttribute('href', dataUrl);
        link.setAttribute('download', response.fileName);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      } catch (e) {
        showToast('Gagal memproses unduhan: ' + e.message, 'gagal');
      }
    } else {
      showToast('Gagal membuat file ekspor: ' + response.message, 'gagal');
    }
  }

  function onGagalExport(error) {
    setExportButtonsLoading(false, null);
    onGagal(error);
  }

  function onUpdateSemuaDataSukses(response) {
    setLoading(false);
    if (response.status === 'sukses') {
      showToast('Semua data berhasil diperbarui dari server.', 'sukses');
      
      // Muat ulang data di halaman saat ini (jika bukan dashboard)
      const currentPage = localStorage.getItem(LAST_PAGE_KEY) || 'halaman-utama';
      if (currentPage !== 'halaman-utama') {
        // Trik untuk memaksa halaman memuat ulang datanya:
        // Pindah ke dashboard, lalu langsung kembali ke halaman saat ini.
        // Ini akan memicu fungsi getSiswa(), getMapel(), dll.
        bukaHalamanTersimpan('halaman-utama'); 
        setTimeout(() => {
          bukaHalamanTersimpan(currentPage);
        }, 100);
      }
    } else {
      showToast('Gagal memperbarui data: ' + response.message, 'gagal');
    }
  }

  // Update untuk fungsi rekalkulasi
  function jalankanRekalkulasiIjazah() {
    const btn = document.getElementById('btn-recalculate-ijazah');
    setButtonLoading(btn, 'Menghitung...');
    google.script.run
      .withSuccessHandler(onRekalkulasiIjazahSukses)
      .withFailureHandler(onGagalRekalkulasiIjazah)
      .recalculateIjazahData(getToken());
  }

  function onRekalkulasiIjazahSukses(response) {
    const btn = document.getElementById('btn-recalculate-ijazah');
    resetButtonLoading(btn);

    if (response.status === 'sukses') {
      // Server akan mengirim { isDirty: false }
      setIjazahDirty(response.isDirty); 
      
      showToast(response.message, 'sukses');
      bukaHalamanNilaiIjazah();
    } else {
      // Server akan mengirim { isDirty: true } jika gagal
      if (response.isDirty) {
        setIjazahDirty(response.isDirty); 
      }
      showToast('Gagal menghitung: ' + response.message, 'gagal');
    }
  }

  function onGagalRekalkulasiIjazah(error) {
    const btn = document.getElementById('btn-recalculate-ijazah');
    resetButtonLoading(btn);
    onGagal(error); 
  }

  /**
   * Menandai bahwa data sumber ijazah telah berubah (dirty).
   * @param {boolean} isDirty 
   */
  function setIjazahDirty(isDirty) {
    if (isDirty) {
      localStorage.setItem('ijazahDataIsDirty', 'true');
      console.log('Ijazah data flagged as DIRTY.');
    } else {
      localStorage.removeItem('ijazahDataIsDirty');
      console.log('Ijazah data flagged as CLEAN.');
    }
    updateRecalculateButtonState();
  }

  /**
   * Memperbarui tampilan visual tombol DAN TEKS berdasarkan status 'dirty'.
   */
  function updateRecalculateButtonState() {
    const isDirty = localStorage.getItem('ijazahDataIsDirty') === 'true';
    
    const btnRecalcDashboard = document.getElementById('btn-buka-nilai-ijazah');
    const btnRecalcPage = document.getElementById('btn-recalculate-ijazah');
    const textReminder = document.getElementById('btn-recalculate-ijazah-text');
    
    if (isDirty) {
      if (btnRecalcDashboard) btnRecalcDashboard.classList.add('btn-dirty-state');
      if (btnRecalcPage) btnRecalcPage.classList.add('btn-dirty-state');
      
      // Tampilkan teks pengingat
      if (textReminder) {
        textReminder.style.display = 'inline-block';
      }
    } else {
      if (btnRecalcDashboard) btnRecalcDashboard.classList.remove('btn-dirty-state');
      if (btnRecalcPage) btnRecalcPage.classList.remove('btn-dirty-state');

      // Sembunyikan teks pengingat
      if (textReminder) {
        textReminder.style.display = 'none';
      }
    }
  }

  /**
   * Helper untuk memeriksa 'isFormDirty' sebelum pindah halaman.
   * @param {function} targetPageFunction Fungsi yang akan dijalankan jika bersih (misal: bukaHalamanInputUjian)
   */
  function handleNavigationConfirm(targetPageFunction) {
    if (isFormDirty) {
      const callback = function() {
        isFormDirty = false; // Reset flag
        targetPageFunction(); // Lanjutkan navigasi
      };
      showConfirmationModal(
        "Perubahan Belum Disimpan", 
        "Anda memiliki <strong>perubahan nilai yang belum disimpan</strong> di halaman ini. Jika Anda pindah halaman, perubahan tersebut akan hilang.<br><br>Yakin ingin tetap pindah?",
        callback, 
        'danger' 
      );
    } else {
      targetPageFunction(); // Langsung navigasi jika form bersih
    }
  }

  let globalValidationData = {
    siswaList: [],
    requiredSemesters: [],
    validationData: {}
  };

  function bukaHalamanValidasi() {
    tampilHalaman('halaman-validasi-nilai');
    hideMessage('validasi-message');
    document.getElementById('validasi-nilai-table-container').innerHTML = '<p>Memeriksa kelengkapan...</p>';
    document.getElementById('validasi-filter-kelas').innerHTML = '<option value="semua">-- Tampilkan Semua Kelas --</option>';
    globalValidationData = { siswaList: [], validationData: {} };
    setLoading(true, 'Memvalidasi...', false, false);
    google.script.run.withSuccessHandler(onValidasiDataLoaded).withFailureHandler(onGagal).getValidationData(getToken());
  }

  function onValidasiDataLoaded(response) {
    setLoading(false);
    const container = document.getElementById('validasi-nilai-table-container');
    
    if (response.status !== 'sukses') {
      container.innerHTML = `<p class="message error" style="display:block;">Gagal memuat data validasi: ${response.message}</p>`;
      globalValidationData = { siswaList: [], requiredSemesters: [], validationData: {} };
      return;
    }

    globalValidationData = response.data;
    populateValidasiFilter(globalValidationData.siswaList);
    renderValidasiTable();
  }

  function populateValidasiFilter(siswaList) {
    const selectKelas = document.getElementById('validasi-filter-kelas');
    const selectedValue = selectKelas.value;
  
    const kelasSet = new Set(siswaList.map(siswa => siswa.kelas));
    const kelasList = Array.from(kelasSet).sort();
  
    let optionsHtml = '<option value="semua">-- Tampilkan Semua Kelas --</option>';
    kelasList.forEach(kelas => {
      optionsHtml += `<option value="${kelas}">${kelas}</option>`;
    });
  
    selectKelas.innerHTML = optionsHtml;
    selectKelas.value = selectedValue || (kelasList.length === 1 ? kelasList[0] : 'semua');
  }

  function renderValidasiTable() {
    const container = document.getElementById('validasi-nilai-table-container');
    const { siswaList, validationData, requiredSemesters } = globalValidationData;
    const selectedKelas = document.getElementById('validasi-filter-kelas').value;

    if (!siswaList || siswaList.length === 0) {
      container.innerHTML = '<p style="text-align: center; padding: 20px;">Belum ada data siswa.</p>';
      return;
    }

    const filteredSiswaList = (selectedKelas === 'semua')
      ? siswaList
      : siswaList.filter(siswa => siswa.kelas === selectedKelas);

    if (filteredSiswaList.length === 0) {
        container.innerHTML = '<p style="text-align: center; padding: 20px;">Tidak ada siswa di kelas yang dipilih.</p>';
        return;
    }
    
    const firstSiswaValidasi = validationData[filteredSiswaList[0].id];
    if (!firstSiswaValidasi) {
      container.innerHTML = '<p style="text-align: center; padding: 20px;">Data validasi tidak ditemukan untuk siswa.</p>';
      return;
    }

    const hasUM = firstSiswaValidasi.ujian.hasOwnProperty('UM');
    const hasUP = firstSiswaValidasi.ujian.hasOwnProperty('UP');
    const jenjangPilihan = jenjangPilihanCache;
    const labelUjian = (jenjangPilihan === 'MI' || jenjangPilihan === 'MTS' || jenjangPilihan === 'MA') ? 'UM' : 'US';

    let html = '<table class="input-nilai-table">';
    html += '<thead><tr>';
    html += '<th>Nama Siswa</th>';
    html += '<th>Kelas</th>';
    
    const namaUjianLengkap = (labelUjian === 'UM') ? 'Ujian Madrasah' : 'Ujian Sekolah';

    if (hasUM) {
      html += `<th class="col-validasi-header col-validasi-ujian clickable-mapel-header" data-mapel-nama="${namaUjianLengkap}" title="Klik untuk lihat nama mapel">${labelUjian}</th>`;
    }
    if (hasUP) {
      html += `<th class="col-validasi-header col-validasi-ujian clickable-mapel-header" data-mapel-nama="Ujian Praktek" title="Klik untuk lihat nama mapel">UP</th>`;
    }
    
    requiredSemesters.forEach(semester => {
      const shortCodeP = `${semester.shortCode}.P`;
      const fullNameP = `${semester.nama} (Pengetahuan)`;
      const shortCodeK = `${semester.shortCode}.K`;
      const fullNameK = `${semester.nama} (Keterampilan)`;
      
      html += `<th class="col-validasi-header col-validasi-rapor clickable-mapel-header" data-mapel-nama="${fullNameP}" title="Klik untuk lihat nama mapel">${shortCodeP}</th>`;
      html += `<th class="col-validasi-header col-validasi-rapor clickable-mapel-header" data-mapel-nama="${fullNameK}" title="Klik untuk lihat nama mapel">${shortCodeK}</th>`;
    });
    
    html += '</tr></thead>';
    
    html += '<tbody>';
    filteredSiswaList.forEach(siswa => {
      html += '<tr>';
      
      const namaProper = toProperCase(siswa.nama);
      const namaFormatted = formatNamaSiswa(namaProper);
      
      html += `
        <td>
          <span 
            class="clickable-nama-siswa" 
            data-nisn="${siswa.nisn}" 
            data-nama-lengkap="${siswa.nama}"
            title="Klik untuk lihat NISN"
          >
            ${namaFormatted}
          </span>
        </td>`;
      
      html += `<td>${siswa.kelas}</td>`;

      const validasi = validationData[siswa.id] || { rapor: {}, ujian: {} };

      const okIcon = '<span class="validasi-icon validasi-ok"><i class="fas fa-check-circle"></i></span>';
      const noIcon = '<span class="validasi-icon validasi-no"><i class="fas fa-times-circle"></i></span>';

      if (hasUM) {
        html += `<td>${validasi.ujian.UM ? okIcon : noIcon}</td>`;
      }
      if (hasUP) {
        html += `<td>${validasi.ujian.UP ? okIcon : noIcon}</td>`;
      }

      requiredSemesters.forEach(semester => {
        const semId = semester.id;
        html += `<td>${validasi.rapor[semId + "_P"] ? okIcon : noIcon}</td>`;
        html += `<td>${validasi.rapor[semId + "_K"] ? okIcon : noIcon}</td>`;
      });

      html += '</tr>';
    });
    html += '</tbody></table>';

    container.innerHTML = html;
  }

  function forceLogoutInstan() {
    setLoading(false); 
    localStorage.removeItem('sessionToken');
    localStorage.removeItem(LAST_PAGE_KEY);

    if (inactivityTimer) {
      clearTimeout(inactivityTimer);
      inactivityTimer = null;
    }
    
    globalSiswaList = [];
    globalGridData = {
      siswaList: [],
      mapelList: [],
      nilaiData: {}
    };
    globalRaporData = {
      P: { siswaList: [], mapelList: [], nilaiData: {} },
      K: { siswaList: [], mapelList: [], nilaiData: {} },
      Rekap: { siswaList: [], mapelList: [], nilaiRekapData: {} }
    };
    jenjangBaseCache = '';
    jenjangPilihanCache = '';

    currentUserRole = '';
    
    document.getElementById('halaman-hasil-siswa').style.display = 'none';

    const pSubjudul = document.querySelector('#halaman-utama h2#salam-sekolah + p');
    if (pSubjudul) {
      pSubjudul.style.marginBottom = '';
    }

    const menuAdminIds = [
      'btn-buka-data-sekolah', 'btn-buka-siswa', 'btn-buka-mapel', 
      'btn-buka-bobot', 'btn-buka-kelas', 'btn-buka-semester',
      'btn-buka-input-rapor', 'btn-buka-validasi-nilai', 
      'btn-buka-nilai-ijazah', 'btn-buka-kelola-kelulusan',
      'btn-update-semua-data', 'btn-buka-guru'
    ];
    
    menuAdminIds.forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        const card = el.closest('.dashboard-card');
        if (card) {
          card.style.display = 'flex';
        } else {
          el.style.display = 'flex';
        }
      }
    });

    document.querySelectorAll('.dashboard-section-header, .dashboard-divider, .dashboard-section-header-flex').forEach(el => {
       if (el.classList.contains('dashboard-section-header-flex')) {
         el.style.display = 'flex';
       } else {
         el.style.display = 'block';
       }
    });

    const guruMenu = document.getElementById('guru-menu-container');
    const inputUjianCard = document.getElementById('btn-buka-input-ujian')?.closest('.dashboard-card');
    
    if (guruMenu && inputUjianCard) {
      const h3InputNilai = Array.from(document.querySelectorAll('#halaman-utama h3.dashboard-section-header')).find(h => h.innerText.trim() === 'Input Nilai');
      if (h3InputNilai) {
        const originalParent = h3InputNilai.nextElementSibling;
        if (originalParent && originalParent.classList.contains('dashboard-grid-input')) {
          originalParent.prepend(inputUjianCard);
        }
      }
      guruMenu.remove();
    }
    
    if (inputUjianCard) {
      inputUjianCard.style.display = 'flex';
    }

    tampilHalaman('halaman-login');
  }

  // Di dalam client.html
  function bukaHalamanSuperadmin() {
    tampilHalaman('halaman-superadmin');
    setLoading(true, 'Memuat daftar sekolah...', false, false);
    document.getElementById('superadmin-sekolah-list').innerHTML = "<p>Memuat...</p>";
    
    // --- TAMBAHKAN BLOK INI ---
    document.getElementById('superadmin-donasi-list').innerHTML = "<p>Memuat...</p>";
    google.script.run
      .withSuccessHandler(renderDonasiList)
      .withFailureHandler(onGagal)
      .getDonasiList(getToken());
    // --- AKHIR TAMBAHAN ---
      
    google.script.run.withSuccessHandler(onSekolahListLoaded).withFailureHandler(onGagal).getSekolahList(getToken());
  }

  /**
   * [SUPERADMIN] Callback setelah data sekolah diterima.
   */
  function onSekolahListLoaded(response) {
    setLoading(false);
    if (response.status === 'sukses') {
      renderSekolahTable(response.sekolah);
    } else {
      document.getElementById('superadmin-sekolah-list').innerHTML = `<p class="message error" style="display:block;">Gagal memuat: ${response.message}</p>`;
    }
  }

  /**
   * [SUPERADMIN] Merender tabel daftar sekolah.
   */
  function renderSekolahTable(sekolahList) {
    const container = document.getElementById('superadmin-sekolah-list');
    let html = '<table class="superadmin-table">';
    html += '<thead><tr><th>Nama Sekolah</th><th>Jenjang</th><th>Email Admin</th><th>Aksi</th></tr></thead>';
    html += '<tbody>';

    if (sekolahList.length === 0) {
      html += '<tr><td colspan="4" style="text-align: center;">Belum ada sekolah terdaftar.</td></tr>';
    }

    sekolahList.forEach(sekolah => {
      // --- TAMBAHAN BLOK KONDISIONAL ---
      let tombolDonasiHtml = '';
      if (sekolah.donasiStatus === "APPROVED") {
        tombolDonasiHtml = `
          <button class="btn-aksi btn-batalkan-premium"
            data-id="${sekolah.id}" 
            data-nama="${sekolah.nama}"
          ><i class="fas fa-ban"></i>Batalkan</button>
        `;
      }
      // --- AKHIR BLOK KONDISIONAL ---

      html += `
        <tr>
          <td>${sekolah.nama}</td>
          <td>${sekolah.jenjang}</td>
          <td>${sekolah.email}</td>
          <td>
            <div class="btn-grup-aksi-sa">
              ${tombolDonasiHtml} <button class="btn-aksi btn-aksi-sukses btn-impersonate-sekolah"
                data-id="${sekolah.id}" 
                data-nama="${sekolah.nama}"
              ><i class="fas fa-sign-in-alt"></i>Masuk</button>
              
              <button class="btn-aksi btn-edit btn-edit-sekolah"
                data-id="${sekolah.id}" 
                data-nama="${sekolah.nama}" 
                data-jenjang="${sekolah.jenjang}" 
                data-email="${sekolah.email}"
                data-ssid="${sekolah.spreadsheetId}"
              ><i class="fas fa-pencil-alt"></i>Edit</button>
              
              <button class="btn-aksi btn-delete btn-delete-sekolah" 
                data-id="${sekolah.id}" 
                data-nama="${sekolah.nama}"
                data-ssid="${sekolah.spreadsheetId}"
              ><i class="fas fa-trash-alt"></i>Hapus</button>
            </div>
          </td>
        </tr>
      `;
    });

    html += '</tbody></table>';
    container.innerHTML = html;
  }

  /**
   * [SUPERADMIN] Menampilkan modal untuk tambah/edit sekolah.
   * FUNGSI DIPERBAIKI: Menggunakan ID form untuk reset dan memperbaiki bug label.
   */
  function showModalSekolah(mode, data) {
    hideMessage('modal-sekolah-error');
    
    const form = document.getElementById('modal-sekolah-form');
    if (form) {
      form.reset(); // Ini akan membersihkan semua input di dalamnya
    } else {
      // Fallback jika form masih belum ada (seharusnya tidak terjadi setelah fix HTML)
      console.error("Form 'modal-sekolah-form' tidak ditemukan!");
      // Kosongkan manual
      document.getElementById('modal-sekolah-nama').value = "";
      document.getElementById('modal-sekolah-jenjang').value = "";
      document.getElementById('modal-sekolah-email').value = "";
      document.getElementById('modal-sekolah-password').value = "";
    }

    document.getElementById('modal-sekolah-mode').value = mode;
    const passInput = document.getElementById('modal-sekolah-password');
    // Cara yang lebih aman untuk menemukan label
    const passLabel = document.querySelector('label[for="modal-sekolah-password"]'); 

    if (mode === 'add') {
      document.getElementById('modal-sekolah-title').innerText = "Tambah Sekolah Baru";
      document.getElementById('modal-sekolah-id').value = "";
      document.getElementById('modal-sekolah-ss-id').value = "";
      
      if(passLabel) passLabel.innerText = "Password Admin (Wajib)";
      passInput.placeholder = "Masukkan password baru";

    } else if (mode === 'edit') {
      document.getElementById('modal-sekolah-title').innerText = "Edit Data Sekolah";
      document.getElementById('modal-sekolah-id').value = data.id;
      document.getElementById('modal-sekolah-ss-id').value = data.spreadsheetId;
      document.getElementById('modal-sekolah-nama').value = data.nama;
      document.getElementById('modal-sekolah-jenjang').value = data.jenjang;
      document.getElementById('modal-sekolah-email').value = data.email;
      
      if(passLabel) passLabel.innerText = "Password Admin (Opsional)";
      passInput.placeholder = "Kosongkan jika tidak berubah";
    }

    document.getElementById('superadmin-sekolah-modal').classList.add('show');
  }

  /**
   * [SUPERADMIN] Menutup modal sekolah.
   */
  function tutupModalSekolah() {
    document.getElementById('superadmin-sekolah-modal').classList.remove('show');
    hideMessage('modal-sekolah-error');
  }

  function simpanSekolah() {
    setButtonLoading(document.getElementById('btn-simpan-sekolah'), 'Menyimpan...');
    hideMessage('modal-sekolah-error');
    const mode = document.getElementById('modal-sekolah-mode').value;
    const dataSekolah = {
      id: document.getElementById('modal-sekolah-id').value,
      nama: document.getElementById('modal-sekolah-nama').value.trim(),
      jenjang: document.getElementById('modal-sekolah-jenjang').value,
      email: document.getElementById('modal-sekolah-email').value.trim(),
      password: document.getElementById('modal-sekolah-password').value
    };
    if (!dataSekolah.nama || !dataSekolah.jenjang || !dataSekolah.email) {
      resetButtonLoading(document.getElementById('btn-simpan-sekolah'));
      showMessage('modal-sekolah-error', 'Data wajib diisi.', true); return;
    }
    if (mode === 'add' && !dataSekolah.password) {
      resetButtonLoading(document.getElementById('btn-simpan-sekolah'));
      showMessage('modal-sekolah-error', 'Password wajib untuk baru.', true); return;
    }
    google.script.run.withSuccessHandler(onSekolahSaved).withFailureHandler(onGagal).superadminSaveSekolah(getToken(), dataSekolah);
  }

  /**
   * [SUPERADMIN] Callback setelah sekolah disimpan.
   */
  function onSekolahSaved(response) {
    resetButtonLoading(document.getElementById('btn-simpan-sekolah'));
    if (response.status === 'sukses') {
      tutupModalSekolah();
      showMessage('superadmin-message', response.message, false);
      bukaHalamanSuperadmin(); // Muat ulang daftar
    } else {
      showMessage('modal-sekolah-error', response.message, true);
    }
  }

  /**
   * [SUPERADMIN] Menampilkan konfirmasi hapus sekolah.
   */
  function konfirmasiHapusSekolah(id, nama, ssid) {
    const title = "Konfirmasi Hapus Sekolah";
    const message = `Anda yakin ingin menghapus sekolah: <strong>${nama}</strong>?
                   <br><br>
                   <strong>PERINGATAN BESAR:</strong> Tindakan ini akan 
                   <strong>MENGHAPUS PERMANEN</strong> akun admin sekolah DAN 
                   <strong>SEMUA DATA SPREADSHEET</strong> (data siswa, nilai, dll) 
                   milik sekolah tersebut.
                   <br><br>
                   Tindakan ini tidak bisa dibatalkan.`;
    
    const callback = function() {
      hapusSekolah(id, ssid);
    };
    
    showConfirmationModal(title, message, callback, 'danger');
  }

  function hapusSekolah(id, ssid) {
    setLoading(true, 'Menghapus sekolah...');
    google.script.run.withSuccessHandler(onSekolahDihapus).withFailureHandler(onGagal).superadminDeleteSekolah(getToken(), id, ssid);
  }

  /**
   * [SUPERADMIN] Callback setelah sekolah dihapus.
   */
  function onSekolahDihapus(response) {
    setLoading(false);
    if (response.status === 'sukses') {
      showMessage('superadmin-message', response.message, false);
      bukaHalamanSuperadmin(); // Muat ulang daftar
    } else {
      showMessage('superadmin-message', response.message, true);
    }
  }

  // --- TAMBAHAN FUNGSI BARU ---
  /**
   * Handler BARU khusus untuk kegagalan checkToken.
   * Ini memperbaiki bug "Memverifikasi sesi..." yang macet.
   */
  function onTokenCheckFailed(error) {
    // 1. Matikan loader
    setLoading(false); 
    
    // 2. Bersihkan session di client
    localStorage.removeItem('sessionToken');
    localStorage.removeItem(LAST_PAGE_KEY);
    
    // 3. Tampilkan halaman login
    tampilHalaman('halaman-login');
    
    // 4. Tampilkan pesan error
    const errorMsg = error.message || 'Sesi tidak valid atau telah berakhir. Silakan login ulang.';
    showMessage('login-error', errorMsg, true);
  }
  // --- AKHIR FUNGSI BARU ---

  /**
   * [SUPERADMIN] Menampilkan konfirmasi sebelum login sebagai sekolah.
   */
  function konfirmasiImpersonate(id, nama) {
    const title = "Konfirmasi Masuk Sebagai";
    const message = `Anda akan masuk sebagai Admin <strong>${nama}</strong>. 
                   <br><br>
                   Sesi Superadmin Anda saat ini akan berakhir. Anda dapat logout dari akun sekolah untuk kembali ke Superadmin.`;
    
    const callback = function() {
      impersonateSekolah(id, nama);
    };
    
    // Tombol OK dibuat 'primary' (biru) bukan 'danger' (merah)
    showConfirmationModal(title, message, callback, 'primary'); 
  }

  function impersonateSekolah(id, nama) {
    setLoading(true, `Masuk sebagai ${nama}...`);
    // Token dikirim pertama, ID kedua (Sesuai Kode.gs yang saya output terakhir)
    google.script.run.withSuccessHandler(hasilLogin).withFailureHandler(onGagal).superadminImpersonate(id, getToken());
  }

  /**
   * [SUPERADMIN] Callback setelah berhasil kembali ke sesi Superadmin.
   */
  function onReturnToSuperadmin(response) {
    setLoading(false);
    if (response.status === 'sukses') {
      // Sembunyikan tombol kembali
      isImpersonatingCache = false;
      document.getElementById('btn-kembali-ke-superadmin').style.display = 'none';

      // 'response' berisi payload Superadmin
      document.getElementById('salam-superadmin').innerText = `Selamat Datang, ${response.namaSekolah}`;
      tampilHalaman('halaman-superadmin');
      bukaHalamanSuperadmin(); // Muat ulang data sekolah
    } else {
      // Gagal kembali, mungkin paksa logout
      onGagal(response);
    }
  }

  /**
   * [ADMIN] Helper baru untuk memeriksa ke server apakah data ijazah
   * benar-benar 'dirty' (berbeda dari cache).
   */
  function updateIjazahDirtyStatusFromServer() {
    console.log("Memeriksa status dirty Ijazah ke server...");
    
    // Panggil API baru di server
    google.script.run
      .withSuccessHandler((response) => {
        if (response.status === 'sukses') {
          console.log("Server merespons. isDirty:", response.isDirty);
          setIjazahDirty(response.isDirty); // Terapkan status dari server
        } else {
          // Jika gagal, anggap saja dirty
          console.warn("Gagal memeriksa status dirty, anggap dirty.");
          updateIjazahDirtyStatusFromServer();
        }
      })
      .withFailureHandler((error) => {
        // Jika gagal, anggap saja dirty
        console.error("Error saat memeriksa status dirty:", error.message);
        setIjazahDirty(true);
      })
      .getIjazahDirtyState();
  }

  /**
   * FUNGSI BARU YANG HILANG (PENTING)
   * Menandai bahwa data sumber ijazah telah berubah (dirty).
   * @param {boolean} isDirty 
   */
  function setIjazahDirty(isDirty) {
    if (isDirty) {
      localStorage.setItem('ijazahDataIsDirty', 'true');
      console.log('Ijazah data flagged as DIRTY.');
    } else {
      localStorage.removeItem('ijazahDataIsDirty');
      console.log('Ijazah data flagged as CLEAN.');
    }
    // Panggil fungsi yang sudah ada di client.html untuk update UI
    updateRecalculateButtonState(); 
  }

  /**
   * [PERBAIKAN] Helper untuk memvalidasi satu aturan password dan mengelola transisi UI.
   * SEKARANG MENGEMBALIKAN STATUS (true/false)
   */
  function checkPasswordRule(ruleId, isMet) {
    const li = document.getElementById(ruleId);
    if (!li) return false; // Kembalikan false jika elemen tidak ada

    if (isMet) {
      // Aturan terpenuhi
      if (!li.classList.contains('valid')) {
        // Ini adalah PERTAMA KALI aturan terpenuhi
        li.classList.add('valid');
        
        // Hapus timer lama JIKA ADA (seharusnya tidak ada, tapi untuk jaga-jaga)
        if (li.timeoutId) {
          clearTimeout(li.timeoutId);
        }
        
        // Atur timer baru untuk menyembunyikan
        li.timeoutId = setTimeout(() => {
          li.classList.add('hide');
        }, 1500); // Sembunyikan setelah 1.5 detik
      }
      return true; // Aturan terpenuhi
      
    } else {
      // Aturan TIDAK terpenuhi (misal: backspace)
      
      // 1. Hapus timer sembunyi jika ada
      if (li.timeoutId) {
        clearTimeout(li.timeoutId);
        li.timeoutId = null;
      }
      
      // 2. Tampilkan kembali aturannya (hapus .valid dan .hide)
      li.classList.remove('valid', 'hide');
      return false; // Aturan tidak terpenuhi
    }
  }

  /**
   * [PERBAIKAN] Fungsi utama untuk memvalidasi password di sisi klien.
   * Sekarang juga menyembunyikan seluruh tooltip jika semua valid.
   */
  function validatePasswordTooltip() {
    const password = document.getElementById('reg-password').value;
    const tooltipContainer = document.getElementById('reg-password-tooltip');
    if (!tooltipContainer) return;

    // Jalankan validasi untuk setiap aturan dan simpan hasilnya
    const isLengthValid = checkPasswordRule('pass-length', password.length >= 8);
    const isLowerValid = checkPasswordRule('pass-lower', /[a-z]/.test(password));
    const isUpperValid = checkPasswordRule('pass-upper', /[A-Z]/.test(password));
    const isNumberValid = checkPasswordRule('pass-number', /\d/.test(password));
    const isSymbolValid = checkPasswordRule('pass-symbol', /[^a-zA-Z0-9]/.test(password));

    // Cek apakah SEMUA aturan valid
    const allValid = isLengthValid && isLowerValid && isUpperValid && isNumberValid && isSymbolValid;

    if (allValid) {
      // Jika semua valid, tambahkan kelas 'all-valid' untuk menyembunyikan container
      tooltipContainer.classList.add('all-valid');
    } else {
      // Jika ada satu saja yang tidak valid, pastikan container terlihat
      tooltipContainer.classList.remove('all-valid');
    }
  }

  /**
   * [BARU] Fungsi untuk memvalidasi kecocokan password konfirmasi.
   */
  function validatePasswordMatch() {
    const passInput = document.getElementById('reg-password');
    const confirmInput = document.getElementById('reg-password-confirm');
    const tooltip = document.getElementById('reg-password-confirm-tooltip');

    if (!passInput || !confirmInput || !tooltip) return;

    const password = passInput.value;
    const confirmPassword = confirmInput.value;

    // Tampilkan tooltip HANYA jika confirm box tidak kosong DAN tidak cocok
    if (confirmPassword.length > 0 && password !== confirmPassword) {
      tooltip.classList.add('show');
    } else {
      tooltip.classList.remove('show');
    }
  }

  /**
   * [BARU] Fungsi untuk memvalidasi format email.
   * @returns {boolean} - true jika valid, false jika tidak.
   */
  function validateEmailFormat() {
    const emailInput = document.getElementById('reg-email');
    const tooltip = document.getElementById('reg-email-tooltip');
    if (!emailInput || !tooltip) return true; // Anggap valid jika elemen tidak ada

    const email = emailInput.value.trim();
    
    // Regex standar untuk format email
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    
    if (email.length > 0 && !emailRegex.test(email)) {
      // Jika tidak kosong DAN formatnya salah
      tooltip.classList.add('show');
      return false;
    } else {
      // Jika kosong ATAU formatnya benar
      tooltip.classList.remove('show');
      return true;
    }
  }

  let globalCountdownTimer = null;

  function activateAuthTab(tabName) {
    const container = document.getElementById('auth-container');

    // --- TAMBAHAN BARU ---
    // Selalu reset teks tab admin setiap kali berpindah tab
    const adminTab = document.getElementById('tab-btn-admin');
    if (adminTab) {
      adminTab.innerText = 'Login Admin';
    }
    // --- AKHIR TAMBAHAN ---

    container.querySelectorAll('.tab-link').forEach(link => link.classList.remove('active'));
    container.querySelectorAll('.auth-tab-content').forEach(content => {
      content.style.display = 'none';
      content.classList.remove('active');
    });
    const regPage = document.getElementById('halaman-registrasi');
    if (regPage) regPage.style.display = 'none';
    
    container.querySelector(`.tab-link[data-tab="${tabName}"]`).classList.add('active');
    const contentToShow = container.querySelector(`.auth-tab-content[data-content="${tabName}"]`);
    if (contentToShow) {
        contentToShow.style.display = 'block';
        contentToShow.classList.add('active');
    }
    hideMessage('login-error');
    hideMessage('login-siswa-error');
    hideMessage('login-guru-error'); // Tambahkan ini
  }

  function bukaHalamanKelolaKelulusan() {
    tampilHalaman('halaman-kelola-kelulusan');
    setLoading(true, 'Memeriksa status...', false, false);
    hideMessage('kelulusan-message');
    document.getElementById('input-tanggal-pengumuman').value = '';
    document.getElementById('btn-publikasikan-hasil').disabled = true;
    document.getElementById('btn-tarik-publikasi').disabled = true;
    google.script.run.withSuccessHandler(onPublishedStatusLoaded).withFailureHandler(onGagal).getPublishedStatus(getToken());
  }

  function onPublishedStatusLoaded(response) {
    setLoading(false);
    
    const statusContainer = document.getElementById('status-publikasi-container');
    const statusText = document.getElementById('status-publikasi-text');
    const tanggalWrapper = document.getElementById('status-publikasi-tanggal-wrapper');
    const tanggalText = document.getElementById('status-publikasi-tanggal');
    const btnPublikasi = document.getElementById('btn-publikasikan-hasil');
    const btnTarik = document.getElementById('btn-tarik-publikasi');
    
    btnPublikasi.disabled = false;
    statusContainer.style.display = 'block';

    if (response.status === 'sukses') {
      if (response.isPublished && response.publishDate) {
        statusContainer.classList.remove('error');
        statusContainer.classList.add('success');
        statusText.innerText = "Sudah Dipublikasikan";
        
        const tgl = new Date(response.publishDate);
        tanggalText.innerText = tgl.toLocaleString('id-ID', { dateStyle: 'full', timeStyle: 'short' });
        tanggalWrapper.style.display = 'block';
        
        document.getElementById('input-tanggal-pengumuman').value = response.publishDate.slice(0, 16);
        btnPublikasi.innerText = "Update Jadwal Publikasi";
        btnTarik.disabled = false;
      } else {
        statusContainer.classList.remove('success');
        statusContainer.classList.add('error');
        statusText.innerText = "Belum Dipublikasikan";
        tanggalWrapper.style.display = 'none';
        btnPublikasi.innerText = "Publikasikan Hasil";
        btnTarik.disabled = true;
      }
    } else {
      statusContainer.classList.add('error');
      statusText.innerText = "Gagal memuat status.";
      showMessage('kelulusan-message', response.message, true);
    }
  }

  function isValidISODateString(dateString) {
    if (!dateString) return false;
    try {
      const d = new Date(dateString);
      return d.toISOString() === dateString;
    } catch (e) {
      return false;
    }
  }

  function konfirmasiPublishKelulusan() {
    const tanggalInput = document.getElementById('input-tanggal-pengumuman').value;
    if (!tanggalInput) { showMessage('kelulusan-message', 'Tentukan tanggal pengumuman.', true); return; }
    const tanggalISO = new Date(tanggalInput).toISOString();
    const title = "Konfirmasi Publikasi";
    const message = `Publikasikan hasil untuk tanggal: <br><strong>${new Date(tanggalISO).toLocaleString('id-ID')}</strong>?`;
    const callback = function() {
      setLoading(true, 'Mempublikasikan...');
      hideMessage('kelulusan-message');
      google.script.run.withSuccessHandler(onKelulusanPublished).withFailureHandler(onGagal).publishKelulusan(getToken(), tanggalISO);
    };
    showConfirmationModal(title, message, callback, 'primary');
  }

  function onKelulusanPublished(response) {
    setLoading(false);
    if (response.status === 'sukses') {
      showMessage('kelulusan-message', response.message, false);
      bukaHalamanKelolaKelulusan(); 
    } else {
      showMessage('kelulusan-message', response.message, true);
    }
  }

  function konfirmasiTarikKelulusan() {
    const title = "Konfirmasi Tarik Publikasi";
    const message = "Tarik data kelulusan? Siswa tidak bisa cek lagi.";
    const callback = function() {
      setLoading(true, 'Menarik publikasi...');
      hideMessage('kelulusan-message');
      google.script.run.withSuccessHandler(onKelulusanUnpublished).withFailureHandler(onGagal).unpublishKelulusan(getToken());
    };
    showConfirmationModal(title, message, callback, 'danger');
  }

  function onKelulusanUnpublished(response) {
    setLoading(false);
    if (response.status === 'sukses') {
      showMessage('kelulusan-message', response.message, false);
      bukaHalamanKelolaKelulusan();
    } else {
      showMessage('kelulusan-message', response.message, true);
    }
  }

  function jalankanCekKelulusan() {
    hideMessage('login-siswa-error');
    const nisnInput = document.getElementById('login-siswa-nisn');
    const tglLahirInput = document.getElementById('login-siswa-tgllahir');
    
    const nisn = nisnInput.value.trim();
    const tglLahir = tglLahirInput.value; 

    if (!nisn) {
      showMessage('login-siswa-error', 'NISN harus diisi.', true);
      nisnInput.focus();
      return;
    }
    
    if (!tglLahir) {
      showMessage('login-siswa-error', 'Tanggal Lahir harus diisi.', true);
      tglLahirInput.focus();
      return;
    }
    
    setButtonLoading(document.getElementById('btn-cek-kelulusan'), 'Mengecek...');
    
    google.script.run
      .withSuccessHandler(onCekKelulusanResult)
      .withFailureHandler(onGagalCekKelulusan)
      .cekStatusSiswa(nisn, tglLahir);
  }

  function onGagalCekKelulusan(error) {
    resetButtonLoading(document.getElementById('btn-cek-kelulusan'));
    showMessage('login-siswa-error', error.message, true);
  }

  function onCekKelulusanResult(response) {
    resetButtonLoading(document.getElementById('btn-cek-kelulusan'));
    
    if (response.status === 'error') {
      showMessage('login-siswa-error', response.message, true);
    } else if (response.status === 'countdown') {
      tampilHalamanCountdown(response.targetDate, response.namaSekolah);
    } else if (response.status === 'hasil') {
      tampilHalamanHasil(response.result, response.namaSiswa, response.namaSekolah);
    }
  }

  function tampilHalamanCountdown(targetDateISO, namaSekolah) {
    document.getElementById('hasil-nama-sekolah').innerText = namaSekolah || 'Sekolah Anda';
    tampilHalaman('halaman-hasil-siswa');
    document.getElementById('hasil-countdown-container').style.display = 'block';
    document.getElementById('hasil-reveal-container').style.display = 'none';
    
    const targetDate = new Date(targetDateISO);
    document.getElementById('countdown-target-date').innerText = 
      `Pengumuman akan dibuka pada: ${targetDate.toLocaleString('id-ID', { dateStyle: 'full', timeStyle: 'long' })}`;
    
    startCountdown(targetDate);
  }

  function tampilHalamanHasil(statusKelulusan, namaSiswa, namaSekolah) {
    if (globalCountdownTimer) {
      clearInterval(globalCountdownTimer);
      globalCountdownTimer = null;
    }
    
    document.getElementById('hasil-nama-sekolah').innerText = namaSekolah || 'Sekolah Anda';
    document.getElementById('hasil-nama-siswa-lulus').innerText = namaSiswa || '';
    document.getElementById('hasil-nama-siswa-gagal').innerText = namaSiswa || '';
    
    tampilHalaman('halaman-hasil-siswa');
    document.getElementById('hasil-countdown-container').style.display = 'none';
    document.getElementById('hasil-reveal-container').style.display = 'block';

    const envelopeImage = document.getElementById('envelope-image-clickable'); 
    const envelopeContainer = document.getElementById('envelope-container');
    const resultContainer = document.getElementById('result-card-container');
    
    // Reset style gambar (untuk jika siswa cek ulang)
    envelopeImage.style.transform = ''; // Hapus style inline
    envelopeImage.style.opacity = '1';
    envelopeImage.classList.remove('envelope-opening'); // Pastikan kelas animasi di-reset
    
    envelopeContainer.style.display = 'block';
    resultContainer.style.display = 'none';
    
    document.getElementById('hasil-lulus-container').style.display = 'none';
    document.getElementById('hasil-tidak-lulus-container').style.display = 'none';

    envelopeImage.dataset.status = statusKelulusan; 
    
    // --- PERUBAHAN PADA CLICK HANDLER ---
    const clickHandler = () => {
      // 1. Tambahkan kelas animasi flip
      envelopeImage.classList.add('envelope-opening');
      
      // 2. Panggil revealResult setelah animasi dimulai
      // (Kita tidak perlu menunggu, revealResult akan menangani timeout)
      revealResult(envelopeImage.dataset.status); 
      
      // 3. Hapus listener
      envelopeImage.removeEventListener('click', clickHandler); 
    };
    // --- AKHIR PERUBAHAN ---
    
    envelopeImage.addEventListener('click', clickHandler); 
  }

  function revealResult(status) {
    // Hapus javascript yang mengatur animasi, karena CSS sudah menanganinya
    const envelopeContainer = document.getElementById('envelope-container');
    const resultContainer = document.getElementById('result-card-container');
    
    // Sesuaikan timeout agar cocok dengan durasi transisi di CSS (0.6s)
    setTimeout(() => {
      envelopeContainer.style.display = 'none';
      resultContainer.style.display = 'block';
      
      if (status === 'LULUS') {
        document.getElementById('hasil-lulus-container').style.display = 'block';
        triggerConfetti();
      } else {
        document.getElementById('hasil-tidak-lulus-container').style.display = 'block';
      }
    }, 600); // Diubah menjadi 600ms agar pas dengan transisi CSS
  }

  function startCountdown(targetDate) {
    if (globalCountdownTimer) {
      clearInterval(globalCountdownTimer);
    }
    
    const targetTime = targetDate.getTime();
    
    const daysEl = document.getElementById('countdown-days');
    const hoursEl = document.getElementById('countdown-hours');
    const minutesEl = document.getElementById('countdown-minutes');
    const secondsEl = document.getElementById('countdown-seconds');

    function updateTimer() {
      const now = new Date().getTime();
      const distance = targetTime - now;

      if (distance < 0) {
        clearInterval(globalCountdownTimer);
        globalCountdownTimer = null;
        
        // --- PERUBAHAN DI SINI ---
        
        // 1. Tampilkan pesan bahwa waktunya telah tiba
        const countdownContainer = document.getElementById('hasil-countdown-container');
        if (countdownContainer) {
          countdownContainer.innerHTML = 
            '<h2 style="color: var(--success-color);">Waktu Pengumuman Telah Tiba!</h2>' +
            '<p>Sedang mengambil hasil kelulusan Anda, harap tunggu...</p>' +
            '<div class="spinner" style="width: 40px; height: 40px; border-width: 4px; margin-top: 20px;"></div>';
        }
        
        // 2. Ambil data login siswa dari form (karena kita masih di halaman login)
        const nisn = document.getElementById('login-siswa-nisn').value;
        const tglLahir = document.getElementById('login-siswa-tgllahir').value;
        
        // 3. Panggil ulang fungsi cek kelulusan secara otomatis
        // onCekKelulusanResult akan menangani tampilan halaman hasil
        google.script.run
          .withSuccessHandler(onCekKelulusanResult)
          .withFailureHandler(onGagalCekKelulusan)
          .cekStatusSiswa(nisn, tglLahir);
        
        // --- AKHIR PERUBAHAN ---
        return;
      }

      const days = Math.floor(distance / (1000 * 60 * 60 * 24));
      const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((distance % (1000 * 60)) / 1000);
      
      daysEl.innerText = String(days).padStart(2, '0');
      hoursEl.innerText = String(hours).padStart(2, '0');
      minutesEl.innerText = String(minutes).padStart(2, '0');
      secondsEl.innerText = String(seconds).padStart(2, '0');
    }

    updateTimer();
    globalCountdownTimer = setInterval(updateTimer, 1000);
  }

  function triggerConfetti() {
    const canvas = document.getElementById('confetti-canvas');
    if (!canvas || !window.confetti) {
      console.log('Confetti library not found.');
      return;
    }

    const myConfetti = confetti.create(canvas, {
      resize: true,
      useWorker: true
    });

    const duration = 5 * 1000;
    const animationEnd = Date.now() + duration;
    const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 10001 };

    function randomInRange(min, max) {
      return Math.random() * (max - min) + min;
    }

    const interval = setInterval(function() {
      const timeLeft = animationEnd - Date.now();

      if (timeLeft <= 0) {
        return clearInterval(interval);
      }

      const particleCount = 50 * (timeLeft / duration);
      
      myConfetti(Object.assign({}, defaults, { 
        particleCount, 
        origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } 
      }));
      myConfetti(Object.assign({}, defaults, { 
        particleCount, 
        origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } 
      }));
    }, 250);
  }

  function jalankanLoginGuru() {
    hideMessage('login-guru-error');
    const npsn = document.getElementById('login-guru-npsn').value.trim();
    const email = document.getElementById('login-guru-email').value.trim();
    const pass = document.getElementById('login-guru-password').value;

    if (!npsn || !email || !pass) {
      showMessage('login-guru-error', "Semua field harus diisi.", true);
      return;
    }

    setButtonLoading(document.getElementById('btn-login-guru'), 'Login Guru...');
    google.script.run
      .withSuccessHandler(hasilLogin)
      .withFailureHandler((error) => {
         resetButtonLoading(document.getElementById('btn-login-guru'));
         showMessage('login-guru-error', error.message, true);
      })
      .prosesLoginGuru(npsn, email, pass);
  }

  function tampilkanDashboardGuru(namaGuru, namaSekolah) {
    tampilHalaman('halaman-utama');
    document.getElementById('salam-sekolah').innerHTML = `Selamat Datang, ${namaGuru}<br><small>${namaSekolah}</small>`;
    
    const pSubjudul = document.querySelector('#halaman-utama h2#salam-sekolah + p');
    if (pSubjudul) {
      pSubjudul.style.marginBottom = '0'; 
    }
    
    const menuAdmin = [
      'btn-buka-data-sekolah', 'btn-buka-siswa', 'btn-buka-mapel', 
      'btn-buka-bobot', 'btn-buka-kelas', 'btn-buka-semester',
      'btn-buka-input-rapor', 'btn-buka-validasi-nilai', 
      'btn-buka-nilai-ijazah', 'btn-buka-kelola-kelulusan',
      'btn-update-semua-data', 'btn-buka-guru'
    ];
    
    menuAdmin.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.closest('.dashboard-card') ? el.closest('.dashboard-card').style.display = 'none' : el.style.display = 'none';
    });

    document.querySelectorAll('.dashboard-section-header, .dashboard-divider, .dashboard-section-header-flex').forEach(el => {
       el.style.display = 'none';
    });

    document.getElementById('btn-buka-input-ujian').closest('.dashboard-card').style.display = 'flex';
    
    const container = document.querySelector('#halaman-utama .page');
    let guruMenu = document.getElementById('guru-menu-container');
    if (!guruMenu) {
        guruMenu = document.createElement('div');
        guruMenu.id = 'guru-menu-container';
        guruMenu.className = 'dashboard-menu-grid';
        
        guruMenu.appendChild(document.getElementById('btn-buka-input-ujian').closest('.dashboard-card'));
        
        if (pSubjudul) {
            pSubjudul.insertAdjacentElement('afterend', guruMenu);
        } else {
            container.appendChild(guruMenu);
        }
    }
  }

  // --- FUNGSI-FUNGSI MANAJEMEN GURU ---

  // --- TAMBAHAN BARU ---
  let globalKelasListCache = []; // Cache untuk daftar kelas
  // --- AKHIR TAMBAHAN ---

  // Di dalam client.html
  function bukaHalamanGuru() {
    tampilHalaman('halaman-guru');
    
    setLoading(true, 'Memuat data guru...', false, false);
    
    document.getElementById('guru-table-container').innerHTML = '<p>Memuat data guru...</p>';
    document.getElementById('btn-tambah-guru-baru').disabled = true;
    document.getElementById('btn-import-guru').disabled = true;
    document.getElementById('btn-cetak-kartu-guru').disabled = true;
    document.getElementById('btn-sync-guru-kelas').disabled = true; // <-- TAMBAHKAN INI
    document.getElementById('btn-sync-guru-kelas').style.display = 'none'; // <-- TAMBAHKAN INI
    document.getElementById('btn-simpan-pengaturan-guru').disabled = true;
    const containerTanggal = document.getElementById('container-tanggal-input-guru');
    if (containerTanggal) containerTanggal.style.display = 'none';
    hideMessage('pengaturan-guru-message');
    
    // 1. Panggil data Pengaturan (paralel)
    google.script.run
      .withSuccessHandler(onPengaturanGuruLoaded)
      .withFailureHandler(onGagal) 
      .getPengaturanGuru(getToken());

    // 2. Reset cache kelas dan panggil getKelas DULU.
    //    Callback-nya (onKelasLoadedForGuruPage) akan memanggil getGuru.
    globalKelasListCache = [];
    google.script.run
      .withSuccessHandler(onKelasLoadedForGuruPage) // <-- Panggil callback baru
      .withFailureHandler(onGagal) // onGagal akan menghentikan loading
      .getKelas(getToken());
  }

  /**
   * [BARU] Callback setelah kelas dimuat, SEBELUM memuat guru.
   */
  function onKelasLoadedForGuruPage(response) {
    if (response.status === 'sukses') {
      globalKelasListCache = response.kelasList;
      
      // 3. Setelah kelas dimuat, SEKARANG panggil getGuru
      google.script.run
        .withSuccessHandler(onGuruLoaded)
        .withFailureHandler(onGagal)
        .getGuru(getToken());
        
    } else {
      // Gagal memuat kelas. Ini fatal. Hentikan loading dan tampilkan error.
      globalKelasListCache = [];
      onGagal(response); // Biarkan onGagal mematikan loading
    }
  }

  let globalGuruList = []; // Cache lokal untuk data guru

  // Di dalam client.html
  function onGuruLoaded(response) {
    setLoading(false);

    document.getElementById('btn-tambah-guru-baru').disabled = false;
    document.getElementById('btn-import-guru').disabled = false;
    document.getElementById('btn-cetak-kartu-guru').disabled = false;
    document.getElementById('btn-sync-guru-kelas').disabled = false; // <-- AKTIFKAN TOMBOL (meski masih tersembunyi)

    if (response.status === 'sukses') {
      globalGuruList = response.guru;
      renderGuruTable(globalGuruList);
      
      // --- TAMBAHKAN BLOK LOGIKA BARU DI BAWAH INI ---
      try {
        const totalKelasCount = globalKelasListCache.length;
        let isDataDirty = false;
        
        // KONDISI 1: Hanya ada 1 kelas
        if (totalKelasCount === 1) { 
          for (const guru of globalGuruList) {
            const mapelData = guru.mapelKelas || {};
            for (const mapelId in mapelData) {
              const kelasArray = mapelData[mapelId];
              // KONDISI 2: Cek apakah datanya "kotor" (BUKAN ["*"])
              if (!Array.isArray(kelasArray) || kelasArray.length !== 1 || kelasArray[0] !== "*") {
                isDataDirty = true;
                break;
              }
            }
            if (isDataDirty) break;
          }
        }
        
        // Tampilkan tombol HANYA jika kedua kondisi terpenuhi
        if (isDataDirty) {
          document.getElementById('btn-sync-guru-kelas').style.display = 'inline-flex';
        } else {
          document.getElementById('btn-sync-guru-kelas').style.display = 'none';
        }
      } catch (e) {
        console.error("Gagal memeriksa status sync guru:", e);
        document.getElementById('btn-sync-guru-kelas').style.display = 'none';
      }
      // --- AKHIR BLOK LOGIKA BARU ---
      
    } else {
      document.getElementById('guru-table-container').innerHTML = `<p class="message error" style="display:block;">${response.message}</p>`;
    }
  }

  /**
   * Callback setelah pengaturan guru dimuat.
   */
  function onPengaturanGuruLoaded(response) {
    // Jika onGuruLoaded belum selesai, setLoading(false) tidak akan dipanggil
    // Kita asumsikan onGuruLoaded akan memanggil setLoading(false) nanti
    
    if (response.status === 'sukses') {
      const toggle = document.getElementById('toggle-waktu-input');
      const tglMulai = document.getElementById('guru-tanggal-mulai');
      const tglTutup = document.getElementById('guru-tanggal-tutup');
      const container = document.getElementById('container-tanggal-input-guru');
      
      toggle.checked = response.pengaturan.isAktif;
      tglMulai.value = response.pengaturan.tanggalMulai;
      tglTutup.value = response.pengaturan.tanggalTutup;

      if (response.pengaturan.isAktif) {
        container.style.display = 'block';
      } else {
        container.style.display = 'none';
      }
      
      document.getElementById('btn-simpan-pengaturan-guru').disabled = false;
    } else {
      // onGagal akan menangani pesan error di 'pengaturan-guru-message'
      showMessage('pengaturan-guru-message', response.message, true);
    }
  }

  /**
   * Menyimpan pengaturan waktu input guru.
   */
  function simpanPengaturanGuru() {
    const isAktif = document.getElementById('toggle-waktu-input').checked;
    const tanggalMulai = document.getElementById('guru-tanggal-mulai').value;
    const tanggalTutup = document.getElementById('guru-tanggal-tutup').value;

    // --- PERUBAHAN VALIDASI DI SINI ---
    // Validasi hanya jika KEDUA tanggal diisi
    if (isAktif && tanggalMulai && tanggalTutup && tanggalMulai >= tanggalTutup) {
      showMessage('pengaturan-guru-message', 'Tanggal selesai harus setelah tanggal mulai.', true);
      return;
    }
    // Validasi "wajib diisi" dihapus
    // --- AKHIR PERUBAHAN ---

    const pengaturan = {
      isAktif: isAktif,
      tanggalMulai: tanggalMulai, // Kirim string kosong jika tidak diisi
      tanggalTutup: tanggalTutup  // Kirim string kosong jika tidak diisi
    };

    setButtonLoading(document.getElementById('btn-simpan-pengaturan-guru'), 'Menyimpan...');
    hideMessage('pengaturan-guru-message');
    
    google.script.run
      .withSuccessHandler(onPengaturanGuruSaved)
      .withFailureHandler(onGagal) // onGagal akan mereset tombol
      .savePengaturanGuru(getToken(), pengaturan);
  }

  /**
   * Callback setelah pengaturan guru disimpan.
   */
  function onPengaturanGuruSaved(response) {
    resetButtonLoading(document.getElementById('btn-simpan-pengaturan-guru'));
    if (response.status === 'sukses') {
      showMessage('pengaturan-guru-message', response.message, false);
    } else {
      showMessage('pengaturan-guru-message', response.message, true);
    }
  }

  // Di dalam client.html
  function renderGuruTable(guruList) {
    const container = document.getElementById('guru-table-container');
    if (!guruList || guruList.length === 0) {
      container.innerHTML = '<p style="text-align: center; padding: 20px;">Belum ada data guru.</p>';
      return;
    }

    // --- LOGIKA BARU DIMULAI DI SINI ---
    // Ambil data kelas yang valid dari cache yang sudah kita muat
    const validKelasNames = globalKelasListCache.map(k => k.nama);
    const totalKelasCount = globalKelasListCache.length;
    // --- LOGIKA BARU BERAKHIR DI SINI ---

    let html = '<table class="siswa-table guru-table">';
    html += '<thead><tr><th>Nama Guru</th><th>Email Login</th><th>Mapel Diampu</th><th>Aksi</th></tr></thead>';
    html += '<tbody>';
    
    guruList.forEach(guru => {
      
      const mapelKelasData = guru.mapelKelas || {};
      const mapelEntries = Object.entries(mapelKelasData);

      let mapelBadges = '';
      if (mapelEntries.length > 0) {
        mapelBadges = mapelEntries.map(([mapelId, kelasArray]) => {
          
          // --- LOGIKA VALIDASI KELAS YANG DIPERBARUI ---
          let kelasStr = '';
          
          if (totalKelasCount <= 1) {
            // KASUS 1: Hanya ada 1 (atau 0) kelas. Selalu tampilkan "Semua Kelas"
            // Ini menyelesaikan skenario Anda (dari 2 kelas jadi 1).
            kelasStr = '(Semua Kelas)';
          } else {
            // KASUS 2: Ada lebih dari 1 kelas.
            if (Array.isArray(kelasArray) && kelasArray.includes('*')) {
              kelasStr = '(Semua Kelas)';
            } else if (Array.isArray(kelasArray)) {
              // Filter kelas yang disimpan vs kelas yang valid
              const validStoredKelas = kelasArray.filter(k => validKelasNames.includes(k));
              
              if (validStoredKelas.length === 0) {
                // Jika guru diatur ke kelas yg sudah dihapus (misal "9C")
                kelasStr = '<i style="opacity: 0.7;">(Kelas Dihapus)</i>';
              } else {
                // Tampilkan hanya kelas yang masih ada
                kelasStr = `(${validStoredKelas.join(', ')})`;
              }
            } else {
              kelasStr = '<i style="opacity: 0.7;">(Data Lama)</i>'; // Fallback jika data rusak
            }
          }
          // --- AKHIR LOGIKA VALIDASI ---

          return `<span class="selected-mapel-tag" style="margin: 2px;">${mapelId} <i style="opacity: 0.7; margin-left: 5px;">${kelasStr}</i></span>`;
        
        }).join('');
      } else {
        mapelBadges = '<span style="color: var(--text-light); font-style: italic;">Belum ada mapel</span>';
      }

      const guruDataJson = JSON.stringify({
          email: guru.email,
          nama: guru.nama,
          mapelKelas: guru.mapelKelas 
      }).replace(/"/g, '&quot;');

      html += `
        <tr>
          <td><strong>${guru.nama}</strong></td>
          <td>${guru.email}</td>
          <td>${mapelBadges}</td>
          <td>
            <div class="btn-grup-aksi">
                  <button class="btn-aksi btn-edit btn-edit-guru" data-guru="${guruDataJson}">
                    <i class="fas fa-pencil-alt"></i> Edit
                  </button>
                  <button class="btn-aksi btn-delete btn-delete-guru" data-email="${guru.email}" data-nama="${guru.nama}">
                    <i class="fas fa-trash-alt"></i> Hapus
                  </button>
            </div>
          </td>
        </tr>
      `;
    });

    html += '</tbody></table>';
    container.innerHTML = html;
  }

  function showModalGuru(mode, guruData = null) {
      hideMessage('modal-guru-error');
      document.getElementById('modal-guru-mode').value = mode;
      const passLabel = document.getElementById('label-guru-password');
      const passInput = document.getElementById('modal-guru-password');
      
      const modal = document.getElementById('guru-modal');
      const uiSingleClass = document.getElementById('modal-guru-ui-single-class');
      const uiMultiClass = document.getElementById('modal-guru-ui-multi-class');
      
      // Tentukan mode berdasarkan jumlah kelas
      const isSingleClassMode = (globalKelasListCache.length <= 1);
      modal.dataset.isSingleClassMode = isSingleClassMode;

      if (isSingleClassMode) {
        // Tampilkan UI Lama (Tag)
        uiSingleClass.style.display = 'block';
        uiMultiClass.style.display = 'none';
        document.getElementById('modal-guru-mapel-selected').innerHTML = ''; // Kosongkan tag
      } else {
        // Tampilkan UI Baru (List Mapel + Kelas)
        uiSingleClass.style.display = 'none';
        uiMultiClass.style.display = 'block';
        document.getElementById('modal-guru-mapel-kelas-list').innerHTML = ''; // Kosongkan list
      }
      
      // Reset input pencarian
      document.getElementById('modal-guru-mapel-search').value = "";
      document.getElementById('modal-guru-mapel-suggestions').style.display = 'none';
      document.getElementById('modal-guru-mapel-kelas-search').value = "";
      document.getElementById('modal-guru-mapel-kelas-suggestions').style.display = 'none';


      if (mode === 'add') {
          document.getElementById('modal-guru-title').innerText = "Tambah Guru Baru";
          document.getElementById('modal-guru-nama').value = "";
          document.getElementById('modal-guru-email').value = "";
          document.getElementById('modal-guru-original-email').value = "";
          passInput.value = "";
          passLabel.innerText = "Password (Wajib)";
          passInput.placeholder = "Buat password baru";
          // (Container mapel sudah dikosongkan di atas)
      } else {
          // Mode Edit
          document.getElementById('modal-guru-title').innerText = "Edit Data Guru";
          document.getElementById('modal-guru-nama').value = guruData.nama;
          document.getElementById('modal-guru-email').value = guruData.email;
          document.getElementById('modal-guru-original-email').value = guruData.email;
          passInput.value = "";
          passLabel.innerText = "Password (Kosongkan jika tidak diubah)";
          passInput.placeholder = "---";
          
          // Render data mapel yang ada
          const mapelKelasData = guruData.mapelKelas || {};
          if (isSingleClassMode) {
            // Mode Kelas Tunggal: Render Tags
            const mapelIds = Object.keys(mapelKelasData);
            renderSelectedMapelTags(mapelIds); // (Fungsi ini sudah ada)
          } else {
            // Mode Multi-Kelas: Render List Row
            renderMapelKelasList(mapelKelasData); 
          }
      }

      // Pastikan (lagi) mapel list global ada
      if (!globalMapelList || globalMapelList.length === 0) {
        google.script.run.withSuccessHandler((response) => {
            if (response.status === 'sukses') {
                globalMapelList = response.mapel;
            }
        }).getMapel(getToken());
      }

      document.getElementById('guru-modal').classList.add('show');
  }

  function tutupModalGuru() {
      document.getElementById('guru-modal').classList.remove('show');
  }

  function simpanGuru() {
      setButtonLoading(document.getElementById('btn-simpan-guru'), 'Menyimpan...');
      hideMessage('modal-guru-error');

      const nama = document.getElementById('modal-guru-nama').value.trim();
      const email = document.getElementById('modal-guru-email').value.trim();
      const password = document.getElementById('modal-guru-password').value;
      const mode = document.getElementById('modal-guru-mode').value;
      const originalEmail = document.getElementById('modal-guru-original-email').value;
      
      const modal = document.getElementById('guru-modal');
      const isSingleClassMode = (modal.dataset.isSingleClassMode === 'true');

      // --- LOGIKA PENYIMPANAN YANG DIPERBARUI ---
      const mapelKelasData = {}; // Ini akan jadi: { "MTK": ["VI", "VI.B"], "IPA": ["VI"] }

      if (isSingleClassMode) {
        // Baca dari UI LAMA (Tags) - Tidak berubah
        document.querySelectorAll('#modal-guru-mapel-selected .selected-mapel-tag-remove').forEach(tag => {
          mapelKelasData[tag.dataset.id] = ["*"]; // "*" = Semua Kelas
        });
      } else {
        // Baca dari UI BARU (List dropdown tunggal)
        document.querySelectorAll('#modal-guru-mapel-kelas-list .mapel-kelas-row').forEach(row => {
          const mapelId = row.dataset.mapelId;
          const select = row.querySelector('.mapel-kelas-select');
          const selectedKelas = select.value;
          
          if (selectedKelas) { // Hanya proses jika kelas dipilih (bukan "-- Pilih Kelas --")
            if (!mapelKelasData[mapelId]) {
              mapelKelasData[mapelId] = []; // Buat array jika ini mapel pertama
            }
            
            // Tambahkan kelas ke array, pastikan unik (mencegah duplikat manual)
            if (!mapelKelasData[mapelId].includes(selectedKelas)) {
              mapelKelasData[mapelId].push(selectedKelas);
            }
          }
        });
      }
      // --- AKHIR LOGIKA PENYIMPANAN ---

      if (!nama || !email) {
          resetButtonLoading(document.getElementById('btn-simpan-guru'));
          showMessage('modal-guru-error', 'Nama dan Email wajib diisi.', true);
          return;
      }
      if (mode === 'add' && !password) {
          resetButtonLoading(document.getElementById('btn-simpan-guru'));
          showMessage('modal-guru-error', 'Password wajib untuk guru baru.', true);
          return;
      }
      if (password && password.length < 8) {
          resetButtonLoading(document.getElementById('btn-simpan-guru'));
          showMessage('modal-guru-error', 'Password minimal 8 karakter.', true);
          return;
      }

      const guruData = {
          mode: mode,
          originalEmail: originalEmail,
          nama: nama,
          email: email,
          password: password,
          mapelKelas: mapelKelasData // Kirim objek (bukan JSON string)
      };

      google.script.run
          .withSuccessHandler((response) => {
              resetButtonLoading(document.getElementById('btn-simpan-guru'));
              if (response.status === 'sukses') {
                  tutupModalGuru();
                  showToast(response.message, 'sukses');
                  bukaHalamanGuru(); 
              } else {
                  showMessage('modal-guru-error', response.message, true);
              }
          })
          .withFailureHandler(onGagal)
          .saveGuru(getToken(), guruData);
  }

  function konfirmasiHapusGuru(email, nama) {
      const title = "Konfirmasi Hapus Guru";
      const message = `Yakin ingin menghapus guru <strong>${nama}</strong> (${email})?<br>Akses login mereka akan dicabut.`;
      const callback = function() {
          setLoading(true, 'Menghapus guru...');
          google.script.run
              .withSuccessHandler((response) => {
                  setLoading(false);
                  if (response.status === 'sukses') {
                      showToast(response.message, 'sukses');
                      bukaHalamanGuru(); // Reload tabel
                  } else {
                      showToast(response.message, 'gagal');
                  }
              })
              .withFailureHandler(onGagal)
              .deleteGuru(getToken(), email);
      };
      showConfirmationModal(title, message, callback, 'danger');
  }

  // Di dalam client.html (FUNGSI BARU)

  /**
   * [BARU] Menampilkan konfirmasi sebelum sinkronisasi kelas guru.
   */
  function konfirmasiSyncGuruKelas() {
    const title = "Sinkronkan Kelas Guru";
    const message = "Ini akan mengatur ulang semua mapel guru agar mengajar di 'Semua Kelas' (karena Anda hanya memiliki 1 kelas terdaftar). Ini akan membersihkan data kelas lama yang mungkin tersisa. Lanjutkan?";
    const callback = function() {
      setLoading(true, 'Menyinkronkan data guru...');
      // Sembunyikan tombolnya langsung agar tidak diklik dua kali
      document.getElementById('btn-sync-guru-kelas').style.display = 'none';
      
      google.script.run
        .withSuccessHandler(onSyncGuruKelasSelesai)
        .withFailureHandler(onGagal)
        .syncGuruClassesToSingleClass(getToken());
    };
    showConfirmationModal(title, message, callback, 'primary');
  }

  /**
   * [BARU] Callback setelah sinkronisasi kelas guru selesai.
   */
  function onSyncGuruKelasSelesai(response) {
    setLoading(false);
    if (response.status === 'sukses') {
      // Muat ulang halaman guru (data akan bersih, tombol akan otomatis hilang)
      bukaHalamanGuru();
      showToast(response.message, 'sukses');
    } else {
      // Gagal, tampilkan pesan error
      // (Tombol akan muncul lagi saat bukaHalamanGuru() dipanggil berikutnya jika masih dirty)
      showMessage('pengaturan-guru-message', response.message, true);
    }
  }

  function getSelectedMapelIds() {
    const ids = new Set();
    document.querySelectorAll('#modal-guru-mapel-selected .selected-mapel-tag-remove').forEach(tag => {
      ids.add(tag.dataset.id);
    });
    return ids;
  }

  function updateMapelSuggestions() {
    // --- PERBAIKAN: Tentukan UI mana yang aktif ---
    const modal = document.getElementById('guru-modal');
    if (!modal) return;
    const isSingleClassMode = (modal.dataset.isSingleClassMode === 'true');

    const container = document.getElementById(isSingleClassMode ? 'modal-guru-mapel-suggestions' : 'modal-guru-mapel-kelas-suggestions');
    const searchInput = document.getElementById(isSingleClassMode ? 'modal-guru-mapel-search' : 'modal-guru-mapel-kelas-search');
    // --- AKHIR PERBAIKAN ---

    const searchTerm = searchInput.value.toLowerCase();

    if (searchTerm.length === 0) {
      container.innerHTML = '';
      container.style.display = 'none';
      return;
    }

    // --- PERBAIKAN: Baca dari UI yang benar ---
    const selectedIds = isSingleClassMode ? 
                        getSelectedMapelIds() : // (Fungsi lama, baca tag)
                        getSelectedMapelKelasIds(); // (Fungsi baru, baca list row)
    // --- AKHIR PERBAIKAN ---

    const filteredMapel = globalMapelList.filter(mapel => {
      return !selectedIds.has(mapel.id) && 
            (mapel.id.toLowerCase().includes(searchTerm) || 
              mapel.nama.toLowerCase().includes(searchTerm));
    });

    if (filteredMapel.length === 0) {
      container.innerHTML = '<div class="mapel-suggestion-item" style="color: var(--text-light); cursor: default;">Mapel tidak ditemukan atau sudah ditambah.</div>';
    } else {
      container.innerHTML = filteredMapel.slice(0, 10).map(mapel => {
        return `
          <div class="mapel-suggestion-item" data-id="${mapel.id}" data-nama="${mapel.nama}">
            <strong>${mapel.id}</strong> - ${mapel.nama}
          </div>
        `;
      }).join('');
    }
    container.style.display = 'block';
  }

  /**
   * [BARU] Helper untuk UI Multi-Kelas: Baca mapel yg sudah ada di list
   */
  function getSelectedMapelKelasIds() {
    const ids = new Set();
    document.querySelectorAll('#modal-guru-mapel-kelas-list .mapel-kelas-row').forEach(row => {
      ids.add(row.dataset.mapelId);
    });
    return ids;
  }

  /**
   * [BARU] Helper untuk UI Multi-Kelas: Render baris baru (Mapel + Pilihan Kelas)
   * VERSI REVISI: Menggunakan <select> tunggal, bukan multiple.
   */
  function addMapelKelasRow(mapelId, mapelNama, selectedKelas = "") { // Terima string, bukan array
    const container = document.getElementById('modal-guru-mapel-kelas-list');
    
    // Buat opsi <select>
    let classOptions = '<option value="">-- Pilih Kelas --</option>'; // Tambah opsi default
    
    if (globalKelasListCache.length > 0) {
      classOptions += globalKelasListCache.map(kelas => {
        // Cek apakah kelas ini yang terpilih
        const isSelected = (selectedKelas === kelas.nama) ? 'selected' : '';
        return `<option value="${kelas.nama}" ${isSelected}>${kelas.nama}</option>`;
      }).join('');
    } else {
      classOptions = '<option value="">-- Tidak ada kelas --</option>';
    }

    const rowHtml = `
      <div class="mapel-kelas-row" data-mapel-id="${mapelId}">
        <span class="mapel-kelas-nama">${mapelId} - ${mapelNama}</span>
        <div class="mapel-kelas-select-wrapper">
            <select class="mapel-kelas-select">
                ${classOptions}
            </select>
        </div>
        <button type="button" class="mapel-kelas-remove" data-id="${mapelId}" title="Hapus Baris Ini">
          <i class="fas fa-trash-alt"></i>
        </button>
      </div>
    `;
    
    container.innerHTML += rowHtml;

    // Reset input pencarian (ini penting untuk UI)
    const searchInput = document.getElementById('modal-guru-mapel-kelas-search');
    const suggestionsContainer = document.getElementById('modal-guru-mapel-kelas-suggestions');
    searchInput.value = "";
    suggestionsContainer.innerHTML = "";
    suggestionsContainer.style.display = "none";
    searchInput.focus();
  }

  /**
   * [BARU] Helper untuk UI Multi-Kelas: Merender seluruh daftar saat edit
   * VERSI REVISI: Membuat satu baris untuk setiap pasangan mapel-kelas.
   */
  function renderMapelKelasList(mapelKelasData) {
    const container = document.getElementById('modal-guru-mapel-kelas-list');
    container.innerHTML = ''; // Kosongkan dulu
    
    if (!globalMapelList || globalMapelList.length === 0) {
      // Coba lagi jika mapel belum termuat
      setTimeout(() => renderMapelKelasList(mapelKelasData), 100);
      return;
    }

    for (const mapelId in mapelKelasData) {
      const mapel = globalMapelList.find(m => m.id === mapelId);
      if (mapel) {
        const selectedKelas = mapelKelasData[mapelId]; // Ini array, misal: ["VI", "VI.B"] or ["*"]
        let kelasArray = Array.isArray(selectedKelas) ? selectedKelas : [];
        
        if (kelasArray.includes("*")) {
          // Jika datanya ["*"] (Semua Kelas), buat satu baris untuk setiap kelas yang ada
          kelasArray = globalKelasListCache.map(k => k.nama);
        }

        if (kelasArray.length > 0) {
          // --- PERUBAHAN LOGIKA INTI ---
          // Buat satu baris untuk SETIAP kelas dalam array
          kelasArray.forEach(namaKelas => {
            addMapelKelasRow(mapel.id, mapel.nama, namaKelas);
          });
          // --- AKHIR PERUBAHAN ---
        }
      }
    }
  }

  function addSelectedMapelTag(mapelId, mapelNama) {
    const container = document.getElementById('modal-guru-mapel-selected');
    const searchInput = document.getElementById('modal-guru-mapel-search');
    const suggestionsContainer = document.getElementById('modal-guru-mapel-suggestions');

    const tagHtml = `
      <div class="selected-mapel-tag" id="tag_mapel_${mapelId}">
        <span>${mapelId} - ${mapelNama}</span>
        <button type="button" class="selected-mapel-tag-remove" data-id="${mapelId}" title="Hapus">&times;</button>
      </div>
    `;

    container.innerHTML += tagHtml;

    searchInput.value = "";
    suggestionsContainer.innerHTML = "";
    suggestionsContainer.style.display = "none";
    searchInput.focus();
  }

  function removeSelectedMapelTag(mapelId) {
    const tagElement = document.getElementById(`tag_mapel_${mapelId}`);
    if (tagElement) {
      tagElement.remove();
    }
  }

  function renderSelectedMapelTags(mapelIdArray) {
    const container = document.getElementById('modal-guru-mapel-selected');
    container.innerHTML = '';
    if (!mapelIdArray || mapelIdArray.length === 0) {
      return;
    }

    if (!globalMapelList || globalMapelList.length === 0) {
      setTimeout(() => renderSelectedMapelTags(mapelIdArray), 100);
      return;
    }

    mapelIdArray.forEach(id => {
      const mapel = globalMapelList.find(m => m.id === id);
      if (mapel) {
        addSelectedMapelTag(mapel.id, mapel.nama);
      }
    });

    const searchInput = document.getElementById('modal-guru-mapel-search');
    if (searchInput) searchInput.value = "";
  }

  function bukaModalImportGuru() {
    document.getElementById('file-upload-guru').value = null;
    document.getElementById('btn-proses-import-guru').disabled = true;
    document.getElementById('import-guru-results').style.display = 'none';
    document.getElementById('import-guru-results').innerHTML = '';
    hideMessage('template-guru-message');

    const fileUploadText = document.getElementById('file-upload-text-guru');
    fileUploadText.innerText = 'Klik untuk memilih file atau seret & letakkan di sini.';
    fileUploadText.classList.remove('file-chosen');
    document.getElementById('file-upload-zone-guru').classList.remove('drag-over');

    guruTelahDiImport = false;

    document.getElementById('import-guru-modal').classList.add('show');
  }

  function tutupModalImportGuru() {
    document.getElementById('import-guru-modal').classList.remove('show');
    if (guruTelahDiImport) {
      guruTelahDiImport = false;
      bukaHalamanGuru();
    }
  }

  function downloadTemplateGuru() {
    setLoading(true, 'Membuat template guru...');
    hideMessage('template-guru-message');
    google.script.run
      .withSuccessHandler(onTemplateGuruReceived)
      .withFailureHandler(onGagal)
      .getGuruTemplateData(getToken());
  }

  function onTemplateGuruReceived(response) {
    setLoading(false);

    if (response.status === 'sukses') {
      showMessage('template-guru-message', 'Template berhasil dibuat. Mengunduh...', false);

      try {
        const dataUrl = `data:${response.mimeType};base64,${response.base64}`;

        const link = document.createElement('a');
        link.setAttribute('href', dataUrl);
        link.setAttribute('download', response.fileName);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);

        link.click();

        document.body.removeChild(link);

      } catch (e) {
        showMessage('template-guru-message', 'Gagal memproses unduhan di browser: ' + e.message, true);
      }

    } else {
      showMessage('template-guru-message', response.message, true);
    }
  }

  function prosesImportFileGuru() {
    setLoading(true, 'Mengimpor guru...');
    document.getElementById('import-guru-results').style.display = 'none';
    hideMessage('template-guru-message');
    const file = document.getElementById('file-upload-guru').files[0];
    if (!file) { setLoading(false); showMessage('template-guru-message', 'Pilih file Excel.', true); return; }
    const reader = new FileReader();
    reader.onload = (e) => {
      const fileData = { base64: e.target.result, mimeType: file.type, fileName: file.name };
      google.script.run.withSuccessHandler(onImportGuruFinished).withFailureHandler(onGagal).prosesImportExcelGuru(getToken(), fileData);
    };
    reader.onerror = (e) => { setLoading(false); showMessage('template-guru-message', 'Gagal baca file.', true); };
    reader.readAsDataURL(file);
  }

  function onImportGuruFinished(response) {
    setLoading(false);
    const resultsContainer = document.getElementById('import-guru-results');

    if (response.status !== 'sukses') {
      showMessage('template-guru-message', response.message, true);
      resultsContainer.style.display = 'none';
      return;
    }

    if (response.berhasilDiUpload > 0) {
      guruTelahDiImport = true;
    }

    let html = '<h4><i class="fas fa-check-circle"></i>Proses Import Selesai</h4>';
    html += `<p>Total data diproses: <strong>${response.totalDiProses}</strong></p>`;
    html += `<p style="color: var(--success-color);">Berhasil ditambah: <strong>${response.berhasilDiUpload}</strong></p>`;
    html += `<p style="color: var(--danger-color);">Gagal/Dilewati: <strong>${response.gagalDiUpload}</strong></p>`;

    if (response.dataGagal && response.dataGagal.length > 0) {
      html += `<hr><p><strong>Detail Data yang Gagal:</strong></p>`;
      html += '<table class="import-gagal-table">';
      html += '<tr><th>Baris</th><th>Nama</th><th>Email</th><th>Alasan Gagal</th></tr>';

      response.dataGagal.forEach(item => {
        html += `
          <tr>
            <td>${item.baris}</td>
            <td>${item.nama || '(Kosong)'}</td>
            <td>${item.email || '(Kosong)'}</td>
            <td>${item.alasan}</td>
          </tr>
        `;
      });
      html += '</table>';
    }

    resultsContainer.innerHTML = html;
    resultsContainer.style.display = 'block';

    document.getElementById('file-upload-guru').value = null;
    document.getElementById('btn-proses-import-guru').disabled = true;
  }

  /**
   * Menampilkan modal konfirmasi SEBELUM me-reset semua password.
   */
  function konfirmasiCetakKartu() {
    const title = "Konfirmasi Cetak Kartu & Reset Password";
    const message = `
      Anda akan membuat kartu login untuk <strong>semua guru</strong>.
      <br><br>
      <strong style="color: var(--danger-color); font-size: 16px;">PERINGATAN BESAR:</strong>
      <br>
      Tindakan ini akan <strong>MENGGANTI (MERESET)</strong> password SEMUA guru dengan password acak baru. Password lama mereka tidak akan berlaku lagi.
      <br><br>
      Yakin ingin melanjutkan?
    `;
    showConfirmationModal(title, message, jalankanCetakKartu, 'danger');
  }

  /**
   * Memanggil server untuk me-reset password dan mendapatkan data kartu.
   */
  function jalankanCetakKartu() {
    setLoading(true, 'Membuat password baru dan data kartu...', true, true);
    google.script.run
      .withSuccessHandler(onCetakKartuSuccess)
      .withFailureHandler(onGagal)
      .generateGuruLoginCards(getToken());
  }

  /**
   * Dipanggil setelah server berhasil membuat data kartu.
   * VERSI REVISI: Ukuran diperbesar (160px) dan Level Koreksi (H)
   */
  function onCetakKartuSuccess(response) {
    setLoading(false);
    if (response.status !== 'sukses' || !response.cardData) {
      onGagal({ message: response.message || "Gagal mengambil data kartu." });
      return;
    }
    
    const websiteUrl = globalAppUrl + '#login-guru';
    const npsn = response.npsn || 'N/A'; 

    if (!globalAppUrl || websiteUrl.length < 20) { 
      console.error("Gagal mendapatkan URL website yang valid. URL:", websiteUrl);
      onGagal({ message: "Gagal mendapatkan URL aplikasi. Tidak dapat membuat QR code." });
      return;
    }

    const cardData = response.cardData;
    const container = document.getElementById('kartu-container');
    const page = document.getElementById('halaman-cetak-kartu');
    container.innerHTML = ''; 

    if (cardData.length === 0) {
      container.innerHTML = '<p>Tidak ada data guru untuk dicetak.</p>';
      page.style.display = 'block';
      return;
    }

    // 1. Buat HTML untuk semua kartu
    let cardsHtml = '';
    for (let i = 0; i < cardData.length; i++) {
      const guru = cardData[i];
      cardsHtml += `
        <div class="login-card">
          <h3>Kartu Login Guru</h3>
          <a class"login-card-qr" 
             id="qr-guru-${i}" 
             href="${websiteUrl}" 
             target="_blank" 
             title="Pindai kode ini, atau klik untuk membuka link">
          </a>
          <div class="login-card-info">
            <strong>${guru.nama}</strong><br>
            NPSN: <strong>${npsn}</strong><br>
            Email: <strong>${guru.email}</strong><br>
            Password: <strong>${guru.newPassword}</strong>
          </div>
        </div>
      `;
    }
    container.innerHTML = cardsHtml;
    
    // 2. Tampilkan halaman cetak
    page.style.display = 'block';

    // 3. Generate QR Code
    setTimeout(() => {
      try {
        for (let i = 0; i < cardData.length; i++) {
          const qrElement = document.getElementById(`qr-guru-${i}`); 
          if (qrElement) {
            qrElement.innerHTML = ''; 
            new QRCode(qrElement, {
              text: websiteUrl,
              
              // --- PERUBAHAN DI SINI ---
              width: 160, 
              height: 160,
              // --- AKHIR PERUBAHAN ---

              colorDark : "#000000",
              colorLight : "#ffffff",

              // --- PERUBAHAN DI SINI (Kembali ke 'H') ---
              correctLevel : QRCode.CorrectLevel.H 
              // --- AKHIR PERUBAHAN ---
            });
          } else {
            console.warn(`Elemen qr-guru-${i} tidak ditemukan.`);
          }
        }
      } catch (e) {
        console.error("Gagal membuat QR Code:", e);
        if (typeof QRCode === 'undefined') {
          showToast("Gagal memuat library QR Code. Periksa koneksi internet.", 'gagal');
        } else {
          showToast("Gagal membuat QR Code, terjadi error.", 'gagal');
        }
      }
    }, 50); 
    
    showToast(`Berhasil membuat ${cardData.length} kartu. Semua password guru telah direset.`, 'sukses');
  }

  function updatePremiumFeatures(status) {
    const isPremium = (status === "APPROVED");
    
    const btnGuru = document.getElementById('btn-buka-guru');
    const tabGuru = document.getElementById('tab-btn-guru');
    const tabSiswa = document.getElementById('tab-btn-siswa');
    const btnKelulusan = document.getElementById('btn-buka-kelola-kelulusan'); // <-- TAMBAHKAN INI
    
    if (btnGuru) {
      const stamp = btnGuru.querySelector('.premium-stamp');
      if (isPremium) {
        btnGuru.classList.remove('card-disabled');
        btnGuru.disabled = false;
        if (stamp) stamp.style.display = 'none';
      } else {
        btnGuru.classList.add('card-disabled');
        btnGuru.disabled = true;
        if (stamp) stamp.style.display = 'block';
      }
    }
    
    // --- TAMBAHKAN BLOK BARU DI BAWAH INI ---
    if (btnKelulusan) {
      const stamp = btnKelulusan.querySelector('.premium-stamp');
      if (isPremium) {
        btnKelulusan.classList.remove('card-disabled');
        btnKelulusan.disabled = false;
        if (stamp) stamp.style.display = 'none';
      } else {
        btnKelulusan.classList.add('card-disabled');
        btnKelulusan.disabled = true;
        if (stamp) stamp.style.display = 'block';
      }
    }
    // --- AKHIR BLOK BARU ---
    
    if (tabGuru) {
      tabGuru.disabled = !isPremium;
      tabGuru.title = isPremium ? "Login sebagai Guru" : "Fitur Premium - Donasi untuk aktivasi";
    }
    
    if (tabSiswa) {
      tabSiswa.disabled = !isPremium;
      tabSiswa.title = isPremium ? "Cek Kelulusan Siswa" : "Fitur Premium - Donasi untuk aktivasi";
    }
  }

  /**
   * [BARU] Membuka halaman donasi dan menampilkan state yang sesuai.
   */
  function bukaHalamanDonasi() {
    tampilHalaman('halaman-donasi');
    
    // Sembunyikan semua state
    document.getElementById('donasi-state-form').style.display = 'none';
    document.getElementById('donasi-state-pending').style.display = 'none';
    document.getElementById('donasi-state-approved').style.display = 'none';
    document.getElementById('donasi-state-rejected').style.display = 'none';
    hideMessage('donasi-message');
    
    // Reset form
    document.getElementById('form-donasi').reset();
    const fileUploadText = document.getElementById('file-upload-text-donasi');
    fileUploadText.innerText = 'Klik untuk memilih file...';
    fileUploadText.classList.remove('file-chosen');

    // Panggil server untuk data terbaru (termasuk URL file / alasan)
    setLoading(true, 'Memeriksa status donasi...', false);
    google.script.run
      .withSuccessHandler(onDonasiStatusLoaded)
      .withFailureHandler(onGagal)
      .getDonasiStatusDetail(getToken());
  }

  /**
   * [BARU] Callback setelah status donasi detail dimuat.
   */
  function onDonasiStatusLoaded(response) {
    setLoading(false);
    if (response.status !== 'sukses') {
      showToast(response.message, 'gagal');
      document.getElementById('donasi-state-form').style.display = 'block';
      return;
    }
    
    // --- PERBARUI FUNGSI INI ---
    const donasi = response.donasi;
    const admin = response.admin; // Ambil data admin
    
    globalDonasiStatus = donasi.status;
    globalDonasiDetail = donasi; // Simpan detail (fileUrl, alasan, dll)

    // Isi field yang terkunci
    if (admin) {
      document.getElementById('donasi-email').value = admin.email || '';
      document.getElementById('donasi-nama-sekolah').value = admin.namaSekolah || '';
    }
    // --- AKHIR PERBARUAN ---

    if (donasi.status === 'PENDING') {
      document.getElementById('donasi-state-pending').style.display = 'block';
      let dataHtml = "Data donasi tidak ada.";
      if (donasi.dataJson) {
        try {
          const data = JSON.parse(donasi.dataJson);
          // Format Angka ke Rupiah
          const jumlahRp = Number(data.jumlah || 0).toLocaleString('id-ID');
          
          // PERBAIKAN: Gunakan data.namaRekening (bukan data.nama) dan tambahkan data.metode
          dataHtml = `
            <strong>Metode:</strong> ${data.metode || 'N/A'}<br>
            <strong>Nama Pengirim:</strong> ${data.namaRekening || 'N/A'}<br>
            <strong>Jumlah:</strong> Rp ${jumlahRp}
          `;
        } catch(e) {
          dataHtml = "<em>Gagal memuat detail donasi.</em>";
        }
      }
      document.getElementById('donasi-pending-data').innerHTML = dataHtml;
      
    } else if (donasi.status === 'APPROVED') {
      document.getElementById('donasi-state-approved').style.display = 'block';
      
    } else if (donasi.status === 'REJECTED') {
      document.getElementById('donasi-state-rejected').style.display = 'block';
      
      //  INI LOGIKA YANG DIMAKSUD 
      document.getElementById('donasi-rejected-reason').innerText = `Alasan: ${donasi.alasan || "Tidak ada alasan."}`;
      //  INI LOGIKA YANG DIMAKSUD 

      // Tampilkan form di bawah pesan reject
      document.getElementById('donasi-state-form').style.display = 'block'; 
      
    } else { // 'NONE'
      document.getElementById('donasi-state-form').style.display = 'block';
    }
    
    // Panggil lagi untuk memastikan UI dashboard (jika ada) sinkron
    updatePremiumFeatures(globalDonasiStatus);
  }

  /**
   * [BARU] Mengirimkan form donasi.
   * --- FUNGSI INI DIPERBARUI TOTAL ---
   */
  function submitDonasiForm() {
    hideMessage('donasi-message');
    
    // Ambil data dari form baru
    const metode = document.getElementById('donasi-metode').value;
    const namaRekening = document.getElementById('donasi-nama-rekening').value.trim();
    const jumlah = document.getElementById('donasi-jumlah').value;
    const fileInput = document.getElementById('donasi-file');
    const file = fileInput.files[0];
    
    if (!metode) {
      showMessage('donasi-message', 'Silakan pilih metode pembayaran.', true);
      return;
    }
    if (!namaRekening) {
      showMessage('donasi-message', 'Nama pemilik rekening/e-wallet wajib diisi.', true);
      return;
    }
    if (!jumlah) {
      showMessage('donasi-message', 'Jumlah donasi wajib diisi.', true);
      return;
    }
    if (!file) {
      showMessage('donasi-message', 'Bukti transfer (file) wajib diunggah.', true);
      return;
    }
    
    setButtonLoading(document.getElementById('btn-kirim-donasi'), 'Mengunggah file...');
    
    const reader = new FileReader();
    reader.onload = (e) => {
      const fileData = { 
        base64: e.target.result, 
        mimeType: file.type, 
        fileName: file.name 
      };
      
      // Buat JSON baru
      const formDataJSON = JSON.stringify({
        metode: metode,
        namaRekening: namaRekening,
        jumlah: jumlah
      });
      
      google.script.run
        .withSuccessHandler(onDonasiSelesai)
        .withFailureHandler(onGagalKirimDonasi)
        .submitDonasi(getToken(), fileData, formDataJSON); // Fungsi backend tetap sama
    };
    reader.onerror = (e) => {
      onGagalKirimDonasi({ message: 'Gagal membaca file.' });
    };
    reader.readAsDataURL(file);
  }

  function onDonasiSelesai(response) {
    resetButtonLoading(document.getElementById('btn-kirim-donasi'));
    if (response.status === 'sukses') {
      globalDonasiStatus = response.donasiStatus;
      bukaHalamanDonasi(); // Muat ulang halaman untuk tampilkan status PENDING
      showToast("Bukti donasi berhasil dikirim!", 'sukses');
    } else {
      onGagalKirimDonasi(response);
    }
  }

  function onGagalKirimDonasi(error) {
    resetButtonLoading(document.getElementById('btn-kirim-donasi'));
    showMessage('donasi-message', error.message, true);
  }

  /**
   * [BARU] Konfirmasi pembatalan donasi.
   */
  function konfirmasiBatalkanDonasi() {
    const title = "Batalkan Donasi";
    const message = "Anda yakin ingin membatalkan pengajuan donasi ini? Bukti transfer Anda akan dihapus.";
    const callback = function() {
      setLoading(true, 'Membatalkan...');
      google.script.run
        .withSuccessHandler(onDonasiDibatalkan)
        .withFailureHandler(onGagal)
        .batalkanDonasi(getToken());
    };
    showConfirmationModal(title, message, callback, 'danger');
  }

  function onDonasiDibatalkan(response) {
    setLoading(false);
    if (response.status === 'sukses') {
      globalDonasiStatus = response.donasiStatus;
      bukaHalamanDonasi(); // Muat ulang halaman (akan kembali ke form)
      showToast("Donasi dibatalkan.", 'sukses');
    } else {
      onGagal(response);
    }
  }

  /**
   * [BARU] Merender daftar donasi pending untuk Superadmin.
   */
  function renderDonasiList(response) {
    const container = document.getElementById('superadmin-donasi-list');
    if (response.status !== 'sukses') {
      container.innerHTML = `<p class="message error" style="display:block;">Gagal memuat donasi: ${response.message}</p>`;
      return;
    }
    
    const list = response.pendingList;
    if (list.length === 0) {
      container.innerHTML = '<p style="text-align: center; padding: 15px 0; color: var(--text-light);">Tidak ada donasi yang menunggu verifikasi.</p>';
      return;
    }
    
    let html = '';
    list.forEach(item => {
      // --- BLOK INI AKAN DIMODIFIKASI ---
      let dataHtml = '<p class="donasi-detail-item"><em>Data form tidak tersedia.</em></p>';
      if (item.dataJson) {
        try {
          const data = JSON.parse(item.dataJson);
          // Format Angka ke Rupiah
          const jumlahRp = Number(data.jumlah || 0).toLocaleString('id-ID');
          
          dataHtml = `
            <div class="donasi-detail-list">
              <span class="donasi-detail-item"><strong>Metode:</strong> ${data.metode || 'N/A'}</span>
              <span class="donasi-detail-item"><strong>Pengirim:</strong> ${data.namaRekening || 'N/A'}</span>
              <span class="donasi-detail-item"><strong>Jumlah:</strong> Rp ${jumlahRp}</span>
            </div>
          `;
        } catch(e) {
          dataHtml = `<p class="donasi-detail-item"><em>Gagal memuat data donasi.</em></p>`;
        }
      }
      // --- AKHIR MODIFIKASI ---
      
      html += `
        <div class="donasi-card">
          <h4>${item.namaSekolah}</h4>
          <p>${dataHtml}</p>
          <div class="donasi-card-actions">
            <button class="btn-aksi btn-donasi-lihat" data-url="${item.fileUrl || '#'}"><i class="fas fa-search"></i>Lihat Bukti</button>
            <button class="btn-aksi btn-donasi-tolak" data-id="${item.sekolahID}"><i class="fas fa-times"></i>Tolak</button>
            <button class="btn-aksi btn-donasi-setujui" data-id="${item.sekolahID}"><i class="fas fa-check"></i>Setujui</button>
          </div>
        </div>
      `;
    });
    container.innerHTML = html;
  }

  /**
   * [BARU] Handler untuk tombol Setujui/Tolak Superadmin.
   * --- FUNGSI INI DIMODIFIKASI (HANYA MENANGANI 'SETUJUI') ---
   */
  function handleDonasiVerify(sekolahID, isApproved) {
    // Fungsi ini sekarang HANYA menangani 'isApproved = true'
    // Kasus 'Tolak' (isApproved = false) ditangani langsung oleh event listener di atas
    if (!isApproved) {
      console.error("handleDonasiVerify dipanggil untuk 'Tolak'. Ini seharusnya tidak terjadi.");
      return;
    }

    const actionText = 'Menyetujui';
    setLoading(true, `${actionText} donasi...`);
    
    google.script.run
      .withSuccessHandler(onDonasiDiverifikasi)
      .withFailureHandler(onGagal)
      .verifikasiDonasi(getToken(), sekolahID, true, ""); // Alasan kosong untuk 'Setujui'
  }

  function onDonasiDiverifikasi(response) {
    setLoading(false);
    if (response.status === 'sukses') {
      showToast(response.message, 'sukses');
      bukaHalamanSuperadmin(); // Muat ulang daftar donasi dan sekolah
    } else {
      onGagal(response);
    }
  }

  // --- TAMBAHKAN FUNGSI-FUNGSI BARU DI BAWAH INI ---
  
  /**
   * [BARU] Menampilkan modal kustom untuk meminta alasan.
   */
  function showAlasanModal(title, message, sekolahID, sekolahNama, onConfirmCallback) {
    const modal = document.getElementById('alasan-modal');
    hideMessage('alasan-modal-error');
    
    document.getElementById('alasan-modal-title').innerText = title;
    document.getElementById('alasan-modal-message').innerHTML = message;
    document.getElementById('alasan-modal-nama-sekolah').innerText = sekolahNama;
    document.getElementById('alasan-modal-input').value = '';
    
    // Simpan data & callback di elemen modal untuk diambil nanti
    modal.dataset.sekolahId = sekolahID;
    modal.onConfirm = onConfirmCallback;
    
    modal.classList.add('show');
    document.getElementById('alasan-modal-input').focus();
  }

  /**
   * [BARU] Menutup modal alasan.
   */
  function tutupAlasanModal() {
    const modal = document.getElementById('alasan-modal');
    modal.classList.remove('show');
    modal.dataset.sekolahId = '';
    modal.onConfirm = null;
    hideMessage('alasan-modal-error');
  }

  /**
   * [BARU] Menangani klik OK pada modal alasan.
   */
  function handleAlasanConfirm() {
    const modal = document.getElementById('alasan-modal');
    const alasanInput = document.getElementById('alasan-modal-input');
    const alasan = alasanInput.value.trim();
    
    if (alasan === "") {
      showMessage('alasan-modal-error', 'Alasan pembatalan tidak boleh kosong.', true);
      alasanInput.focus();
      return;
    }
    
    if (typeof modal.onConfirm === 'function') {
      const sekolahID = modal.dataset.sekolahId;
      modal.onConfirm(sekolahID, alasan); // Panggil callback asli
    }
    
    tutupAlasanModal();
  }

  /**
   * [SUPERADMIN] Konfirmasi pembatalan premium.
   * --- FUNGSI INI DIMODIFIKASI UNTUK MENGGUNAKAN MODAL BARU ---
   */
  function konfirmasiBatalkanPremium(sekolahID, namaSekolah) { 
    const title = "Batalkan Status Premium";
    const message = `Masukkan alasan pembatalan untuk sekolah: <strong><span id="alasan-modal-nama-sekolah"></span></strong>`;

    // Callback yang akan dijalankan oleh modal kustom saat di-OK
    const callback = function(id, alasan) {
      setLoading(true, 'Membatalkan status premium...');
      google.script.run
        .withSuccessHandler(onPremiumDibatalkan)
        .withFailureHandler(onGagal)
        .superadminBatalkanPremium(getToken(), id, alasan); // Kirim 'id' dan 'alasan' dari modal
    };

    // Tampilkan modal kustom baru
    showAlasanModal(title, message, sekolahID, namaSekolah, callback);
  }

  /**
   * [SUPERADMIN] Callback setelah premium dibatalkan.
   */
  function onPremiumDibatalkan(response) {
    setLoading(false);
    if (response.status === 'sukses') {
      showToast(response.message, 'sukses');
      bukaHalamanSuperadmin(); // Muat ulang daftar sekolah
    } else {
      showMessage('superadmin-message', response.message, true);
    }
  }

  /* --- ============================================= --- */
  /* ---      INISIALISASI SLIDER DONASI (SWIPER)      --- */
  /* --- ============================================= --- */

  // Pastikan kode ini ada DI LUAR (setelah) fungsi-fungsi lain
  // Ia akan otomatis berjalan saat halaman dimuat

  var donasiSwiper = new Swiper(".donasi-slider", {
    // Opsi Loop (Kembali ke awal setelah slide terakhir)
    loop: true,

    // Indikator Titik-titik
    pagination: {
      el: ".swiper-pagination",
      clickable: true,
    },

    // Tombol Panah Kanan/Kiri
    navigation: {
      nextEl: ".swiper-button-next",
      prevEl: ".swiper-button-prev",
    },
    
    // Bonus: Otomatis hentikan video YouTube saat slide diganti
    on: {
      slideChange: function () {
        try {
          // Cari semua iframe di dalam slider (LOGIKA ASLI)
          var iframes = this.el.querySelectorAll('iframe');
          iframes.forEach(function(iframe) {
            // Reset 'src'-nya untuk menghentikan video
            var iframeSrc = iframe.src;
            iframe.src = iframeSrc; 
          });

          /* --- =================================== --- */
          /* ---      TAMBAHAN BARU DI SINI        --- */
          /* --- =================================== --- */
          // Hentikan juga player API jika ada
          if (ytPlayerDonasi && typeof ytPlayerDonasi.stopVideo === 'function') {
            ytPlayerDonasi.stopVideo();
          }
          // Pastikan nav tampil lagi saat slide diganti
          const sliderEl = document.querySelector('.donasi-slider');
          if (sliderEl) {
              sliderEl.classList.remove('video-is-playing');
          }
          /* --- =================================== --- */
          /* ---      AKHIR TAMBAHAN BARU          --- */
          /* --- =================================== --- */

        } catch (e) {
          console.warn("Gagal menghentikan video:", e);
        }
      },
    }
  });

  /* --- ============================================= --- */
  /* ---      KODE BARU: KONTROL VIDEO YOUTUBE         --- */
  /* --- ============================================= --- */

  // 1. Variabel global untuk player
  let ytPlayerDonasi = null;

  /**
   * 2. Fungsi ini dipanggil otomatis oleh API YouTube (dari index.html)
   * saat API siap.
   */
  function onYouTubeIframeAPIReady() {
    const playerElement = document.getElementById('youtube-player-donasi');
    if (playerElement) {
      try {
        ytPlayerDonasi = new YT.Player('youtube-player-donasi', {
          events: {
            'onReady': onPlayerReady,
            'onStateChange': onPlayerStateChange
          }
        });
      } catch(e) {
        console.error("Gagal menginisialisasi YouTube Player API:", e);
      }
    }
  }

  /**
   * 3. Dipanggil saat player siap.
   */
  function onPlayerReady(event) {
    // Player siap. Kita tambahkan listener untuk menampilkan kembali nav
    const sliderEl = document.querySelector('.donasi-slider');
    if (sliderEl) {
      // Listener untuk "kursor diarahkan ke video/slider"
      sliderEl.addEventListener('mouseenter', showSliderNav);
      // Listener untuk "halaman diklik"
      document.addEventListener('click', showSliderNav);
    }
  }

  /**
   * 4. Fungsi untuk menangani perubahan status player (Play, Pause, dll.)
   */
  function onPlayerStateChange(event) {
    const sliderEl = document.querySelector('.donasi-slider');
    if (!sliderEl) return;

    if (event.data == YT.PlayerState.PLAYING) {
      // Saat video diputar: Sembunyikan navigasi
      sliderEl.classList.add('video-is-playing');
    } else {
      // Saat video dijeda, selesai, atau buffering: Tampilkan navigasi
      sliderEl.classList.remove('video-is-playing');
    }
  }

  /**
   * 5. Fungsi helper untuk menampilkan navigasi (dipanggil oleh listener)
   */
  function showSliderNav() {
    const sliderEl = document.querySelector('.donasi-slider');
    if (sliderEl) {
      sliderEl.classList.remove('video-is-playing');
    }
  }
  /* --- ============================================= --- */
  /* ---      AKHIR KODE BARU                        --- */
  /* --- ============================================= --- */

</script>
